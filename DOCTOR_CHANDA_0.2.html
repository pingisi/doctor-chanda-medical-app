<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="description" content="Doctor Chanda - Medical Records & E-Prescription App">
    <title>Smart Medical Records & E-Prescription</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb; /* blue-600 */
            --secondary-color: #10b981; /* emerald-500 */
            --accent-color: #f59e0b; /* amber-500 */
            --gradient-primary: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            --gradient-secondary: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --shadow-brand: 0 10px 25px -5px rgba(37, 99, 235, 0.2), 0 4px 6px -2px rgba(37, 99, 235, 0.05);
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        
        /* Professional Brand Elements */
        .brand-logo {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .medical-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-brand);
            border: 1px solid rgba(37, 99, 235, 0.1);
            transition: all 0.3s ease;
        }
        
        .medical-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px -10px rgba(37, 99, 235, 0.3);
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* blue-600 */
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #059669; /* emerald-600 */
        }
        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            min-height: 56px;
            min-width: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 200px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .dropdown-content.show {
            display: block;
        }
        .dropdown-item {
            color: black;
            padding: 8px 12px;
            text-decoration: none;
            display: block;
            cursor: pointer;
        }
        .dropdown-item:hover {
            background-color: #f1f1f1;
        }
        .prescription-paper {
            background: white;
            padding: 2rem;
            margin: 1rem auto;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-top: 6px solid var(--primary-color);
            position: relative;
            min-height: 750px;
            padding-bottom: 80px;
            page-break-inside: avoid;
            page-break-after: avoid;
        }

        .prescription-content-wrapper {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }

        .prescription-signature-area {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            page-break-inside: avoid;
            margin-top: 30px;
        }

        .prescription-signature-area img {
            max-height: 60px;
            max-width: 200px;
            margin-bottom: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 5px;
            background: white;
        }

        .signature-doctor-info {
            border-top: 2px solid #2563eb;
            padding-top: 10px;
            margin-top: 10px;
        }

        .signature-verification {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 8px;
            display: inline-block;
        }

        .prescription-header {
            page-break-after: avoid;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .prescription-medications {
            page-break-inside: avoid;
            margin-bottom: 30px;
        }

            @media print {
                @page {
                    size: A4 portrait;
                    margin: 12mm; /* Optimized margins for A4 */
                }

                * {
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                }

                body {
                    margin: 0 !important;
                    padding: 0 !important;
                    background: white !important;
                    font-size: 12pt !important; /* Standard print font size */
                    line-height: 1.4 !important;
                }

                body * {
                    visibility: hidden;
                }
                
                .prescription-paper, 
                .prescription-paper * {
                    visibility: visible !important;
                }
                
                .prescription-paper {
                    position: static !important;
                    width: 100% !important;
                    max-width: none !important;
                    margin: 0 !important;
                    padding: 15mm !important; /* Consistent with page margins */
                    box-shadow: none !important;
                    border-top: 6px solid #2563eb !important;
                    border-left: none !important;
                    border-right: none !important;
                    border-bottom: none !important;
                    min-height: calc(297mm - 24mm) !important; /* Full A4 height minus margins */
                    max-height: calc(297mm - 24mm) !important;
                    background: white !important;
                    page-break-inside: avoid !important;
                    font-size: 11pt !important;
                    line-height: 1.3 !important;
                }

                .prescription-content-wrapper {
                    margin-bottom: 20mm !important;
                    page-break-inside: avoid;
                    min-height: 180mm !important; /* Ensure good content spacing */
                }

                .prescription-signature-area {
                    background: white !important;
                    border: 1px solid #e5e7eb !important;
                    border-radius: 6px !important;
                    padding: 12mm !important;
                    box-shadow: none !important;
                    margin-top: 15mm !important;
                    margin-left: auto !important;
                    margin-right: 0 !important;
                    width: 80mm !important; /* Optimized for A4 */
                    max-width: 80mm !important;
                    page-break-inside: avoid !important;
                    position: absolute !important;
                    right: 15mm !important;
                    bottom: 15mm !important;
                }

                .prescription-signature-area img {
                    max-height: 50px !important;
                    max-width: 180px !important;
                    border: 1px solid #e5e7eb !important;
                    border-radius: 4px !important;
                    padding: 5px !important;
                }

                .signature-verification {
                    background: #10b981 !important;
                    color: white !important;
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                }

                .prescription-header {
                    page-break-after: avoid;
                }

                .prescription-medications {
                    page-break-inside: avoid;
                }
                
                .no-print {
                    display: none !important;
                    visibility: hidden !important;
                }

                /* Ensure signature section is always visible in print */
                #signatureSection {
                    display: block !important;
                    visibility: visible !important;
                }

                /* Force single page layout */
                * {
                    page-break-inside: avoid !important;
                }

                /* Optimize content for single page */
                header, .prescription-header {
                    margin-bottom: 15px !important;
                }

                .prescription-medications, .prescription-content {
                    margin-bottom: 15px !important;
                }

                /* Ensure signature always fits on same page */
                .prescription-signature-area {
                    margin-top: 20px !important;
                    break-inside: avoid !important;
                    page-break-inside: avoid !important;
                }

                /* Consistent footer alignment for all document types */
                .document-footer, .prescription-signature-area {
                    position: absolute !important;
                    bottom: 20px !important;
                    right: 40px !important;
                    width: 250px !important;
                }

                /* PDF capture optimization - ensure all elements are crisp */
                .prescription-paper img,
                .certificate-template img {
                    image-rendering: -webkit-optimize-contrast !important;
                    image-rendering: crisp-edges !important;
                }

                /* Improved signature positioning for signed prescriptions */
                .prescription-paper.printing .prescription-signature-area {
                    position: absolute;
                    bottom: 20px;
                    right: 40px; /* Consistent with certificate */
                    width: 250px; /* Match updated width */
                }

                /* Universal document layout for print */
                .document-layout {
                    position: absolute;
                    left: 0;
                    top: 0;
                    width: 100% !important;
                    max-width: none !important;
                    margin: 0 !important;
                    padding: 40px !important;
                    box-shadow: none !important;
                    border: 2px solid var(--primary-color) !important;
                    border-top: 6px solid var(--primary-color) !important;
                    min-height: calc(100vh - 1.5in) !important;
                    page-break-inside: avoid !important;
                }

                .document-footer {
                    position: absolute;
                    bottom: 20px;
                    width: calc(100% - 80px);
                    page-break-inside: avoid;
                }

                .document-signature img {
                    max-height: 40px !important;
                    max-width: 150px !important;
                }
            }        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* Signature Status Mobile Fix */
        #signatureStatus {
            margin-top: 16px;
        }
        
        #signatureStatus.hidden {
            display: none !important;
        }
        
        #resetSignatureBtn {
            font-weight: 600;
        }

        /* Canvas touch optimization */
        #signatureCanvas {
            touch-action: none; /* Prevent default touch behaviors like scrolling */
            -webkit-touch-callout: none; /* Prevent callout on iOS */
            -webkit-user-select: none; /* Prevent text selection */
            user-select: none;
        }

        /* Shake animation for PIN errors */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* PIN-less signature styles */
        .signature-preview-container {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }

        .pin-disabled-badge {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 8px;
        }

        /* Mobile modal improvements */
        .fixed.z-50 {
            position: fixed !important;
            z-index: 9999 !important;
        }

        /* Better mobile button interaction */
        @media (max-width: 768px) {
            .fixed.z-50 button {
                min-height: 48px !important;
                font-size: 16px !important;
                padding: 12px 20px !important;
                border-radius: 8px !important;
                transition: all 0.15s ease !important;
            }
            
            .fixed.z-50 button:active {
                transform: scale(0.95) !important;
                opacity: 0.8 !important;
            }
            
            .fixed.z-50 input {
                font-size: 16px !important; /* Prevents zoom on iOS */
                min-height: 48px !important;
            }
            
            /* Ensure FAB button remains circular on mobile */
            #addPatientBtn {
                width: 56px !important;
                height: 56px !important;
                min-width: 56px !important;
                min-height: 56px !important;
                border-radius: 50% !important;
                padding: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                z-index: 50 !important;
                position: fixed !important;
                bottom: 24px !important;
                right: 24px !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
            }
            
            /* Ensure FAB container doesn't interfere */
            #addPatientBtn svg {
                width: 24px !important;
                height: 24px !important;
            }
        }

        /* Prevent body scroll when modal is open */
        .modal-open {
            overflow: hidden !important;
            position: fixed !important;
            width: 100% !important;
        }
        
        /* Enhanced Mobile Optimization */
        @media (max-width: 640px) {
            body {
                overscroll-behavior: none; /* Prevents pull-to-refresh */
                touch-action: pan-y; /* Allows vertical scrolling but prevents unnecessary horizontal actions */
            }

            #app {
                padding: 0.75rem !important;
                max-width: 100% !important;
            }
            
            /* Fix for signature status on mobile */
            #signatureStatus {
                display: block !important;
                margin-top: 20px;
            }
            
            #signatureStatus.hidden {
                display: none !important;
            }
            
            #resetSignatureBtn {
                display: block !important;
                min-height: 44px;
                padding: 10px 16px !important;
                font-size: 14px;
                margin: 10px 0;
                width: 100%;
                text-align: center;
                font-weight: 600;
            }
            
            .prescription-paper {
                margin: 0.5rem;
                padding: 1rem;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            }
            
            /* Prevent zoom on iOS when focusing inputs */
            input, select, textarea {
                font-size: 16px !important;
                padding: 12px !important;
                min-height: 48px; /* Improved touch target size */
                border-radius: 8px !important;
                -webkit-appearance: none; /* Remove default styling */
                appearance: none;
            }
            
            /* Make all interactive elements easier to tap */
            button, .btn, a[role="button"] {
                min-height: 48px;
                padding: 12px 16px;
                border-radius: 8px;
                touch-action: manipulation; /* Optimize touch behavior */
            }
            
            /* Position FABs better for thumb reach */
            .floating-btn {
                bottom: 24px;
                right: 24px;
                width: 60px;
                height: 60px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            
            /* Improved checkbox touch targets */
            input[type="checkbox"] {
                min-width: 24px;
                min-height: 24px;
                margin: 0 8px 0 0;
            }
            
            /* Better spacing for mobile content */
            .space-y-6 > * + * {
                margin-top: 1.5rem;
            }
            
            .space-y-4 > * + * {
                margin-top: 1rem;
            }
            
            /* Mobile button improvements */
            .flex.space-x-2 > button,
            .flex.gap-2 > button {
                min-height: 48px;
                padding: 10px 12px;
                font-size: 14px;
            }
            
            /* Better action buttons */
            .no-print button {
                min-height: 48px !important;
                font-size: 14px;
                padding: 12px 16px !important;
            }
            
            /* Fix for tab navigation on mobile */
            .flex.flex-wrap {
                gap: 8px;
                justify-content: center;
            }
            
            .flex.flex-wrap > button {
                flex: 1 1 auto;
                min-width: 0;
                text-align: center;
                white-space: nowrap;
            }
            
            /* Mobile-specific UI improvements */
            header {
                border-radius: 12px !important;
                padding: 16px !important;
            }
            
            .medical-card {
                padding: 16px !important;
                margin-bottom: 12px;
            }
            
            /* Fix modals for mobile */
            .modal-content {
                width: 95% !important;
                max-width: 95% !important;
                max-height: 90vh;
                overflow-y: auto;
                border-radius: 12px;
                padding: 16px !important;
            }
            
            /* Ensure appropriate spacing for patient list */
            #patientListContainer {
                margin-bottom: 100px; /* Space for FAB */
            }
            
            /* Improve scrolling on mobile */
            .overflow-y-auto {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Fix quick stats display */
            #quickStats {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        /* Ensure signature setup section is visible */
        #signatureSetupSection {
            display: block !important;
            visibility: visible !important;
        }

        /* Shake animation for modal */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* Font preview styles */
        .font-style-btn {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .font-style-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .font-style-btn.bg-blue-100 {
            background-color: #dbeafe !important;
            border-color: #3b82f6 !important;
        }

        /* Signature preview styles */
        #signaturePreviewText {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            letter-spacing: 1px;
        }

        /* Universal Document Layout Styles */
        .document-layout {
            background: white;
            padding: 2rem;
            margin: 1rem auto;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-top: 6px solid var(--primary-color);
            position: relative;
            min-height: 600px;
        }

        .document-content {
            margin-bottom: 120px;
            page-break-inside: avoid;
        }

        .document-footer {
            position: absolute;
            bottom: 20px;
            width: calc(100% - 4rem);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            page-break-inside: avoid;
        }

        .document-signature {
            text-align: center;
            min-width: 200px;
            page-break-inside: avoid;
        }

        .document-signature img {
            max-height: 50px;
            max-width: 180px;
            margin-bottom: 8px;
        }

        .document-id-section {
            font-size: 11px;
            color: #6b7280;
            padding: 8px 0;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
        }

        /* Medical Certificate Styles */
        .certificate-template {
            font-family: 'Times New Roman', serif;
            line-height: 1.5;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            min-height: 600px;
            position: relative;
            background: white;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-top: 5px solid var(--primary-color); /* Slightly thinner border */
        }

        .certificate-header {
            text-align: center;
            border-bottom: 2px solid #2563eb;
            padding-bottom: 15px;
            margin-bottom: 20px;
            page-break-inside: avoid;
        }

        .certificate-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e40af;
            margin: 12px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            page-break-inside: avoid;
        }

        .certificate-content {
            padding: 20px 0;
            text-align: justify;
            margin-bottom: 40px; /* Reduced since we're separating signature */
            page-break-inside: avoid;
        }

        .certificate-content p {
            margin-bottom: 15px;
            page-break-inside: avoid;
            orphans: 2;
            widows: 2;
        }

        .certificate-footer {
            position: relative; /* Changed from absolute to prevent overlap */
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #2563eb;
            display: flex;
            justify-content: flex-end; /* Align signature to right */
            page-break-inside: avoid;
        }

        .certificate-signature {
            text-align: center;
            border: 2px solid #2563eb;
            border-radius: 12px;
            padding: 20px;
            width: 300px; /* Fixed width to prevent expansion */
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            page-break-inside: avoid;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-left: auto; /* Ensure it stays aligned to the right */
        }

        .certificate-signature img {
            max-height: 70px;
            max-width: 200px;
            margin-bottom: 15px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .certificate-signature-header {
            background: #2563eb;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 15px;
            display: inline-block;
        }

        .certificate-doctor-details {
            border-top: 2px solid #2563eb;
            padding-top: 12px;
            margin-top: 12px;
        }

        /* Mobile responsive signature styles */
        @media (max-width: 768px) {
            .prescription-signature-area {
                width: 100% !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
                margin-top: 30px !important;
            }

            .certificate-signature {
                width: 100% !important;
                margin-top: 20px !important;
                margin-left: 0 !important;
            }
            
            .certificate-footer {
                justify-content: center !important;
            }
            
            .certificate-info-section {
                margin-bottom: 20px !important;
            }
            
            .certificate-info-section > div {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            .prescription-paper {
                padding: 1rem !important;
                padding-bottom: 60px !important;
            }
        }

        /* Enhanced signature hover effects for screen */
        .prescription-signature-area:hover,
        .certificate-signature:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }

        /* Signature status indicators */
        .signature-status-verified {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: 600;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .certificate-seal {
            width: 80px;
            height: 80px;
            border: 3px solid #2563eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #2563eb;
            margin: 0 auto 10px;
            page-break-inside: avoid;
        }

        /* Enhanced Print Styles */
        @media print {
            @page {
                size: A4;
                margin: 1in;
            }
            
            body {
                margin: 0;
                padding: 0;
                background: white;
            }
            
            .certificate-template {
                font-size: 13px; /* Slightly smaller font for better fit */
                box-shadow: none;
                border: 2px solid #2563eb;
                padding: 25px; /* Reduced padding for better space utilization */
                margin: 0;
                max-width: none;
                width: 100%;
                height: calc(100vh - 2in); /* Fixed height for single page */
                position: relative;
                display: flex;
                flex-direction: column;
            }
            
            .certificate-header {
                page-break-after: avoid;
                flex-shrink: 0; /* Prevent header from shrinking */
                padding-bottom: 12px;
                margin-bottom: 18px;
            }
            
            .certificate-header h2 {
                font-size: 18px !important;
            }
            
            .certificate-header h3 {
                font-size: 14px !important;
            }
            
            .certificate-content {
                page-break-inside: avoid;
                margin-bottom: 20px; /* Clear spacing */
            }
            
            /* Certificate info section for print */
            .certificate-info-section {
                page-break-inside: avoid;
                margin: 15px 0;
            }
            
            .certificate-footer {
                position: relative;
                margin-top: 20px;
                padding-top: 15px;
                border-top: 2px solid #2563eb !important;
                display: flex;
                justify-content: flex-end;
                page-break-inside: avoid;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .certificate-signature {
                page-break-inside: avoid;
                flex-shrink: 0; /* Prevent signature from shrinking */
            }
            
            /* Additional certificate print optimizations */
            .certificate-template * {
                box-sizing: border-box !important;
            }
            
            /* Ensure certificate content is properly sized */
            .certificate-content p {
                margin-bottom: 8px !important;
                line-height: 1.4 !important;
            }
            
            /* Optimize signature area for print */
            .certificate-signature {
                border: 2px solid #2563eb !important;
                background: #f8fafc !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Force single page layout for certificates */
            .certificate-template {
                page-break-after: avoid !important;
                page-break-before: avoid !important;
            }
            
            .no-print {
                display: none !important;
            }
        }

        /* PDF Generation Specific Styles */
        .pdf-certificate {
            font-family: 'Times New Roman', serif;
            line-height: 1.4;
            color: #333;
            padding: 30px;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        
        .pdf-certificate .certificate-header {
            flex-shrink: 0;
        }

        .pdf-certificate .certificate-content {
            margin-bottom: 20px;
        }
        
        .pdf-certificate .certificate-info-section {
            margin: 15px 0;
            page-break-inside: avoid;
        }

        .pdf-certificate .certificate-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #2563eb;
            display: flex;
            justify-content: flex-end;
        }
        
        /* Ensure signature area stays within bounds */
        .pdf-certificate .certificate-signature {
            max-width: 300px;
            flex-shrink: 0;
        }
        
        /* Patient Filter and Archive Styles */
        .patient-filter-btn {
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .patient-filter-btn.active {
            border-color: #3b82f6;
            font-weight: 600;
        }
        
        .patient-filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Archive patient styling */
        .medical-card.archived {
            opacity: 0.7;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .archive-patient-btn:hover {
            transform: scale(1.05);
        }
        
        .delete-patient-btn:hover {
            transform: scale(1.05);
        }
        
        /* Status indicators */
        .status-indicator {
            position: relative;
        }
        
        .status-indicator::after {
            content: '';
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .status-indicator.active::after {
            background-color: #10b981;
        }
        
        .status-indicator.archived::after {
            background-color: #6b7280;
        }
        
        /* Enhanced Animations and Effects */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        .animate-slide-in-up {
            animation: slideInUp 0.5s ease-out;
        }
        
        .animate-fade-in-scale {
            animation: fadeInScale 0.3s ease-out;
        }
        
        /* Enhanced Medical Card Hover Effects */
        .medical-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }
        
        .medical-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(37, 99, 235, 0.25), 0 0 0 1px rgba(37, 99, 235, 0.1);
        }
        
        /* Quick Stats Cards Enhancement */
        .stats-card {
            background: linear-gradient(135deg, var(--bg-from) 0%, var(--bg-to) 100%);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        /* Enhanced Button Animations */
        .floating-btn {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 40;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .floating-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 20px 40px -10px rgba(37, 99, 235, 0.4);
        }
        
        /* Search Bar Enhancement */
        .search-container {
            position: relative;
        }
        
        .search-container::before {
            content: '';
            position: absolute;
            inset: 0;
            padding: 2px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 0.75rem;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .search-container:focus-within::before {
            opacity: 1;
        }
        
        /* Loading Animation Enhancement */
        .loading-pulse {
            animation: pulse 2s infinite;
        }
        
        /* Responsive Enhancements */
        @media (max-width: 768px) {
            .floating-btn {
                bottom: 1rem;
                right: 1rem;
            }
            
            .medical-card:hover {
                transform: translateY(-2px) scale(1.01);
            }
        }
        
        /* Mobile Performance Optimizations */
        @media (max-width: 768px) {
            /* Remove fancy effects on mobile for better performance */
            .glass-card {
                background: #ffffff;
                backdrop-filter: none;
                border: 1px solid rgba(0, 0, 0, 0.1);
            }
            
            .glass-header {
                background: #2563eb;
                backdrop-filter: none;
            }
            
            /* Disable animations on low-end devices */
            @media (prefers-reduced-motion) {
                * {
                    animation: none !important;
                    transition: none !important;
                    transform: none !important;
                }
            }
            
            /* Optimize touch interactions */
            a, button, input, select, textarea, [role="button"] {
                touch-action: manipulation;
            }
            
            /* Prevent content shift on keyboard appearance */
            input, textarea, select {
                font-size: 16px !important;
            }
            
            /* Better tap targets */
            .tap-target {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Fast tap response */
            a:active, button:active, [role="button"]:active {
                opacity: 0.7;
                transition: opacity 0.1s;
            }
        }
        
        /* Content visibility optimizations for long pages */
        .offscreen-content {
            content-visibility: auto;
            contain-intrinsic-size: 0 500px;
        }
    </style>
</head>
<body class="antialiased">

    <!-- App Container -->
    <div id="app" class="max-w-4xl mx-auto p-2 sm:p-4 md:p-6">

        <!-- Professional Loading Spinner -->
        <div id="loading" class="fixed inset-0 bg-gradient-to-br from-blue-50 to-white bg-opacity-95 flex flex-col items-center justify-center z-50">
            <div class="relative">
                <!-- Medical Cross Logo -->
                <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-blue-700 rounded-full flex items-center justify-center mb-4 shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                    </svg>
                </div>
                <!-- Animated Ring -->
                <div class="absolute -inset-2">
                    <div class="animate-spin rounded-full h-24 w-24 border-4 border-transparent border-t-blue-500 border-r-blue-500"></div>
                </div>
            </div>
            <div class="text-center mt-4">
                <h3 class="text-lg font-bold text-blue-800">MediRecords Pro</h3>
                <p class="text-sm text-blue-600 animate-pulse">Loading your medical workspace...</p>
            </div>
        </div>
        
        <!-- Streamlined Header for Mobile -->
        <header class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-4 rounded-xl shadow-lg mb-4 relative overflow-hidden">
            <div class="relative z-10 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <!-- Doctor Avatar - Simplified -->
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl sm:text-2xl font-bold">
                            <span class="text-white">MediRecords</span>
                        </h1>
                        <p class="text-blue-100 text-xs">Dr. Chanda Chowdhury</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2">
                    <div class="text-xs text-blue-100 hidden sm:block">
                        <span id="currentDate" class="font-medium"></span>
                    </div>
                    <button id="settingsBtn" class="p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Simplified Quick Stats for Mobile -->
        <div id="quickStats" class="grid grid-cols-2 gap-3 mb-4">
            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                        <i data-lucide="users" class="w-5 h-5 text-blue-600"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-xs">Total Patients</p>
                        <p class="text-xl font-bold text-gray-800" id="totalPatientsCount">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                        <i data-lucide="calendar-check" class="w-5 h-5 text-green-600"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-xs">Today</p>
                        <p class="text-xl font-bold text-gray-800" id="todayVisitsCount">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient List View -->
        <div id="patientListView" class="view active">
            <!-- Mobile-Optimized Search Bar -->
            <div class="mb-4">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                    </div>
                    <input id="searchInput" type="text" placeholder="Search patients..." class="w-full pl-10 pr-10 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none text-base bg-white shadow-sm">
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                        <button id="searchFiltersBtn" class="text-gray-400 hover:text-blue-500 p-2">
                            <i data-lucide="filter" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Simplified Filter Tabs -->
            <div class="mb-4 flex bg-gray-100 p-1 rounded-lg">
                <button id="showAllPatients" class="patient-filter-btn flex-1 py-2 px-2 rounded-md text-sm font-medium bg-blue-500 text-white">
                    All (<span id="allCount">0</span>)
                </button>
                <button id="showActivePatients" class="patient-filter-btn flex-1 py-2 px-2 rounded-md text-sm font-medium text-gray-700">
                    Active (<span id="activeCount">0</span>)
                </button>
                <button id="showArchivedPatients" class="patient-filter-btn flex-1 py-2 px-2 rounded-md text-sm font-medium text-gray-700">
                    Archived (<span id="archivedCount">0</span>)
                </button>
            </div>
            <div id="patientListContainer" class="space-y-3">
                <!-- Patient cards will be injected here -->
            </div>
            <!-- Simplified Mobile FAB -->
            <div class="fixed bottom-6 right-6 z-40">
                <!-- Main Add Patient Button - Single Essential Button -->
                <button id="addPatientBtn" class="w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center transition-all duration-200 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Add/Edit Patient View -->
        <div id="patientFormView" class="view">
            <h2 class="text-xl font-bold mb-4" id="patientFormTitle">Add New Patient</h2>
            <form id="patientForm" class="bg-white p-4 sm:p-6 rounded-lg shadow-md space-y-6">
                <input type="hidden" id="patientId">
                
                <!-- Patient ID Display -->
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="block text-sm font-medium text-blue-700">Patient ID</label>
                            <div id="displayPatientId" class="text-lg font-bold text-blue-900">Will be generated automatically</div>
                        </div>
                        <div class="text-blue-600">
                            <i data-lucide="id-card" class="w-6 h-6"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Basic Information -->
                <div class="border-b pb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Basic Information</h3>
                    <div class="space-y-4">
                        <!-- Indian Identity & Insurance Extensions -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="patientABHA" class="block text-sm font-medium text-gray-700">ABHA ID</label>
                                <input type="text" id="patientABHA" class="mt-1 block w-full p-3 border rounded-md" placeholder="XX-XXXX-XXXX-XXXX" pattern="[0-9A-Za-z\-]{6,20}">
                                <p class="text-xs text-gray-500 mt-1">Optional National Health ID</p>
                            </div>
                            <div>
                                <label for="patientAadhaar" class="block text-sm font-medium text-gray-700">Aadhaar (Last 4)</label>
                                <input type="text" id="patientAadhaar" class="mt-1 block w-full p-3 border rounded-md" maxlength="4" pattern="[0-9]{4}" placeholder="1234">
                                <p class="text-xs text-gray-500 mt-1">Store ONLY last 4 for privacy</p>
                            </div>
                            <div>
                                <label for="patientInsurance" class="block text-sm font-medium text-gray-700">Insurance</label>
                                <select id="patientInsurance" class="mt-1 block w-full p-3 border rounded-md">
                                    <option value="">None</option>
                                    <option value="Ayushman Bharat">Ayushman Bharat</option>
                                    <option value="CGHS">CGHS</option>
                                    <option value="ESIC">ESIC</option>
                                    <option value="Private">Private</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="patientName" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="patientName" class="mt-1 block w-full p-3 border rounded-md" required>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="patientDOB" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                                <input type="date" id="patientDOB" class="mt-1 block w-full p-3 border rounded-md" required>
                                <div class="mt-1 text-sm text-gray-600">
                                    <span>Age: </span>
                                    <span id="calculatedAge" class="font-medium">-</span>
                                    <span> years</span>
                                </div>
                                <input type="hidden" id="patientAge">
                            </div>
                            <div>
                                <label for="patientGender" class="block text-sm font-medium text-gray-700">Gender</label>
                                <select id="patientGender" class="mt-1 block w-full p-3 border rounded-md" required>
                                    <option value="">Select Gender</option>
                                    <option>Male</option>
                                    <option>Female</option>
                                    <option>Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="patientContact" class="block text-sm font-medium text-gray-700">Contact Number</label>
                                <input type="tel" id="patientContact" class="mt-1 block w-full p-3 border rounded-md">
                                <p class="text-xs text-gray-500 mt-1">Format: 10-digit Indian mobile</p>
                            </div>
                            <div>
                                <label for="patientEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                                <input type="email" id="patientEmail" class="mt-1 block w-full p-3 border rounded-md">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="patientBloodGroup" class="block text-sm font-medium text-gray-700">Blood Group</label>
                                <select id="patientBloodGroup" class="mt-1 block w-full p-3 border rounded-md">
                                    <option value="">Select</option>
                                    <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                                    <option>O+</option><option>O-</option><option>AB+</option><option>AB-</option>
                                </select>
                            </div>
                            <div>
                                <label for="patientOrganDonor" class="block text-sm font-medium text-gray-700">Organ Donor</label>
                                <select id="patientOrganDonor" class="mt-1 block w-full p-3 border rounded-md">
                                    <option value="">Unknown</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                            <div>
                                <label for="patientLanguages" class="block text-sm font-medium text-gray-700">Languages</label>
                                <input type="text" id="patientLanguages" class="mt-1 block w-full p-3 border rounded-md" placeholder="English, Hindi">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label for="patientPIN" class="block text-sm font-medium text-gray-700">PIN Code</label>
                                <input type="text" id="patientPIN" class="mt-1 block w-full p-3 border rounded-md" maxlength="6" pattern="[0-9]{6}" placeholder="700001">
                            </div>
                            <div>
                                <label for="patientCity" class="block text-sm font-medium text-gray-700">City/Town</label>
                                <input type="text" id="patientCity" class="mt-1 block w-full p-3 border rounded-md">
                            </div>
                            <div>
                                <label for="patientState" class="block text-sm font-medium text-gray-700">State</label>
                                <select id="patientState" class="mt-1 block w-full p-3 border rounded-md">
                                    <option value="">Select</option>
                                    <option>Andhra Pradesh</option><option>Arunachal Pradesh</option><option>Assam</option><option>Bihar</option><option>Chhattisgarh</option><option>Delhi</option><option>Goa</option><option>Gujarat</option><option>Haryana</option><option>Himachal Pradesh</option><option>Jharkhand</option><option>Karnataka</option><option>Kerala</option><option>Madhya Pradesh</option><option>Maharashtra</option><option>Manipur</option><option>Meghalaya</option><option>Mizoram</option><option>Nagaland</option><option>Odisha</option><option>Punjab</option><option>Rajasthan</option><option>Sikkim</option><option>Tamil Nadu</option><option>Telangana</option><option>Tripura</option><option>Uttar Pradesh</option><option>Uttarakhand</option><option>West Bengal</option>
                                </select>
                            </div>
                            <div>
                                <label for="patientOccupation" class="block text-sm font-medium text-gray-700">Occupation</label>
                                <input type="text" id="patientOccupation" class="mt-1 block w-full p-3 border rounded-md" placeholder="Teacher, Farmer, IT...">
                            </div>
                        </div>
                        <div>
                            <label for="patientAddress" class="block text-sm font-medium text-gray-700">Address</label>
                            <textarea id="patientAddress" rows="2" class="mt-1 block w-full p-3 border rounded-md"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="patientEmergencyContact" class="block text-sm font-medium text-gray-700">Emergency Contact</label>
                                <input type="text" id="patientEmergencyContact" class="mt-1 block w-full p-3 border rounded-md" placeholder="Name - Relation - Phone">
                            </div>
                            <div>
                                <label for="patientChronicFlags" class="block text-sm font-medium text-gray-700">Chronic Conditions</label>
                                <div class="mt-1 grid grid-cols-2 gap-1 text-xs">
                                    <label class="flex items-center space-x-1"><input type="checkbox" value="Diabetes" class="chronic-flag"> <span>Diabetes</span></label>
                                    <label class="flex items-center space-x-1"><input type="checkbox" value="Hypertension" class="chronic-flag"> <span>Hypertension</span></label>
                                    <label class="flex items-center space-x-1"><input type="checkbox" value="CKD" class="chronic-flag"> <span>CKD</span></label>
                                    <label class="flex items-center space-x-1"><input type="checkbox" value="TB" class="chronic-flag"> <span>TB</span></label>
                                    <label class="flex items-center space-x-1"><input type="checkbox" value="Thyroid" class="chronic-flag"> <span>Thyroid</span></label>
                                    <label class="flex items-center space-x-1"><input type="checkbox" value="Asthma/COPD" class="chronic-flag"> <span>Asthma/COPD</span></label>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="patientDiet" class="block text-sm font-medium text-gray-700">Diet Pattern</label>
                            <select id="patientDiet" class="mt-1 block w-full p-3 border rounded-md">
                                <option value="">Select</option>
                                <option>Vegetarian</option>
                                <option>Eggetarian</option>
                                <option>Non-Vegetarian</option>
                                <option>Vegan</option>
                            </select>
                        </div>
                        <div>
                            <label for="patientTobacco" class="block text-sm font-medium text-gray-700">Tobacco Use</label>
                            <select id="patientTobacco" class="mt-1 block w-full p-3 border rounded-md">
                                <option value="">Select</option>
                                <option>None</option>
                                <option>Chewing</option>
                                <option>Smoking</option>
                                <option>Both</option>
                                <option>Former User</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Current Vitals -->
                <div class="border-b pb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Current Vitals</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="patientHeight" class="block text-sm font-medium text-gray-700">Height (cm)</label>
                            <input type="number" id="patientHeight" class="mt-1 block w-full p-3 border rounded-md" step="0.1" min="50" max="250">
                        </div>
                        <div>
                            <label for="patientWeight" class="block text-sm font-medium text-gray-700">Weight (kg)</label>
                            <input type="number" id="patientWeight" class="mt-1 block w-full p-3 border rounded-md" step="0.1" min="5" max="300">
                        </div>
                        <div>
                            <label for="patientBP" class="block text-sm font-medium text-gray-700">Blood Pressure</label>
                            <input type="text" id="patientBP" class="mt-1 block w-full p-3 border rounded-md" placeholder="120/80">
                        </div>
                        <div>
                            <label for="patientTemp" class="block text-sm font-medium text-gray-700">Temperature (F)</label>
                            <input type="number" id="patientTemp" class="mt-1 block w-full p-3 border rounded-md" step="0.1" min="90" max="110">
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        <span id="bmiDisplay"></span>
                    </div>
                </div>

                <!-- Medical History -->
                <div class="border-b pb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Medical History</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="medicalHistory" class="block text-sm font-medium text-gray-700">Past Medical History</label>
                            <textarea id="medicalHistory" rows="3" class="mt-1 block w-full p-3 border rounded-md" placeholder="Diabetes, Hypertension, Heart disease, etc."></textarea>
                        </div>
                        <div>
                            <label for="surgicalHistory" class="block text-sm font-medium text-gray-700">Surgical History</label>
                            <textarea id="surgicalHistory" rows="3" class="mt-1 block w-full p-3 border rounded-md" placeholder="Previous surgeries, procedures, dates..."></textarea>
                        </div>
                        <div>
                            <label for="medicationHistory" class="block text-sm font-medium text-gray-700">Current Medications</label>
                            <textarea id="medicationHistory" rows="3" class="mt-1 block w-full p-3 border rounded-md" placeholder="Regular medications, dosages..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Allergies -->
                <div class="border-b pb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Allergies & Restrictions</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="drugAllergies" class="block text-sm font-medium text-gray-700">Drug Allergies</label>
                            <textarea id="drugAllergies" rows="2" class="mt-1 block w-full p-3 border rounded-md" placeholder="Penicillin, Aspirin, etc."></textarea>
                        </div>
                        <div>
                            <label for="foodAllergies" class="block text-sm font-medium text-gray-700">Food Allergies/Dietary Restrictions</label>
                            <textarea id="foodAllergies" rows="2" class="mt-1 block w-full p-3 border rounded-md" placeholder="Nuts, Shellfish, Lactose intolerance, etc."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Personal & Lifestyle History -->
                <div class="border-b pb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Personal & Lifestyle History</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="smokingHistory" class="block text-sm font-medium text-gray-700">Smoking History</label>
                                <select id="smokingHistory" class="mt-1 block w-full p-3 border rounded-md">
                                    <option value="">Select</option>
                                    <option>Never smoked</option>
                                    <option>Ex-smoker</option>
                                    <option>Current smoker</option>
                                </select>
                            </div>
                            <div>
                                <label for="alcoholHistory" class="block text-sm font-medium text-gray-700">Alcohol History</label>
                                <select id="alcoholHistory" class="mt-1 block w-full p-3 border rounded-md">
                                    <option value="">Select</option>
                                    <option>Non-drinker</option>
                                    <option>Occasional</option>
                                    <option>Regular</option>
                                    <option>Heavy</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="exerciseHabits" class="block text-sm font-medium text-gray-700">Exercise & Physical Activity</label>
                            <textarea id="exerciseHabits" rows="2" class="mt-1 block w-full p-2 border rounded-md" placeholder="Regular walking, gym, yoga, etc."></textarea>
                        </div>
                        <div>
                            <label for="occupationalHistory" class="block text-sm font-medium text-gray-700">Occupational & Environmental History</label>
                            <textarea id="occupationalHistory" rows="2" class="mt-1 block w-full p-2 border rounded-md" placeholder="Job, workplace exposures, environmental factors..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Gynecological & Obstetric History (for female patients) -->
                <div class="border-b pb-4" id="gynecologicalSection" style="display: none;">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Gynecological & Obstetric History</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="menarche" class="block text-sm font-medium text-gray-700">Age at Menarche</label>
                                <input type="number" id="menarche" class="mt-1 block w-full p-3 border rounded-md" min="8" max="18">
                            </div>
                            <div>
                                <label for="menstrualCycle" class="block text-sm font-medium text-gray-700">Cycle Length (days)</label>
                                <input type="number" id="menstrualCycle" class="mt-1 block w-full p-3 border rounded-md" min="21" max="35">
                            </div>
                            <div>
                                <label for="lastMenstrualPeriod" class="block text-sm font-medium text-gray-700">Last Menstrual Period</label>
                                <input type="date" id="lastMenstrualPeriod" class="mt-1 block w-full p-3 border rounded-md">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <div>
                                <label for="gravida" class="block text-sm font-medium text-gray-700">Gravida (G)</label>
                                <input type="number" id="gravida" class="mt-1 block w-full p-3 border rounded-md" min="0">
                            </div>
                            <div>
                                <label for="para" class="block text-sm font-medium text-gray-700">Para (P)</label>
                                <input type="number" id="para" class="mt-1 block w-full p-3 border rounded-md" min="0">
                            </div>
                            <div>
                                <label for="abortions" class="block text-sm font-medium text-gray-700">Abortions (A)</label>
                                <input type="number" id="abortions" class="mt-1 block w-full p-3 border rounded-md" min="0">
                            </div>
                            <div>
                                <label for="living" class="block text-sm font-medium text-gray-700">Living (L)</label>
                                <input type="number" id="living" class="mt-1 block w-full p-3 border rounded-md" min="0">
                            </div>
                        </div>
                        <div>
                            <label for="contraceptiveHistory" class="block text-sm font-medium text-gray-700">Contraceptive History</label>
                            <textarea id="contraceptiveHistory" rows="2" class="mt-1 block w-full p-2 border rounded-md" placeholder="OCP, IUCD, Condoms, etc."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Family Medical History -->
                <div class="border-b pb-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Family Medical History</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="familyHistory" class="block text-sm font-medium text-gray-700">Family History of Diseases</label>
                            <textarea id="familyHistory" rows="3" class="mt-1 block w-full p-2 border rounded-md" placeholder="Diabetes, Heart disease, Cancer, Hypertension in family members..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 pt-4">
                    <button type="button" id="cancelPatientForm" class="bg-gray-200 px-4 py-3 rounded-lg">Cancel</button>
                    <button type="submit" class="btn-primary px-4 py-3 rounded-lg">Save Patient</button>
                </div>
            </form>
        </div>

        <!-- Patient Detail View -->
        <div id="patientDetailView" class="view">
            <button id="backToPatientList" class="flex items-center space-x-2 text-blue-500 mb-4">
                <i data-lucide="arrow-left"></i>
                <span>All Patients</span>
            </button>
            
            <!-- Patient Header Card -->
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                    <div class="flex-1 min-w-0">
                        <h2 id="detailPatientName" class="text-xl sm:text-2xl font-bold text-gray-800"></h2>
                        <p id="detailPatientInfo" class="text-gray-600"></p>
                        <div id="detailPatientVitals" class="mt-2 text-sm text-gray-600"></div>
                    </div>
                    <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                        <button id="viewPatientProfileBtn" class="flex-1 sm:flex-none text-sm bg-blue-100 text-blue-600 px-3 py-2 rounded hover:bg-blue-200 min-h-[44px]">
                            <i data-lucide="user" class="w-4 h-4 inline mr-1"></i>
                            <span class="hidden sm:inline">View </span>Profile
                        </button>
                        <button id="addVitalsBtn" class="flex-1 sm:flex-none text-sm bg-green-100 text-green-600 px-3 py-2 rounded hover:bg-green-200 min-h-[44px]">
                            <i data-lucide="activity" class="w-4 h-4 inline mr-1"></i>
                            <span class="hidden sm:inline">Record </span>Vitals
                        </button>
                        <button id="uploadTestResultBtn" class="flex-1 sm:flex-none text-sm bg-purple-100 text-purple-600 px-3 py-2 rounded hover:bg-purple-200 min-h-[44px]">
                            <i data-lucide="upload" class="w-4 h-4 inline mr-1"></i>
                            <span class="hidden sm:inline">Upload </span>Test
                        </button>
                        <button id="generateAIReportBtn" class="flex-1 sm:flex-none text-sm bg-gradient-to-r from-purple-500 to-blue-500 text-white px-3 py-2 rounded hover:from-purple-600 hover:to-blue-600 min-h-[44px]">
                            <i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i>
                            Summary
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabs for different sections -->
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="border-b overflow-x-auto">
                    <nav class="flex space-x-4 sm:space-x-8 px-4 sm:px-6 min-w-max">
                        <button class="patient-tab-btn py-3 border-b-2 border-blue-500 text-blue-600 font-medium whitespace-nowrap" data-tab="consultations">
                            <i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i>
                            <span class="hidden sm:inline">Consultations</span>
                            <span class="sm:hidden">Consult</span>
                        </button>
                        <button class="patient-tab-btn py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="vitals">
                            <i data-lucide="activity" class="w-4 h-4 inline mr-1"></i>
                            <span class="hidden sm:inline">Vitals History</span>
                            <span class="sm:hidden">Vitals</span>
                        </button>
                        <button class="patient-tab-btn py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="tests">
                            <i data-lucide="folder-open" class="w-4 h-4 inline mr-1"></i>
                            <span class="hidden sm:inline">Test Results</span>
                            <span class="sm:hidden">Tests</span>
                        </button>
                        <button class="patient-tab-btn py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="certificates">
                            <i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i>
                            <span class="hidden sm:inline">Medical Certificates</span>
                            <span class="sm:hidden">Certificates</span>
                        </button>
                    </nav>
                </div>

                <!-- Consultations Tab -->
                <div id="consultationsTab" class="patient-tab-content p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Consultation History</h3>
                    <div id="consultationList" class="space-y-3">
                        <!-- Consultation history goes here -->
                    </div>
                </div>

                <!-- Vitals History Tab -->
                <div id="vitalsTab" class="patient-tab-content p-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Vitals History</h3>
                    <div id="vitalsHistory" class="space-y-3">
                        <!-- Vitals history goes here -->
                    </div>
                </div>

                <!-- Test Results Tab -->
                <div id="testsTab" class="patient-tab-content p-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Test Results & Documents</h3>
                    <div id="testResults" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Test results will be displayed here -->
                    </div>
                </div>

                <!-- Medical Certificates Tab -->
                <div id="certificatesTab" class="patient-tab-content p-6 hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <h3 class="text-lg font-semibold text-gray-700">Medical Leave Certificates</h3>
                        <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                            <button id="autoGenerateCertBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                                <i data-lucide="zap" class="w-4 h-4"></i>
                                <span>Auto Generate</span>
                            </button>
                            <button id="createCertificateBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center space-x-2">
                                <i data-lucide="file-plus" class="w-4 h-4"></i>
                                <span>Create Manual</span>
                            </button>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-blue-600">Total Certificates</p>
                                    <p id="totalCertificates" class="text-2xl font-bold text-blue-800">0</p>
                                </div>
                                <i data-lucide="file-text" class="w-8 h-8 text-blue-400"></i>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-green-600">This Month</p>
                                    <p id="monthCertificates" class="text-2xl font-bold text-green-800">0</p>
                                </div>
                                <i data-lucide="calendar" class="w-8 h-8 text-green-400"></i>
                            </div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-purple-600">Available Consultations</p>
                                    <p id="availableConsultations" class="text-2xl font-bold text-purple-800">0</p>
                                </div>
                                <i data-lucide="stethoscope" class="w-8 h-8 text-purple-400"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Certificate List -->
                    <div id="certificatesList" class="space-y-4">
                        <!-- Certificates will be displayed here -->
                    </div>

                    <!-- Empty State -->
                    <div id="certificatesEmptyState" class="text-center py-12 text-gray-500">
                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                        <p class="text-lg font-medium">No medical certificates issued yet</p>
                        <p class="text-sm">Create your first medical leave certificate for this patient</p>
                    </div>
                </div>
            </div>

            <button id="addConsultationBtn" class="floating-btn bg-gradient-to-r from-emerald-500 to-emerald-600 text-white p-4 rounded-full shadow-2xl hover:shadow-xl hover:from-emerald-600 hover:to-emerald-700 transition-all duration-300 transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="12" y1="18" x2="12" y2="12"/>
                    <line x1="9" y1="15" x2="15" y2="15"/>
                </svg>
            </button>
        </div>

        <!-- Consultation Form View -->
        <div id="consultationFormView" class="view">
             <button id="backToPatientDetail" class="flex items-center space-x-2 text-blue-500 mb-4">
                <i data-lucide="arrow-left"></i>
                <span id="backToPatientDetailName">Back to Patient</span>
            </button>
            <h2 class="text-xl font-bold mb-4">New Consultation / Prescription</h2>
            <form id="consultationForm" class="bg-white p-6 rounded-lg shadow-md space-y-4">
                <input type="hidden" id="consultationPatientId">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Chief Complaint(s)</label>
                    <div class="relative">
                        <textarea id="chiefComplaint" rows="2" class="mt-1 block w-full p-2 border rounded-md pr-10"></textarea>
                        <button type="button" id="aiComplaintBtn" class="absolute top-2 right-2 text-blue-500 hover:text-blue-700" title="AI Suggestions">
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Diagnosis</label>
                    <div class="relative">
                        <textarea id="diagnosis" rows="2" class="mt-1 block w-full p-2 border rounded-md pr-10" required></textarea>
                        <button type="button" id="aiDiagnosisBtn" class="absolute top-2 right-2 text-blue-500 hover:text-blue-700" title="AI Diagnosis Assistant">
                            <i data-lucide="brain" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Tests/Investigations</label>
                    <div class="relative">
                        <textarea id="investigations" rows="2" class="mt-1 block w-full p-2 border rounded-md pr-10" placeholder="Blood tests, imaging, or other investigations..."></textarea>
                        <button type="button" id="aiInvestigationBtn" class="absolute top-2 right-2 text-blue-500 hover:text-blue-700" title="AI Test Suggestions">
                            <i data-lucide="flask-conical" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <div id="medicationsContainer">
                    <div class="flex justify-between items-center">
                        <label class="block text-sm font-medium text-gray-700">Medications (Rx)</label>
                        <div class="flex space-x-2">
                            <button type="button" id="aiMedicationBtn" class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded hover:bg-purple-200 flex items-center space-x-1" title="AI Medication Suggestions">
                                <i data-lucide="sparkles" class="w-3 h-3"></i>
                                <span>AI Suggest</span>
                            </button>
                        </div>
                    </div>
                    <!-- Medication fields will be added here -->
                </div>
                <button type="button" id="addMedicationBtn" class="text-sm text-blue-600 hover:underline flex items-center space-x-1">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                    <span>Add Medication</span>
                </button>
                <div>
                    <label class="block text-sm font-medium text-gray-700">General Advice</label>
                    <div class="relative">
                        <textarea id="advice" rows="2" class="mt-1 block w-full p-2 border rounded-md pr-10"></textarea>
                        <button type="button" id="aiAdviceBtn" class="absolute top-2 right-2 text-blue-500 hover:text-blue-700" title="AI Advice Generator">
                            <i data-lucide="lightbulb" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Next Follow-up</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <select id="followUpType" class="p-3 border rounded-md">
                            <option value="">Select Type</option>
                            <option value="days">Days</option>
                            <option value="weeks">Weeks</option>
                            <option value="months">Months</option>
                            <option value="custom">Custom</option>
                        </select>
                        <input type="text" id="followUpValue" placeholder="Enter value or custom text" 
                               class="p-3 border rounded-md">
                    </div>
                    <input type="hidden" id="followUp">
                </div>
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 pt-4">
                    <button type="button" id="cancelConsultationForm" class="bg-gray-200 px-4 py-3 rounded-lg">Cancel</button>
                    <button type="submit" class="btn-primary px-4 py-3 rounded-lg">Generate Prescription</button>
                </div>
            </form>
        </div>

        <!-- Prescription Display View -->
        <div id="prescriptionDisplayView" class="view">
            <button id="backToPatientDetailFromRx" class="no-print flex items-center space-x-2 text-blue-500 mb-4">
                <i data-lucide="arrow-left"></i>
                <span>Back to Patient Details</span>
            </button>
            <div id="prescriptionContent" class="prescription-paper">
                <!-- Prescription content will be injected here -->
            </div>
            <div class="no-print mt-6 flex flex-col sm:flex-row justify-center gap-2 sm:gap-4 px-2 sm:px-0">
                <button id="signPrescriptionBtn" class="flex items-center justify-center space-x-2 bg-purple-600 text-white px-4 py-3 rounded-lg shadow-md hover:bg-purple-700 min-h-[48px]">
                    <i data-lucide="pen-tool"></i>
                    <span class="text-sm sm:text-base">Add Digital Signature</span>
                </button>
                <button id="viewPrescriptionBtn" class="flex items-center justify-center space-x-2 bg-blue-600 text-white px-4 py-3 rounded-lg shadow-md hover:bg-blue-700 min-h-[48px]">
                    <i data-lucide="eye"></i>
                    <span class="text-sm sm:text-base">View Prescription</span>
                </button>
                <button id="shareWhatsappBtn" class="flex items-center justify-center space-x-2 btn-secondary px-4 py-3 rounded-lg shadow-md min-h-[48px]">
                    <i data-lucide="share-2"></i>
                    <span class="text-sm sm:text-base">Share & Print</span>
                </button>
                 <button id="printBtn" class="flex items-center justify-center space-x-2 bg-gray-600 text-white px-4 py-3 rounded-lg shadow-md min-h-[48px]">
                    <i data-lucide="printer"></i>
                    <span class="text-sm sm:text-base">Quick Print</span>
                </button>
                <button id="downloadPdfBtn" class="flex items-center justify-center space-x-2 bg-red-600 text-white px-4 py-3 rounded-lg shadow-md hover:bg-red-700 min-h-[48px]">
                    <i data-lucide="download"></i>
                    <span class="text-sm sm:text-base">Download PDF</span>
                </button>
                <button id="verifyPrescriptionBtn" class="flex items-center justify-center space-x-2 bg-indigo-600 text-white px-4 py-3 rounded-lg shadow-md hover:bg-indigo-700 min-h-[48px]">
                    <i data-lucide="shield-check"></i>
                    <span class="text-sm sm:text-base">Verify Authenticity</span>
                </button>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settingsView" class="view">
            <button id="backToPatientListFromSettings" class="flex items-center space-x-2 text-blue-500 mb-4">
                <i data-lucide="arrow-left"></i>
                <span>Back to Patients</span>
            </button>
            <h2 class="text-xl font-bold mb-4">Doctor's Profile</h2>
            <form id="settingsForm" class="bg-white p-4 sm:p-6 rounded-lg shadow-md space-y-4">
                <div>
                    <label for="doctorName" class="block text-sm font-medium text-gray-700">Doctor's Name</label>
                    <input type="text" id="doctorName" class="mt-1 block w-full p-3 border rounded-md" required>
                </div>
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700">Title/Designation</label>
                    <input type="text" id="title" class="mt-1 block w-full p-3 border rounded-md" placeholder="e.g., MBBS, MD (Internal Medicine)">
                </div>
                <div>
                    <label for="specializations" class="block text-sm font-medium text-gray-700">Specializations</label>
                    <input type="text" id="specializations" class="mt-1 block w-full p-3 border rounded-md" placeholder="e.g., General Medicine, Family Medicine, Cardiology">
                </div>
                <div>
                    <label for="qualifications" class="block text-sm font-medium text-gray-700">Qualifications</label>
                    <input type="text" id="qualifications" class="mt-1 block w-full p-3 border rounded-md" placeholder="e.g., MBBS, MD (General Medicine), DNB">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="mobile" class="block text-sm font-medium text-gray-700">Mobile Number</label>
                        <input type="tel" id="mobile" class="mt-1 block w-full p-3 border rounded-md" placeholder="e.g., +91-98307 77190">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="email" class="mt-1 block w-full p-3 border rounded-md" placeholder="e.g., doctor@example.com">
                    </div>
                </div>
                <div>
                    <label for="regNumber" class="block text-sm font-medium text-gray-700">Registration Number</label>
                    <input type="text" id="regNumber" class="mt-1 block w-full p-3 border rounded-md" placeholder="e.g., WBMC 71600">
                </div>
                 <div>
                    <label for="clinicInfo" class="block text-sm font-medium text-gray-700">Clinic Name & Address</label>
                    <textarea id="clinicInfo" rows="3" class="mt-1 block w-full p-3 border rounded-md"></textarea>
                </div>
                
                <!-- Data Management Section -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Digital Signature Setup</h3>
                    <div class="space-y-4">
                        <div id="signatureSetupSection">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">Secure Digital Signature</h4>
                                <p class="text-sm text-blue-600 mb-3">Set up your digital signature for quick and easy prescription signing.</p>
                                
                                <div class="space-y-3">
                                    <!-- PIN Section - Now Optional -->
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <label class="flex items-center space-x-2 text-sm font-medium text-gray-700">
                                                <input type="checkbox" id="enablePinProtection" class="rounded">
                                                <span>Enable PIN Protection (Optional)</span>
                                            </label>
                                            <i data-lucide="info" class="w-4 h-4 text-blue-500" title="PIN protection adds an extra layer of security"></i>
                                        </div>
                                        <p class="text-xs text-gray-600 mb-3">PIN protection is optional. You can sign prescriptions with just one click when disabled.</p>
                                        
                                        <div id="pinSetupSection" class="space-y-2 hidden">
                                            <div>
                                                <input type="password" id="signaturePin" class="block w-full p-2 border rounded-md text-sm" 
                                                       placeholder="Enter 4-6 digit PIN" maxlength="6" minlength="4">
                                            </div>
                                            <div>
                                                <input type="password" id="confirmSignaturePin" class="block w-full p-2 border rounded-md text-sm" 
                                                       placeholder="Confirm PIN" maxlength="6" minlength="4">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Signature Style</label>
                                        <div class="grid grid-cols-1 gap-2">
                                            <button type="button" id="typeSignatureBtn" class="bg-indigo-500 text-white px-4 py-3 rounded hover:bg-indigo-600">
                                                <i data-lucide="type" class="w-4 h-4 inline mr-2"></i>
                                                Type Digital Signature
                                            </button>
                                            <button type="button" id="drawSignatureBtn" class="bg-blue-500 text-white px-4 py-3 rounded hover:bg-blue-600">
                                                <i data-lucide="edit-3" class="w-4 h-4 inline mr-2"></i>
                                                Draw Digital Signature
                                            </button>
                                            <button type="button" id="uploadSignatureBtn" class="bg-green-500 text-white px-4 py-3 rounded hover:bg-green-600">
                                                <i data-lucide="upload" class="w-4 h-4 inline mr-2"></i>
                                                Upload Signature Image
                                            </button>
                                        </div>
                                        <input type="file" id="signatureImageInput" accept="image/*" style="display: none;">
                                    </div>
                                    
                                    <div id="signaturePreview" class="hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Signature Preview</label>
                                        <div class="border rounded-lg p-4 bg-white">
                                            <img id="signatureImage" class="max-h-20 mx-auto" />
                                        </div>
                                    </div>
                                    
                                    <button type="button" id="saveSignatureBtn" class="w-full bg-purple-500 text-white px-4 py-3 rounded hover:bg-purple-600 disabled:bg-gray-300" disabled>
                                        <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                                        Save Digital Signature Setup
                                    </button>
                                </div>
                            </div>
                            
                            <div id="signatureStatus" class="mt-4 hidden">
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <div class="flex items-center">
                                        <i data-lucide="shield-check" class="w-5 h-5 text-green-600 mr-2"></i>
                                        <span class="text-green-800 font-medium">Digital Signature Configured</span>
                                    </div>
                                    <p class="text-sm text-green-600 mt-1">Your digital signature is now protected with PIN authentication.</p>
                                    <button type="button" id="resetSignatureBtn" class="mt-2 text-xs bg-red-100 text-red-600 px-3 py-1 rounded hover:bg-red-200">
                                        Reset Signature Setup
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Management Section -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Data Management</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button type="button" id="exportDataBtn" class="bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600">
                            <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                            Export Data
                        </button>
                        <button type="button" id="importDataBtn" class="bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600">
                            <i data-lucide="upload" class="w-4 h-4 inline mr-2"></i>
                            Import Data
                        </button>
                    </div>
                    <input type="file" id="importFileInput" accept=".json" style="display: none;">
                    <div class="mt-4 text-sm text-gray-600 space-y-2">
                        <p><strong>Storage Info:</strong></p>
                        <p id="storageInfo">Loading...</p>
                        <button type="button" id="clearDataBtn" class="text-red-500 hover:text-red-700 text-sm">
                            Clear All Data ( Cannot be undone)
                        </button>
                    </div>
                </div>
                
                <!-- AI Configuration Section -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                        <i data-lucide="brain" class="w-5 h-5 mr-2 text-purple-600"></i>
                        AI Configuration
                    </h3>
                    <div class="space-y-4">
                        <!-- AI Provider Info -->
                        <div class="mb-4">
                            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                <div class="flex items-center mb-2">
                                    <i data-lucide="brain" class="w-5 h-5 mr-2 text-blue-600"></i>
                                    <h4 class="font-semibold text-blue-800">Powered by Google Gemini API</h4>
                                </div>
                                <p class="text-blue-700 text-sm">
                                    This application uses Google's latest Gemini AI models for medical assistance and diagnosis support.
                                </p>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <p class="text-sm text-purple-700 mb-3">
                                Configure your Google Gemini API key to enable advanced AI features for medical assistance and diagnosis support.
                            </p>
                            
                            <div class="bg-yellow-50 border border-yellow-200 p-3 rounded mb-4">
                                <div class="flex items-start">
                                    <i data-lucide="alert-triangle" class="w-4 h-4 text-yellow-600 mr-2 mt-0.5 flex-shrink-0"></i>
                                    <div class="text-xs text-yellow-800">
                                        <strong>Running locally?</strong> You may encounter CORS restrictions. 
                                        <a href="#" onclick="showCORSHelp()" class="text-blue-600 hover:underline">Click here for solutions</a>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label for="geminiApiKey" class="block text-sm font-medium text-gray-700 mb-2">
                                        Gemini API Key
                                    </label>
                                    <input type="password" id="geminiApiKey" class="w-full p-3 border rounded-md" 
                                           placeholder="AIza...">
                                    <p class="text-xs text-gray-500 mt-1">
                                        Get your API key from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-500 hover:underline">Google AI Studio</a>
                                    </p>
                                </div>
                                
                                <div>
                                    <label for="geminiModel" class="block text-sm font-medium text-gray-700 mb-2">
                                        Gemini Model
                                    </label>
                                    <select id="geminiModel" class="w-full p-3 border rounded-md">
                                        <option value="gemini-2.5-pro">gemini-2.5-pro ( Most Advanced - Complex Reasoning)</option>
                                        <option value="gemini-2.5-flash" selected>gemini-2.5-flash ( Recommended - Best Performance)</option>
                                        <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite ( Ultra Fast - Cost Efficient)</option>
                                        <option value="gemini-2.0-flash">gemini-2.0-flash ( Previous Gen - Stable)</option>
                                        <option value="gemini-2.0-flash-lite">gemini-2.0-flash-lite ( Lightweight - Fast)</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">
                                        Choose the Gemini model - 2.5 Flash is recommended for best performance
                                    </p>
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="aiEnabled" class="w-4 h-4 text-purple-600 rounded">
                                    <label for="aiEnabled" class="text-sm font-medium text-gray-700">
                                        Enable AI Features
                                    </label>
                                </div>
                                
                                <div id="aiStatus" class="text-sm">
                                    <div class="flex items-center space-x-2">
                                        <div id="aiStatusIndicator" class="w-2 h-2 rounded-full bg-gray-400"></div>
                                        <span id="aiStatusText" class="text-gray-600">AI features disabled</span>
                                    </div>
                                </div>
                                
                                <div class="flex space-x-2 flex-wrap gap-2">
                                    <button type="button" id="testAIConnection" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 text-sm">
                                        Test AI Connection
                                    </button>
                                    <button type="button" id="testDiagnosisAI" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 text-sm">
                                        Test Diagnosis AI
                                    </button>
                                    <button type="button" id="debugAIConfig" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm">
                                        Debug Config
                                    </button>
                                    <button type="button" id="debugDiagnosisAI" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 text-sm">
                                        Debug Diagnosis
                                    </button>
                                </div>
                                
                                <div id="apiTestResults" class="mt-3 text-sm hidden">
                                    <div class="bg-gray-50 p-3 rounded border">
                                        <div class="font-medium mb-2">API Test Results:</div>
                                        <div id="apiTestStatus" class="mb-2 text-sm"></div>
                                        <div id="apiTestOutput" class="text-xs font-mono"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- GitHub Sync Section -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                        <i data-lucide="github" class="w-5 h-5 mr-2 text-gray-800"></i>
                        GitHub Data Sync
                    </h3>
                    <div class="space-y-4">
                        <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i data-lucide="cloud" class="w-5 h-5 mr-2 text-gray-600"></i>
                                <h4 class="font-semibold text-gray-800">Cloud Backup & Sync</h4>
                            </div>
                            <p class="text-gray-700 text-sm mb-4">
                                Automatically backup your patient records, consultations, and medical data to a private GitHub repository for secure cloud storage and cross-device access.
                            </p>
                            
                            <div class="bg-yellow-50 border border-yellow-200 p-3 rounded mb-4">
                                <div class="flex items-start">
                                    <i data-lucide="shield" class="w-4 h-4 text-yellow-600 mr-2 mt-0.5 flex-shrink-0"></i>
                                    <div class="text-xs text-yellow-800">
                                        <strong>Security Note:</strong> Use a private GitHub repository. Data is encrypted before upload. Never share your personal access token.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label for="githubToken" class="block text-sm font-medium text-gray-700 mb-2">
                                        GitHub Personal Access Token
                                    </label>
                                    <input type="password" id="githubToken" class="w-full p-3 border rounded-md" 
                                           placeholder="ghp_...">
                                    <p class="text-xs text-gray-500 mt-1">
                                        Create a token at <a href="https://github.com/settings/tokens" target="_blank" class="text-blue-500 hover:underline">GitHub Settings  Developer settings  Personal access tokens</a>
                                        <br>Required scopes: <code class="bg-gray-100 px-1 rounded">repo</code>
                                    </p>
                                </div>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="githubUsername" class="block text-sm font-medium text-gray-700 mb-2">
                                            GitHub Username
                                        </label>
                                        <input type="text" id="githubUsername" class="w-full p-3 border rounded-md" 
                                               placeholder="your-username">
                                    </div>
                                    <div>
                                        <label for="githubRepo" class="block text-sm font-medium text-gray-700 mb-2">
                                            Repository Name
                                        </label>
                                        <input type="text" id="githubRepo" class="w-full p-3 border rounded-md" 
                                               placeholder="medical-records-backup">
                                        <p class="text-xs text-gray-500 mt-1">Repository must be private</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="githubSyncEnabled" class="w-4 h-4 text-blue-600 rounded">
                                    <label for="githubSyncEnabled" class="text-sm font-medium text-gray-700">
                                        Enable Automatic GitHub Sync
                                    </label>
                                </div>
                                
                                <div id="githubStatus" class="text-sm">
                                    <div class="flex items-center space-x-2">
                                        <div id="githubStatusIndicator" class="w-2 h-2 rounded-full bg-gray-400"></div>
                                        <span id="githubStatusText" class="text-gray-600">GitHub sync disabled</span>
                                    </div>
                                </div>
                                
                                <div class="flex space-x-2 flex-wrap gap-2">
                                    <button type="button" id="testGitHubConnection" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 text-sm">
                                        Test Connection
                                    </button>
                                    <button type="button" id="syncToGitHub" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm">
                                        <i data-lucide="upload" class="w-4 h-4 inline mr-1"></i>
                                        Sync to GitHub
                                    </button>
                                    <button type="button" id="syncFromGitHub" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 text-sm">
                                        <i data-lucide="download" class="w-4 h-4 inline mr-1"></i>
                                        Sync from GitHub
                                    </button>
                                </div>
                                
                                <div id="githubTestResults" class="mt-3 text-sm hidden">
                                    <div class="bg-gray-50 p-3 rounded border">
                                        <div class="font-medium mb-2">GitHub Sync Results:</div>
                                        <div id="githubTestStatus" class="mb-2 text-sm"></div>
                                        <div id="githubTestOutput" class="text-xs font-mono"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end pt-4">
                    <button type="submit" class="btn-primary px-6 py-3 rounded-lg min-h-[44px]">Save Profile</button>
                </div>
            </form>
        </div>

        <!-- Digital Signature Modal -->
        <div id="signatureModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-4 sm:p-6 max-w-lg w-full mx-2 sm:mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Digital Signature Authentication</h3>
                    <button id="closeSignatureModal" class="text-gray-500 hover:text-gray-700 p-2">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="text-center mb-6">
                        <i data-lucide="pen-tool" class="w-16 h-16 text-purple-600 mx-auto mb-3"></i>
                        <h4 class="text-xl font-semibold text-gray-800 mb-2">Ready to Sign</h4>
                        <p class="text-gray-600 text-sm sm:text-base">Click "Sign Now" to add your digital signature to this prescription.</p>
                        
                        <!-- Optional: Show signature preview -->
                        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-500 mb-2">Your signature will appear as:</p>
                            <div class="border-dashed border-2 border-gray-300 p-2 bg-white rounded">
                                <div id="signaturePreview" class="text-center">
                                    <img src="${doctorProfile.digitalSignature || ''}" alt="Digital Signature Preview" 
                                         style="max-height: 40px; max-width: 150px; margin: 0 auto;" 
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <div style="display: none; color: #666; font-style: italic;">Dr. ${doctorProfile.name || 'Doctor'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden PIN input for legacy support -->
                    <input type="hidden" id="signaturePinInput" value="bypass">
                    <div id="pinError" class="text-red-500 text-sm mt-1 hidden">Authentication failed. Please try again.</div>
                    
                    <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3">
                        <button id="cancelSignature" class="bg-gray-200 px-6 py-3 rounded-lg hover:bg-gray-300 transition-colors">
                            <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>
                            Cancel
                        </button>
                        <button id="confirmSignature" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors shadow-lg">
                            <i data-lucide="pen-tool" class="w-4 h-4 inline mr-2"></i>
                            Sign Now
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signature Drawing Modal -->
        <div id="drawSignatureModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-4 sm:p-6 max-w-2xl w-full mx-2 sm:mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Draw Your Digital Signature</h3>
                    <button id="closeDrawModal" class="text-gray-500 hover:text-gray-700 p-2">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div class="border rounded-lg p-2 sm:p-4 bg-gray-50">
                        <canvas id="signatureCanvas" width="600" height="200" class="border bg-white cursor-crosshair rounded w-full max-w-full h-auto touch-none"></canvas>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between space-y-2 sm:space-y-0">
                        <button id="clearCanvas" class="bg-gray-200 px-4 py-3 rounded-lg">
                            <i data-lucide="eraser" class="w-4 h-4 inline mr-2"></i>
                            Clear
                        </button>
                        <div class="space-x-2">
                            <button id="cancelDraw" class="bg-gray-200 px-4 py-2 rounded-lg">Cancel</button>
                            <button id="saveDrawnSignature" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                                Save Signature
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 text-center">Draw your signature in the box above using your mouse or touchscreen</p>
                </div>
            </div>
        </div>

        <!-- Type Signature Modal -->
        <div id="typeSignatureModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-4 sm:p-6 max-w-2xl w-full mx-2 sm:mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Type Your Digital Signature</h3>
                    <button id="closeTypeModal" class="text-gray-500 hover:text-gray-700 p-2">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="signatureText" class="block text-sm font-medium text-gray-700 mb-2">Your Name/Signature Text</label>
                        <input type="text" id="signatureText" class="w-full p-3 border rounded-lg text-lg" 
                               placeholder="Enter your full name or preferred signature text">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Font Style</label>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                            <button type="button" class="font-style-btn p-3 border rounded-lg text-center hover:bg-blue-50 hover:border-blue-300" 
                                    data-font="Dancing Script" style="font-family: 'Dancing Script', cursive;">
                                Elegant Script
                            </button>
                            <button type="button" class="font-style-btn p-3 border rounded-lg text-center hover:bg-blue-50 hover:border-blue-300" 
                                    data-font="Allura" style="font-family: 'Allura', cursive;">
                                Flowing Script
                            </button>
                            <button type="button" class="font-style-btn p-3 border rounded-lg text-center hover:bg-blue-50 hover:border-blue-300" 
                                    data-font="Great Vibes" style="font-family: 'Great Vibes', cursive;">
                                Classic Script
                            </button>
                            <button type="button" class="font-style-btn p-3 border rounded-lg text-center hover:bg-blue-50 hover:border-blue-300" 
                                    data-font="Pacifico" style="font-family: 'Pacifico', cursive;">
                                Modern Casual
                            </button>
                            <button type="button" class="font-style-btn p-3 border rounded-lg text-center hover:bg-blue-50 hover:border-blue-300" 
                                    data-font="Sacramento" style="font-family: 'Sacramento', cursive;">
                                Professional
                            </button>
                            <button type="button" class="font-style-btn p-3 border rounded-lg text-center hover:bg-blue-50 hover:border-blue-300" 
                                    data-font="Kaushan Script" style="font-family: 'Kaushan Script', cursive;">
                                Bold Script
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Size</label>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="fontSize" value="24" class="mr-2">
                                <span class="text-sm">Small</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="fontSize" value="32" class="mr-2" checked>
                                <span class="text-sm">Medium</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="fontSize" value="40" class="mr-2">
                                <span class="text-sm">Large</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Preview</label>
                        <div class="border rounded-lg p-4 bg-gray-50 min-h-[100px] flex items-center justify-center">
                            <div id="signaturePreviewText" class="text-2xl" style="font-family: 'Dancing Script', cursive;">
                                Your signature will appear here
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-between space-y-2 sm:space-y-0">
                        <button id="cancelType" class="bg-gray-200 px-4 py-2 rounded-lg">Cancel</button>
                        <button id="saveTypedSignature" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600">
                            <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                            Save Signature
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 text-center">Choose your preferred font style and see the preview above</p>
                </div>
            </div>
        </div>

        <!-- Patient Profile Modal -->
        <div id="patientProfileModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-96 overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Complete Patient Profile</h3>
                    <button id="closeProfileModal" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="patientProfileContent">
                    <!-- Patient profile content will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Vitals Recording Modal -->
        <div id="vitalsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white p-6 border-b rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-800">Record Patient Vitals</h3>
                        <button id="closeVitalsModal" class="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <form id="vitalsForm" class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="vitalHeight" class="block text-sm font-medium text-gray-700">Height (cm)</label>
                            <input type="number" id="vitalHeight" class="mt-1 block w-full p-2 border rounded-md" step="0.1">
                        </div>
                        <div>
                            <label for="vitalWeight" class="block text-sm font-medium text-gray-700">Weight (kg)</label>
                            <input type="number" id="vitalWeight" class="mt-1 block w-full p-2 border rounded-md" step="0.1">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="vitalBP" class="block text-sm font-medium text-gray-700">Blood Pressure</label>
                            <input type="text" id="vitalBP" class="mt-1 block w-full p-2 border rounded-md" placeholder="120/80">
                        </div>
                        <div>
                            <label for="vitalTemp" class="block text-sm font-medium text-gray-700">Temperature (F)</label>
                            <input type="number" id="vitalTemp" class="mt-1 block w-full p-2 border rounded-md" step="0.1">
                        </div>
                    </div>
                    <div>
                        <label for="vitalPulse" class="block text-sm font-medium text-gray-700">Pulse Rate (bpm)</label>
                        <input type="number" id="vitalPulse" class="mt-1 block w-full p-2 border rounded-md">
                    </div>
                    
                    <!-- Gynecology-specific vitals -->
                    <div class="border-t pt-4 mt-4">
                        <h4 class="text-sm font-semibold text-gray-800 mb-3">Gynecological Examination</h4>
                        
                        <!-- Menstrual Cycle Information -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="vitalLMP" class="block text-sm font-medium text-gray-700">LMP (Last Menstrual Period)</label>
                                <input type="date" id="vitalLMP" class="mt-1 block w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="vitalCycle" class="block text-sm font-medium text-gray-700">Menstrual Cycle</label>
                                <select id="vitalCycle" class="mt-1 block w-full p-2 border rounded-md">
                                    <option value="">Select</option>
                                    <option value="regular">Regular</option>
                                    <option value="irregular">Irregular</option>
                                    <option value="amenorrhea">Amenorrhea</option>
                                    <option value="menopause">Menopause</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="vitalFlow" class="block text-sm font-medium text-gray-700">Menstrual Flow</label>
                                <select id="vitalFlow" class="mt-1 block w-full p-2 border rounded-md">
                                    <option value="">Select</option>
                                    <option value="normal">Normal</option>
                                    <option value="heavy">Heavy</option>
                                    <option value="light">Light</option>
                                    <option value="spotting">Spotting</option>
                                </select>
                            </div>
                            <div>
                                <label for="vitalCycleDuration" class="block text-sm font-medium text-gray-700">Cycle Duration (days)</label>
                                <input type="number" id="vitalCycleDuration" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 28">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="vitalAnaemia" class="block text-sm font-medium text-gray-700">Anaemia</label>
                                <select id="vitalAnaemia" class="mt-1 block w-full p-2 border rounded-md">
                                    <option value="">Select</option>
                                    <option value="absent">Absent</option>
                                    <option value="mild">Mild</option>
                                    <option value="moderate">Moderate</option>
                                    <option value="severe">Severe</option>
                                </select>
                            </div>
                            <div>
                                <label for="vitalOedema" class="block text-sm font-medium text-gray-700">Oedema</label>
                                <select id="vitalOedema" class="mt-1 block w-full p-2 border rounded-md">
                                    <option value="">Select</option>
                                    <option value="absent">Absent</option>
                                    <option value="pedal">Pedal</option>
                                    <option value="facial">Facial</option>
                                    <option value="generalized">Generalized</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label for="vitalUterusHeight" class="block text-sm font-medium text-gray-700">Height of Uterus</label>
                            <input type="text" id="vitalUterusHeight" class="mt-1 block w-full p-2 border rounded-md" placeholder="e.g., 28 weeks size, At umbilicus">
                        </div>
                        
                        <div>
                            <label for="vitalPA" class="block text-sm font-medium text-gray-700">P/A (Per Abdomen)</label>
                            <textarea id="vitalPA" rows="2" class="mt-1 block w-full p-2 border rounded-md" placeholder="Abdominal examination findings..."></textarea>
                        </div>
                        
                        <div>
                            <label for="vitalPV" class="block text-sm font-medium text-gray-700">P/V (Per Vaginum)</label>
                            <textarea id="vitalPV" rows="2" class="mt-1 block w-full p-2 border rounded-md" placeholder="Vaginal examination findings..."></textarea>
                        </div>
                        
                        <div>
                            <label for="vitalPS" class="block text-sm font-medium text-gray-700">P/S (Per Speculum)</label>
                            <textarea id="vitalPS" rows="2" class="mt-1 block w-full p-2 border rounded-md" placeholder="Speculum examination findings..."></textarea>
                        </div>
                    </div>
                    
                    <div>
                        <label for="vitalNotes" class="block text-sm font-medium text-gray-700">Additional Notes</label>
                        <textarea id="vitalNotes" rows="2" class="mt-1 block w-full p-2 border rounded-md" placeholder="Any additional observations..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 pt-6 border-t">
                        <button type="button" id="cancelVitalsForm" class="bg-gray-200 hover:bg-gray-300 px-6 py-3 rounded-lg font-medium transition-colors">Cancel</button>
                        <button type="submit" class="btn-primary px-6 py-3 rounded-lg font-medium">Save Vitals</button>
                    </div>
                </form>
                </div>
            </div>
        </div>

        <!-- Test Result Upload Modal -->
        <div id="testUploadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Upload Test Result</h3>
                    <button id="closeTestUploadModal" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <form id="testUploadForm" class="space-y-4">
                    <div>
                        <label for="testName" class="block text-sm font-medium text-gray-700">Test Name</label>
                        <input type="text" id="testName" class="mt-1 block w-full p-2 border rounded-md" required placeholder="CBC, X-Ray Chest, etc.">
                    </div>
                    <div>
                        <label for="testDate" class="block text-sm font-medium text-gray-700">Test Date</label>
                        <input type="date" id="testDate" class="mt-1 block w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="testFile" class="block text-sm font-medium text-gray-700">Upload File</label>
                        <input type="file" id="testFile" class="mt-1 block w-full p-2 border rounded-md" accept="image/*,.pdf,.doc,.docx">
                        <div class="mt-1 text-xs text-gray-500">Supported: Images, PDF, Word documents</div>
                    </div>
                    <div>
                        <label for="testNotes" class="block text-sm font-medium text-gray-700">Notes/Results</label>
                        <textarea id="testNotes" rows="3" class="mt-1 block w-full p-2 border rounded-md" placeholder="Key findings, normal values, etc."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="cancelTestUploadForm" class="bg-gray-200 px-4 py-2 rounded-lg">Cancel</button>
                        <button type="submit" class="btn-primary px-4 py-2 rounded-lg">Upload Test</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Medical Certificate Modal -->
        <div id="certificateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Medical Leave Certificate</h3>
                    <button id="closeCertificateModal" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <form id="certificateForm" class="space-y-6">
                    <!-- Certificate Type -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="certificateType" class="block text-sm font-medium text-gray-700 mb-2">Certificate Type</label>
                            <select id="certificateType" class="w-full p-3 border rounded-md" required>
                                <option value="">Select Certificate Type</option>
                                <option value="sick_leave">Sick Leave</option>
                                <option value="medical_leave">Medical Leave</option>
                                <option value="maternity_leave">Maternity Leave</option>
                                <option value="disability">Disability Certificate</option>
                                <option value="fitness">Fitness Certificate</option>
                                <option value="covid_isolation">COVID-19 Isolation</option>
                            </select>
                        </div>
                        <div>
                            <label for="certificateDate" class="block text-sm font-medium text-gray-700 mb-2">Certificate Date</label>
                            <input type="date" id="certificateDate" class="w-full p-3 border rounded-md" required>
                        </div>
                    </div>

                    <!-- Leave Period -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-3">Leave Period</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="leaveStartDate" class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                                <input type="date" id="leaveStartDate" class="w-full p-3 border rounded-md" required>
                            </div>
                            <div>
                                <label for="leaveEndDate" class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                <input type="date" id="leaveEndDate" class="w-full p-3 border rounded-md" required>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="flex items-center">
                                <input type="checkbox" id="indefiniteLeave" class="mr-2">
                                <span class="text-sm text-gray-700">Indefinite period (no end date)</span>
                            </label>
                        </div>
                    </div>

                    <!-- Medical Condition -->
                    <div>
                        <label for="medicalCondition" class="block text-sm font-medium text-gray-700 mb-2">Medical Condition/Diagnosis</label>
                        <textarea id="medicalCondition" rows="3" class="w-full p-3 border rounded-md" 
                                  placeholder="Brief description of the medical condition requiring leave..." required></textarea>
                    </div>

                    <!-- Recommendations -->
                    <div>
                        <label for="recommendations" class="block text-sm font-medium text-gray-700 mb-2">Medical Recommendations</label>
                        <textarea id="recommendations" rows="3" class="w-full p-3 border rounded-md" 
                                  placeholder="Rest, medication compliance, follow-up requirements, etc."></textarea>
                    </div>

                    <!-- Additional Options -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="requiresBedRest" class="mr-2">
                                <span class="text-sm text-gray-700">Requires complete bed rest</span>
                            </label>
                        </div>
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="requiresFollowUp" class="mr-2">
                                <span class="text-sm text-gray-700">Requires medical follow-up</span>
                            </label>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 pt-6 border-t">
                        <button type="button" id="cancelCertificateForm" class="bg-gray-200 px-6 py-3 rounded-lg hover:bg-gray-300">
                            Cancel
                        </button>
                        <button type="button" id="previewCertificate" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                            <i data-lucide="eye" class="w-4 h-4 inline mr-2"></i>
                            Preview Certificate
                        </button>
                        <button type="submit" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
                            <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                            Issue Certificate
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Certificate Preview Modal -->
        <div id="certificatePreviewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Certificate Preview</h3>
                    <div class="flex space-x-2">
                        <button id="printCertificate" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            <i data-lucide="printer" class="w-4 h-4 inline mr-2"></i>
                            Print
                        </button>
                        <button id="closeCertificatePreview" class="text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>

                <!-- Certificate Template -->
                <div id="certificateTemplate" class="bg-white p-8 border shadow-lg">
                    <!-- Certificate content will be generated here -->
                </div>

                <div class="flex flex-wrap justify-center gap-3 mt-6">
                    <button id="editCertificate" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium">
                        <i data-lucide="edit" class="w-4 h-4 inline mr-2"></i>
                        Edit
                    </button>
                    <button id="signAndIssueCertificate" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 text-sm font-medium">
                        <i data-lucide="file-check" class="w-4 h-4 inline mr-2"></i>
                        Sign
                    </button>
                </div>
            </div>
        </div>

        <!-- Auto Generate Certificate Modal -->
        <div id="autoGenerateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">Auto Generate Certificate from Consultation</h3>
                    <button id="closeAutoGenerateModal" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- Consultation Selection -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-700 mb-4">Select Consultation to Base Certificate On:</h4>
                    <div id="consultationsList" class="space-y-3 max-h-60 overflow-y-auto">
                        <!-- Consultations will be loaded here -->
                    </div>
                </div>

                <!-- Certificate Configuration -->
                <div id="certificateConfig" class="hidden">
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h4 class="font-semibold text-blue-800 mb-3">Certificate Configuration</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="autoCertType" class="block text-sm font-medium text-gray-700 mb-2">Certificate Type</label>
                                <select id="autoCertType" class="w-full p-3 border rounded-md">
                                    <option value="sick_leave">Sick Leave</option>
                                    <option value="medical_leave">Medical Leave</option>
                                    <option value="fitness">Fitness Certificate</option>
                                    <option value="disability">Disability Certificate</option>
                                </select>
                            </div>
                            <div>
                                <label for="autoLeaveDays" class="block text-sm font-medium text-gray-700 mb-2">Recommended Leave Days</label>
                                <select id="autoLeaveDays" class="w-full p-3 border rounded-md">
                                    <option value="3">3 Days</option>
                                    <option value="5">5 Days</option>
                                    <option value="7" selected>1 Week</option>
                                    <option value="14">2 Weeks</option>
                                    <option value="30">1 Month</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="includeCurrentDiagnosis" class="mr-2" checked>
                                <span class="text-sm text-gray-700">Include current diagnosis and treatment</span>
                            </label>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button id="cancelAutoGenerate" class="bg-gray-200 px-6 py-3 rounded-lg hover:bg-gray-300">
                            Cancel
                        </button>
                        <button id="generateFromConsultation" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                            <i data-lucide="zap" class="w-4 h-4 inline mr-2"></i>
                            Generate Certificate
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Certificate Actions Modal -->
        <div id="certificateActionsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">Certificate Actions</h3>
                    <button id="closeCertificateActions" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- Email Section -->
                    <div class="border rounded-lg p-4">
                        <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="mail" class="w-4 h-4 mr-2"></i>
                            Email Certificate
                        </h4>
                        <div class="space-y-3">
                            <input type="email" id="patientEmail" class="w-full p-2 border rounded-md" 
                                   placeholder="Patient's email address">
                            <div class="flex space-x-2">
                                <input type="email" id="ccEmail" class="flex-1 p-2 border rounded-md" 
                                       placeholder="CC: Additional email (optional)">
                            </div>
                            <button id="sendEmailCertificate" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                                <i data-lucide="send" class="w-4 h-4 inline mr-2"></i>
                                Send Email
                            </button>
                        </div>
                    </div>

                    <!-- WhatsApp Section -->
                    <div class="border rounded-lg p-4">
                        <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="message-circle" class="w-4 h-4 mr-2"></i>
                            WhatsApp Share
                        </h4>
                        <div class="space-y-3">
                            <button id="shareWhatsApp" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                                <i data-lucide="message-circle" class="w-4 h-4 inline mr-2"></i>
                                Open WhatsApp & Share
                            </button>
                        </div>
                    </div>

                    <!-- Share & Print Section -->
                    <div class="border rounded-lg p-4">
                        <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                            <i data-lucide="share-2" class="w-4 h-4 mr-2"></i>
                            Share & Print (All as Single-Page PDF)
                        </h4>
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <button id="printStandard" class="bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700 text-sm">
                                <i data-lucide="printer" class="w-4 h-4 inline mr-1"></i>
                                Print PDF
                            </button>
                            <button id="downloadCertificatePDF" class="bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 text-sm">
                                <i data-lucide="download" class="w-4 h-4 inline mr-1"></i>
                                Download PDF
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mb-3">All options generate single-page PDFs for professional presentation</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Custom Confirmation Modal for Mobile -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 shadow-2xl">
            <div class="text-center">
                <div class="mb-4">
                    <i id="confirmationIcon" data-lucide="alert-triangle" class="w-12 h-12 text-orange-500 mx-auto mb-3"></i>
                    <h3 id="confirmationTitle" class="text-lg font-bold text-gray-900 mb-2">Confirm Action</h3>
                    <p id="confirmationMessage" class="text-gray-600 text-sm">Are you sure you want to proceed?</p>
                </div>
                <div class="flex flex-col space-y-3">
                    <button id="confirmationCancel" class="bg-gray-200 text-gray-800 px-6 py-3 rounded-lg hover:bg-gray-300 transition-colors font-medium">
                        Cancel
                    </button>
                    <button id="confirmationConfirm" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors font-medium">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Catch all JavaScript errors
        window.addEventListener('error', function(e) {
            // Handle errors gracefully
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            // Handle promise rejections
        });

        // Custom Mobile-Friendly Confirmation Modal
        function showCustomConfirm(title, message, confirmText = 'Confirm', cancelText = 'Cancel', iconType = 'alert-triangle') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmationModal');
                const titleEl = document.getElementById('confirmationTitle');
                const messageEl = document.getElementById('confirmationMessage');
                const iconEl = document.getElementById('confirmationIcon');
                const confirmBtn = document.getElementById('confirmationConfirm');
                const cancelBtn = document.getElementById('confirmationCancel');

                // Set content
                titleEl.textContent = title;
                messageEl.textContent = message;
                confirmBtn.textContent = confirmText;
                cancelBtn.textContent = cancelText;
                
                // Set icon
                iconEl.setAttribute('data-lucide', iconType);
                
                // Show modal and prevent body scroll
                modal.classList.remove('hidden');
                document.body.classList.add('modal-open');
                
                // Add touch event handlers for better mobile support
                let hasHandled = false; // Prevent double-firing
                
                const handleConfirm = (e) => {
                    if (hasHandled) return;
                    hasHandled = true;
                    e.preventDefault();
                    e.stopPropagation();
                    modal.classList.add('hidden');
                    cleanup();
                    resolve(true);
                };
                
                const handleCancel = (e) => {
                    if (hasHandled) return;
                    hasHandled = true;
                    e.preventDefault();
                    e.stopPropagation();
                    modal.classList.add('hidden');
                    cleanup();
                    resolve(false);
                };
                
                const cleanup = () => {
                    confirmBtn.removeEventListener('click', handleConfirm);
                    confirmBtn.removeEventListener('touchstart', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    cancelBtn.removeEventListener('touchstart', handleCancel);
                    document.body.classList.remove('modal-open');
                };
                
                // Add event listeners with better mobile support
                confirmBtn.addEventListener('click', handleConfirm, { passive: false });
                confirmBtn.addEventListener('touchstart', handleConfirm, { passive: false });
                cancelBtn.addEventListener('click', handleCancel, { passive: false });
                cancelBtn.addEventListener('touchstart', handleCancel, { passive: false });
                
                // Re-initialize Lucide icons
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            });
        }

        // Custom Mobile-Friendly Prompt Modal
        function showCustomPrompt(title, message, placeholder = '', confirmText = 'Confirm', cancelText = 'Cancel') {
            return new Promise((resolve) => {
                // Create prompt modal dynamically
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 shadow-2xl">
                        <div class="text-center">
                            <div class="mb-4">
                                <i data-lucide="edit-3" class="w-12 h-12 text-blue-500 mx-auto mb-3"></i>
                                <h3 class="text-lg font-bold text-gray-900 mb-2">${title}</h3>
                                <p class="text-gray-600 text-sm mb-4">${message}</p>
                                <input type="text" id="promptInput" class="w-full p-3 border rounded-lg text-center font-mono text-lg tracking-wider" 
                                       placeholder="${placeholder}" autocomplete="off">
                            </div>
                            <div class="flex flex-col space-y-3">
                                <button id="promptCancel" class="bg-gray-200 text-gray-800 px-6 py-3 rounded-lg hover:bg-gray-300 transition-colors font-medium">
                                    ${cancelText}
                                </button>
                                <button id="promptConfirm" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                                    ${confirmText}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                document.body.classList.add('modal-open');
                
                const input = modal.querySelector('#promptInput');
                const confirmBtn = modal.querySelector('#promptConfirm');
                const cancelBtn = modal.querySelector('#promptCancel');
                
                // Focus input
                input.focus();
                
                let hasHandled = false; // Prevent double-firing
                
                const handleConfirm = (e) => {
                    if (hasHandled) return;
                    hasHandled = true;
                    e.preventDefault();
                    e.stopPropagation();
                    const value = input.value;
                    document.body.removeChild(modal);
                    document.body.classList.remove('modal-open');
                    resolve(value);
                };
                
                const handleCancel = (e) => {
                    if (hasHandled) return;
                    hasHandled = true;
                    e.preventDefault();
                    e.stopPropagation();
                    document.body.removeChild(modal);
                    document.body.classList.remove('modal-open');
                    resolve(null);
                };
                
                // Add event listeners with better mobile support
                confirmBtn.addEventListener('click', handleConfirm, { passive: false });
                confirmBtn.addEventListener('touchstart', handleConfirm, { passive: false });
                cancelBtn.addEventListener('click', handleCancel, { passive: false });
                cancelBtn.addEventListener('touchstart', handleCancel, { passive: false });
                
                // Enter key support
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleConfirm(e);
                    }
                });
                
                // Re-initialize Lucide icons
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            });
        }

        // Mobile touch handling improvements
        function addMobileTouchHandlers() {
            // Prevent 300ms delay on mobile touches
            const fastclick = function(element, handler) {
                element.addEventListener('touchstart', handler, { passive: true });
                element.addEventListener('click', handler);
            };
            
            // Add better touch handling to all modal buttons
            document.addEventListener('DOMContentLoaded', function() {
                // Improve touch responsiveness for all buttons
                const style = document.createElement('style');
                style.textContent = `
                    button, .btn {
                        -webkit-tap-highlight-color: transparent;
                        touch-action: manipulation;
                        user-select: none;
                    }
                    
                    button:active, .btn:active {
                        transform: scale(0.98);
                        transition: transform 0.1s;
                    }
                `;
                document.head.appendChild(style);
            });
        }
        
        // Initialize mobile improvements
        addMobileTouchHandlers();
        
        // Test function for mobile modal functionality
        window.testMobileModal = async function() {
            const result = await showCustomConfirm(
                'Test Mobile Modal',
                'This is a test of the mobile-friendly confirmation modal. Does it work properly?',
                'Yes, it works!',
                'No, there are issues',
                'smartphone'
            );
            
            if (result) {
                showNotification('Great! The modal is working correctly.', 'success');
            } else {
                showNotification('Please report what issues you encountered.', 'error');
            }
        };

        // Make them globally available
        window.showCustomConfirm = showCustomConfirm;
        window.showCustomPrompt = showCustomPrompt;
        
        // Proper loading state management
        function hideLoadingSpinner() {
            const spinner = document.getElementById('loading');
            if (spinner) {
                spinner.style.display = 'none';
            }
        }
        
        // --- LOCAL STORAGE CONFIGURATION ---
        const STORAGE_KEYS = {
            DOCTOR_PROFILE: 'clinic_doctor_profile',
            PATIENTS: 'clinic_patients',
            CONSULTATIONS: 'clinic_consultations_',
            CERTIFICATES: 'clinic_certificates_'
        };

        // --- MEDICAL AUTHENTICATION UTILITIES ---
        function generateMedicalUUID() {
            // Generate UUID v4 compliant identifier for medical documents
            return 'xxxx-xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0,
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // Mobile device detection utility
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (window.innerWidth <= 768) ||
                   ('ontouchstart' in window);
        }

        function generateDigitalSignatureHash(signatureData, timestamp, doctorId) {
            // Create a hash for signature authenticity (simplified version)
            const data = signatureData + timestamp + doctorId;
            let hash = 0;
            for (let i = 0; i < data.length; i++) {
                const char = data.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash).toString(16).toUpperCase();
        }

        function formatMedicalTimestamp(date = new Date()) {
            return {
                date: date.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric'
                }),
                time: date.toLocaleTimeString('en-IN', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }),
                iso: date.toISOString(),
                timezone: 'IST'
            };
        }
        
        // --- CONFIG & STATE ---
        let currentPatientId = null;
        let doctorProfile = {};
        let patients = [];
        let consultations = [];
        
        // Default doctor profile for Indian doctors
        const defaultDoctorProfile = {
            doctorName: 'Dr. [Your Name]',
            title: 'MBBS, MD',
            specializations: 'General Medicine, Family Medicine',
            qualifications: 'MBBS, MD (Internal Medicine)',
            mobile: '+91-[Your Mobile Number]',
            email: '[Your Email]',
            regNumber: '[State Medical Council Registration]',
            clinicInfo: 'Clinic Name\nAddress Line 1\nAddress Line 2\nCity, State - PIN',
            digitalSignature: '',
            signaturePin: '',
            signatureSetup: false
        };
        
        // Smart AI-powered medical assistant functions
        const MEDICAL_AI = {
            // Centralized AI API handler
            async callAI(prompt, options = {}) {
                if (!AI_CONFIG.enabled) {
                    throw new Error('AI features are disabled');
                }
                
                // Use Gemini API exclusively
                return await this.callGemini(prompt, options.temperature || 0.3, options.maxTokens || 1000);
            },
            
            async callGemini(prompt, temperature, maxTokens) {
                return await callGemini(prompt, 'Medical AI Assistant');
            },
            
            // Get medication suggestions based on patient data and symptoms
            async getMedicationSuggestions(patientData, symptoms, diagnosis = '') {
                if (!AI_CONFIG.enabled) {
                    throw new Error('AI features are disabled');
                }
                
                const prompt = `As a medical AI assistant for Dr. Chanda Chowdhury (Gynaecologist & Obstetrician) practicing in India, suggest 4-6 appropriate Indian medications for:

PATIENT PROFILE:
- Age: ${patientData.age || 'adult'} years
- Gender: ${patientData.gender || 'female'}
- Chief Complaint: ${symptoms}
- Provisional Diagnosis: ${diagnosis}
- Weight: ${patientData.weight || 'unknown'} kg
- BP: ${patientData.bp || 'normal'}

INDIAN MEDICATION REQUIREMENTS:
- Use only medications commonly available in Indian pharmacies
- Prefer Indian pharmaceutical brands (Cipla, Sun Pharma, Dr. Reddy's, Lupin, Zydus, etc.)
- Include brand names with generic names in brackets
- Follow Indian prescribing patterns and dosage recommendations
- Consider Indian dietary habits and lifestyle
- Include approximate cost in Indian Rupees
- Focus on gynaecological and obstetric conditions common in Indian women
- Consider monsoon season effects and Indian climate if relevant

SPECIFIC INDIAN CONTEXT:
- Iron deficiency anemia is common in Indian women
- Vitamin D deficiency is prevalent
- Consider vegetarian diet preferences
- Include probiotics for gut health post-antibiotic therapy
- Consider traditional Indian dietary supplements where appropriate

Return ONLY a valid JSON array with this exact format:
[
  {
    "name": "Brand Name (Generic Name)",
    "manufacturer": "Indian Pharma Company",
    "dosage": "Specific Indian standard dosage",
    "frequency": "Times per day with meals/empty stomach",
    "duration": "Treatment duration",
    "indication": "Specific medical indication",
    "precautions": "Indian context precautions",
    "cost": "XX-XX (approximate Indian price)",
    "availability": "Prescription/OTC status in India"
  }
]

EXAMPLES OF INDIAN MEDICATIONS TO CONSIDER:
- Shelcal-500 (Calcium Carbonate) - Cipla
- Ferrous Ascorbate tablets - Various brands
- Meftal-Spas (Mefenamic Acid + Dicyclomine) - Blue Cross
- Duphaston (Dydrogesterone) - Abbott
- Yasmin/Diane-35 for PCOS - Bayer
- Daflon for varicose veins/piles
- Candid-V3 for vaginal infections
- Pantocid-DSR for gastric issues

IMPORTANT: Return ONLY the JSON array with Indian medications, no explanatory text. Use proper JSON syntax with double quotes.`;

                try {
                    // Use Gemini API for Indian medication suggestions
                    const response = await callGemini(prompt, 'Indian gynaecological medication recommendations');
                    
                    if (response) {
                        console.log('Indian medication AI response:', response);
                        
                        const jsonMatch = response.match(/\[[\s\S]*\]/);
                        if (jsonMatch) {
                            console.log('Extracted Indian medication JSON:', jsonMatch[0]);
                            const parsedMedications = JSON.parse(jsonMatch[0]);
                            if (Array.isArray(parsedMedications) && parsedMedications.length > 0) {
                                return parsedMedications;
                            }
                        }
                    }
                    
                    throw new Error('Unable to get Indian medication recommendations. Please ensure API key is configured and try again.');
                    
                } catch (error) {
                    console.error('Indian medication AI error:', error);
                    throw new Error(`Medication AI failed: ${error.message}`);
                }
            },
            
            // Get diagnosis suggestions based on symptoms and patient data
            async getDiagnosisSuggestions(patientData, chiefComplaint, symptoms) {
                if (!AI_CONFIG.enabled) {
                    throw new Error('AI features are disabled. Please enable them in settings.');
                }
                
                const prompt = `As a medical AI assistant for Dr. Chanda Chowdhury (Gynaecologist & Obstetrician) practicing in India, you must return ONLY a valid JSON array of 4-6 possible diagnoses in the exact format specified at the end of this prompt.

PATIENT PROFILE:
- Age: ${patientData.age || 'adult'} years
- Gender: ${patientData.gender || 'female'}
- Chief Complaint: ${chiefComplaint}
- Associated Symptoms: ${symptoms}
- Weight: ${patientData.weight || 'unknown'} kg
- Blood Pressure: ${patientData.bp || 'normal'}

INDIAN GYNECOLOGY CONTEXT:
- Consider conditions highly prevalent in Indian women
- Factor in nutritional deficiencies common in India (Iron, Vitamin D, B12)
- Consider impact of Indian dietary habits (vegetarian diet, late marriage)
- Include infectious causes common in tropical climate
- Consider socio-economic factors affecting health
- Include conditions related to early marriage and multiple pregnancies
- Factor in poor menstrual hygiene in rural areas

SPECIFIC INDIAN CONDITIONS TO CONSIDER:
- PCOS (affects 1 in 5 Indian women)
- Iron deficiency anemia (very common)
- Hypothyroidism (high prevalence)
- Genital tuberculosis (endemic areas)
- Cervical cancer (high incidence due to poor screening)
- White discharge (leucorrhea) - very common complaint
- Menstrual disorders due to stress and malnutrition
- Pregnancy-related complications (GDM, anemia)
- Pelvic inflammatory disease
- Fibroids and ovarian cysts

Return ONLY a valid JSON array with this exact format:
[
  {
    "diagnosis": "Specific Indian diagnosis name (ICD-10 code if applicable)",
    "probability": "High/Medium/Low",
    "reasoning": "Clinical reasoning considering Indian context",
    "redFlags": "Warning signs requiring immediate attention",
    "indianContext": "Specific considerations for Indian patients",
    "commonInAge": "Age group where this is most common in India"
  }
]

EXAMPLES OF INDIAN GYNECOLOGICAL DIAGNOSES:
- "PCOS (Polycystic Ovary Syndrome)" - Very common in urban Indian women
- "Iron Deficiency Anemia with Menorrhagia" - Extremely common due to poor nutrition
- "Hypothyroidism with Menstrual Irregularities" - High prevalence in Indian women
- "Chronic PID (Pelvic Inflammatory Disease)" - Common due to poor hygiene
- "Genital Tuberculosis" - Consider in endemic areas
- "Pregnancy with Gestational Diabetes" - High risk in Indian women
- "Cervical Dysplasia/CIN" - High incidence, poor screening
- "Leucorrhea (Pathological White Discharge)" - Very common complaint
- "Dysfunctional Uterine Bleeding" - Common in perimenopausal Indian women

IMPORTANT INSTRUCTIONS:
1. Your entire response must be ONLY a valid JSON array. No explanatory text.
2. Only use double quotes for strings and property names.
3. Do not include any non-JSON text, markdown formatting, or code blocks.
4. Make sure the JSON is valid and can be parsed with JSON.parse().

Example of a valid response (just output raw JSON like this):
[
  {
    "diagnosis": "PCOS",
    "probability": "High",
    "reasoning": "Common in Indian women with irregular periods",
    "redFlags": "Risk of metabolic syndrome",
    "indianContext": "High prevalence in urban Indian women",
    "commonInAge": "20-35 years"
  },
  {...},
  {...}
]`;

                try {
                    // Use Gemini API
                    const response = await callGemini(prompt, 'Diagnosis suggestions for gynaecological conditions');
                    
                    if (response) {
                        console.log('Raw AI response:', response);
                        
                        // First try to parse the entire response as JSON
                        try {
                            const directParse = JSON.parse(response.trim());
                            if (Array.isArray(directParse) && directParse.length > 0) {
                                console.log('Successfully parsed direct JSON response');
                                return directParse;
                            }
                        } catch (directParseError) {
                            console.log('Direct parse failed, trying to extract JSON array');
                        }
                        
                        // Try to extract JSON array pattern
                        const jsonMatch = response.match(/\[[\s\S]*\]/);
                        if (jsonMatch) {
                            console.log('Extracted JSON string:', jsonMatch[0]);
                            try {
                                const parsedSuggestions = JSON.parse(jsonMatch[0]);
                                if (Array.isArray(parsedSuggestions) && parsedSuggestions.length > 0) {
                                    return parsedSuggestions;
                                }
                            } catch (parseError) {
                                console.warn('JSON parse failed:', parseError.message);
                                console.log('Attempting to clean and retry...');
                                
                                // Try to clean the JSON string
                                let cleanJson = jsonMatch[0];
                                cleanJson = cleanJson.replace(/[\u0000-\u001F\u007F-\u009F]/g, ''); // Remove control characters
                                cleanJson = cleanJson.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":'); // Quote unquoted keys
                                cleanJson = cleanJson.replace(/,\s*}/g, '}'); // Remove trailing commas
                                cleanJson = cleanJson.replace(/,\s*]/g, ']'); // Remove trailing commas in arrays
                                
                                try {
                                    const parsedSuggestions = JSON.parse(cleanJson);
                                    if (Array.isArray(parsedSuggestions) && parsedSuggestions.length > 0) {
                                        return parsedSuggestions;
                                    }
                                } catch (cleanParseError) {
                                    console.warn('Cleaned JSON parse also failed:', cleanParseError.message);
                                }
                            }
                        }
                        
                        // If no JSON array found, try more aggressive approaches
                        console.log('No valid JSON array found, trying to create structured data from text');
                        
                        // Look for diagnosis patterns and create structured data manually
                        // Common patterns in diagnostic text
                        const diagnosisLines = response.split(/\n+/);
                        const manualDiagnoses = [];
                        
                        let currentDiagnosis = null;
                        
                        for (const line of diagnosisLines) {
                            // Check if line contains a potential diagnosis name
                            if (line.includes(':') && !line.startsWith('-') && !line.startsWith('*')) {
                                const [name, rest] = line.split(':', 2);
                                if (name && name.length < 100) {  // Reasonable name length
                                    currentDiagnosis = {
                                        "diagnosis": name.trim(),
                                        "probability": "Medium",
                                        "reasoning": rest ? rest.trim() : "",
                                        "redFlags": "",
                                        "indianContext": "Common in Indian women",
                                        "commonInAge": "Adult"
                                    };
                                    manualDiagnoses.push(currentDiagnosis);
                                }
                            } 
                            // Add data to current diagnosis object
                            else if (currentDiagnosis) {
                                if (line.toLowerCase().includes('probability') || line.toLowerCase().includes('likely')) {
                                    if (line.toLowerCase().includes('high')) currentDiagnosis.probability = "High";
                                    else if (line.toLowerCase().includes('low')) currentDiagnosis.probability = "Low";
                                }
                                else if (line.toLowerCase().includes('reason') || line.toLowerCase().includes('because')) {
                                    currentDiagnosis.reasoning += " " + line.trim();
                                }
                                else if (line.toLowerCase().includes('warning') || line.toLowerCase().includes('flag')) {
                                    currentDiagnosis.redFlags = line.trim();
                                }
                                else if (line.toLowerCase().includes('india') || line.toLowerCase().includes('context')) {
                                    currentDiagnosis.indianContext = line.trim();
                                }
                                else if (line.toLowerCase().includes('age')) {
                                    currentDiagnosis.commonInAge = line.trim();
                                }
                            }
                        }
                        
                        // If we extracted some diagnoses, use them
                        if (manualDiagnoses.length > 0) {
                            console.log('Created structured data from text response');
                            return manualDiagnoses;
                        }
                        
                        // Last resort: create fallback diagnoses based on chief complaint and symptom keywords
                        if (chiefComplaint) {
                            console.log('Creating fallback diagnoses from chief complaint');
                            const fallbackDiagnoses = [];
                            
                            // Check for common gynecological conditions based on keywords
                            const keywordMap = {
                                "period": ["Menstrual Irregularity", "Dysmenorrhea", "PCOS"],
                                "pain": ["Pelvic Inflammatory Disease", "Dysmenorrhea", "Endometriosis"],
                                "discharge": ["Vaginitis", "Cervicitis", "Bacterial Vaginosis"],
                                "bleeding": ["Abnormal Uterine Bleeding", "Uterine Fibroids", "Endometrial Hyperplasia"],
                                "pregnant": ["Early Pregnancy", "Threatened Abortion", "Ectopic Pregnancy"],
                                "itch": ["Vulvovaginal Candidiasis", "Trichomoniasis", "Allergic Dermatitis"],
                                "lump": ["Uterine Fibroids", "Ovarian Cyst", "Bartholin's Cyst"],
                                "delay": ["PCOS", "Hypothyroidism", "Hyperprolactinemia"]
                            };
                            
                            // Find matching keywords
                            const complaint = chiefComplaint.toLowerCase();
                            for (const [keyword, diagnoses] of Object.entries(keywordMap)) {
                                if (complaint.includes(keyword)) {
                                    diagnoses.forEach(d => {
                                        fallbackDiagnoses.push({
                                            "diagnosis": d,
                                            "probability": "Medium",
                                            "reasoning": "Based on chief complaint: " + chiefComplaint,
                                            "redFlags": "Please verify with proper clinical examination",
                                            "indianContext": "Common in Indian women",
                                            "commonInAge": "Adult women"
                                        });
                                    });
                                }
                            }
                            
                            // Add a general diagnosis if none matched
                            if (fallbackDiagnoses.length === 0) {
                                fallbackDiagnoses.push({
                                    "diagnosis": "Gynecological Condition Requiring Evaluation",
                                    "probability": "Medium",
                                    "reasoning": "Based on limited information: " + chiefComplaint,
                                    "redFlags": "Please perform proper clinical examination",
                                    "indianContext": "Consider local health context",
                                    "commonInAge": "Adult women"
                                });
                            }
                            
                            return fallbackDiagnoses;
                        }
                    }
                    
                    console.log('No valid diagnosis suggestions could be generated');
                    throw new Error('Unable to generate diagnosis suggestions. Please check your inputs and try again.');
                    
                } catch (error) {
                    console.error('Diagnosis AI error:', error);
                    throw new Error(`Diagnosis AI failed: ${error.message}`);
                }
            },
            
            // Get investigation/test suggestions
            async getInvestigationSuggestions(patientData, symptoms, suspectedDiagnosis) {
                if (!AI_CONFIG.enabled) {
                    throw new Error('AI features are disabled');
                }
                
                const prompt = `As a medical AI assistant for Dr. Chanda Chowdhury (Gynaecologist & Obstetrician) practicing in India, suggest 5-7 appropriate Indian laboratory investigations for:

PATIENT PROFILE:
- Age: ${patientData.age || 'adult'} years
- Gender: ${patientData.gender || 'female'}
- Chief Complaint: ${symptoms}
- Provisional Diagnosis: ${suspectedDiagnosis}
- Weight: ${patientData.weight || 'unknown'} kg
- Blood Pressure: ${patientData.bp || 'normal'}

INDIAN INVESTIGATION REQUIREMENTS:
- Use investigation names as commonly used in Indian labs (SRL, Dr. Lal PathLabs, Metropolis, Thyrocare)
- Include accurate Indian pricing based on major lab chains
- Follow Indian medical guidelines and FOGSI recommendations
- Consider common deficiencies in Indian women (Iron, Vitamin D, B12)
- Include investigations readily available in tier-2/tier-3 Indian cities
- Prioritize cost-effective investigations for middle-class Indian families
- Consider monsoon-related infections and seasonal variations

SPECIFIC INDIAN CONTEXT FOR WOMEN:
- High prevalence of iron deficiency anemia
- Vitamin D deficiency due to limited sun exposure
- PCOS is very common (1 in 5 Indian women)
- Thyroid disorders are prevalent
- Gestational diabetes screening protocols
- TB screening if suspicious symptoms
- Consider vegetarian diet impact on B12 levels

Return ONLY a valid JSON array with this exact format:
[
  {
    "test": "Complete Indian test name as per major labs",
    "labCode": "Common lab code (e.g., CBC, TSH, HbA1c)",
    "priority": "High/Medium/Low",
    "reasoning": "Clinical indication for Indian patients",
    "expectedFindings": "Normal ranges and what abnormal values indicate",
    "cost": "XXX-XXX (SRL/Lal PathLabs/Metropolis range)",
    "fastingRequired": "Yes/No",
    "reportTime": "Same day/Next day/2-3 days",
    "availability": "All labs/Major labs only/Specialized centers"
  }
]

EXAMPLES OF INDIAN INVESTIGATIONS:
- Complete Blood Count (CBC) with ESR - 300-500
- Thyroid Profile (T3, T4, TSH) - 400-700
- HbA1c (Glycated Hemoglobin) - 350-600
- Lipid Profile (Fasting) - 350-500
- Vitamin D (25-OH) - 800-1200
- Anti-Mullerian Hormone (AMH) - 1500-2500
- CA-125 (Tumor marker) - 800-1200
- USG Pelvis (Trans-abdominal) - 800-1500
- Pap Smear with HPV DNA - 1200-2000
- OGTT (Oral Glucose Tolerance Test) - 200-400

IMPORTANT: Return ONLY the JSON array with Indian lab investigations, accurate pricing, and local availability. Use proper JSON syntax with double quotes.`;

                try {
                    // Use Gemini API for Indian investigation suggestions
                    const response = await callGemini(prompt, 'Indian laboratory investigation recommendations');
                    
                    if (response) {
                        console.log('Indian investigation AI response:', response);
                        
                        const jsonMatch = response.match(/\[[\s\S]*\]/);
                        if (jsonMatch) {
                            console.log('Extracted Indian investigation JSON:', jsonMatch[0]);
                            const parsedInvestigations = JSON.parse(jsonMatch[0]);
                            if (Array.isArray(parsedInvestigations) && parsedInvestigations.length > 0) {
                                return parsedInvestigations;
                            }
                        }
                    }
                    
                    throw new Error('Unable to get Indian investigation recommendations. Please ensure API key is configured and try again.');
                    
                } catch (error) {
                    console.error('Indian investigation AI error:', error);
                    throw new Error(`Investigation AI failed: ${error.message}`);
                }
            },
            
            // Utility to parse JSON responses from AI
            parseJsonResponse(response) {
                if (!response) return [];
                
                try {
                    // Extract JSON array from response
                    const jsonMatch = response.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                    return [];
                } catch (error) {
                    return [];
                }
            }
        };
        
        // Enhanced AI Configuration with Gemini API setup
        let AI_CONFIG;
        try {
            AI_CONFIG = {
                gemini: {
                    apiKey: localStorage.getItem('gemini_api_key') || '',
                    model: localStorage.getItem('gemini_model') || 'gemini-2.5-flash',
                    temperature: 0.3,
                    maxTokens: 1000,
                    baseUrl: 'https://generativelanguage.googleapis.com/v1beta/models'
                },
                // Enhanced AI capabilities
                enabled: localStorage.getItem('ai_enabled') !== 'false',
                provider: 'gemini', // Only Gemini API supported
                specialty: 'Gynaecology and Obstetrics',
                features: {
                    smartDiagnosis: true,
                    drugInteractionCheck: true,
                    patientRiskAssessment: true,
                    clinicalDecisionSupport: true,
                    medicalImageAnalysis: true,
                    predictiveAnalytics: true,
                    continuousLearning: true
                },
                // Medical knowledge context
                medicalContext: {
                    primarySpecialty: 'Gynecology & Obstetrics',
                    subSpecialties: ['Infertility', 'Laparoscopy', 'Robotic Surgery'],
                    patientDemographics: 'Indian women, all age groups',
                    commonConditions: ['PCOS', 'Menstrual disorders', 'UTI', 'Pregnancy care', 'Infertility']
                }
            };
        } catch (configError) {
            console.error('AI_CONFIG initialization error:', configError);
            // Fallback configuration
            AI_CONFIG = {
                gemini: {
                    apiKey: '',
                    model: 'gemini-2.5-flash',
                    temperature: 0.3,
                    maxTokens: 1000,
                    baseUrl: 'https://generativelanguage.googleapis.com/v1beta/models'
                },
                enabled: false,
                provider: 'gemini',
                specialty: 'Gynaecology and Obstetrics',
                features: {
                    smartDiagnosis: true,
                    drugInteractionCheck: true,
                    patientRiskAssessment: true,
                    clinicalDecisionSupport: true,
                    medicalImageAnalysis: true,
                    predictiveAnalytics: true,
                    continuousLearning: true
                },
                medicalContext: {
                    primarySpecialty: 'Gynecology & Obstetrics',
                    subSpecialties: ['Infertility', 'Laparoscopy', 'Robotic Surgery'],
                    patientDemographics: 'Indian women, all age groups',
                    commonConditions: ['PCOS', 'Menstrual disorders', 'UTI', 'Pregnancy care', 'Infertility']
                }
            };
        }
        
        // --- DOM ELEMENTS CACHE ---
        const views = document.querySelectorAll('.view');
        const loadingSpinner = document.getElementById('loading');
        
        // Cache for API responses to avoid redundant calls
        const apiCache = new Map();
        const CACHE_EXPIRY = 30 * 60 * 1000; // 30 minutes
        
        function getCachedApiResponse(key) {
            const cached = apiCache.get(key);
            if (cached && Date.now() - cached.timestamp < CACHE_EXPIRY) {
                return cached.data;
            }
            return null;
        }
        
        function setCachedApiResponse(key, data) {
            apiCache.set(key, { data, timestamp: Date.now() });
        }
        
        // Cache frequently used DOM elements
        let domCache = {};
        function getCachedElement(id) {
            if (!domCache[id]) {
                domCache[id] = document.getElementById(id);
            }
            return domCache[id];
        }
        
        // Optimized DOM manipulation utilities
        function clearElement(element) {
            while (element.firstChild) {
                element.removeChild(element.firstChild);
            }
        }
        
        function createElementWithClass(tag, className) {
            const element = document.createElement(tag);
            if (className) element.className = className;
            return element;
        }
        
        // Debouncing function to improve performance on frequent events
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- UI ENHANCEMENT FUNCTIONS ---
        function updateQuickStats() {
            try {
                const totalPatients = patients.length;
                const activePatients = patients.filter(p => !p.archived).length;
                const archivedPatients = patients.filter(p => p.archived).length;
                
                // Gather all consultations from all patients instead of relying on global var
                const allConsultations = [];
                patients.forEach(patient => {
                    try {
                        const patientConsultations = loadConsultations(patient.id);
                        if (Array.isArray(patientConsultations)) {
                            allConsultations.push(...patientConsultations);
                        }
                    } catch (e) {
                        console.error(`Error loading consultations for patient ${patient.id}:`, e);
                    }
                });
                
                // Calculate today's visits
                const today = new Date().toDateString();
                const todayVisits = allConsultations.filter(c => 
                    c && c.date && new Date(c.date).toDateString() === today
                ).length;
                
                // Update dashboard elements safely
                const totalPatientsEl = document.getElementById('totalPatientsCount');
                if (totalPatientsEl) {
                    totalPatientsEl.textContent = totalPatients;
                }
                
                const todayVisitsEl = document.getElementById('todayVisitsCount');
                if (todayVisitsEl) {
                    todayVisitsEl.textContent = todayVisits;
                }
                
                // Optional elements that might not be present in mobile-optimized UI
                const weekVisitsEl = document.getElementById('weekVisitsCount');
                if (weekVisitsEl) {
                    const startOfWeek = new Date();
                    startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                    const weekVisits = allConsultations.filter(c => 
                        c && c.date && new Date(c.date) >= startOfWeek
                    ).length;
                    weekVisitsEl.textContent = weekVisits;
                }
                
                const archivedPatientsEl = document.getElementById('archivedPatientsCount');
                if (archivedPatientsEl) {
                    archivedPatientsEl.textContent = archivedPatients;
                }
            } catch (err) {
                // This prevents any errors in stats from breaking the whole app
                console.error('Error updating quick stats:', err);
            }
        }
        
        function updateDateTime() {
            const now = new Date();
            const dateElement = document.getElementById('currentDate');
            const timeElement = document.getElementById('currentTime');
            
            if (dateElement) {
                dateElement.textContent = now.toLocaleDateString('en-IN', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
            }
            
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('en-IN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            }
        }
        
        function setupQuickActions() {
            const toggleBtn = document.getElementById('toggleQuickActions');
            const quickActionsMenu = document.getElementById('quickActionsMenu');
            let isMenuOpen = false;
            
            if (toggleBtn && quickActionsMenu) {
                toggleBtn.onclick = () => {
                    isMenuOpen = !isMenuOpen;
                    if (isMenuOpen) {
                        quickActionsMenu.classList.remove('opacity-0', 'translate-y-4');
                        quickActionsMenu.classList.add('opacity-100', 'translate-y-0');
                        toggleBtn.innerHTML = '<i data-lucide="x" class="w-5 h-5"></i>';
                    } else {
                        quickActionsMenu.classList.add('opacity-0', 'translate-y-4');
                        quickActionsMenu.classList.remove('opacity-100', 'translate-y-0');
                        toggleBtn.innerHTML = '<i data-lucide="more-horizontal" class="w-5 h-5"></i>';
                    }
                    lucide.createIcons();
                };
            }
            
            // Backup Data functionality
            const backupBtn = document.getElementById('backupDataBtn');
            if (backupBtn) {
                backupBtn.onclick = () => {
                    try {
                        const data = {
                            patients: patients,
                            consultations: consultations,
                            doctorProfile: doctorProfile,
                            exportDate: new Date().toISOString(),
                            version: '2.0'
                        };
                        
                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `MediRecords_Backup_${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        showNotification('Data backup downloaded successfully!', 'success');
                    } catch (error) {
                        showNotification('Failed to create backup', 'error');
                    }
                };
            }
            
            // AI Insights functionality
            const aiInsightsBtn = document.getElementById('aiInsightsBtn');
            if (aiInsightsBtn) {
                aiInsightsBtn.onclick = () => {
                    showAIInsightsModal();
                };
            }
        }
        
        function showAIInsightsModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto shadow-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                            <i data-lucide="brain" class="w-6 h-6 mr-2 text-purple-600"></i>
                            AI Practice Insights
                        </h3>
                        <button class="close-modal text-gray-400 hover:text-gray-600 p-2">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl">
                            <h4 class="font-semibold text-blue-800 mb-2">Patient Demographics</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Total Patients:</span>
                                    <span class="font-bold">${patients.length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Active:</span>
                                    <span class="font-bold text-green-600">${patients.filter(p => !p.archived).length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Archived:</span>
                                    <span class="font-bold text-gray-600">${patients.filter(p => p.archived).length}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl">
                            <h4 class="font-semibold text-green-800 mb-2">Practice Activity</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Total Consultations:</span>
                                    <span class="font-bold">${consultations.length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>This Month:</span>
                                    <span class="font-bold text-blue-600">${consultations.filter(c => new Date(c.date).getMonth() === new Date().getMonth()).length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Avg per Patient:</span>
                                    <span class="font-bold">${patients.length > 0 ? (consultations.length / patients.length).toFixed(1) : '0'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border border-purple-200">
                        <h4 class="font-semibold text-purple-800 mb-2 flex items-center">
                            <i data-lucide="lightbulb" class="w-4 h-4 mr-1"></i>
                            Practice Recommendations
                        </h4>
                        <div class="text-sm text-purple-700 space-y-1">
                            ${getAIRecommendations()}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelector('.close-modal').onclick = () => {
                document.body.removeChild(modal);
            };
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            lucide.createIcons();
        }
        
        function getAIRecommendations() {
            const recommendations = [];
            
            if (patients.length < 10) {
                recommendations.push(' Consider patient referral programs to grow your practice');
            }
            
            if (consultations.length > 0) {
                const avgConsultationsPerMonth = consultations.filter(c => 
                    new Date(c.date).getMonth() === new Date().getMonth()
                ).length;
                
                if (avgConsultationsPerMonth < 20) {
                    recommendations.push(' Schedule follow-up appointments to improve patient care continuity');
                }
            }
            
            const archivedPercent = (patients.filter(p => p.archived).length / patients.length) * 100;
            if (archivedPercent > 30) {
                recommendations.push(' Consider re-engaging archived patients with health check reminders');
            }
            
            if (recommendations.length === 0) {
                recommendations.push(' Your practice is running smoothly! Continue providing excellent care.');
                recommendations.push(' Consider implementing preventive care reminders for patients.');
            }
            
            return recommendations.join('<br>');
        }

        // --- INITIALIZATION ---
        async function initialize() {
            console.log('Starting initialize function...');
            const loadingSpinner = document.getElementById('loading');
            
            try {
                // Test localStorage availability
                try {
                    localStorage.setItem('test', 'test');
                    if (localStorage.getItem('test') !== 'test') {
                        throw new Error('localStorage read test failed');
                    }
                    localStorage.removeItem('test');
                    console.log('localStorage is working properly');
                } catch (storageError) {
                    console.error('localStorage error:', storageError);
                    alert('Warning: Local storage is not available. Your data may not be saved properly. Please ensure cookies and local storage are enabled in your browser settings.');
                }
            
                console.log('Setting up event delegation...');
                // Setup global event delegation for reset signature button
                document.addEventListener('click', function(e) {
                    if (e.target && e.target.id === 'resetSignatureBtn') {
                        e.preventDefault();
                        resetSignatureSetup();
                    }
                });
                
                console.log('Loading doctor profile...');
                // Load data from local storage
                try {
                    loadDoctorProfile();
                } catch (profileError) {
                    console.error('Profile loading error:', profileError);
                }
                
                console.log('Loading patients...');
                try {
                    loadPatients();
                } catch (patientsError) {
                    console.error('Patients loading error:', patientsError);
                }
                
                console.log('Attaching event listeners...');
                try {
                    attachEventListeners();
                } catch (eventError) {
                    console.error('Event listener error:', eventError);
                }
                
                console.log('Setting up UI enhancements...');
                try {
                    // Setup date/time display
                    updateDateTime();
                    setInterval(updateDateTime, 60000); // Update every minute
                    
                    // Setup quick actions
                    setupQuickActions();
                    
                    // Update stats dashboard
                    updateQuickStats();
                } catch (uiError) {
                    console.error('UI enhancement error:', uiError);
                }
                
                console.log('Showing patient list view...');
                try {
                    showView('patientListView');
                } catch (viewError) {
                    console.error('View error:', viewError);
                }
                
                console.log('Hiding loading spinner...');
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'none';
                }
                
                console.log('Initialization completed successfully');
                
            } catch (error) {
                console.error('Initialize function error:', error);
                // Always hide the loading spinner, even on error
                if (loadingSpinner) {
                    loadingSpinner.innerHTML = `
                        <div class="text-center">
                            <div class="text-red-500 mb-4">
                                <i data-lucide="alert-circle" class="w-8 h-8 mx-auto mb-2"></i>
                                Error loading app
                            </div>
                            <p class="text-sm text-gray-600 mb-4">Error: ${error.message}</p>
                            <button onclick="location.reload()" class="bg-blue-500 text-white px-4 py-2 rounded">
                                Try Again
                            </button>
                        </div>
                    `;
                    // Also try to hide it completely after showing error
                    setTimeout(() => {
                        loadingSpinner.style.display = 'none';
                    }, 10000);
                }
                
                // Try to create icons even with error
                try {
                    lucide.createIcons();
                } catch (iconError) {
                    console.error('Icon creation error:', iconError);
                }
            }
        }
        
        // AI-powered medication search - replaces all hardcoded data
        async function searchMedicationData(query, diagnosis = '', patientAge = 'adult', patientData = {}) {
            try {
                // Get current patient data if available
                const currentPatient = getCurrentPatientData();
                const searchPatientData = { ...currentPatient, ...patientData, age: patientAge };
                
                // Use AI to get medication suggestions
                const aiSuggestions = await MEDICAL_AI.getMedicationSuggestions(
                    searchPatientData, 
                    query, 
                    diagnosis
                );
                
                // Format results for UI compatibility
                return aiSuggestions.map(med => ({
                    name: med.name,
                    dosage: med.dosage,
                    duration: med.duration,
                    indication: med.indication,
                    precautions: med.precautions,
                    category: med.category,
                    source: 'ai',
                    // Legacy format compatibility
                    forms: ['As prescribed'],
                    strengths: [med.dosage],
                    indications: [med.indication],
                    dosages: {
                        'Recommended': med.dosage,
                        'Duration': med.duration
                    }
                }));
                
            } catch (error) {
                console.warn('AI medication search error:', error);
                
                // Fallback to basic suggestions if AI fails
                return [{
                    name: `Search: ${query}`,
                    dosage: 'Please consult current medical guidelines',
                    indication: 'Manual prescription required',
                    source: 'fallback',
                    forms: ['Various'],
                    strengths: ['As appropriate'],
                    indications: ['As diagnosed'],
                    dosages: {
                        'Fallback': 'Consult medical references'
                    }
                }];
            }
        }
        
        // Helper function to get current patient data for AI context
        function getCurrentPatientData() {
            return {
                age: getCachedElement('patientAge')?.value || 'adult',
                gender: getCachedElement('patientGender')?.value || 'female',
                weight: getCachedElement('patientWeight')?.value || '60',
                bp: getCachedElement('patientBP')?.value || 'normal',
                temperature: getCachedElement('patientTemp')?.value || 'normal'
            };
        }
        
        // AI-powered diagnosis suggestions
        async function getAIDiagnosisSuggestions(chiefComplaint, symptoms) {
            try {
                const currentPatient = getCurrentPatientData();
                const suggestions = await MEDICAL_AI.getDiagnosisSuggestions(
                    currentPatient, 
                    chiefComplaint, 
                    symptoms
                );
                return suggestions;
            } catch (error) {
                console.warn('AI diagnosis suggestion error:', error);
                return [{
                    diagnosis: 'Manual assessment required',
                    probability: 'Variable',
                    reasoning: 'Please consult current medical guidelines',
                    redFlags: 'Watch for any concerning symptoms'
                }];
            }
        }
        
        // Mobile Optimization Function
        function optimizeForMobile() {
            // Check if we're on a mobile device
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Prevent iOS double-tap zoom
                document.addEventListener('touchend', function(event) {
                    if (event.target.tagName === 'A' || event.target.tagName === 'BUTTON' || event.target.getAttribute('role') === 'button') {
                        event.preventDefault();
                        event.target.click();
                    }
                });
                
                // Fix iOS input focus issues
                const inputs = document.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    input.addEventListener('focus', function() {
                        document.body.classList.add('input-focused');
                    });
                    
                    input.addEventListener('blur', function() {
                        document.body.classList.remove('input-focused');
                        // Add slight delay to ensure keyboard is closed before any UI adjustments
                        setTimeout(() => window.scrollTo(0, 0), 100);
                    });
                });
                
                // Improve scrolling performance
                document.querySelectorAll('.overflow-y-auto, .overflow-x-auto').forEach(el => {
                    el.style.webkitOverflowScrolling = 'touch';
                });
                
                // Use passive listeners for touch events to improve scrolling performance
                document.addEventListener('touchstart', function(){}, {passive: true});
                document.addEventListener('touchmove', function(){}, {passive: true});
                
                // Adjust UI for mobile by hiding non-essential elements EXCEPT reset signature
                const nonEssentialElements = document.querySelectorAll('.desktop-only, .hide-on-mobile');
                nonEssentialElements.forEach(el => {
                    // Make sure we don't hide the reset signature button
                    if (el.id !== 'resetSignatureBtn' && !el.closest('#signatureStatus')) {
                        el.style.display = 'none';
                    }
                });
                
                // Ensure the reset signature button is always visible on mobile
                const resetBtn = document.getElementById('resetSignatureBtn');
                if (resetBtn) {
                    resetBtn.style.display = 'inline-block';
                    resetBtn.classList.add('mobile-visible-btn');
                    
                    // Make it more tappable on mobile
                    resetBtn.style.minHeight = '44px';
                    resetBtn.style.padding = '10px 16px';
                    resetBtn.style.fontSize = '14px';
                    resetBtn.style.margin = '10px 0';
                    resetBtn.style.display = 'block';
                    resetBtn.style.width = '100%';
                }
                
                // Also ensure the signature status container is visible
                const signatureStatus = document.getElementById('signatureStatus');
                if (signatureStatus) {
                    signatureStatus.classList.remove('hidden');
                }
            }
        }

        window.onload = async () => {
            // Run mobile optimizations
            optimizeForMobile();
            
            // Recheck on resize
            window.addEventListener('resize', optimizeForMobile);
            
            console.log('Window loaded, starting initialization...');
            
            // Ensure the spinner is hidden even if initialization fails
            setTimeout(() => {
                console.log('Force hiding loading spinner after 5 seconds...');
                const loadingSpinner = document.getElementById('loading');
                if (loadingSpinner && loadingSpinner.style.display !== 'none') {
                    loadingSpinner.style.display = 'none';
                    console.log('Loading spinner hidden by timeout');
                }
            }, 5000); // Force hide after 5 seconds
            
            try {
                console.log('Creating icons...');
                try {
                    lucide.createIcons();
                } catch (iconError) {
                    console.error('Icon creation error:', iconError);
                }
                
                console.log('Starting initialize function...');
                await initialize();
                console.log('Initialization completed successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                // Handle initialization error
                const loadingSpinner = document.getElementById('loading');
                if (loadingSpinner) {
                    loadingSpinner.innerHTML = `
                        <div class="text-center">
                            <div class="text-red-500 mb-4">
                                <i data-lucide="alert-circle" class="w-8 h-8 mx-auto mb-2"></i>
                                Error loading app
                            </div>
                            <p class="text-sm text-gray-600 mb-4">Error: ${error.message}</p>
                            <button onclick="location.reload()" class="bg-blue-500 text-white px-4 py-2 rounded">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            }
        };

        // --- VIEW MANAGEMENT ---
        function showView(viewId, patientId = null) {
            currentPatientId = patientId || currentPatientId;
            views.forEach(v => v.classList.remove('active'));
            document.getElementById(viewId)?.classList.add('active');
            
            // Mobile-specific enhancements for settings view
            if (viewId === 'settingsView' && isMobileDevice()) {
                console.log('Mobile device: Refreshing profile data for settings view');
                loadDoctorProfile();
                // Small delay to ensure DOM updates are complete
                setTimeout(() => {
                    const event = new Event('settingsViewLoaded');
                    document.dispatchEvent(event);
                }, 50);
            }
            
            window.scrollTo(0, 0);
        }

        // --- LOCAL STORAGE DATA HANDLING ---
        function loadDoctorProfile() {
            const saved = localStorage.getItem(STORAGE_KEYS.DOCTOR_PROFILE);
            if (saved) {
                doctorProfile = JSON.parse(saved);
            } else {
                doctorProfile = { ...defaultDoctorProfile };
                saveDoctorProfile();
            }
        }
        
        function saveDoctorProfile() {
            localStorage.setItem(STORAGE_KEYS.DOCTOR_PROFILE, JSON.stringify(doctorProfile));
            // Auto-sync to GitHub if enabled
            autoSyncToGitHub();
        }
        
        function loadPatients() {
            const saved = localStorage.getItem(STORAGE_KEYS.PATIENTS);
            if (saved) {
                patients = JSON.parse(saved);
                // Migrate existing patients to add Patient ID if missing
                migratePatientIds();
            } else {
                patients = [];
            }
            
            // Load all consultations for all patients
            consultations = [];
            for (const patient of patients) {
                const patientConsultations = loadConsultations(patient.id);
                consultations = consultations.concat(patientConsultations);
            }
            
            renderPatientList();
        }

        function migratePatientIds() {
            let needsSave = false;
            patients.forEach(patient => {
                if (!patient.patientId) {
                    // For existing patients, create ID based on their creation date or current date
                    const createdDate = patient.createdAt ? new Date(patient.createdAt) : new Date();
                    const year = createdDate.getFullYear();
                    const month = String(createdDate.getMonth() + 1).padStart(2, '0');
                    const day = String(createdDate.getDate()).padStart(2, '0');
                    const dateStr = `${year}${month}${day}`;
                    
                    // Find existing patients with same date to get sequential number
                    const sameDate = patients.filter(p => p.patientId && p.patientId.includes(dateStr));
                    const sequentialNumber = String(sameDate.length + 1).padStart(3, '0');
                    
                    patient.patientId = `P-${dateStr}-${sequentialNumber}`;
                    needsSave = true;
                }
            });
            
            if (needsSave) {
                savePatients();
            }
        }
        
        function savePatients() {
            localStorage.setItem(STORAGE_KEYS.PATIENTS, JSON.stringify(patients));
            // Auto-sync to GitHub if enabled
            autoSyncToGitHub();
        }
        
        function loadConsultations(patientId) {
            const saved = localStorage.getItem(STORAGE_KEYS.CONSULTATIONS + patientId);
            if (saved) {
                return JSON.parse(saved);
            }
            return [];
        }
        
        function saveConsultations(patientId, patientConsultations) {
            localStorage.setItem(STORAGE_KEYS.CONSULTATIONS + patientId, JSON.stringify(patientConsultations));
            
            // Update the global consultations array
            // First, remove any existing consultations for this patient
            consultations = consultations.filter(c => c.patientId !== patientId);
            
            // Then add the new consultations with patientId attached
            const consultationsWithPatientId = patientConsultations.map(c => ({
                ...c,
                patientId: patientId
            }));
            
            // Add them to the global array
            consultations = consultations.concat(consultationsWithPatientId);
            
            // Auto-sync to GitHub if enabled
            autoSyncToGitHub();
        }
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function generatePatientId() {
            // Generate a user-friendly Patient ID in format: P-YYYYMMDD-XXX
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const dateStr = `${year}${month}${day}`;
            
            // Get existing patient count for today to generate sequential number
            const existingPatients = patients.filter(p => p.patientId && p.patientId.includes(dateStr));
            const sequentialNumber = String(existingPatients.length + 1).padStart(3, '0');
            
            return `P-${dateStr}-${sequentialNumber}`;
        }

        // --- RENDERING ---
        function renderPatientList() {
            const container = document.getElementById('patientListContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            container.innerHTML = '';
            
            // Get current filter
            const activeFilter = document.querySelector('.patient-filter-btn.active')?.id || 'showAllPatients';
            
            // Filter patients based on search term and archive status
            let filteredPatients = patients.filter(p => p.name.toLowerCase().includes(searchTerm));
            
            if (activeFilter === 'showActivePatients') {
                filteredPatients = filteredPatients.filter(p => !p.archived);
            } else if (activeFilter === 'showArchivedPatients') {
                filteredPatients = filteredPatients.filter(p => p.archived);
            }
            
            // Update counts safely
            try {
                const allCount = patients.length;
                const activeCount = patients.filter(p => !p.archived).length;
                const archivedCount = patients.filter(p => p.archived).length;
                
                const allCountEl = document.getElementById('allCount');
                if (allCountEl) allCountEl.textContent = allCount;
                
                const activeCountEl = document.getElementById('activeCount');
                if (activeCountEl) activeCountEl.textContent = activeCount;
                
                const archivedCountEl = document.getElementById('archivedCount');
                if (archivedCountEl) archivedCountEl.textContent = archivedCount;
                
                // Update quick stats dashboard
                updateQuickStats();
            } catch (err) {
                console.error('Error updating patient counts:', err);
            }

            if (filteredPatients.length === 0) {
                 container.innerHTML = `<div class="text-center text-gray-500 py-10">
                    <i data-lucide="users-2" class="mx-auto h-12 w-12 text-gray-400"></i>
                    <p>No patients found.</p>
                    <p class="text-sm">Click the '+' button to add your first patient.</p>
                </div>`;
                lucide.createIcons();
                return;
            }

            filteredPatients.forEach(p => {
                const card = document.createElement('div');
                card.className = `medical-card p-5 cursor-pointer flex justify-between items-center hover:shadow-lg transition-all duration-300 ${p.archived ? 'archived' : ''}`;
                card.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <!-- Enhanced Patient Avatar -->
                        <div class="relative">
                            <div class="w-14 h-14 bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 rounded-full flex items-center justify-center ring-2 ring-white shadow-lg">
                                <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                        <circle cx="12" cy="7" r="4"/>
                                    </svg>
                                </div>
                            </div>
                            <!-- Patient ID Badge -->
                            <div class="absolute -top-1 -right-1 bg-blue-500 text-white text-xs px-1.5 py-0.5 rounded-full font-bold">
                                ${p.patientId ? p.patientId.split('-').pop() : 'NEW'}
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center space-x-2">
                                <p class="font-bold text-lg text-gray-800">${p.name}</p>
                                ${p.archived ? '<span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded">ARCHIVED</span>' : ''}
                            </div>
                            <p class="text-sm text-gray-600 flex items-center space-x-2">
                                <span>${p.age}, ${p.gender}</span>
                                <span class="w-1 h-1 bg-gray-400 rounded-full"></span>
                                <span class="text-blue-600 font-medium">ID: ${p.patientId || 'N/A'}</span>
                            </p>
                            ${p.lastVisit ? `<p class="text-xs text-gray-500 mt-1">Last visit: ${new Date(p.lastVisit).toLocaleDateString()}</p>` : ''}
                            ${p.archived && p.archivedDate ? `<p class="text-xs text-gray-500 mt-1">Archived: ${new Date(p.archivedDate).toLocaleDateString()}</p>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <!-- Health Status Indicator -->
                        <div class="w-3 h-3 ${p.archived ? 'bg-gray-400' : 'bg-green-400'} rounded-full opacity-75" title="${p.archived ? 'Archived Patient' : 'Active Patient'}"></div>
                        <button class="archive-patient-btn text-orange-500 hover:text-orange-700 p-2 rounded-full hover:bg-orange-50" data-id="${p.id}" title="${p.archived ? 'Unarchive Patient' : 'Archive Patient'}">
                            <i data-lucide="${p.archived ? 'archive-restore' : 'archive'}" class="w-4 h-4"></i>
                        </button>
                        <button class="edit-patient-btn text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-50" data-id="${p.id}" title="Edit Patient">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button class="delete-patient-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50" data-id="${p.id}" title="Delete Patient">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                        <i data-lucide="chevron-right" class="text-gray-400 w-5 h-5"></i>
                    </div>
                `;
                card.onclick = (e) => {
                    if (e.target.closest('.edit-patient-btn')) {
                        e.stopPropagation();
                        const id = e.target.closest('.edit-patient-btn').getAttribute('data-id');
                        editPatient(id);
                    } else if (e.target.closest('.delete-patient-btn')) {
                        e.stopPropagation();
                        const id = e.target.closest('.delete-patient-btn').getAttribute('data-id');
                        deletePatient(id);
                    } else if (e.target.closest('.archive-patient-btn')) {
                        e.stopPropagation();
                        const id = e.target.closest('.archive-patient-btn').getAttribute('data-id');
                        toggleArchivePatient(id);
                    } else {
                        showPatientDetail(p.id);
                    }
                };
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function showPatientDetail(patientId) {
            currentPatientId = patientId;
            const patient = patients.find(p => p.id === patientId);

            if (patient) {
                document.getElementById('detailPatientName').textContent = patient.name;
                document.getElementById('detailPatientInfo').textContent = `ID: ${patient.patientId || 'N/A'} | ${patient.age}, ${patient.gender} | Contact: ${patient.contact || 'N/A'}`;
                
                // Reset tab state to show consultations tab as active
                document.querySelectorAll('.patient-tab-btn').forEach(btn => {
                    btn.classList.remove('border-blue-500', 'text-blue-600', 'font-medium');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                
                // Hide all tab contents
                document.querySelectorAll('.patient-tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Show consultations tab as default and make it active
                const consultationsBtn = document.querySelector('[data-tab="consultations"]');
                if (consultationsBtn) {
                    consultationsBtn.classList.add('border-blue-500', 'text-blue-600', 'font-medium');
                    consultationsBtn.classList.remove('border-transparent', 'text-gray-500');
                }
                
                document.getElementById('consultationsTab').classList.remove('hidden');
                
                showView('patientDetailView');
                
                // Load consultations from local storage immediately
                loadConsultationHistory();
                
                // Initialize lucide icons for new content
                lucide.createIcons();
            }
        }
        
        function loadConsultationHistory() {
            const consultations = loadConsultations(currentPatientId);
            const consultationList = document.getElementById('consultationList');
            consultationList.innerHTML = '';
            
            if (consultations.length === 0) {
                consultationList.innerHTML = `<p class="text-center text-gray-500 py-4">No consultation history found.</p>`;
                return;
            }
            
            // Sort by date (newest first)
            consultations.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const patient = patients.find(p => p.id === currentPatientId);
            
            consultations.forEach(consult => {
                const consultCard = document.createElement('div');
                consultCard.className = 'bg-white p-4 rounded-lg shadow-sm cursor-pointer flex justify-between items-center';
                const consultDate = new Date(consult.date).toLocaleDateString('en-IN', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
                consultCard.innerHTML = `
                    <div class="consultation-content" onclick="showPrescription(patients.find(p => p.id === '${patient.id}'), ${JSON.stringify(consult).replace(/"/g, '&quot;')})">
                        <p class="font-semibold text-gray-800">${consult.diagnosis}</p>
                        <p class="text-sm text-gray-500">${consultDate}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="edit-consultation-btn text-blue-500 hover:text-blue-700 p-1" 
                                data-patient-id="${patient.id}" data-consultation-id="${consult.id}" 
                                title="Edit Consultation">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button class="view-prescription-btn text-green-500 hover:text-green-700 p-1" 
                                data-patient-id="${patient.id}" data-consultation-id="${consult.id}" 
                                title="View Prescription">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                
                // Add event listeners for edit and view buttons
                const editBtn = consultCard.querySelector('.edit-consultation-btn');
                const viewBtn = consultCard.querySelector('.view-prescription-btn');
                
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    editConsultation(patient.id, consult.id);
                };
                
                viewBtn.onclick = (e) => {
                    e.stopPropagation();
                    showPrescription(patient, consult);
                };
                
                consultationList.appendChild(consultCard);
            });
            
            // Initialize lucide icons for the new buttons
            lucide.createIcons();
        }
        
        // Patient Management Functions
        function deletePatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            const confirmMessage = ` DELETE PATIENT: ${patient.name}\n\nThis will permanently delete:\n Patient profile\n All consultation records\n All medical history\n\nThis action CANNOT be undone!\n\nType "DELETE" to confirm:`;
            
            const userInput = prompt(confirmMessage);
            if (userInput === 'DELETE') {
                // Remove patient from array
                const patientIndex = patients.findIndex(p => p.id === patientId);
                if (patientIndex > -1) {
                    patients.splice(patientIndex, 1);
                }
                
                // Remove all consultations for this patient from localStorage
                localStorage.removeItem(STORAGE_KEYS.CONSULTATIONS + patientId);
                
                // Also remove from global consultations array if it exists
                if (typeof consultations !== 'undefined') {
                    const patientConsultations = consultations.filter(c => c.patientId === patientId);
                    patientConsultations.forEach(consultation => {
                        const consultIndex = consultations.findIndex(c => c.id === consultation.id);
                        if (consultIndex > -1) {
                            consultations.splice(consultIndex, 1);
                        }
                    });
                }
                
                // Save to localStorage
                savePatients();
                
                // Update UI
                renderPatientList();
                showNotification(`Patient ${patient.name} deleted successfully`, 'success');
                
                // If this was the current patient, clear the selection
                if (currentPatientId === patientId) {
                    currentPatientId = null;
                }
            } else if (userInput !== null) {
                showNotification('Delete cancelled - incorrect confirmation text', 'warning');
            }
        }
        
        async function toggleArchivePatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            const isArchiving = !patient.archived;
            const action = isArchiving ? 'archive' : 'unarchive';
            const confirmMessage = isArchiving ? 
                `Archived patients will be hidden from the active list but can be restored anytime.` :
                `This patient will be restored to the active list.`;
            
            const confirmed = await showCustomConfirm(
                `${action.charAt(0).toUpperCase() + action.slice(1)} Patient`,
                `Are you sure you want to ${action} ${patient.name}? ${confirmMessage}`,
                action.charAt(0).toUpperCase() + action.slice(1),
                'Cancel',
                isArchiving ? 'archive' : 'user-check'
            );
            
            if (confirmed) {
                // Toggle archive status
                patient.archived = isArchiving;
                patient.archivedDate = isArchiving ? new Date().toISOString() : null;
                
                // Update patient in array
                const patientIndex = patients.findIndex(p => p.id === patientId);
                if (patientIndex > -1) {
                    patients[patientIndex] = patient;
                }
                
                // Save to localStorage
                savePatients();
                
                // Update UI
                renderPatientList();
                showNotification(`Patient ${patient.name} ${action}d successfully`, 'success');
            }
        }
        
        function addMedicationField(med = { name: '', dosage: '', duration: '' }) {
            const container = document.getElementById('medicationsContainer');
            const medDiv = document.createElement('div');
            medDiv.className = 'medication-item grid grid-cols-1 md:grid-cols-3 gap-2 border-t pt-3 mt-3';
            medDiv.innerHTML = `
                <div class="relative">
                    <div class="dropdown">
                        <input type="text" placeholder="Search medication..." class="med-name p-2 border rounded-md w-full" value="${med.name}" required>
                        <div class="med-dropdown dropdown-content">
                            <!-- Medication suggestions will be populated by JS -->
                        </div>
                    </div>
                    <div id="med-details" class="text-xs text-gray-600 mt-1"></div>
                </div>
                <div class="relative">
                    <div class="dropdown">
                        <input type="text" placeholder="Select dosage..." class="med-dosage p-2 border rounded-md w-full" value="${med.dosage}">
                        <div class="dosage-dropdown dropdown-content">
                            <!-- Dosage suggestions will be populated by JS -->
                        </div>
                    </div>
                </div>
                <div class="flex items-center">
                    <input type="text" placeholder="Duration (e.g., 7 days)" class="med-duration p-2 border rounded-md w-full" value="${med.duration}">
                    <button type="button" class="remove-med-btn p-2 text-red-500 ml-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            `;
            container.appendChild(medDiv);
            
            // Setup enhanced medication search functionality
            const medNameInput = medDiv.querySelector('.med-name');
            const medDropdown = medDiv.querySelector('.med-dropdown');
            const dosageInput = medDiv.querySelector('.med-dosage');
            const dosageDropdown = medDiv.querySelector('.dosage-dropdown');
            const medDetailsDiv = medDiv.querySelector('#med-details');
            
            let selectedMedication = null;
            
            medNameInput.addEventListener('input', async function() {
                const value = this.value.toLowerCase();
                medDropdown.innerHTML = '';
                
                if (value.length > 1) {
                    // Show loading indicator
                    medDropdown.innerHTML = '<div class="dropdown-item text-gray-500">Searching...</div>';
                    medDropdown.classList.add('show');
                    
                    try {
                        // Search in local database
                        const localResults = medicationDatabase.filter(med => 
                            med.name.toLowerCase().includes(value)
                        ).slice(0, 10);
                        
                        // Try enhanced search with open APIs
                        const patientAge = getCurrentPatientAge();
                        const diagnosis = document.getElementById('diagnosis').value;
                        let allResults = await searchMedicationData(value, diagnosis, patientAge);
                        
                        // Merge with local results
                        allResults = [...localResults, ...allResults].slice(0, 10);
                        
                        medDropdown.innerHTML = '';
                        
                        if (allResults.length > 0) {
                            allResults.forEach(med => {
                                const item = document.createElement('div');
                                item.className = 'dropdown-item border-b p-2';
                                item.innerHTML = `
                                    <div class="font-medium">${med.name}</div>
                                    <div class="text-xs text-gray-500">
                                        ${med.forms ? med.forms.join(', ') : 'Tablet'}
                                        ${med.indications ? `  ${med.indications.slice(0, 2).join(', ')}` : ''}
                                    </div>
                                `;
                                item.onclick = async () => {
                                    medNameInput.value = med.name;
                                    selectedMedication = med;
                                    medDropdown.classList.remove('show');
                                    showMedicationDetails(med, medDetailsDiv);
                                    
                                    // Get enhanced dosage suggestions
                                    const patientAge = getCurrentPatientAge();
                                    const indication = document.getElementById('diagnosis').value;
                                    const dosageSuggestions = await getEnhancedDosageSuggestions(med, patientAge, indication);
                                    populateEnhancedDosageSuggestions(dosageSuggestions, dosageDropdown, dosageInput);
                                };
                                medDropdown.appendChild(item);
                            });
                            medDropdown.classList.add('show');
                        } else {
                            medDropdown.innerHTML = '<div class="dropdown-item text-gray-500">No medications found</div>';
                            medDropdown.classList.add('show');
                        }
                    } catch (error) {
                        console.error('Medication search error:', error);
                        medDropdown.innerHTML = '<div class="dropdown-item text-red-500">Search error</div>';
                    }
                } else {
                    medDropdown.classList.remove('show');
                }
            });
            
            medNameInput.addEventListener('focus', function() {
                if (this.value.length > 1) {
                    const event = new Event('input');
                    this.dispatchEvent(event);
                }
            });
            
            medNameInput.addEventListener('blur', function() {
                setTimeout(() => {
                    medDropdown.classList.remove('show');
                }, 200);
            });
            
            dosageInput.addEventListener('focus', function() {
                if (selectedMedication) {
                    const patientAge = getCurrentPatientAge();
                    const indication = document.getElementById('diagnosis').value;
                    getEnhancedDosageSuggestions(selectedMedication, patientAge, indication)
                        .then(suggestions => {
                            populateEnhancedDosageSuggestions(suggestions, dosageDropdown, dosageInput);
                        });
                }
            });
            
            dosageInput.addEventListener('blur', function() {
                setTimeout(() => {
                    dosageDropdown.classList.remove('show');
                }, 200);
            });
            
            medDiv.querySelector('.remove-med-btn').onclick = () => medDiv.remove();
            lucide.createIcons();
        }
        
        function showMedicationDetails(medication, detailsDiv) {
            let details = '';
            if (medication.strengths && medication.strengths.length > 0) {
                details += `Available: ${medication.strengths.join(', ')}`;
            }
            if (medication.indications && medication.indications.length > 0) {
                details += `  Used for: ${medication.indications.slice(0, 2).join(', ')}`;
            }
            detailsDiv.innerHTML = details;
        }
        
        function populateEnhancedDosageSuggestions(suggestions, dropdown, input) {
            dropdown.innerHTML = '';
            
            suggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'dropdown-item border-b p-2';
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-medium text-xs">${suggestion.category}</div>
                            <div class="text-sm">${suggestion.dosage}</div>
                        </div>
                        <div class="text-xs px-2 py-1 rounded ${
                            suggestion.source === 'ai' ? 'bg-purple-100 text-purple-600' : 
                            suggestion.source === 'database' ? 'bg-blue-100 text-blue-600' : 
                            'bg-gray-100 text-gray-600'
                        }">
                            ${suggestion.source === 'ai' ? 'AI' : suggestion.source === 'database' ? 'DB' : 'STD'}
                        </div>
                    </div>
                `;
                item.onclick = () => {
                    input.value = suggestion.dosage;
                    dropdown.classList.remove('show');
                };
                dropdown.appendChild(item);
            });
            
            dropdown.classList.add('show');
        }
        
        function populateDosageSuggestions(medication, dropdown, input) {
            dropdown.innerHTML = '';
            
            if (medication.dosages) {
                Object.entries(medication.dosages).forEach(([category, dosage]) => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.innerHTML = `
                        <div class="font-medium text-xs">${category}</div>
                        <div class="text-sm">${dosage}</div>
                    `;
                    item.onclick = () => {
                        input.value = dosage;
                        dropdown.classList.remove('show');
                    };
                    dropdown.appendChild(item);
                });
            }
            
            // Add common dosage patterns
            const commonDosages = [
                'Once daily (OD)',
                'Twice daily (BD)',
                'Three times daily (TDS)',
                'Four times daily (QID)',
                'Every 6 hours',
                'Every 8 hours',
                'At bedtime (HS)',
                'As needed (PRN/SOS)',
                'Before meals (AC)',
                'After meals (PC)',
                'Empty stomach'
            ];
            
            if (medication.dosages) {
                const separator = document.createElement('div');
                separator.className = 'border-t my-1';
                dropdown.appendChild(separator);
            }
            
            commonDosages.forEach(dosage => {
                const item = document.createElement('div');
                item.className = 'dropdown-item text-sm text-gray-600';
                item.textContent = dosage;
                item.onclick = () => {
                    input.value = dosage;
                    dropdown.classList.remove('show');
                };
                dropdown.appendChild(item);
            });
            
            dropdown.classList.add('show');
        }

        function showPrescription(patient, consultation) {
            const container = document.getElementById('prescriptionContent');
            const consultDate = new Date(consultation.date).toLocaleDateString('en-IN');
            
            // Generate medical-standard identifiers
            const prescriptionUUID = generateMedicalUUID();
            const prescriptionId = 'E-RX-' + Date.now();
            const timestamp = formatMedicalTimestamp();
            const signatureHash = doctorProfile.digitalSignature ? 
                generateDigitalSignatureHash(doctorProfile.digitalSignature, timestamp.iso, doctorProfile.regNumber || 'UNKNOWN') : 
                null;
            
            let medsHtml = '<tr><td colspan="3" class="py-2 text-gray-600">No medications prescribed.</td></tr>';
            if (consultation.medications && consultation.medications.length > 0) {
                medsHtml = consultation.medications.map((med, i) => `
                    <tr class="border-b">
                        <td class="py-2 pr-2">${i+1}. ${med.name}</td>
                        <td class="py-2 px-2">${med.dosage}</td>
                        <td class="py-2 pl-2">${med.duration}</td>
                    </tr>
                `).join('');
            }
            
            container.innerHTML = `
                <header class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-6 border-2 border-blue-200 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <!-- Professional Medical Logo -->
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-700 rounded-full flex items-center justify-center shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                                    <path d="M12 5L8 9l4 4 4-4-4-4Z"/>
                                </svg>
                            </div>
                            <div class="text-left">
                                <h2 class="text-3xl font-bold text-blue-800">${doctorProfile.doctorName || 'Dr. Chanda Chowdhury'}</h2>
                                <p class="text-lg font-semibold text-blue-700">${doctorProfile.qualifications || 'Consultant Gynaecologist & Obstetrician'}</p>
                            </div>
                        </div>
                        <!-- Digital Badge -->
                        <div class="text-right">
                            <div class="inline-flex items-center space-x-2 bg-green-100 text-green-800 px-3 py-2 rounded-full text-xs font-semibold">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 12l2 2 4-4"/>
                                    <path d="M21 12c0 1.66-1.34 3-3 3H6a3 3 0 01-3-3V8a3 3 0 013-3h12a3 3 0 013 3v4z"/>
                                </svg>
                                <span>VERIFIED</span>
                            </div>
                            <div class="text-xs text-gray-600 mt-1">Digital Prescription</div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 space-y-1">
                        <p><strong>Specializations:</strong> ${doctorProfile.specializations || 'Infertility, Laparoscopic & Robotic Surgery'}</p>
                        <p><strong>Qualifications:</strong> ${doctorProfile.qualifications || 'MBBS, DNB (Gynae. & Obst.), MRCOG (I), FICRS'}</p>
                        ${doctorProfile.mobile ? `<p><strong>Contact:</strong> Mobile: ${doctorProfile.mobile}${doctorProfile.email ? `, E-mail: ${doctorProfile.email}` : ''}</p>` : ''}
                        <p><strong>Regn. No.:</strong> ${doctorProfile.regNumber || 'WBMC 71600'}</p>
                        ${doctorProfile.clinicInfo ? `<p class="mt-2"><strong>Clinic:</strong> ${doctorProfile.clinicInfo}</p>` : ''}
                    </div>
                    <div class="flex justify-between items-center mt-3 text-xs text-gray-500">
                        <div>E-PRESCRIPTION</div>
                        <div>ID: ${prescriptionId} | UUID: ${prescriptionUUID}</div>
                    </div>
                </header>
                <div class="border-b py-2 flex justify-between text-sm">
                    <div>
                        <strong>Patient:</strong> ${patient.name} (ID: ${patient.patientId || 'N/A'}) - ${patient.age}/${patient.gender.charAt(0)}
                    </div>
                    <div>
                        <strong>Date:</strong> ${consultDate}
                    </div>
                </div>
                <div class="py-4">
                    ${consultation.chiefComplaint ? `<div class="mb-4"><strong class="text-gray-700">Complaint:</strong><p>${consultation.chiefComplaint}</p></div>` : ''}
                    ${consultation.diagnosis ? `<div class="mb-4"><strong class="text-gray-700">Diagnosis:</strong><p>${consultation.diagnosis}</p></div>` : ''}
                    ${consultation.investigations ? `<div class="mb-4"><strong class="text-gray-700">Investigations:</strong><p class="text-sm whitespace-pre-wrap">${consultation.investigations}</p></div>` : ''}
                </div>
                <div>
                    <strong class="text-xl font-serif">Rx</strong>
                    <table class="w-full mt-2 text-left text-sm">
                        <thead><tr class="border-b"><th class="py-1 pr-2">Medication</th><th class="py-1 px-2">Dosage</th><th class="py-1 pl-2">Duration</th></tr></thead>
                        <tbody>${medsHtml}</tbody>
                    </table>
                </div>
                ${consultation.advice ? `<div class="mt-6 pt-4 border-t"><strong class="text-gray-700">Advice:</strong><p class="text-sm whitespace-pre-wrap">${consultation.advice}</p></div>` : ''}
                ${consultation.followUp ? `<div class="mt-4"><strong class="text-gray-700">Follow-up:</strong><p class="text-sm">${consultation.followUp}</p></div>` : ''}
                <div class="prescription-content-wrapper">
                    <!-- Main content ends here -->
                </div>
                <div class="prescription-footer" style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ccc; display: flex; justify-content: space-between; align-items: flex-end; page-break-inside: avoid;">
                    <div style="text-align: left; font-size: 12px; color: #6b7280;">
                        <p style="margin: 0;"><strong>Issue Date:</strong> ${consultDate}</p>
                        <p style="margin: 5px 0;"><strong>Time:</strong> ${timestamp.time} ${timestamp.timezone}</p>
                        ${signatureHash ? `<p style="margin: 5px 0;"><strong>Auth Hash:</strong> ${signatureHash}</p>` : ''}
                        <p style="margin: 5px 0;"><strong>Prescription ID:</strong> ${prescriptionId}</p>
                    </div>
                    
                    <div id="signatureSection" class="prescription-signature-area" style="text-align: center; width: 300px;">
                        <div style="background: #2563eb; color: white; padding: 6px 12px; border-radius: 15px; font-size: 10px; font-weight: bold; margin-bottom: 12px; display: inline-block;">
                             AUTHORIZED PRESCRIPTION
                        </div>
                        ${doctorProfile.digitalSignature ? `
                            <div style="margin-bottom: 15px;">
                                <img id="prescriptionSignature" src="${doctorProfile.digitalSignature}" alt="Digital Signature" style="max-height: 60px; max-width: 200px; display: block; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 4px; padding: 5px; background: white;">
                            </div>
                            <div class="signature-doctor-info" style="border-top: 2px solid #2563eb; padding-top: 10px; margin-top: 10px; font-size: 12px;">
                                <div style="font-weight: bold; margin-bottom: 4px; color: #1f2937;">${doctorProfile.doctorName || 'Dr. [Your Name]'}</div>
                                <div style="color: #4b5563; margin-bottom: 3px; font-size: 11px;">${doctorProfile.qualifications || 'MBBS, MD'}</div>
                                <div style="color: #6b7280; font-size: 10px; margin-bottom: 8px;">Reg. No: ${doctorProfile.regNumber || '[Registration Number]'}</div>
                                <div class="signature-verification" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 4px 8px; border-radius: 12px; font-size: 9px; font-weight: 600; display: inline-block;">
                                     DIGITALLY VERIFIED & AUTHENTICATED
                                </div>
                            </div>
                        ` : `
                            <div style="height: 60px; margin-bottom: 15px; border: 2px dashed #cbd5e1; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 11px; background: #f9fafb;">
                                 [Digital Signature Required]
                            </div>
                            <div class="signature-doctor-info" style="border-top: 2px solid #2563eb; padding-top: 10px; margin-top: 10px; font-size: 12px;">
                                <div style="font-weight: bold; margin-bottom: 4px; color: #1f2937;">${doctorProfile.doctorName || 'Dr. [Your Name]'}</div>
                                <div style="color: #6b7280; margin-bottom: 2px;">${doctorProfile.qualifications || 'MBBS, MD'}</div>
                                <div style="color: #6b7280; font-size: 11px;">Reg. No: ${doctorProfile.regNumber || '[Registration Number]'}</div>
                            </div>
                        `}
                    </div>
                </div>
                <div style="text-align: center; font-size: 10px; color: #9ca3af; margin-top: 15px;">
                    This is a digitally generated e-prescription. UUID: ${prescriptionUUID}
                </div>
            `;
            
            // Setup share button with improved error handling
            document.getElementById('shareWhatsappBtn').onclick = async () => {
                try {
                    await generateAndSharePDF(patient, consultation);
                } catch (error) {
                    console.error('Share button error:', error);
                    showNotification('Error sharing PDF. Please try again.', 'error');
                }
            };
            
            document.getElementById('downloadPdfBtn').onclick = async () => {
                try {
                    await downloadPDF(patient, consultation);
                } catch (error) {
                    console.error('Download button error:', error);
                    showNotification('Error downloading PDF. Please try again.', 'error');
                }
            };

            // Setup digital signature button
            const signPrescriptionBtn = document.getElementById('signPrescriptionBtn');
            if (signPrescriptionBtn) {
                signPrescriptionBtn.onclick = () => {
                    showDigitalSignatureModal();
                };
            }

            // Setup new action buttons
            document.getElementById('viewPrescriptionBtn').onclick = () => {
                viewPrescriptionModal(patient, consultation);
            };

            document.getElementById('verifyPrescriptionBtn').onclick = () => {
                verifyPrescriptionAuthenticity(patient, consultation);
            };

            showView('prescriptionDisplayView');
        }

        // --- LEGACY PDF GENERATION FUNCTIONS (kept for compatibility) ---
        // Note: This function generates PDF programmatically, but may not match the exact display
        // The main PDF functions now use HTML2Canvas to capture the exact display
        async function generatePDF_Legacy(patient, consultation) {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                // Set up fonts - use standard fonts that render well in PDFs
                pdf.setFont('times', 'normal');

                // Page dimensions
                const pageWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const margin = 20; // 20mm margin
                const contentWidth = pageWidth - (margin * 2);
                const contentHeight = pageHeight - (margin * 2);

                let yPosition = margin;

                // Helper function to add text with word wrapping
                function addWrappedText(text, x, y, maxWidth, fontSize = 12, fontStyle = 'normal') {
                    pdf.setFontSize(fontSize);
                    pdf.setFont('times', fontStyle);

                    const lines = pdf.splitTextToSize(text, maxWidth);
                    let currentY = y;

                    for (const line of lines) {
                        if (currentY > pageHeight - margin) {
                            pdf.addPage();
                            currentY = margin;
                        }
                        pdf.text(line, x, currentY);
                        currentY += fontSize * 0.6; // Increased line height for better readability
                    }

                    return currentY;
                }

                // Header
                pdf.setFontSize(16);
                pdf.setFont('times', 'bold');
                yPosition = addWrappedText('Dr. Chanda Chowdhury', margin, yPosition, contentWidth, 16, 'bold');
                yPosition += 2;

                pdf.setFontSize(12);
                pdf.setFont('times', 'normal');
                yPosition = addWrappedText('Consultant Gynaecologist & Obstetrician', margin, yPosition, contentWidth, 12, 'normal');
                yPosition = addWrappedText('MBBS, MS (Obstetrics & Gynaecology)', margin, yPosition, contentWidth, 12, 'normal');
                yPosition = addWrappedText('Reg. No: WBMC-12345', margin, yPosition, contentWidth, 12, 'normal');
                yPosition += 5;

                // Patient details
                pdf.setFontSize(14);
                pdf.setFont('times', 'bold');
                yPosition = addWrappedText('Patient Details:', margin, yPosition, contentWidth, 14, 'bold');
                yPosition += 3;

                pdf.setFontSize(11);
                pdf.setFont('times', 'normal');
                let patientDetailsY = yPosition;
                addWrappedText(`Name: ${patient.name}`, margin, patientDetailsY, contentWidth / 2, 11, 'normal');
                addWrappedText(`Age: ${patient.age} years`, margin + 80, patientDetailsY, contentWidth / 2, 11, 'normal');
                patientDetailsY += 7;
                addWrappedText(`Patient ID: ${patient.patientId || 'N/A'}`, margin, patientDetailsY, contentWidth / 2, 11, 'normal');
                addWrappedText(`Gender: ${patient.gender}`, margin + 80, patientDetailsY, contentWidth / 2, 11, 'normal');
                patientDetailsY += 7;
                addWrappedText(`Date: ${new Date(consultation.date).toLocaleDateString('en-IN')}`, margin, patientDetailsY, contentWidth / 2, 11, 'normal');
                yPosition = patientDetailsY + 7;

                // Prescription content
                pdf.setFontSize(14);
                pdf.setFont('times', 'bold');
                yPosition = addWrappedText('Prescription:', margin, yPosition, contentWidth, 14, 'bold');
                yPosition += 3;

                // Medicines
                if (consultation.medicines && consultation.medicines.length > 0) {
                    pdf.setFontSize(11);
                    pdf.setFont('times', 'normal');

                    consultation.medicines.forEach((medicine, index) => {
                        const medicineText = `${index + 1}. ${medicine.name} - ${medicine.dosage} - ${medicine.duration}`;
                        yPosition = addWrappedText(medicineText, margin + 5, yPosition, contentWidth - 5, 11, 'normal');
                        yPosition += 2;
                    });
                }

                yPosition += 5;

                // Advice
                if (consultation.advice) {
                    pdf.setFontSize(12);
                    pdf.setFont('times', 'bold');
                    yPosition = addWrappedText('Advice:', margin, yPosition, contentWidth, 12, 'bold');
                    yPosition += 3;

                    pdf.setFontSize(11);
                    pdf.setFont('times', 'normal');
                    yPosition = addWrappedText(consultation.advice, margin + 5, yPosition, contentWidth - 5, 11, 'normal');
                    yPosition += 5;
                }

                // Next visit
                if (consultation.nextVisit) {
                    pdf.setFontSize(12);
                    pdf.setFont('times', 'bold');
                    yPosition = addWrappedText('Next Visit:', margin, yPosition, contentWidth, 12, 'bold');
                    yPosition += 3;

                    pdf.setFontSize(11);
                    pdf.setFont('times', 'normal');
                    yPosition = addWrappedText(consultation.nextVisit, margin + 5, yPosition, contentWidth - 5, 11, 'normal');
                    yPosition += 10;
                }

                // Ensure there's enough space for footer - check if we need a new page
                const footerHeight = 55; // Increased height for signature + prescription details
                const footerStartY = pageHeight - margin - footerHeight;
                
                if (yPosition > footerStartY - 10) {
                    pdf.addPage();
                    yPosition = margin;
                }
                
                // Add some space before footer
                yPosition = Math.max(yPosition + 15, footerStartY - 20);
                
                // Draw a separator line
                pdf.setDrawColor(180, 180, 180);
                pdf.setLineWidth(0.5);
                pdf.line(margin, yPosition, pageWidth - margin, yPosition);
                
                // Generate prescription details
                const prescriptionId = 'E-RX-' + Date.now();
                const timestamp = formatMedicalTimestamp();
                const signatureHash = generateDigitalSignatureHash(prescriptionId, timestamp.iso, doctorProfile.regNumber || 'WBMC-12345');

                // Doctor signature and prescription details (right side - matching HTML layout)
                const signatureX = pageWidth - margin - 70;
                let signatureY = yPosition + 8;
                
                // Add digital signature image if available
                if (doctorProfile.digitalSignature) {
                    try {
                        // Add signature image
                        const imgWidth = 40; // mm
                        const imgHeight = 12; // mm
                        pdf.addImage(doctorProfile.digitalSignature, 'PNG', signatureX, signatureY, imgWidth, imgHeight);
                        signatureY += imgHeight + 3;
                    } catch (error) {
                        console.warn('Could not add signature image to PDF:', error);
                        signatureY += 5;
                    }
                }
                
                // Doctor signature section
                pdf.setFontSize(11);
                pdf.setFont('times', 'bold');
                pdf.text(doctorProfile.doctorName || 'Dr. Chanda Chowdhury', signatureX, signatureY);
                signatureY += 5;
                pdf.setFontSize(9);
                pdf.setFont('times', 'normal');
                pdf.text(doctorProfile.qualifications || 'MBBS, MS (Obstetrics & Gynaecology)', signatureX, signatureY);
                signatureY += 4;
                pdf.text(`Reg. No: ${doctorProfile.regNumber || 'WBMC-12345'}`, signatureX, signatureY);
                signatureY += 4;
                
                // Digital signature verification
                if (doctorProfile.digitalSignature) {
                    pdf.setFontSize(8);
                    pdf.setFont('times', 'normal');
                    pdf.text(' Digitally Signed & Verified', signatureX, signatureY);
                    signatureY += 5;
                } else {
                    signatureY += 3;
                }
                
                // Separator line under signature
                pdf.setDrawColor(200, 200, 200);
                pdf.setLineWidth(0.3);
                pdf.line(signatureX, signatureY, signatureX + 60, signatureY);
                signatureY += 5;
                
                // Prescription details under signature (matching HTML layout)
                pdf.setFontSize(8);
                pdf.setFont('times', 'bold');
                pdf.text(`Prescription ID: ${prescriptionId}`, signatureX, signatureY);
                signatureY += 3;
                pdf.text(`Issue Date: ${new Date().toLocaleDateString('en-IN')}`, signatureX, signatureY);
                signatureY += 3;
                pdf.text(`Time: ${timestamp.time} ${timestamp.timezone}`, signatureX, signatureY);
                signatureY += 3;
                if (signatureHash) {
                    pdf.text(`Auth Hash: ${signatureHash}`, signatureX, signatureY);
                }

                return pdf;
            } catch (error) {
                console.error('PDF generation error:', error);
                throw error;
            }
        }

        async function downloadPDF(patient, consultation) {
            try {
                showNotification('Generating PDF with proper page layout...', 'info');
                
                // Get the prescription content element
                const prescriptionElement = document.getElementById('prescriptionContent');
                if (!prescriptionElement) {
                    throw new Error('Prescription content not found');
                }
                
                // Ensure signature section is visible
                const signatureSection = document.getElementById('signatureSection');
                const wasHidden = signatureSection && signatureSection.classList.contains('hidden');
                if (wasHidden) {
                    signatureSection.classList.remove('hidden');
                }
                
                if (signatureSection) {
                    signatureSection.style.display = 'block';
                    signatureSection.style.visibility = 'visible';
                }
                
                // Wait for content to render
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Create a temporary container with desktop-optimized styles for PDF
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = prescriptionElement.innerHTML;
                
                // Apply desktop-optimized styles for proper page layout
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.style.background = 'white';
                tempContainer.style.width = '800px'; // Fixed desktop width
                tempContainer.style.maxWidth = '800px';
                tempContainer.style.padding = '2rem'; // Desktop padding
                tempContainer.style.margin = '0 auto';
                tempContainer.style.boxShadow = 'none';
                tempContainer.style.borderTop = '6px solid #2563eb';
                tempContainer.style.minHeight = '750px';
                tempContainer.style.fontSize = '14px';
                tempContainer.style.lineHeight = '1.5';
                
                // Ensure all child elements inherit proper styling
                const allElements = tempContainer.querySelectorAll('*');
                allElements.forEach(el => {
                    el.style.boxSizing = 'border-box';
                    el.style.maxWidth = '100%';
                    // Ensure text is properly sized for PDF
                    if (el.tagName === 'P' || el.tagName === 'DIV') {
                        el.style.marginBottom = '0.5rem';
                    }
                });
                
                document.body.appendChild(tempContainer);
                
                // Wait for the temporary container to render
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Capture with html2canvas using desktop-optimized settings
                const canvas = await html2canvas(tempContainer, {
                    scale: 2.5, // Optimized scale for A4 print quality (300 DPI equivalent)
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: 800, // Fixed width for consistent layout
                    height: tempContainer.offsetHeight,
                    logging: false,
                    letterRendering: true,
                    fontLoadTimeout: 15000,
                    imageTimeout: 15000,
                    removeContainer: true,
                    onclone: (clonedDoc) => {
                        // Apply exact same styling to cloned document
                        const clonedTemp = clonedDoc.body.lastElementChild;
                        if (clonedTemp) {
                            clonedTemp.style.width = '800px';
                            clonedTemp.style.maxWidth = '800px';
                            clonedTemp.style.padding = '2rem';
                            clonedTemp.style.margin = '0';
                            clonedTemp.style.boxShadow = 'none';
                            clonedTemp.style.fontSize = '14px';
                            clonedTemp.style.lineHeight = '1.5';
                            
                            // Ensure all text is sharp
                            const clonedElements = clonedTemp.querySelectorAll('*');
                            clonedElements.forEach(el => {
                                el.style.webkitFontSmoothing = 'antialiased';
                                el.style.mozOsxFontSmoothing = 'grayscale';
                                el.style.boxSizing = 'border-box';
                                if (el.tagName === 'P' || el.tagName === 'DIV') {
                                    el.style.marginBottom = '0.5rem';
                                }
                            });
                        }
                    }
                });
                
                // Remove temporary container
                document.body.removeChild(tempContainer);
                
                const imgData = canvas.toDataURL('image/png', 1.0);
                
                // Create PDF with optimized A4 dimensions for printing and sharing
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    putOnlyUsedFonts: true,
                    floatPrecision: 16 // High precision for better quality
                });
                
                // Standard A4 dimensions (210  297 mm)
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 12; // Reduced margin for better content utilization
                
                // Calculate optimal image dimensions
                const maxWidth = pageWidth - (margin * 2);
                const maxHeight = pageHeight - (margin * 2);
                
                // Calculate scaling to fit A4 while maintaining aspect ratio
                const scaleX = maxWidth / canvas.width;
                const scaleY = maxHeight / canvas.height;
                const scale = Math.min(scaleX, scaleY, 1); // Don't upscale
                
                const finalWidth = canvas.width * scale;
                const finalHeight = canvas.height * scale;
                
                // Center the content on A4 page
                const xPos = (pageWidth - finalWidth) / 2;
                const yPos = (pageHeight - finalHeight) / 2;
                
                // Add image with optimized compression for sharing
                pdf.addImage(imgData, 'PNG', xPos, yPos, finalWidth, finalHeight, undefined, 'MEDIUM');
                
                // Add PDF metadata for better organization
                pdf.setProperties({
                    title: `Medical Prescription - ${patient.name}`,
                    subject: 'Medical Prescription',
                    author: doctorProfile.name || 'Doctor',
                    creator: 'Medical Records App',
                    producer: 'jsPDF',
                    keywords: 'prescription, medical, healthcare'
                });
                
                // Generate filename
                const fileName = `Prescription_${patient.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                // Download PDF
                pdf.save(fileName);
                
                // Restore hidden state if it was hidden
                if (wasHidden && signatureSection) {
                    signatureSection.classList.add('hidden');
                }
                
                showNotification('PDF downloaded successfully!', 'success');
            } catch (error) {
                console.error('PDF download error:', error);
                showNotification('Error generating PDF. Please try again.', 'error');
            }
        }

        async function generateAndSharePDF(patient, consultation) {
            try {
                showNotification('Preparing PDF for WhatsApp share...', 'info');
                
                // Get the prescription content element
                const prescriptionElement = document.getElementById('prescriptionContent');
                if (!prescriptionElement) {
                    throw new Error('Prescription content not found');
                }
                
                // Ensure signature section is visible
                const signatureSection = document.getElementById('signatureSection');
                const wasHidden = signatureSection && signatureSection.classList.contains('hidden');
                if (wasHidden) {
                    signatureSection.classList.remove('hidden');
                }
                
                if (signatureSection) {
                    signatureSection.style.display = 'block';
                    signatureSection.style.visibility = 'visible';
                }
                
                // Wait for content to render
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Create a temporary container with desktop-optimized styles for PDF
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = prescriptionElement.innerHTML;
                
                // Apply desktop-optimized styles for proper page layout
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.style.background = 'white';
                tempContainer.style.width = '800px'; // Fixed desktop width
                tempContainer.style.maxWidth = '800px';
                tempContainer.style.padding = '2rem'; // Desktop padding
                tempContainer.style.margin = '0 auto';
                tempContainer.style.boxShadow = 'none';
                tempContainer.style.borderTop = '6px solid #2563eb';
                tempContainer.style.minHeight = '750px';
                tempContainer.style.fontSize = '14px';
                tempContainer.style.lineHeight = '1.5';
                
                // Ensure all child elements inherit proper styling
                const allElements = tempContainer.querySelectorAll('*');
                allElements.forEach(el => {
                    el.style.boxSizing = 'border-box';
                    el.style.maxWidth = '100%';
                    // Ensure text is properly sized for PDF
                    if (el.tagName === 'P' || el.tagName === 'DIV') {
                        el.style.marginBottom = '0.5rem';
                    }
                });
                
                document.body.appendChild(tempContainer);
                
                // Wait for the temporary container to render
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Capture with html2canvas using desktop-optimized settings
                const canvas = await html2canvas(tempContainer, {
                    scale: 3, // Higher scale for better quality
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: 800, // Fixed width for consistent layout
                    height: tempContainer.offsetHeight,
                    logging: false,
                    letterRendering: true,
                    imageTimeout: 20000,
                    onclone: (clonedDoc) => {
                        const clonedTemp = clonedDoc.body.lastElementChild;
                        if (clonedTemp) {
                            // Ensure cloned element has proper desktop styling
                            clonedTemp.style.width = '800px';
                            clonedTemp.style.maxWidth = '800px';
                            clonedTemp.style.padding = '2rem';
                            clonedTemp.style.margin = '0';
                            clonedTemp.style.boxShadow = 'none';
                            clonedTemp.style.fontSize = '14px';
                            clonedTemp.style.lineHeight = '1.5';
                            
                            // Ensure all text is sharp and properly formatted
                            const clonedElements = clonedTemp.querySelectorAll('*');
                            clonedElements.forEach(el => {
                                el.style.webkitFontSmoothing = 'antialiased';
                                el.style.mozOsxFontSmoothing = 'grayscale';
                                el.style.boxSizing = 'border-box';
                                if (el.tagName === 'P' || el.tagName === 'DIV') {
                                    el.style.marginBottom = '0.5rem';
                                }
                            });
                        }
                    }
                });
                
                // Remove temporary container
                document.body.removeChild(tempContainer);
                
                const imgData = canvas.toDataURL('image/png', 1.0);
                
                // Create PDF with proper page layout dimensions
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    putOnlyUsedFonts: true,
                    floatPrecision: 16
                });
                
                // A4 dimensions: 210  297 mm
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15; // Generous margins for professional look
                
                // Calculate dimensions to fit the content properly on the page
                const contentWidth = pageWidth - (margin * 2);
                const contentHeight = pageHeight - (margin * 2);
                
                // Calculate scaling to maintain aspect ratio and fit on page
                const scaleX = contentWidth / canvas.width;
                const scaleY = contentHeight / canvas.height;
                const scale = Math.min(scaleX, scaleY, 1); // Don't upscale
                
                const finalWidth = canvas.width * scale;
                const finalHeight = canvas.height * scale;
                
                // Center the content on the A4 page
                const xPos = (pageWidth - finalWidth) / 2;
                const yPos = margin;
                
                // Add the image with high quality compression
                pdf.addImage(imgData, 'PNG', xPos, yPos, finalWidth, finalHeight, undefined, 'FAST');
                
                // Add PDF metadata
                pdf.setProperties({
                    title: `Medical Prescription - ${patient.name}`,
                    subject: 'Medical Prescription',
                    author: doctorProfile.doctorName || 'Doctor',
                    creator: 'Medical Records App',
                    producer: 'jsPDF',
                    keywords: 'prescription, medical, healthcare'
                });
                
                // Convert PDF to blob
                const pdfBlob = pdf.output('blob');
                
                // Generate filename
                const consultDate = new Date(consultation.date).toLocaleDateString('en-IN');
                const fileName = `Prescription_${patient.name.replace(/\s+/g, '_')}_${consultDate.replace(/\//g, '-')}.pdf`;
                
                // Generate WhatsApp message
                const message = ` *E-PRESCRIPTION*\n\n*${doctorProfile.doctorName || 'Dr. Chanda Chowdhury'}*\nConsultant Gynaecologist & Obstetrician\n\n*Patient:* ${patient.name} (ID: ${patient.patientId || 'N/A'})\n*Date:* ${consultDate}\n\nPrescription PDF is ready for sharing.`;
                
                // Check if Web Share API is available
                if (navigator.share && navigator.canShare) {
                    try {
                        // Create a File object from the blob
                        const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                        
                        if (navigator.canShare({ files: [file] })) {
                            await navigator.share({
                                title: 'Medical Prescription',
                                text: message,
                                files: [file]
                            });
                            
                            // Restore hidden state if it was hidden
                            if (wasHidden && signatureSection) {
                                signatureSection.classList.add('hidden');
                            }
                            
                            showNotification('PDF shared successfully!', 'success');
                            return;
                        }
                    } catch (shareError) {
                        console.warn('Web Share API failed:', shareError);
                    }
                }
                
                // Fallback: Download PDF and open WhatsApp with text
                const link = document.createElement('a');
                link.href = URL.createObjectURL(pdfBlob);
                link.download = fileName;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up the object URL after a delay
                setTimeout(() => URL.revokeObjectURL(link.href), 1000);
                
                // Restore hidden state if it was hidden
                if (wasHidden && signatureSection) {
                    signatureSection.classList.add('hidden');
                }
                
                // Open WhatsApp with text message (encode for URL)
                const encodedMessage = encodeURIComponent(message + '\n\n(PDF file has been downloaded to your device - please attach it manually)');
                
                // Try different WhatsApp approaches
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile) {
                    // Mobile: try WhatsApp app first
                    window.open(`whatsapp://send?text=${encodedMessage}`, '_blank');
                } else {
                    // Desktop: use WhatsApp Web
                    window.open(`https://web.whatsapp.com/send?text=${encodedMessage}`, '_blank');
                }
                
                showNotification('PDF downloaded! WhatsApp opened - please attach the PDF manually.', 'success');
                
            } catch (error) {
                console.error('PDF sharing error:', error);
                showNotification('Error generating PDF. Please try again.', 'error');
            }
        }

        // --- NOTIFICATION SYSTEM ---
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 translate-x-full`;
            
            // Set color based on type
            let bgColor, textColor, icon;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    textColor = 'text-white';
                    icon = 'check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    textColor = 'text-white';
                    icon = 'x-circle';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-blue-500';
                    textColor = 'text-white';
                    icon = 'info';
                    break;
            }
            
            notification.classList.add(bgColor, textColor);
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i data-lucide="${icon}" class="w-5 h-5"></i>
                    <span class="text-sm font-medium">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Initialize lucide icons for the notification
            lucide.createIcons();
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 4000);
        }

        // --- ACTIONS & EVENT HANDLERS ---
        function attachEventListeners() {
            try {
                // Setup age calculation from DOB
                setupAgeCalculation();
                
                // Setup follow-up handlers
                setupFollowUpHandlers();
                
                // Setup vitals and modal handlers
                setupVitalsAndModals();
                
                // Navigation
                const addPatientBtn = document.getElementById('addPatientBtn');
                if (addPatientBtn) {
                    addPatientBtn.onclick = () => {
                        document.getElementById('patientForm').reset();
                        document.getElementById('patientId').value = '';
                        document.getElementById('patientFormTitle').textContent = 'Add New Patient';
                        // Display the Patient ID that will be assigned
                        document.getElementById('displayPatientId').textContent = generatePatientId();
                        showView('patientFormView');
                    };
                }
                
                const cancelPatientForm = document.getElementById('cancelPatientForm');
                if (cancelPatientForm) {
                    cancelPatientForm.onclick = () => showView('patientListView');
                }
                
                const backToPatientList = document.getElementById('backToPatientList');
                if (backToPatientList) {
                    backToPatientList.onclick = () => showView('patientListView');
                }
                
                const settingsBtn = document.getElementById('settingsBtn');
                console.log('Found settings button:', !!settingsBtn);
                if (settingsBtn) {
                    // Remove any existing event listeners
                    settingsBtn.onclick = null;
                    
                    settingsBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('Settings button clicked');
                        try {
                            const settingsForm = document.getElementById('settingsForm');
                            if (settingsForm) {
                                settingsForm.reset();
                            } else {
                                console.warn('Settings form not found');
                            }
                            
                            if(doctorProfile) {
                                const fields = ['doctorName', 'title', 'specializations', 'qualifications', 'mobile', 'email', 'regNumber', 'clinicInfo'];
                                fields.forEach(field => {
                                    const element = document.getElementById(field);
                                    if (element) {
                                        element.value = doctorProfile[field] || '';
                                    }
                                });
                            }
                        
                        // Load AI settings
                        const geminiApiKeyElement = document.getElementById('geminiApiKey');
                        const geminiModelElement = document.getElementById('geminiModel');
                        const aiEnabledElement = document.getElementById('aiEnabled');
                        
                        if (geminiApiKeyElement) {
                            geminiApiKeyElement.value = localStorage.getItem('gemini_api_key') || '';
                        }
                        if (geminiModelElement) {
                            geminiModelElement.value = localStorage.getItem('gemini_model') || 'gemini-2.5-flash';
                        }
                        if (aiEnabledElement) {
                            aiEnabledElement.checked = AI_CONFIG.enabled;
                        }
                        
                        // Load GitHub settings
                        const githubTokenElement = document.getElementById('githubToken');
                        const githubUsernameElement = document.getElementById('githubUsername');
                        const githubRepoElement = document.getElementById('githubRepo');
                        const githubSyncEnabledElement = document.getElementById('githubSyncEnabled');
                        
                        if (githubTokenElement) {
                            githubTokenElement.value = localStorage.getItem('github_token') || '';
                        }
                        if (githubUsernameElement) {
                            githubUsernameElement.value = localStorage.getItem('github_username') || '';
                        }
                        if (githubRepoElement) {
                            githubRepoElement.value = localStorage.getItem('github_repo') || '';
                        }
                        if (githubSyncEnabledElement) {
                            githubSyncEnabledElement.checked = localStorage.getItem('github_sync_enabled') === 'true';
                        }
                        
                        // Update GitHub status
                        updateGitHubStatus();
                        
                        // Show API test results section if it exists
                        const apiTestResults = document.getElementById('apiTestResults');
                        if (apiTestResults) {
                            apiTestResults.classList.add('hidden'); // Start hidden
                        }
                        
                        showView('settingsView');
                        
                        // Ensure signature setup section is visible
                        setTimeout(() => {
                            const setupSection = document.getElementById('signatureSetupSection');
                            const statusSection = document.getElementById('signatureStatus');
                            
                            if (setupSection) {
                                setupSection.style.display = 'block';
                                setupSection.style.visibility = 'visible';
                            }
                            if (statusSection) {
                                statusSection.classList.add('hidden');
                            }
                            
                            setupDigitalSignature();
                        }, 100);
                        } catch (error) {
                            console.error('Error in settings button:', error);
                            // Still show the settings view even if there's an error loading data
                            showView('settingsView');
                        }
                    });
                } else {
                    console.error('Settings button not found in DOM');
                }
                
                const backToPatientListFromSettings = document.getElementById('backToPatientListFromSettings');
                if (backToPatientListFromSettings) {
                    backToPatientListFromSettings.onclick = () => showView('patientListView');
                }

                const addConsultationBtn = document.getElementById('addConsultationBtn');
                if (addConsultationBtn) {
                    addConsultationBtn.onclick = () => {
                        document.getElementById('consultationForm').reset();
                        document.getElementById('consultationPatientId').value = currentPatientId;
                        document.getElementById('medicationsContainer').innerHTML = `
                            <div class="flex justify-between items-center">
                                <label class="block text-sm font-medium text-gray-700">Medications (Rx)</label>
                                <div class="flex space-x-2">
                                    <button type="button" id="aiMedicationBtn" class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded hover:bg-purple-200 flex items-center space-x-1" title="AI Medication Suggestions">
                                        <i data-lucide="sparkles" class="w-3 h-3"></i>
                                        <span>AI Suggest</span>
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // Event listeners handled by event delegation - no need to re-attach
                        console.log('Medication buttons created, event delegation will handle clicks');
                        
                        addMedicationField({name:'', dosage:'', duration:''});
                        showView('consultationFormView');
                        
                        // Recreate icons for new buttons
                        lucide.createIcons();
                    };
                }
                
                const cancelConsultationForm = document.getElementById('cancelConsultationForm');
                if (cancelConsultationForm) {
                    cancelConsultationForm.onclick = () => showView('patientDetailView');
                }
                
                const backToPatientDetail = document.getElementById('backToPatientDetail');
                if (backToPatientDetail) {
                    backToPatientDetail.onclick = () => showView('patientDetailView');
                }
                
                const backToPatientDetailFromRx = document.getElementById('backToPatientDetailFromRx');
                if (backToPatientDetailFromRx) {
                    backToPatientDetailFromRx.onclick = () => showView('patientDetailView');
                }
                
                const addMedicationBtn = document.getElementById('addMedicationBtn');
                if (addMedicationBtn) {
                    addMedicationBtn.onclick = () => addMedicationField();
                }

                // Forms
                const patientForm = document.getElementById('patientForm');
                if (patientForm) {
                    patientForm.onsubmit = savePatient;
                }
                
                const settingsForm = document.getElementById('settingsForm');
                if (settingsForm) {
                    settingsForm.onsubmit = saveSettings;
                }
                
                // API Test Buttons
                const testAI = document.getElementById('testAIConnection');
                if (testAI) {
                    testAI.onclick = testAIConnection;
                }
                
                // Debug AI Configuration Button
                const debugAI = document.getElementById('debugAIConfig');
                if (debugAI) {
                    debugAI.onclick = () => {
                        checkAIConfiguration();
                        alert('AI Configuration diagnostic completed. Check the browser console (F12) for detailed results.');
                    };
                }
                
                // Legacy button support
                const testGemini = document.getElementById('testGeminiConnection');
                if (testGemini) {
                    testGemini.onclick = testGeminiConnection;
                }
                
                const testDiagnosisAIBtn = document.getElementById('testDiagnosisAI');
                if (testDiagnosisAIBtn) {
                    testDiagnosisAIBtn.onclick = testDiagnosisAI;
                }
                
                const debugDiagnosisAIBtn = document.getElementById('debugDiagnosisAI');
                if (debugDiagnosisAIBtn) {
                    debugDiagnosisAIBtn.onclick = () => {
                        if (window.debugAIDiagnosis) {
                            window.debugAIDiagnosis();
                        }
                    };
                }
                
                // GitHub Sync Event Listeners
                const testGitHubBtn = document.getElementById('testGitHubConnection');
                if (testGitHubBtn) {
                    testGitHubBtn.onclick = testGitHubConnection;
                }
                
                const syncToGitHubBtn = document.getElementById('syncToGitHub');
                if (syncToGitHubBtn) {
                    syncToGitHubBtn.onclick = () => syncDataToGitHub();
                }
                
                const syncFromGitHubBtn = document.getElementById('syncFromGitHub');
                if (syncFromGitHubBtn) {
                    syncFromGitHubBtn.onclick = () => syncDataFromGitHub();
                }
                
                const consultationForm = document.getElementById('consultationForm');
                if (consultationForm) {
                    consultationForm.onsubmit = saveConsultation;
                }

                // Search
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.oninput = renderPatientList;
                }
                
                // Patient Filter Buttons
                const filterButtons = document.querySelectorAll('.patient-filter-btn');
                filterButtons.forEach(btn => {
                    btn.onclick = (e) => {
                        // Remove active class from all filter buttons
                        filterButtons.forEach(b => {
                            b.classList.remove('active', 'bg-blue-100', 'text-blue-700');
                            b.classList.add('bg-gray-100', 'text-gray-700');
                        });
                        
                        // Add active class to clicked button
                        e.target.classList.add('active', 'bg-blue-100', 'text-blue-700');
                        e.target.classList.remove('bg-gray-100', 'text-gray-700');
                        
                        // Re-render patient list with new filter
                        renderPatientList();
                    };
                });

                // Prescription Actions
                const printBtn = document.getElementById('printBtn');
                if (printBtn) {
                    printBtn.onclick = () => {
                        const prescriptionElement = document.getElementById('prescriptionContent');
                        const signatureSection = document.getElementById('signatureSection');
                        
                        // Ensure signature is visible for printing
                        const wasHidden = signatureSection && signatureSection.classList.contains('hidden');
                        if (wasHidden) {
                            signatureSection.classList.remove('hidden');
                        }
                        
                        if (signatureSection) {
                            signatureSection.style.display = 'block';
                            signatureSection.style.visibility = 'visible';
                        }
                        
                        if (prescriptionElement) {
                            prescriptionElement.classList.add('printing');
                        }
                        
                        // Small delay to ensure styles are applied
                        setTimeout(() => {
                            window.print();
                            
                            // Restore original state after printing
                            setTimeout(() => {
                                if (prescriptionElement) {
                                    prescriptionElement.classList.remove('printing');
                                }
                                if (wasHidden && signatureSection) {
                                    signatureSection.classList.add('hidden');
                                }
                            }, 1000);
                        }, 100);
                    };
                }
                
                // AI Assistant Buttons
                setupAIAssistants();
                
                // Data Management
                setupDataManagement();
                
                // Digital Signature Setup
                setupDigitalSignature();
                
                // Patient form enhancements
                setupPatientFormEnhancements();
                
                // Setup signature modals and canvas
                setupDigitalSignatureModal();
                
                // Setup medical certificates
                setupMedicalCertificates();
                
                // Add event delegation for dynamically created AI buttons
                document.body.addEventListener('click', function(e) {
                    // Check for AI Medication button
                    if (e.target.id === 'aiMedicationBtn' || e.target.closest('#aiMedicationBtn')) {
                        e.preventDefault();
                        console.log('AI Medication button clicked via event delegation');
                        suggestMedications();
                        return;
                    }
                    // Alternative check using classes for buttons with sparkles icon
                    const clickedButton = e.target.closest('button');
                    if (clickedButton && clickedButton.title === 'AI Medication Suggestions') {
                        e.preventDefault();
                        console.log('AI Medication button clicked via title match');
                        suggestMedications();
                        return;
                    }
                });
                
            } catch (error) {
                console.error('Error attaching event listeners:', error);
                showNotification('Some features may not work properly. Please reload the page.', 'error');
            }
            
            // Initialize Lucide icons to ensure all buttons render properly
            if (window.lucide) {
                window.lucide.createIcons();
            }
            
            // Debug information
            console.log('Settings button found:', !!document.getElementById('settingsBtn'));
            console.log('Settings view found:', !!document.getElementById('settingsView'));
            console.log('AI Medication button found:', !!document.getElementById('aiMedicationBtn'));
            console.log('AI_CONFIG status:', {
                enabled: AI_CONFIG.enabled,
                hasApiKey: !!AI_CONFIG.gemini.apiKey,
                apiKeyLength: AI_CONFIG.gemini.apiKey?.length,
                model: AI_CONFIG.gemini.model
            });
            
            // Test AI medication suggestions functionality 
            window.testAIMedications = function() {
                console.log('Testing AI medication suggestions...');
                // Set some test data
                document.getElementById('diagnosis').value = 'PCOS';
                document.getElementById('chiefComplaint').value = 'Irregular periods and weight gain';
                // Call the function
                suggestMedications();
            };
            
            console.log('Added testAIMedications() function for debugging');
            
            // Fallback setup for settings button (in case of timing issues)
            setTimeout(() => {
                const settingsBtn = document.getElementById('settingsBtn');
                if (settingsBtn && !settingsBtn.onclick && !settingsBtn.hasAttribute('data-listener-attached')) {
                    console.log('Setting up fallback settings button handler');
                    settingsBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('Fallback settings button clicked');
                        showView('settingsView');
                    });
                    settingsBtn.setAttribute('data-listener-attached', 'true');
                }
            }, 1000);
            
            // Add mobile-specific event listener for settings view
            if (isMobileDevice()) {
                console.log('Setting up mobile-specific settings view listener');
                document.addEventListener('settingsViewLoaded', function() {
                    console.log('Settings view loaded on mobile, re-initializing digital signature');
                    setTimeout(() => initializeDigitalSignature(), 100);
                });
            }
        }
        
        function setupPatientFormEnhancements() {
            // BMI calculation
            document.getElementById('patientHeight').addEventListener('input', updateBMIDisplay);
            document.getElementById('patientWeight').addEventListener('input', updateBMIDisplay);
            
            // Gynecological section toggle
            document.getElementById('patientGender').addEventListener('change', showGynecologicalSection);
        }
        
        function setupVitalsAndModals() {
            // Patient detail buttons
            document.getElementById('viewPatientProfileBtn').onclick = () => showPatientProfileModal();
            document.getElementById('addVitalsBtn').onclick = () => showVitalsModal();
            document.getElementById('uploadTestResultBtn').onclick = () => showTestUploadModal();
            document.getElementById('generateAIReportBtn').onclick = () => generateAIPatientSummary();
            
            // Patient tab switching
            document.querySelectorAll('.patient-tab-btn').forEach(btn => {
                btn.onclick = () => switchPatientTab(btn.getAttribute('data-tab'));
            });
            
            // Modal close buttons
            document.getElementById('closeProfileModal').onclick = () => {
                document.getElementById('patientProfileModal').classList.add('hidden');
            };
            document.getElementById('closeVitalsModal').onclick = () => {
                clearVitalsForm();
                document.getElementById('vitalsModal').classList.add('hidden');
            };

            // Close modal when clicking outside
            document.getElementById('vitalsModal').onclick = (e) => {
                if (e.target === document.getElementById('vitalsModal')) {
                    clearVitalsForm();
                    document.getElementById('vitalsModal').classList.add('hidden');
                }
            };
            document.getElementById('closeTestUploadModal').onclick = () => {
                document.getElementById('testUploadModal').classList.add('hidden');
            };
            
            // Form submissions
            document.getElementById('vitalsForm').onsubmit = saveVitalsRecord;
            document.getElementById('testUploadForm').onsubmit = saveTestResultRecord;
            
            // Cancel buttons
            document.getElementById('cancelVitalsForm').onclick = () => {
                clearVitalsForm();
                document.getElementById('vitalsModal').classList.add('hidden');
            };
            document.getElementById('cancelTestUploadForm').onclick = () => {
                document.getElementById('testUploadModal').classList.add('hidden');
            };
        }
        
        function switchPatientTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.patient-tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600', 'font-medium');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Hide all tab contents
            document.querySelectorAll('.patient-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected tab
            const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
            selectedBtn.classList.add('border-blue-500', 'text-blue-600', 'font-medium');
            selectedBtn.classList.remove('border-transparent', 'text-gray-500');
            
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
            
            // Load content based on tab
            if (tabName === 'consultations') {
                loadConsultationHistory();
            } else if (tabName === 'vitals') {
                loadVitalsHistory();
            } else if (tabName === 'tests') {
                loadTestResultsHistory();
            } else if (tabName === 'certificates') {
                renderCertificatesList();
            }
        }
        
        function showPatientProfileModal() {
            const patient = patients.find(p => p.id === currentPatientId);
            if (!patient) return;
            
            const modal = document.getElementById('patientProfileModal');
            const content = document.getElementById('patientProfileContent');
            
            content.innerHTML = generatePatientProfileHTML(patient);
            modal.classList.remove('hidden');
            lucide.createIcons();
        }
        
        function generatePatientProfileHTML(patient) {
            return `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">Basic Information</h4>
                            <div class="space-y-1 text-sm">
                                <p><strong>Name:</strong> ${patient.name}</p>
                                <p><strong>Patient ID:</strong> ${patient.patientId || 'N/A'}</p>
                                <p><strong>Age:</strong> ${patient.age} years</p>
                                <p><strong>Gender:</strong> ${patient.gender}</p>
                                <p><strong>Contact:</strong> ${patient.contact || 'Not provided'}</p>
                                <p><strong>Email:</strong> ${patient.email || 'Not provided'}</p>
                                <p><strong>Address:</strong> ${patient.address || 'Not provided'}</p>
                            </div>
                        </div>
                        
                        ${patient.height || patient.weight || patient.bloodPressure || patient.temperature ? `
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-800 mb-2">Latest Vitals</h4>
                            <div class="space-y-1 text-sm">
                                ${patient.height ? `<p><strong>Height:</strong> ${patient.height} cm</p>` : ''}
                                ${patient.weight ? `<p><strong>Weight:</strong> ${patient.weight} kg</p>` : ''}
                                ${patient.height && patient.weight ? `<p><strong>BMI:</strong> ${calculateBMI(patient.height, patient.weight)}</p>` : ''}
                                ${patient.bloodPressure ? `<p><strong>BP:</strong> ${patient.bloodPressure}</p>` : ''}
                                ${patient.temperature ? `<p><strong>Temperature:</strong> ${patient.temperature}F</p>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${patient.drugAllergies || patient.foodAllergies ? `
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-red-800 mb-2">Allergies</h4>
                            <div class="space-y-1 text-sm">
                                ${patient.drugAllergies ? `<p><strong>Drug Allergies:</strong> ${patient.drugAllergies}</p>` : ''}
                                ${patient.foodAllergies ? `<p><strong>Food Allergies:</strong> ${patient.foodAllergies}</p>` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="space-y-4">
                        ${patient.medicalHistory || patient.surgicalHistory || patient.medicationHistory ? `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-2">Medical History</h4>
                            <div class="space-y-2 text-sm">
                                ${patient.medicalHistory ? `<p><strong>Past Medical:</strong> ${patient.medicalHistory}</p>` : ''}
                                ${patient.surgicalHistory ? `<p><strong>Surgical:</strong> ${patient.surgicalHistory}</p>` : ''}
                                ${patient.medicationHistory ? `<p><strong>Current Medications:</strong> ${patient.medicationHistory}</p>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${patient.gender === 'Female' && (patient.menarche || patient.menstrualCycle || patient.gravida || patient.para) ? `
                        <div class="bg-pink-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-pink-800 mb-2">Gynecological History</h4>
                            <div class="space-y-1 text-sm">
                                ${patient.menarche ? `<p><strong>Menarche:</strong> ${patient.menarche} years</p>` : ''}
                                ${patient.menstrualCycle ? `<p><strong>Cycle:</strong> ${patient.menstrualCycle} days</p>` : ''}
                                ${patient.lastMenstrualPeriod ? `<p><strong>LMP:</strong> ${new Date(patient.lastMenstrualPeriod).toLocaleDateString()}</p>` : ''}
                                ${patient.gravida ? `<p><strong>G:</strong> ${patient.gravida}</p>` : ''}
                                ${patient.para ? `<p><strong>P:</strong> ${patient.para}</p>` : ''}
                                ${patient.abortions ? `<p><strong>A:</strong> ${patient.abortions}</p>` : ''}
                                ${patient.living ? `<p><strong>L:</strong> ${patient.living}</p>` : ''}
                                ${patient.contraceptiveHistory ? `<p><strong>Contraception:</strong> ${patient.contraceptiveHistory}</p>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${patient.familyHistory ? `
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-yellow-800 mb-2">Family History</h4>
                            <p class="text-sm">${patient.familyHistory}</p>
                        </div>
                        ` : ''}
                        
                        ${patient.smokingHistory || patient.alcoholHistory || patient.exerciseHabits || patient.occupationalHistory ? `
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-purple-800 mb-2">Lifestyle & Habits</h4>
                            <div class="space-y-1 text-sm">
                                ${patient.smokingHistory ? `<p><strong>Smoking:</strong> ${patient.smokingHistory}</p>` : ''}
                                ${patient.alcoholHistory ? `<p><strong>Alcohol:</strong> ${patient.alcoholHistory}</p>` : ''}
                                ${patient.exerciseHabits ? `<p><strong>Exercise:</strong> ${patient.exerciseHabits}</p>` : ''}
                                ${patient.occupationalHistory ? `<p><strong>Occupation:</strong> ${patient.occupationalHistory}</p>` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="editPatient('${patient.id}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        <i data-lucide="edit" class="w-4 h-4 inline mr-2"></i>
                        Edit Profile
                    </button>
                </div>
            `;
        }
        
        function clearVitalsForm() {
            document.getElementById('vitalsForm').reset();
            // Reset all select dropdowns specifically
            document.getElementById('vitalCycle').value = '';
            document.getElementById('vitalFlow').value = '';
            document.getElementById('vitalAnaemia').value = '';
            document.getElementById('vitalOedema').value = '';
        }
        
        function showVitalsModal() {
            const modal = document.getElementById('vitalsModal');
            clearVitalsForm();
            modal.classList.remove('hidden');
            // Scroll modal content to top
            const modalContent = modal.querySelector('.bg-white');
            if (modalContent) {
                modalContent.scrollTop = 0;
            }
            // Focus on first input
            setTimeout(() => {
                const firstInput = modal.querySelector('input');
                if (firstInput) firstInput.focus();
            }, 100);
        }
        
        function showTestUploadModal() {
            const modal = document.getElementById('testUploadModal');
            document.getElementById('testUploadForm').reset();
            document.getElementById('testDate').value = new Date().toISOString().split('T')[0];
            modal.classList.remove('hidden');
        }
        
        async function saveVitalsRecord(e) {
            e.preventDefault();
            
            const vital = {
                id: generateId(),
                date: new Date().toISOString(),
                height: document.getElementById('vitalHeight').value,
                weight: document.getElementById('vitalWeight').value,
                bloodPressure: document.getElementById('vitalBP').value,
                temperature: document.getElementById('vitalTemp').value,
                pulse: document.getElementById('vitalPulse').value,
                // Gynecology-specific fields
                // Menstrual cycle information
                lmp: document.getElementById('vitalLMP').value,
                cycle: document.getElementById('vitalCycle').value,
                flow: document.getElementById('vitalFlow').value,
                cycleDuration: document.getElementById('vitalCycleDuration').value,
                // Other gynecological fields
                anaemia: document.getElementById('vitalAnaemia').value,
                oedema: document.getElementById('vitalOedema').value,
                uterusHeight: document.getElementById('vitalUterusHeight').value,
                perAbdomen: document.getElementById('vitalPA').value,
                perVaginum: document.getElementById('vitalPV').value,
                perSpeculum: document.getElementById('vitalPS').value,
                notes: document.getElementById('vitalNotes').value
            };
            
            try {
                saveVital(currentPatientId, vital);
                showNotification('Vitals recorded successfully!', 'success');
                clearVitalsForm();
                document.getElementById('vitalsModal').classList.add('hidden');
                
                // Update patient's latest vitals in main record
                const patient = patients.find(p => p.id === currentPatientId);
                if (patient) {
                    if (vital.height) patient.height = vital.height;
                    if (vital.weight) patient.weight = vital.weight;
                    if (vital.bloodPressure) patient.bloodPressure = vital.bloodPressure;
                    if (vital.temperature) patient.temperature = vital.temperature;
                    savePatients();
                }
                
                // Refresh vitals tab if currently showing
                if (!document.getElementById('vitalsTab').classList.contains('hidden')) {
                    loadVitalsHistory();
                }
            } catch (error) {
                console.error('Error saving vitals:', error);
                showNotification('Error saving vitals', 'error');
            }
        }
        
        async function saveTestResultRecord(e) {
            e.preventDefault();
            
            const file = document.getElementById('testFile').files[0];
            let fileData = null;
            
            if (file) {
                try {
                    fileData = await convertFileToBase64(file);
                } catch (error) {
                    showNotification('Error processing file', 'error');
                    return;
                }
            }
            
            const testResult = {
                id: generateId(),
                name: document.getElementById('testName').value,
                date: document.getElementById('testDate').value,
                uploadDate: new Date().toISOString(),
                notes: document.getElementById('testNotes').value,
                file: fileData ? {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: fileData
                } : null
            };
            
            try {
                saveTestResult(currentPatientId, testResult);
                showNotification('Test result uploaded successfully!', 'success');
                document.getElementById('testUploadModal').classList.add('hidden');
                
                // Refresh tests tab if currently showing
                if (!document.getElementById('testsTab').classList.contains('hidden')) {
                    loadTestResultsHistory();
                }
            } catch (error) {
                console.error('Error saving test result:', error);
                showNotification('Error saving test result', 'error');
            }
        }
        
        function convertFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function loadVitalsHistory() {
            const vitals = loadVitals(currentPatientId);
            const container = document.getElementById('vitalsHistory');
            
            if (vitals.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">No vitals recorded yet.</p>';
                return;
            }
            
            // Sort by date (newest first)
            vitals.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = vitals.map(vital => {
                const date = new Date(vital.date).toLocaleDateString('en-IN');
                const bmi = vital.height && vital.weight ? calculateBMI(vital.height, vital.weight) : null;
                
                return `
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <div class="flex justify-between items-start">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 flex-1">
                                ${vital.height ? `<div><span class="text-sm text-gray-600">Height:</span><br><span class="font-medium">${vital.height} cm</span></div>` : ''}
                                ${vital.weight ? `<div><span class="text-sm text-gray-600">Weight:</span><br><span class="font-medium">${vital.weight} kg</span></div>` : ''}
                                ${vital.bloodPressure ? `<div><span class="text-sm text-gray-600">BP:</span><br><span class="font-medium">${vital.bloodPressure}</span></div>` : ''}
                                ${vital.temperature ? `<div><span class="text-sm text-gray-600">Temperature:</span><br><span class="font-medium">${vital.temperature}F</span></div>` : ''}
                                ${vital.pulse ? `<div><span class="text-sm text-gray-600">Pulse:</span><br><span class="font-medium">${vital.pulse} bpm</span></div>` : ''}
                                ${bmi ? `<div><span class="text-sm text-gray-600">BMI:</span><br><span class="font-medium">${bmi}</span></div>` : ''}
                            </div>
                            <div class="text-right text-sm text-gray-500">
                                <p>${date}</p>
                            </div>
                        </div>
                        
                        <!-- Menstrual Cycle Information -->
                        ${(vital.lmp || vital.cycle || vital.flow || vital.cycleDuration) ? `
                        <div class="mt-3 pt-3 border-t">
                            <h5 class="text-sm font-semibold text-gray-700 mb-2">Menstrual Cycle Information</h5>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
                                ${vital.lmp ? `<div><span class="text-gray-600">LMP:</span> <span class="font-medium">${new Date(vital.lmp).toLocaleDateString('en-IN')}</span></div>` : ''}
                                ${vital.cycle ? `<div><span class="text-gray-600">Cycle:</span> <span class="font-medium capitalize">${vital.cycle}</span></div>` : ''}
                                ${vital.flow ? `<div><span class="text-gray-600">Flow:</span> <span class="font-medium capitalize">${vital.flow}</span></div>` : ''}
                                ${vital.cycleDuration ? `<div><span class="text-gray-600">Duration:</span> <span class="font-medium">${vital.cycleDuration} days</span></div>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Gynecological examination findings -->
                        ${(vital.anaemia || vital.oedema || vital.uterusHeight || vital.perAbdomen || vital.perVaginum || vital.perSpeculum) ? `
                        <div class="mt-3 pt-3 border-t">
                            <h5 class="text-sm font-semibold text-gray-700 mb-2">Gynecological Examination</h5>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
                                ${vital.anaemia ? `<div><span class="text-gray-600">Anaemia:</span> <span class="font-medium capitalize">${vital.anaemia}</span></div>` : ''}
                                ${vital.oedema ? `<div><span class="text-gray-600">Oedema:</span> <span class="font-medium capitalize">${vital.oedema}</span></div>` : ''}
                                ${vital.uterusHeight ? `<div><span class="text-gray-600">Uterus Height:</span> <span class="font-medium">${vital.uterusHeight}</span></div>` : ''}
                            </div>
                            ${vital.perAbdomen ? `<div class="mt-2 text-sm"><span class="text-gray-600 font-medium">P/A:</span> ${vital.perAbdomen}</div>` : ''}
                            ${vital.perVaginum ? `<div class="mt-2 text-sm"><span class="text-gray-600 font-medium">P/V:</span> ${vital.perVaginum}</div>` : ''}
                            ${vital.perSpeculum ? `<div class="mt-2 text-sm"><span class="text-gray-600 font-medium">P/S:</span> ${vital.perSpeculum}</div>` : ''}
                        </div>
                        ` : ''}
                        
                        ${vital.notes ? `<div class="mt-3 pt-3 border-t text-sm"><strong>Additional Notes:</strong> ${vital.notes}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function loadTestResultsHistory() {
            const tests = loadTestResults(currentPatientId);
            const container = document.getElementById('testResults');
            
            if (tests.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No test results uploaded yet.</div>';
                return;
            }
            
            // Sort by date (newest first)
            tests.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));
            
            container.innerHTML = tests.map(test => {
                const testDate = new Date(test.date).toLocaleDateString('en-IN');
                const uploadDate = new Date(test.uploadDate).toLocaleDateString('en-IN');
                
                return `
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">${test.name}</h4>
                                <p class="text-sm text-gray-600">Test Date: ${testDate}</p>
                                <p class="text-xs text-gray-500">Uploaded: ${uploadDate}</p>
                                ${test.notes ? `<p class="text-sm mt-2">${test.notes}</p>` : ''}
                            </div>
                            ${test.file ? `
                                <button onclick="viewTestFile('${test.id}')" class="ml-3 text-blue-500 hover:text-blue-700">
                                    <i data-lucide="eye" class="w-5 h-5"></i>
                                </button>
                            ` : ''}
                        </div>
                        ${test.file ? `
                            <div class="mt-3 flex items-center space-x-2 text-xs text-gray-500">
                                <i data-lucide="paperclip" class="w-3 h-3"></i>
                                <span>${test.file.name}</span>
                                <span>(${(test.file.size / 1024 / 1024).toFixed(2)} MB)</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        function viewTestFile(testId) {
            const tests = loadTestResults(currentPatientId);
            const test = tests.find(t => t.id === testId);
            
            if (test && test.file) {
                // Create a new window/tab to display the file
                const newWindow = window.open();
                newWindow.document.write(`
                    <html>
                        <head><title>${test.name} - ${test.file.name}</title></head>
                        <body style="margin:0; padding:20px; font-family: Arial, sans-serif;">
                            <h3>${test.name}</h3>
                            <p><strong>Test Date:</strong> ${new Date(test.date).toLocaleDateString('en-IN')}</p>
                            <p><strong>File:</strong> ${test.file.name}</p>
                            ${test.notes ? `<p><strong>Notes:</strong> ${test.notes}</p>` : ''}
                            <hr style="margin: 20px 0;">
                            ${test.file.type.startsWith('image/') ? 
                                `<img src="${test.file.data}" style="max-width: 100%; height: auto;">` :
                                `<embed src="${test.file.data}" width="100%" height="600px" type="${test.file.type}">`
                            }
                        </body>
                    </html>
                `);
            }
        }
        
        // --- DATA MANAGEMENT FUNCTIONS ---
        function setupDataManagement() {
            // Export Data
            document.getElementById('exportDataBtn').onclick = exportData;
            
            // Import Data
            document.getElementById('importDataBtn').onclick = () => {
                document.getElementById('importFileInput').click();
            };
            
            document.getElementById('importFileInput').onchange = importData;
            
            // Clear All Data
            document.getElementById('clearDataBtn').onclick = clearAllData;
            
            // Update storage info
            updateStorageInfo();
        }
        
        // --- DIGITAL SIGNATURE FUNCTIONS ---
        let tempSignatureData = null;
        let globalValidatePins = null; // Will hold reference to validation function
        
        // Test function to debug signature setup
        function testSignatureElements() {
            console.log('Testing signature elements...');
            const elements = {
                setupSection: document.getElementById('signatureSetupSection'),
                statusSection: document.getElementById('signatureStatus'),
                signaturePin: document.getElementById('signaturePin'),
                confirmPin: document.getElementById('confirmSignaturePin'),
                saveBtn: document.getElementById('saveSignatureBtn'),
                drawBtn: document.getElementById('drawSignatureBtn'),
                uploadBtn: document.getElementById('uploadSignatureBtn')
            };
            
            for (const [name, element] of Object.entries(elements)) {
                console.log(`${name}:`, element ? 'FOUND' : 'NOT FOUND', element);
                if (element && name === 'setupSection') {
                    console.log('Setup section styles:', {
                        display: element.style.display,
                        visibility: element.style.visibility,
                        offsetHeight: element.offsetHeight,
                        offsetWidth: element.offsetWidth
                    });
                }
            }
            
            return elements;
        }
        
        // Manual function to set up button handlers
        function setupSignatureButtons() {
            console.log('Setting up signature buttons manually...');
            
            const drawBtn = document.getElementById('drawSignatureBtn');
            const uploadBtn = document.getElementById('uploadSignatureBtn');
            const resetBtn = document.getElementById('resetSignatureBtn');
            
            if (drawBtn) {
                drawBtn.addEventListener('click', function(e) {
                    console.log('Draw button clicked manually');
                    e.preventDefault();
                    showSignatureDrawingModal();
                });
                console.log('Draw button handler added');
            }
            
            if (uploadBtn) {
                uploadBtn.addEventListener('click', function(e) {
                    console.log('Upload button clicked manually');
                    e.preventDefault();
                    const imageInput = document.getElementById('signatureImageInput');
                    if (imageInput) {
                        imageInput.click();
                    }
                });
                console.log('Upload button handler added');
            }
            
            if (resetBtn) {
                resetBtn.addEventListener('click', function(e) {
                    console.log('Reset button clicked manually');
                    e.preventDefault();
                    resetSignatureSetup();
                });
                console.log('Reset button handler added');
            }
        }
        
        // Debugging function to test signature functionality step by step
        function debugSignatureSetup() {
            console.log('=== SIGNATURE DEBUG START ===');
            
            // Check if elements exist
            const elements = {
                signaturePin: document.getElementById('signaturePin'),
                confirmPin: document.getElementById('confirmSignaturePin'),
                drawBtn: document.getElementById('drawSignatureBtn'),
                uploadBtn: document.getElementById('uploadSignatureBtn'),
                saveBtn: document.getElementById('saveSignatureBtn'),
                resetBtn: document.getElementById('resetSignatureBtn'),
                setupSection: document.getElementById('signatureSetupSection'),
                statusSection: document.getElementById('signatureStatus'),
                preview: document.getElementById('signaturePreview'),
                drawModal: document.getElementById('drawSignatureModal'),
                canvas: document.getElementById('signatureCanvas')
            };
            
            console.log('Elements check:', elements);
            
            // Check current state
            console.log('Current state:', {
                doctorProfile: doctorProfile,
                tempSignatureData: typeof tempSignatureData !== 'undefined' ? 'exists' : 'undefined'
            });
            
            // Force show setup section
            if (elements.setupSection) {
                elements.setupSection.style.display = 'block';
                elements.setupSection.style.visibility = 'visible';
                elements.setupSection.classList.remove('hidden');
                console.log('Setup section forced visible');
            }
            
            // Hide status section
            if (elements.statusSection) {
                elements.statusSection.classList.add('hidden');
                elements.statusSection.style.display = 'none';
                console.log('Status section hidden');
            }
            
            // Clear any stored data for fresh start
            if (typeof doctorProfile !== 'undefined') {
                doctorProfile.signatureSetup = false;
                doctorProfile.signaturePin = '';
                doctorProfile.digitalSignature = '';
                console.log('Cleared doctorProfile signature data');
            }
            
            // Clear localStorage
            localStorage.removeItem('signaturePIN');
            localStorage.removeItem('doctorSignature');
            console.log('Cleared localStorage signature data');
            
            // Reset form fields
            if (elements.signaturePin) elements.signaturePin.value = '';
            if (elements.confirmPin) elements.confirmPin.value = '';
            if (elements.saveBtn) elements.saveBtn.disabled = true;
            
            console.log('=== SIGNATURE DEBUG END ===');
            alert('Signature setup reset! Check console for details. Now try drawing or uploading a signature.');
        }
        
        // Simple function to force enable save button for testing
        function forceEnableSave() {
            const saveBtn = document.getElementById('saveSignatureBtn');
            if (saveBtn) {
                saveBtn.disabled = false;
                console.log('Save button force enabled');
                alert('Save button enabled. Make sure you have PIN and signature data.');
            }
        }
        
        // Step-by-step signature setup test
        function testSignatureStepByStep() {
            alert('Step 1: I will reset the signature setup');
            debugSignatureSetup();
            
            setTimeout(() => {
                alert('Step 2: Now click "Draw Digital Signature" button to test drawing');
            }, 1000);
        }
        
        // Test drawing functionality specifically
        function testDrawingModal() {
            console.log('Testing drawing modal...');
            showSignatureDrawingModal();
        }
        
        // Test upload functionality specifically  
        function testUploadSignature() {
            console.log('Testing upload functionality...');
            const imageInput = document.getElementById('signatureImageInput');
            if (imageInput) {
                imageInput.click();
                console.log('File input triggered');
            } else {
                console.error('Image input not found');
            }
        }
        
        // Complete signature functionality test
        function runCompleteSignatureTest() {
            console.log('=== COMPLETE SIGNATURE TEST ===');
            
            // Step 1: Reset everything
            debugSignatureSetup();
            
            // Step 2: Test elements
            const elements = {
                drawBtn: document.getElementById('drawSignatureBtn'),
                uploadBtn: document.getElementById('uploadSignatureBtn'),
                pinInput: document.getElementById('signaturePin'),
                confirmPinInput: document.getElementById('confirmSignaturePin'),
                saveBtn: document.getElementById('saveSignatureBtn')
            };
            
            console.log('Testing button clicks...');
            
            // Test draw button
            if (elements.drawBtn) {
                console.log('Testing draw button click...');
                elements.drawBtn.click();
            }
            
            setTimeout(() => {
                // Close modal if it opened
                const modal = document.getElementById('drawSignatureModal');
                if (modal && !modal.classList.contains('hidden')) {
                    modal.classList.add('hidden');
                    console.log('Closed draw modal');
                }
                
                // Test upload button
                if (elements.uploadBtn) {
                    console.log('Testing upload button click...');
                    elements.uploadBtn.click();
                }
                
                // Set test PIN
                if (elements.pinInput && elements.confirmPinInput) {
                    elements.pinInput.value = '1234';
                    elements.confirmPinInput.value = '1234';
                    console.log('Set test PINs');
                    
                    // Trigger input events
                    elements.pinInput.dispatchEvent(new Event('input'));
                    elements.confirmPinInput.dispatchEvent(new Event('input'));
                }
                
                console.log('=== TEST COMPLETE ===');
                console.log('Check if buttons responded and console for any errors');
                
            }, 1000);
        }
        
        // Quick test function for reset signature
        function testResetSignature() {
            console.log('Testing reset signature function...');
            console.log('Reset button element:', document.getElementById('resetSignatureBtn'));
            resetSignatureSetup();
        }
        
        // Debug function to check button state
        function debugResetButton() {
            const btn = document.getElementById('resetSignatureBtn');
            console.log('Reset button debug:', {
                exists: !!btn,
                visible: btn ? getComputedStyle(btn).display !== 'none' : false,
                hasClickListener: btn ? btn.onclick !== null : false,
                parentVisible: btn && btn.parentElement ? getComputedStyle(btn.parentElement).display !== 'none' : false
            });
            
            if (btn) {
                console.log('Button element:', btn);
                console.log('Button parent:', btn.parentElement);
            }
            
            return btn;
        }
        
        // Make debug functions available globally
        window.testResetSignature = testResetSignature;
        window.debugResetButton = debugResetButton;

        // Make certificate functions available globally for onclick handlers
        window.viewCertificate = viewCertificate;
        window.printCertificateById = printCertificateById;
        window.showCertificateActionsModal = showCertificateActionsModal;
        window.verifyCertificate = verifyCertificate;
        window.sendCertificateEmail = sendCertificateEmail;
        window.shareCertificateWhatsApp = shareCertificateWhatsApp;
        window.printCertificateAdvanced = printCertificateAdvanced;
        window.showAutoGenerateModal = showAutoGenerateModal;
        window.hideAutoGenerateModal = hideAutoGenerateModal;
        window.showCertificateModal = showCertificateModal;
        window.hideCertificateModal = hideCertificateModal;
        window.selectConsultationForCert = selectConsultationForCert;
        window.handleAutoGenerate = handleAutoGenerate;
        window.hideCertificatePreview = hideCertificatePreview;
        window.editCertificate = editCertificate;
        window.signAndIssueCertificate = signAndIssueCertificate;
        window.printCertificate = printCertificate;

        // Certificate verification function
        function verifyCertificate(certificateId) {
            const certificates = loadCertificates(currentPatientId);
            const certificate = certificates.find(c => c.id === certificateId);
            
            if (!certificate) {
                showNotification('Certificate not found', 'error');
                return;
            }

            // Verify signature hash
            const expectedHash = generateDigitalSignatureHash(
                doctorProfile.digitalSignature, 
                certificate.issuedDate, 
                certificate.issuedByRegNo || 'UNKNOWN'
            );

            const isValid = certificate.digitalSignatureHash === expectedHash;
            
            const verificationDetails = `
                <div class="p-4">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i data-lucide="${isValid ? 'shield-check' : 'shield-x'}" class="w-5 h-5 mr-2 ${isValid ? 'text-green-600' : 'text-red-600'}"></i>
                        Certificate Verification
                    </h3>
                    
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="font-medium">Certificate ID:</span>
                            <span class="font-mono">${certificate.id}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">UUID:</span>
                            <span class="font-mono">${certificate.uuid}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Issue Date:</span>
                            <span>${new Date(certificate.issuedDate).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Issued By:</span>
                            <span>${certificate.issuedBy} (${certificate.issuedByRegNo})</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Digital Signature:</span>
                            <span class="${isValid ? 'text-green-600' : 'text-red-600'} font-medium">
                                ${isValid ? ' Valid' : ' Invalid'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Auth Hash:</span>
                            <span class="font-mono text-xs">${certificate.digitalSignatureHash}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Security Level:</span>
                            <span>${certificate.metadata?.securityLevel || 'Standard'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Compliance:</span>
                            <span>${certificate.authenticationData?.compliance || 'Standard'}</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 ${isValid ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} border rounded-lg">
                        <p class="text-sm ${isValid ? 'text-green-800' : 'text-red-800'}">
                            ${isValid ? 
                                ' This certificate is digitally verified and authentic. The signature and timestamp match the issuing doctor\'s credentials.' :
                                ' This certificate could not be verified. The digital signature may have been tampered with or the issuing credentials have changed.'
                            }
                        </p>
                    </div>
                </div>
            `;

            // Show verification modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full mx-4">
                    ${verificationDetails}
                    <div class="p-4 border-t">
                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Re-initialize Lucide icons in the modal
            if (window.lucide) {
                window.lucide.createIcons();
            }
        }
        
        function setupDigitalSignature() {
            console.log('setupDigitalSignature called');
            
            try {
                // Always show the setup section first
                const setupSection = document.getElementById('signatureSetupSection');
                const statusSection = document.getElementById('signatureStatus');
                
                console.log('Setup section found:', !!setupSection);
                console.log('Status section found:', !!statusSection);
                
                if (setupSection) {
                    setupSection.style.display = 'block';
                    console.log('Setup section set to display: block');
                }
                if (statusSection) {
                    statusSection.classList.add('hidden');
                    console.log('Status section hidden');
                }
                
                // Check if signature is already configured with enhanced mobile support
                const hasValidSignature = doctorProfile.signatureSetup && 
                                         doctorProfile.digitalSignature && 
                                         doctorProfile.digitalSignature.length > 0;
                
                console.log('Signature configuration check:', {
                    signatureSetup: doctorProfile.signatureSetup,
                    hasDigitalSignature: !!doctorProfile.digitalSignature,
                    signatureLength: doctorProfile.digitalSignature ? doctorProfile.digitalSignature.length : 0,
                    isMobile: isMobileDevice()
                });
                
                if (hasValidSignature) {
                    console.log('Signature already configured, showing status');
                    // Add a small delay for mobile browsers to ensure DOM is ready
                    if (isMobileDevice()) {
                        setTimeout(() => showSignatureConfigured(), 100);
                    } else {
                        showSignatureConfigured();
                    }
                    return;
                }
                
                // Setup signature PIN validation
                const signaturePin = document.getElementById('signaturePin');
                const confirmPin = document.getElementById('confirmSignaturePin');
                const saveBtn = document.getElementById('saveSignatureBtn');
                
                console.log('Digital signature elements found:', {
                    signaturePin: !!signaturePin,
                    confirmPin: !!confirmPin,
                    saveBtn: !!saveBtn
                });
                
                if (!signaturePin || !confirmPin || !saveBtn) {
                    console.warn('Digital signature elements not found, skipping setup');
                    // Let's add an alert to see if this is the issue
                    alert('Digital signature elements not found. Please check the console for details.');
                    return;
                }
                
                function validatePins() {
                    const pin = signaturePin.value;
                    const confirm = confirmPin.value;
                    const pinEnabled = document.getElementById('enablePinProtection')?.checked || false;
                    
                    console.log('Validating setup:', { 
                        pin: pin.length, 
                        confirm: confirm.length, 
                        tempSignatureData: !!tempSignatureData,
                        pinEnabled: pinEnabled,
                        pinMatch: pin === confirm,
                        pinLengthOk: pin.length >= 4 || !pinEnabled
                    });
                    
                    // Check conditions based on whether PIN is enabled
                    let pinConditionMet = true;
                    if (pinEnabled) {
                        pinConditionMet = pin.length >= 4 && pin === confirm;
                    }
                    
                    if (pinConditionMet && tempSignatureData) {
                        saveBtn.disabled = false;
                        saveBtn.classList.remove('disabled:bg-gray-300');
                        saveBtn.classList.add('bg-purple-500', 'hover:bg-purple-600');
                        console.log('Save button ENABLED - all conditions met');
                    } else {
                        saveBtn.disabled = true;
                        saveBtn.classList.add('disabled:bg-gray-300');
                        saveBtn.classList.remove('bg-purple-500', 'hover:bg-purple-600');
                        console.log('Save button DISABLED - missing:', {
                            pinIssue: pinEnabled && (pin.length < 4 || pin !== confirm),
                            noSignature: !tempSignatureData
                        });
                    }
                }
                
                signaturePin.addEventListener('input', validatePins);
                confirmPin.addEventListener('input', validatePins);
                
                // Setup PIN toggle functionality
                const pinToggle = document.getElementById('enablePinProtection');
                const pinSetupSection = document.getElementById('pinSetupSection');
                
                if (pinToggle && pinSetupSection) {
                    pinToggle.addEventListener('change', function() {
                        if (this.checked) {
                            pinSetupSection.classList.remove('hidden');
                            signaturePin.required = true;
                            confirmPin.required = true;
                        } else {
                            pinSetupSection.classList.add('hidden');
                            signaturePin.required = false;
                            confirmPin.required = false;
                            // Clear PIN values when disabled
                            signaturePin.value = '';
                            confirmPin.value = '';
                        }
                        validatePins(); // Re-validate when toggle changes
                    });
                }
                
                // Make validatePins available globally
                globalValidatePins = validatePins;
                
                // Setup signature drawing
                const drawBtn = document.getElementById('drawSignatureBtn');
                console.log('Draw button found:', !!drawBtn);
                if (drawBtn) {
                    // Remove any existing event listeners
                    drawBtn.onclick = null;
                    // Add event listener
                    drawBtn.addEventListener('click', function(e) {
                        console.log('Draw signature button clicked');
                        e.preventDefault();
                        e.stopPropagation();
                        showSignatureDrawingModal();
                    });
                }
                
                // Setup signature type
                const typeBtn = document.getElementById('typeSignatureBtn');
                console.log('Type button found:', !!typeBtn);
                if (typeBtn) {
                    // Remove any existing event listeners
                    typeBtn.onclick = null;
                    // Add event listener
                    typeBtn.addEventListener('click', function(e) {
                        console.log('Type signature button clicked');
                        e.preventDefault();
                        e.stopPropagation();
                        showTypeSignatureModal();
                    });
                }

                // Setup signature upload
                const uploadBtn = document.getElementById('uploadSignatureBtn');
                console.log('Upload button found:', !!uploadBtn);
                if (uploadBtn) {
                    // Remove any existing event listeners
                    uploadBtn.onclick = null;
                    // Add event listener
                    uploadBtn.addEventListener('click', function(e) {
                        console.log('Upload signature button clicked');
                        e.preventDefault();
                        e.stopPropagation();
                        const imageInput = document.getElementById('signatureImageInput');
                        if (imageInput) {
                            imageInput.click();
                        }
                    });
                }
                
                const imageInput = document.getElementById('signatureImageInput');
                if (imageInput) {
                    imageInput.onchange = handleSignatureUpload;
                }
                
                // Setup save signature
                if (saveBtn) {
                    saveBtn.onclick = saveDigitalSignatureSetup;
                }
                
                // Setup reset signature with better error handling
                const resetBtn = document.getElementById('resetSignatureBtn');
                if (resetBtn) {
                    resetBtn.onclick = (e) => {
                        e.preventDefault();
                        console.log('Reset button clicked');
                        resetSignatureSetup();
                    };
                    console.log('Reset button event listener attached');
                } else {
                    console.log('Reset button not found in DOM');
                }
                
            } catch (error) {
                console.warn('Error setting up digital signature:', error);
            }
        }
        
        function setupDigitalSignatureModal() {
            // Setup digital signature authentication modal
            const closeSignatureModal = document.getElementById('closeSignatureModal');
            const cancelSignature = document.getElementById('cancelSignature');
            const confirmSignature = document.getElementById('confirmSignature');
            
            if (closeSignatureModal) {
                closeSignatureModal.onclick = hideDigitalSignatureModal;
            }
            
            if (cancelSignature) {
                cancelSignature.onclick = hideDigitalSignatureModal;
            }
            
            if (confirmSignature) {
                confirmSignature.onclick = validateDigitalSignature;
            }
            
            // Setup drawing modal handlers
            const closeDrawModal = document.getElementById('closeDrawModal');
            const cancelDraw = document.getElementById('cancelDraw');
            const clearCanvas = document.getElementById('clearCanvas');
            const saveDrawnSignature = document.getElementById('saveDrawnSignature');
            
            if (closeDrawModal) {
                closeDrawModal.onclick = hideSignatureDrawingModal;
            }
            
            if (cancelDraw) {
                cancelDraw.onclick = hideSignatureDrawingModal;
            }
            
            if (clearCanvas) {
                clearCanvas.onclick = clearSignatureCanvas;
            }
            
            if (saveDrawnSignature) {
                saveDrawnSignature.onclick = saveDrawnSignatureData;
            }
            
            // Setup canvas for drawing
            setupSignatureCanvas();
            
            // Setup type signature modal handlers
            const closeTypeModal = document.getElementById('closeTypeModal');
            const cancelType = document.getElementById('cancelType');
            const saveTypedSignature = document.getElementById('saveTypedSignature');
            
            if (closeTypeModal) {
                closeTypeModal.onclick = hideTypeSignatureModal;
            }
            
            if (cancelType) {
                cancelType.onclick = hideTypeSignatureModal;
            }
            
            if (saveTypedSignature) {
                saveTypedSignature.onclick = saveTypedSignatureData;
            }
            
            // Setup type signature functionality
            setupTypeSignature();
        }
        
        function setupSignatureCanvas() {
            const canvas = document.getElementById('signatureCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            // Function to resize and set up canvas
            function resizeCanvas() {
                // Save current drawing if any
                let imageData = null;
                if (canvas.width > 0 && canvas.height > 0) {
                    try {
                        imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    } catch(e) {
                        console.log("No existing image data to save");
                    }
                }
                
                // Set the correct canvas size based on device
                const isMobile = window.innerWidth < 768;
                // Use the modal content width instead of parent element for more accurate sizing
                const modalContent = canvas.closest('.bg-white.rounded-lg');
                const containerWidth = modalContent ? modalContent.clientWidth - 32 : window.innerWidth - 40; // Account for padding
                canvas.width = isMobile ? Math.max(containerWidth, 300) : 600; // Minimum width of 300px on mobile
                canvas.height = isMobile ? canvas.width * 0.5 : 200; // Keep aspect ratio of roughly 2:1
                
                // Reset styles after resize (canvas resets after size change)
                ctx.strokeStyle = '#000';
                ctx.lineWidth = isMobile ? 3 : 2; // Thicker lines on mobile for better visibility
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                // Restore drawing if there was one
                if (imageData) {
                    try {
                        ctx.putImageData(imageData, 0, 0);
                    } catch(e) {
                        console.log("Couldn't restore image data after resize");
                    }
                }
            }
            
            // Initial resize
            resizeCanvas();
            
            // Handle device orientation changes and window resizing
            window.addEventListener('resize', resizeCanvas);
            window.addEventListener('orientationchange', resizeCanvas);
            
            function draw(e) {
                if (!isDrawing) return;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            // Mouse events
            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            });
            
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', () => isDrawing = false);
            canvas.addEventListener('mouseout', () => isDrawing = false);
            
            // Touch events for mobile - use passive: false to ensure preventDefault works on all browsers
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault(); // Prevent scrolling when touching the canvas
                console.log('Touch start detected');
                
                if (e.touches && e.touches.length > 0) {
                    const rect = canvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    
                    // Calculate the scaling factor between the actual canvas size and its display size
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    
                    // Apply the scaling to get the correct position on the canvas
                    const x = (touch.clientX - rect.left) * scaleX;
                    const y = (touch.clientY - rect.top) * scaleY;
                    
                    console.log('Touch start at:', x, y, 'scale:', scaleX, scaleY);
                    isDrawing = true;
                    [lastX, lastY] = [x, y];
                }
            }, { passive: false });
            
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault(); // Prevent scrolling when touching the canvas
                if (!isDrawing) return;
                
                if (e.touches && e.touches.length > 0) {
                    const rect = canvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    
                    // Calculate the scaling factor between the actual canvas size and its display size
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    
                    // Apply the scaling to get the correct position on the canvas
                    const x = (touch.clientX - rect.left) * scaleX;
                    const y = (touch.clientY - rect.top) * scaleY;
                    
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    
                    [lastX, lastY] = [x, y];
                }
            }, { passive: false });
            
            canvas.addEventListener('touchend', function(e) {
                console.log('Touch end detected');
                isDrawing = false;
            });
            
            canvas.addEventListener('touchcancel', function(e) {
                console.log('Touch cancelled');
                isDrawing = false;
            });
        }
        
        function showSignatureDrawingModal() {
            console.log('showSignatureDrawingModal called');
            const modal = document.getElementById('drawSignatureModal');
            console.log('Draw modal found:', !!modal);
            if (modal) {
                modal.classList.remove('hidden');
                console.log('Modal shown, hidden class removed');
                
                // Clear the canvas when opening
                clearSignatureCanvas();
                
                // Force canvas setup and resize after modal is visible
                setTimeout(() => {
                    const canvas = document.getElementById('signatureCanvas');
                    if (canvas) {
                        // Directly call resize function to ensure proper sizing
                        const ctx = canvas.getContext('2d');
                        const isMobile = window.innerWidth < 768;
                        const modalContent = canvas.closest('.bg-white.rounded-lg');
                        const containerWidth = modalContent ? modalContent.clientWidth - 32 : window.innerWidth - 40;
                        canvas.width = isMobile ? Math.max(containerWidth, 300) : 600;
                        canvas.height = isMobile ? canvas.width * 0.5 : 200;
                        
                        // Reset canvas context properties
                        ctx.strokeStyle = '#000';
                        ctx.lineWidth = isMobile ? 3 : 2;
                        ctx.lineCap = 'round';
                        ctx.lineJoin = 'round';
                        
                        console.log('Canvas resized for mobile:', isMobile, 'width:', canvas.width, 'height:', canvas.height);
                    }
                }, 100); // Small delay to ensure DOM has updated
            } else {
                console.error('Draw signature modal not found');
            }
        }
        
        function hideSignatureDrawingModal() {
            const modal = document.getElementById('drawSignatureModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        function clearSignatureCanvas() {
            const canvas = document.getElementById('signatureCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                // Get the current dimensions to ensure we clear the entire canvas
                const width = canvas.width;
                const height = canvas.height;
                ctx.clearRect(0, 0, width, height);
                
                // Reset canvas state
                ctx.strokeStyle = '#000';
                const isMobile = window.innerWidth < 768;
                ctx.lineWidth = isMobile ? 3 : 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
            }
        }
        
        function saveDrawnSignatureData() {
            const canvas = document.getElementById('signatureCanvas');
            if (!canvas) return;
            
            // Check if anything is drawn
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const isBlank = !imageData.data.some(channel => channel !== 0);
            
            if (isBlank) {
                showNotification('Please draw your signature first', 'error');
                return;
            }
            
            // Convert to base64
            tempSignatureData = canvas.toDataURL('image/png');
            
            // Show preview
            showSignaturePreview(tempSignatureData);
            
            // Hide drawing modal
            hideSignatureDrawingModal();
            
            // Trigger validation to enable save button if conditions are met
            if (globalValidatePins) {
                globalValidatePins();
            }
            
            showNotification('Signature captured! Set your PIN to save.', 'success');
        }
        
        function handleSignatureUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('Please select an image file', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                tempSignatureData = e.target.result;
                showSignaturePreview(tempSignatureData);
                
                // Trigger validation to enable save button if conditions are met
                if (globalValidatePins) {
                    globalValidatePins();
                }
                
                showNotification('Signature uploaded! Set your PIN to save.', 'success');
            };
            reader.readAsDataURL(file);
        }
        
        function showSignaturePreview(signatureData) {
            const preview = document.getElementById('signaturePreview');
            const image = document.getElementById('signatureImage');
            
            if (preview && image) {
                image.src = signatureData;
                preview.classList.remove('hidden');
            }
        }
        
        function saveDigitalSignatureSetup() {
            console.log('saveDigitalSignatureSetup called');
            const pin = document.getElementById('signaturePin').value;
            const confirmPin = document.getElementById('confirmSignaturePin').value;
            const pinEnabled = document.getElementById('enablePinProtection')?.checked || false;
            
            console.log('Setup validation:', {
                pin: pin.length,
                confirmPin: confirmPin.length,
                pinEnabled: pinEnabled,
                tempSignatureData: !!tempSignatureData
            });
            
            // Validate PIN only if enabled
            if (pinEnabled) {
                if (pin.length < 4) {
                    showNotification('PIN must be at least 4 digits', 'error');
                    return;
                }
                
                if (pin !== confirmPin) {
                    showNotification('PINs do not match', 'error');
                    return;
                }
            }
            
            if (!tempSignatureData) {
                showNotification('Please draw or upload your signature first', 'error');
                return;
            }
            
            try {
                // Save to doctor profile
                doctorProfile.signatureSetup = true;
                doctorProfile.pinProtectionEnabled = pinEnabled;
                doctorProfile.signaturePin = pinEnabled ? pin : ''; // Only save PIN if enabled
                doctorProfile.digitalSignature = tempSignatureData;
                
                saveDoctorProfile();
                
                // Clear form
                document.getElementById('signaturePin').value = '';
                document.getElementById('confirmSignaturePin').value = '';
                tempSignatureData = null;
                
                // Show success status
                showSignatureConfigured();
                
                const message = pinEnabled ? 
                    'Digital signature setup completed with PIN protection!' : 
                    'Digital signature setup completed! One-click signing enabled.';
                showNotification(message, 'success');
                
            } catch (error) {
                console.error('Error saving signature setup:', error);
                showNotification('Error saving signature setup', 'error');
            }
        }
        
        function showSignatureConfigured() {
            console.log('showSignatureConfigured called');
            const setupSection = document.getElementById('signatureSetupSection');
            const statusSection = document.getElementById('signatureStatus');
            
            if (setupSection) {
                setupSection.style.display = 'none';
                console.log('Setup section hidden');
            }
            
            if (statusSection) {
                statusSection.classList.remove('hidden');
                statusSection.style.display = 'block';
                
                // Update status message based on PIN protection setting
                const statusMessage = statusSection.querySelector('p');
                const pinProtectionEnabled = doctorProfile.pinProtectionEnabled;
                
                if (statusMessage) {
                    if (pinProtectionEnabled) {
                        statusMessage.innerHTML = `
                            <span class="text-green-600 font-medium"> Digital signature configured with PIN protection</span><br>
                            <span class="text-sm text-gray-600">PIN required for each signature</span>
                        `;
                    } else {
                        statusMessage.innerHTML = `
                            <span class="text-blue-600 font-medium"> Digital signature configured</span>
                            <span class="pin-disabled-badge">One-Click Signing</span><br>
                            <span class="text-sm text-gray-600">No PIN required - signatures applied instantly</span>
                        `;
                    }
                }
                
                console.log('Status section displayed');
            }
            
            // Setup reset button event listener when status section becomes visible
            setTimeout(() => {
                const resetBtn = document.getElementById('resetSignatureBtn');
                if (resetBtn) {
                    // Make sure the button is visible
                    resetBtn.style.display = 'inline-block';
                    
                    // Enhanced visibility for mobile
                    if (window.innerWidth <= 768) {
                        resetBtn.style.minHeight = '44px';
                        resetBtn.style.padding = '10px 16px';
                        resetBtn.style.fontSize = '14px';
                        resetBtn.style.margin = '10px 0';
                        resetBtn.style.display = 'block';
                        resetBtn.style.width = '100%';
                        console.log('Reset button styled for mobile');
                    }
                    
                    resetBtn.onclick = (e) => {
                        e.preventDefault();
                        console.log('Reset button clicked from status section');
                        resetSignatureSetup();
                    };
                    console.log('Reset button event listener attached in showSignatureConfigured');
                } else {
                    console.warn('Reset button not found in showSignatureConfigured');
                }
            }, 100);
        }
        
        async function resetSignatureSetup() {
            console.log('resetSignatureSetup called');
            console.log('Current doctorProfile state:', {
                signatureSetup: doctorProfile.signatureSetup,
                hasDigitalSignature: !!doctorProfile.digitalSignature,
                hasPIN: !!doctorProfile.signaturePin
            });
            
            const confirmed = await showCustomConfirm(
                'Reset Digital Signature', 
                'Are you sure you want to reset your digital signature setup? This cannot be undone.',
                'Reset',
                'Cancel',
                'alert-triangle'
            );
            
            if (!confirmed) {
                console.log('User cancelled reset');
                return;
            }
            
            console.log('User confirmed reset, proceeding...');
            
            try {
                // Clear signature data
                console.log('Clearing signature data...');
                doctorProfile.signatureSetup = false;
                doctorProfile.signaturePin = '';
                doctorProfile.digitalSignature = '';
                
                // Make sure the reset button is visible, especially on mobile
                const resetBtn = document.getElementById('resetSignatureBtn');
                if (resetBtn) {
                    resetBtn.style.display = 'inline-block';
                    
                    // Enhanced visibility for mobile
                    if (window.innerWidth <= 768) {
                        resetBtn.style.minHeight = '44px';
                        resetBtn.style.padding = '10px 16px';
                        resetBtn.style.fontSize = '14px';
                        resetBtn.style.margin = '10px 0';
                        resetBtn.style.display = 'block';
                        resetBtn.style.width = '100%';
                    }
                }
                
                // Clear temporary data
                tempSignatureData = null;
                console.log('Temporary data cleared');
                
                // Save to localStorage
                console.log('Saving doctor profile...');
                saveDoctorProfile();
                console.log('Doctor profile saved');
                
                // Show setup section again
                const setupSection = document.getElementById('signatureSetupSection');
                const statusSection = document.getElementById('signatureStatus');
                
                console.log('Elements found:', {
                    setupSection: !!setupSection,
                    statusSection: !!statusSection
                });
                
                if (setupSection) {
                    setupSection.style.display = 'block';
                    setupSection.style.visibility = 'visible';
                    console.log('Setup section shown');
                }
                
                if (statusSection) {
                    statusSection.classList.add('hidden');
                    console.log('Status section hidden');
                }
                
                // Clear form fields
                const signaturePin = document.getElementById('signaturePin');
                const confirmPin = document.getElementById('confirmSignaturePin');
                const saveBtn = document.getElementById('saveSignatureBtn');
                
                console.log('Form elements found:', {
                    signaturePin: !!signaturePin,
                    confirmPin: !!confirmPin,
                    saveBtn: !!saveBtn
                });
                
                if (signaturePin) signaturePin.value = '';
                if (confirmPin) confirmPin.value = '';
                if (saveBtn) saveBtn.disabled = true;
                
                // Clear preview
                const preview = document.getElementById('signaturePreview');
                if (preview) {
                    preview.classList.add('hidden');
                    console.log('Preview cleared');
                }
                
                // Clear any signature canvases
                const drawCanvas = document.getElementById('drawSignatureCanvas');
                const typeCanvas = document.getElementById('typeSignatureCanvas');
                if (drawCanvas) {
                    const drawCtx = drawCanvas.getContext('2d');
                    drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
                    console.log('Draw canvas cleared');
                }
                if (typeCanvas) {
                    const typeCtx = typeCanvas.getContext('2d');
                    typeCtx.clearRect(0, 0, typeCanvas.width, typeCanvas.height);
                    console.log('Type canvas cleared');
                }
                
                // Re-initialize the signature setup
                console.log('Re-initializing signature setup...');
                setTimeout(() => {
                    setupDigitalSignature();
                    console.log('Signature setup re-initialized');
                }, 100);
                
                showNotification('Digital signature setup has been reset successfully', 'success');
                console.log('Reset completed successfully');
                
            } catch (error) {
                console.error('Error resetting signature:', error);
                console.error('Error stack:', error.stack);
                showNotification('Error resetting signature setup: ' + error.message, 'error');
            }
        }
        
        function showDigitalSignatureModal() {
            // Force refresh of doctor profile from localStorage on mobile
            if (isMobileDevice()) {
                console.log('Mobile device detected, refreshing profile data');
                loadDoctorProfile();
            }
            
            // Double-check signature setup with more robust validation
            const hasSignature = doctorProfile.signatureSetup && 
                                doctorProfile.digitalSignature && 
                                doctorProfile.digitalSignature.length > 0;
            
            console.log('Signature validation:', {
                signatureSetup: doctorProfile.signatureSetup,
                hasDigitalSignature: !!doctorProfile.digitalSignature,
                signatureLength: doctorProfile.digitalSignature ? doctorProfile.digitalSignature.length : 0,
                isMobile: isMobileDevice()
            });
            
            if (!hasSignature) {
                showNotification('Please set up your digital signature first in Settings', 'error');
                return;
            }
            
            // Check if PIN protection is disabled - if so, sign immediately
            if (!doctorProfile.pinProtectionEnabled) {
                console.log('PIN protection disabled, signing immediately');
                validateDigitalSignature(); // This will skip PIN validation
                return;
            }
            
            const modal = document.getElementById('signatureModal');
            const pinInput = document.getElementById('signaturePinInput');
            const pinError = document.getElementById('pinError');
            
            if (modal) {
                modal.classList.remove('hidden');
                if (pinInput) {
                    pinInput.value = '';
                    pinInput.focus();
                    
                    // Add Enter key support
                    pinInput.onkeypress = function(e) {
                        if (e.key === 'Enter') {
                            validateDigitalSignature();
                        }
                    };
                }
                if (pinError) {
                    pinError.classList.add('hidden');
                }
            }
        }
        
        function hideDigitalSignatureModal() {
            const modal = document.getElementById('signatureModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        function validateDigitalSignature() {
            // Check if PIN protection is enabled
            if (doctorProfile.pinProtectionEnabled && doctorProfile.signaturePin) {
                // Use PIN validation
                const enteredPin = document.getElementById('signaturePinInput')?.value || '';
                const pinError = document.getElementById('pinError');
                
                if (enteredPin !== doctorProfile.signaturePin) {
                    // PIN is incorrect
                    if (pinError) {
                        pinError.classList.remove('hidden');
                        pinError.textContent = 'Incorrect PIN. Please try again.';
                    }
                    if (document.getElementById('signaturePinInput')) {
                        document.getElementById('signaturePinInput').value = '';
                    }
                    
                    // Add shake animation
                    const modal = document.querySelector('#signatureModal .bg-white');
                    if (modal) {
                        modal.style.animation = 'shake 0.5s';
                        setTimeout(() => {
                            modal.style.animation = '';
                        }, 500);
                    }
                    return; // Exit if PIN is wrong
                }
            }
            
            // PIN is correct or PIN protection is disabled - proceed with signing
            console.log('Signature validation passed, proceeding with signing');
            
            // Check if this is for certificate or prescription
            if (window.tempCertificateAction) {
                // Handle certificate signing
                const formData = getCertificateFormData();
                saveCertificate(formData);
                hideCertificatePreview();
                hideDigitalSignatureModal();
                window.tempCertificateAction = false;
                showNotification('Medical certificate signed successfully!', 'success');
            } else {
                // Add signature to prescription
                addSignatureToPrescription();
                hideDigitalSignatureModal();
                showNotification('Prescription signed successfully!', 'success');
            }
        }

        // Legacy function for PIN-based validation (backup)
        function validateDigitalSignatureWithPin() {
            const enteredPin = document.getElementById('signaturePinInput').value;
            const pinError = document.getElementById('pinError');
            
            if (enteredPin === doctorProfile.signaturePin) {
                // Check if this is for certificate or prescription
                if (window.tempCertificateAction) {
                    // Handle certificate signing
                    const formData = getCertificateFormData();
                    saveCertificate(formData);
                    hideCertificatePreview();
                    hideDigitalSignatureModal();
                    window.tempCertificateAction = false;
                    showNotification('Medical certificate issued successfully!', 'success');
                } else {
                    // PIN is correct, add signature to prescription
                    addSignatureToPrescription();
                    hideDigitalSignatureModal();
                    showNotification('Digital signature added successfully!', 'success');
                }
            } else {
                // PIN is incorrect
                if (pinError) {
                    pinError.classList.remove('hidden');
                }
                document.getElementById('signaturePinInput').value = '';
                
                // Add shake animation
                const modal = document.querySelector('#signatureModal .bg-white');
                if (modal) {
                    modal.style.animation = 'shake 0.5s';
                    setTimeout(() => {
                        modal.style.animation = '';
                    }, 500);
                }
            }
        }
        
        function addSignatureToPrescription() {
            const signatureSection = document.getElementById('signatureSection');
            
            if (signatureSection && doctorProfile.digitalSignature) {
                // Generate updated authentication data
                const timestamp = formatMedicalTimestamp();
                const signatureHash = generateDigitalSignatureHash(
                    doctorProfile.digitalSignature, 
                    timestamp.iso, 
                    doctorProfile.regNumber || 'UNKNOWN'
                );
                
                // Update the signature section with professional format
                signatureSection.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <img src="${doctorProfile.digitalSignature}" alt="Digital Signature" style="max-height: 50px; max-width: 180px; display: block; margin: 0 auto;">
                    </div>
                    <div style="border-top: 1px solid #333; padding-top: 8px; font-size: 12px;">
                        <div style="font-weight: bold; margin-bottom: 3px;">${doctorProfile.doctorName || 'Dr. [Your Name]'}</div>
                        <div style="color: #6b7280; margin-bottom: 2px;">${doctorProfile.qualifications || 'MBBS, MD'}</div>
                        <div style="color: #6b7280; font-size: 11px;">Reg. No: ${doctorProfile.regNumber || '[Registration Number]'}</div>
                        <div style="color: #059669; font-size: 10px; margin-top: 5px; font-weight: 500;"> Digitally Signed & Verified</div>
                        <div style="color: #6b7280; font-size: 9px; margin-top: 3px;">Signed: ${timestamp.date} ${timestamp.time}</div>
                    </div>
                `;
                
                signatureSection.classList.remove('hidden');
                
                // Update authentication hash in footer
                const authHashElement = document.querySelector('footer p:last-child');
                if (authHashElement && authHashElement.textContent.includes('Auth Hash:')) {
                    authHashElement.innerHTML = `<strong>Auth Hash:</strong> ${signatureHash}`;
                }
                
                showNotification('Prescription signed successfully with digital authentication!', 'success');
            }
        }

        // Type Signature Functions
        function setupTypeSignature() {
            const signatureText = document.getElementById('signatureText');
            const fontButtons = document.querySelectorAll('.font-style-btn');
            const fontSizeRadios = document.querySelectorAll('input[name="fontSize"]');
            const previewElement = document.getElementById('signaturePreviewText');
            
            let selectedFont = 'Dancing Script';
            let selectedSize = '32';
            
            // Handle text input
            if (signatureText) {
                signatureText.addEventListener('input', updateSignaturePreview);
            }
            
            // Handle font selection
            fontButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    fontButtons.forEach(btn => btn.classList.remove('bg-blue-100', 'border-blue-500'));
                    
                    // Add active class to clicked button
                    this.classList.add('bg-blue-100', 'border-blue-500');
                    
                    selectedFont = this.getAttribute('data-font');
                    updateSignaturePreview();
                });
            });
            
            // Handle font size selection
            fontSizeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    selectedSize = this.value;
                    updateSignaturePreview();
                });
            });
            
            function updateSignaturePreview() {
                if (previewElement && signatureText) {
                    const text = signatureText.value || 'Your signature will appear here';
                    previewElement.textContent = text;
                    previewElement.style.fontFamily = `'${selectedFont}', cursive`;
                    previewElement.style.fontSize = `${selectedSize}px`;
                }
            }
            
            // Set default font selection
            if (fontButtons.length > 0) {
                fontButtons[0].classList.add('bg-blue-100', 'border-blue-500');
            }
            
            // Initial preview update
            updateSignaturePreview();
        }
        
        function showTypeSignatureModal() {
            const modal = document.getElementById('typeSignatureModal');
            if (modal) {
                modal.classList.remove('hidden');
                // Clear previous input
                const signatureText = document.getElementById('signatureText');
                if (signatureText) {
                    signatureText.value = '';
                    signatureText.focus();
                }
                // Update preview
                updateTypeSignaturePreview();
            }
        }
        
        function hideTypeSignatureModal() {
            const modal = document.getElementById('typeSignatureModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        function updateTypeSignaturePreview() {
            const signatureText = document.getElementById('signatureText');
            const previewElement = document.getElementById('signaturePreviewText');
            const selectedFont = document.querySelector('.font-style-btn.bg-blue-100');
            const selectedSize = document.querySelector('input[name="fontSize"]:checked');
            
            if (previewElement && signatureText) {
                const text = signatureText.value || 'Your signature will appear here';
                previewElement.textContent = text;
                
                if (selectedFont) {
                    const fontFamily = selectedFont.getAttribute('data-font');
                    previewElement.style.fontFamily = `'${fontFamily}', cursive`;
                }
                
                if (selectedSize) {
                    previewElement.style.fontSize = `${selectedSize.value}px`;
                }
            }
        }
        
        function saveTypedSignatureData() {
            const signatureText = document.getElementById('signatureText');
            const selectedFont = document.querySelector('.font-style-btn.bg-blue-100');
            const selectedSize = document.querySelector('input[name="fontSize"]:checked');
            
            if (!signatureText || !signatureText.value.trim()) {
                showNotification('Please enter your signature text', 'error');
                return;
            }
            
            const text = signatureText.value.trim();
            const fontFamily = selectedFont ? selectedFont.getAttribute('data-font') : 'Dancing Script';
            const fontSize = selectedSize ? selectedSize.value : '32';
            
            // Create a canvas to generate the signature image
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = 400;
            canvas.height = 100;
            
            // Set font and style
            ctx.font = `${fontSize}px "${fontFamily}", cursive`;
            ctx.fillStyle = '#000000';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Draw the text
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
            
            // Convert to base64
            tempSignatureData = canvas.toDataURL('image/png');
            
            // Show preview
            showSignaturePreview(tempSignatureData);
            
            // Hide type modal
            hideTypeSignatureModal();
            
            // Trigger validation to enable save button if conditions are met
            if (globalValidatePins) {
                globalValidatePins();
            }
            
            showNotification('Typed signature created! Set your PIN to save.', 'success');
        }
        
        function exportData() {
            try {
                // Collect all data
                const exportData = {
                    doctorProfile: doctorProfile,
                    patients: patients,
                    consultations: {}
                };
                
                // Collect all consultations for each patient
                patients.forEach(patient => {
                    exportData.consultations[patient.id] = loadConsultations(patient.id);
                });
                
                exportData.exportDate = new Date().toISOString();
                exportData.appVersion = '1.0.0';
                
                // Create download
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `clinic-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert('Data exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting data. Please try again.');
            }
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importedData.doctorProfile || !importedData.patients) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Confirm import
                    const confirmed = await showCustomConfirm(
                        'Import Data',
                        'This will replace all existing data. Are you sure?',
                        'Import',
                        'Cancel',
                        'upload'
                    );
                    if (!confirmed) return;
                    
                    // Import doctor profile
                    if (importedData.doctorProfile) {
                        doctorProfile = importedData.doctorProfile;
                        saveDoctorProfile();
                    }
                    
                    // Import patients
                    if (importedData.patients) {
                        patients = importedData.patients;
                        savePatients();
                    }
                    
                    // Import consultations
                    if (importedData.consultations) {
                        Object.keys(importedData.consultations).forEach(patientId => {
                            saveConsultations(patientId, importedData.consultations[patientId]);
                        });
                    }
                    
                    // Refresh UI
                    renderPatientList();
                    updateStorageInfo();
                    
                    alert('Data imported successfully!');
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }
        
        async function clearAllData() {
            const confirmed = await showCustomConfirm(
                'Delete All Data',
                ' This will permanently delete ALL data including patients, consultations, and settings. This cannot be undone!',
                'Continue',
                'Cancel',
                'trash-2'
            );
            
            if (confirmed) {
                const secondConfirm = await showCustomPrompt(
                    'Final Confirmation',
                    'Type "DELETE" exactly to confirm permanent deletion:',
                    'Type DELETE here...',
                    'Delete Forever',
                    'Cancel'
                );
                if (secondConfirm === 'DELETE') {
                    // Clear all localStorage
                    Object.values(STORAGE_KEYS).forEach(key => {
                        localStorage.removeItem(key);
                    });
                    
                    // Clear consultation data for all patients
                    patients.forEach(patient => {
                        localStorage.removeItem(STORAGE_KEYS.CONSULTATIONS + patient.id);
                    });
                    
                    // Reset to default state
                    doctorProfile = { ...defaultDoctorProfile };
                    patients = [];
                    currentPatientId = null;
                    
                    saveDoctorProfile();
                    renderPatientList();
                    updateStorageInfo();
                    
                    alert('All data has been cleared.');
                    showView('patientListView');
                }
            }
        }
        
        function updateStorageInfo() {
            try {
                const used = JSON.stringify({
                    profile: doctorProfile,
                    patients: patients,
                    consultations: patients.map(p => loadConsultations(p.id))
                }).length;
                
                const usedKB = (used / 1024).toFixed(2);
                const patientCount = patients.length;
                const consultCount = patients.reduce((total, p) => total + loadConsultations(p.id).length, 0);
                
                document.getElementById('storageInfo').innerHTML = `
                    Data Size: ${usedKB} KB<br>
                    Patients: ${patientCount}<br>
                    Consultations: ${consultCount}<br>
                    Storage: Local Device
                `;
            } catch (error) {
                document.getElementById('storageInfo').textContent = 'Unable to calculate storage info';
            }
        }
        
                // --- ADVANCED AI FUNCTIONS ---
                
        function generateAIPatientSummary() {
            const patient = patients.find(p => p.id === currentPatientId);
            if (!patient) {
                showNotification('Please select a patient first', 'error');
                return;
            }
            
            const consultations = loadConsultations(currentPatientId);
            const vitals = loadVitals(currentPatientId);
            const tests = loadTestResults(currentPatientId);
            
            showNotification('Generating basic patient summary...', 'info');
            
            try {
                const basicSummary = generateBasicSummary(patient, consultations, vitals, tests);
                showAISummaryModal(basicSummary, patient);
                
            } catch (error) {
                console.error('Summary error:', error);
                showNotification('Error generating summary. Please try again.', 'error');
            }
        }                function generateBasicSummary(patient, consultations, vitals, tests) {
                    const age = parseInt(patient.age) || 0;
                    const lastConsultation = consultations.length > 0 ? consultations[consultations.length - 1] : null;
                    const lastVitals = vitals.length > 0 ? vitals[vitals.length - 1] : null;
                    
                    return `
        **COMPREHENSIVE PATIENT SUMMARY**
        
        **Patient Information:**
         ${patient.name}, ${patient.age} year old ${patient.gender}
         Contact: ${patient.contact || 'Not provided'}
         Address: ${patient.address || 'Not provided'}
        
        **Medical History:**
        ${patient.medicalHistory ? ` Past Medical History: ${patient.medicalHistory}` : ' No significant past medical history'}
        ${patient.surgicalHistory ? ` Surgical History: ${patient.surgicalHistory}` : ' No previous surgeries'}
        ${patient.medicationHistory ? ` Current Medications: ${patient.medicationHistory}` : ' No regular medications'}
        
        **Risk Factors:**
        ${patient.familyHistory ? ` Family History: ${patient.familyHistory}` : ' No significant family history'}
        ${patient.smokingHistory && patient.smokingHistory !== 'Never smoked' ? ` Smoking: ${patient.smokingHistory}` : ''}
        ${patient.alcoholHistory && patient.alcoholHistory !== 'Non-drinker' ? ` Alcohol: ${patient.alcoholHistory}` : ''}
        ${age > 35 ? ' Age-related risks for cardiovascular disease' : ''}
        
        **Allergies:**
        ${patient.drugAllergies ? ` Drug Allergies: ${patient.drugAllergies}` : ' No known drug allergies'}
        ${patient.foodAllergies ? ` Food Allergies: ${patient.foodAllergies}` : ' No known food allergies'}
        
        ${patient.gender === 'Female' ? `
        **Gynecological Summary:**
        ${patient.menarche ? ` Menarche: ${patient.menarche} years` : ''}
        ${patient.menstrualCycle ? ` Cycle Length: ${patient.menstrualCycle} days` : ''}
        ${patient.gravida ? ` Obstetric History: G${patient.gravida}P${patient.para || 0}A${patient.abortions || 0}L${patient.living || 0}` : ''}
        ${patient.contraceptiveHistory ? ` Contraception: ${patient.contraceptiveHistory}` : ''}
        ` : ''}
        
        **Recent Clinical Activity:**
         Total Consultations: ${consultations.length}
        ${lastConsultation ? ` Last Visit: ${new Date(lastConsultation.date).toLocaleDateString()} - ${lastConsultation.diagnosis}` : ' No recent consultations'}
         Vitals Records: ${vitals.length}
        ${lastVitals ? ` Latest Vitals: BP ${lastVitals.bloodPressure || 'N/A'}, Weight ${lastVitals.weight || 'N/A'}kg` : ''}
         Test Results: ${tests.length} files uploaded
        
        **Clinical Recommendations:**
         Regular follow-up as per condition requirements
        ${age >= 21 && patient.gender === 'Female' ? ' Annual Pap smear screening' : ''}
        ${age >= 40 ? ' Annual mammography (if female), cardiac screening' : ''}
        ${age >= 30 ? ' Diabetes and hypertension screening every 2-3 years' : ''}
         Maintain healthy lifestyle with regular exercise
         Medication compliance if on regular treatment
        
        **Priority Actions:**
        ${consultations.length === 0 ? ' Schedule initial comprehensive consultation' : ''}
        ${vitals.length === 0 ? ' Record baseline vitals' : ''}
        ${patient.drugAllergies ? ' Ensure all prescriptions check for drug allergies' : ''}
         Update emergency contact information
         Regular preventive health screening as appropriate for age
                    `.trim();
                }
                
                function showAISummaryModal(summary, patient) {
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-96 overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold flex items-center">
                                    <i data-lucide="brain" class="w-5 h-5 mr-2 text-purple-600"></i>
                                    AI-Generated Patient Summary: ${patient.name}
                                </h3>
                                <button class="close-summary-modal text-gray-500 hover:text-gray-700">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <div class="prose max-w-none">
                                <pre class="whitespace-pre-wrap text-sm font-sans leading-relaxed bg-gray-50 p-4 rounded-lg">${summary}</pre>
                            </div>
                            <div class="flex justify-between mt-6">
                                <button class="copy-summary-btn bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 flex items-center">
                                    <i data-lucide="copy" class="w-4 h-4 mr-2"></i>
                                    Copy Summary
                                </button>
                                <button class="regenerate-summary-btn bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 flex items-center">
                                    <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                                    Regenerate
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    lucide.createIcons();
                    
                    // Handle close
                    modal.querySelector('.close-summary-modal').onclick = () => {
                        document.body.removeChild(modal);
                    };
                    
                    // Handle copy
                    modal.querySelector('.copy-summary-btn').onclick = async () => {
                        try {
                            await navigator.clipboard.writeText(summary);
                            showNotification('Summary copied to clipboard!', 'success');
                        } catch (error) {
                            console.error('Copy failed:', error);
                            showNotification('Copy failed. Please select and copy manually.', 'error');
                        }
                    };
                    
                    // Handle regenerate
                    modal.querySelector('.regenerate-summary-btn').onclick = () => {
                        document.body.removeChild(modal);
                        generateAIPatientSummary();
                    };
                    
                    // Close on backdrop click
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            document.body.removeChild(modal);
                        }
                    };
                }
                
                // Smart AI Insights Panel Manager
                async function showSmartAIInsights(patient, consultationData = null) {
                    const panel = document.getElementById('smartAIPanel');
                    const content = document.getElementById('aiInsightsContent');
                    
                    // Show loading
                    content.innerHTML = '<div class="text-center py-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div><p class="mt-2 text-sm text-gray-600">Analyzing patient data...</p></div>';
                    panel.classList.remove('hidden');
                    
                    try {
                        const insights = await generateSmartInsights(patient, consultationData);
                        displaySmartInsights(insights);
                    } catch (error) {
                        console.error('Smart insights error:', error);
                        content.innerHTML = '<div class="text-red-500 text-sm">Error generating insights. Please try again.</div>';
                    }
                }
        
        async function generateSmartInsights(patient, consultationData) {
            const insights = {
                riskFactors: [],
                drugInteractions: [],
                recommendations: [],
                redFlags: [],
                preventiveCare: []
            };
            
            if (!patient) return insights;
            
            // Risk Factor Analysis
            insights.riskFactors = await analyzeRiskFactors(patient);
            
            // Drug Interaction Check
            if (consultationData && consultationData.medications) {
                insights.drugInteractions = await checkDrugInteractions(consultationData.medications, patient);
            }
            
            // Clinical Recommendations
            insights.recommendations = await generateClinicalRecommendations(patient, consultationData);
            
            // Red Flag Warnings
            insights.redFlags = await identifyRedFlags(patient, consultationData);
            
            // Preventive Care Suggestions
            insights.preventiveCare = await suggestPreventiveCare(patient);
            
            return insights;
        }
        
        async function analyzeRiskFactors(patient) {
            const riskFactors = [];
            const age = parseInt(patient.age) || 0;
            
            // Age-based risks
            if (age > 35) {
                riskFactors.push({
                    type: 'Age-related',
                    factor: 'Increased risk for pregnancy complications',
                    severity: 'moderate',
                    recommendation: 'Regular monitoring if planning pregnancy'
                });
            }
            
            if (age > 40) {
                riskFactors.push({
                    type: 'Screening',
                    factor: 'Due for mammography screening',
                    severity: 'low',
                    recommendation: 'Annual mammography recommended'
                });
            }
            
            // Medical history risks
            if (patient.medicalHistory) {
                const history = patient.medicalHistory.toLowerCase();
                if (history.includes('diabetes')) {
                    riskFactors.push({
                        type: 'Metabolic',
                        factor: 'Diabetes increases cardiovascular risk',
                        severity: 'high',
                        recommendation: 'Regular HbA1c monitoring, lipid profile'
                    });
                }
                
                if (history.includes('hypertension')) {
                    riskFactors.push({
                        type: 'Cardiovascular',
                        factor: 'Hypertension risk factor',
                        severity: 'moderate',
                        recommendation: 'Regular BP monitoring, lifestyle modification'
                    });
                }
            }
            
            // Family history risks
            if (patient.familyHistory) {
                const familyHistory = patient.familyHistory.toLowerCase();
                if (familyHistory.includes('breast cancer') || familyHistory.includes('ovarian cancer')) {
                    riskFactors.push({
                        type: 'Genetic',
                        factor: 'Family history of breast/ovarian cancer',
                        severity: 'high',
                        recommendation: 'Consider genetic counseling, early screening'
                    });
                }
            }
            
            // Lifestyle risks
            if (patient.smokingHistory === 'Current smoker') {
                riskFactors.push({
                    type: 'Lifestyle',
                    factor: 'Smoking increases multiple health risks',
                    severity: 'high',
                    recommendation: 'Smoking cessation counseling'
                });
            }
            
            // BMI risks
            if (patient.height && patient.weight) {
                const bmi = calculateBMI(patient.height, patient.weight);
                if (bmi > 30) {
                    riskFactors.push({
                        type: 'Metabolic',
                        factor: 'Obesity (BMI > 30)',
                        severity: 'moderate',
                        recommendation: 'Weight management, diabetes screening'
                    });
                }
            }
            
            // Try AI-powered risk analysis
            if (AI_CONFIG.enabled) {
                try {
                    const aiRisks = await getAIRiskAssessment(patient);
                    riskFactors.push(...aiRisks);
                } catch (error) {
                    console.warn('AI risk assessment failed:', error);
                }
            }
            
            return riskFactors;
        }
        
        async function getAIRiskAssessment(patient) {
            const prompt = `Analyze the following patient profile for medical risk factors:

Patient: ${patient.age} year old ${patient.gender}
Medical History: ${patient.medicalHistory || 'None provided'}
Family History: ${patient.familyHistory || 'None provided'}
Medications: ${patient.medicationHistory || 'None provided'}
Lifestyle: Smoking: ${patient.smokingHistory || 'Unknown'}, Alcohol: ${patient.alcoholHistory || 'Unknown'}

Return ONLY a valid JSON array with this exact format:
[
  {
    "type": "Risk category",
    "factor": "Specific risk factor description",
    "severity": "high",
    "recommendation": "Specific action recommendation"
  }
]

IMPORTANT: Return ONLY the JSON array, no explanatory text before or after. Use proper JSON syntax with double quotes.`;

            try {
                const response = await callGemini(prompt);
                if (response) {
                    console.log('Raw risk assessment AI response:', response);
                    
                    const jsonMatch = response.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        console.log('Extracted risk assessment JSON:', jsonMatch[0]);
                        try {
                            const parsedRisks = JSON.parse(jsonMatch[0]);
                            if (Array.isArray(parsedRisks) && parsedRisks.length > 0) {
                                return parsedRisks;
                            }
                        } catch (parseError) {
                            console.warn('Risk assessment JSON parse failed:', parseError.message);
                            
                            // Try to clean the JSON string
                            let cleanJson = jsonMatch[0];
                            cleanJson = cleanJson.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
                            cleanJson = cleanJson.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
                            cleanJson = cleanJson.replace(/,\s*}/g, '}');
                            cleanJson = cleanJson.replace(/,\s*]/g, ']');
                            
                            try {
                                const parsedRisks = JSON.parse(cleanJson);
                                if (Array.isArray(parsedRisks) && parsedRisks.length > 0) {
                                    return parsedRisks;
                                }
                            } catch (cleanParseError) {
                                console.warn('Cleaned risk assessment JSON parse also failed:', cleanParseError.message);
                            }
                        }
                    }
                    
                    // Text parsing fallback
                    console.log('Attempting risk assessment text parsing fallback...');
                    const lines = response.split('\n').filter(line => line.trim().length > 0);
                    const risks = [];
                    
                    lines.forEach(line => {
                        const cleanLine = line.replace(/^\d+\.?\s*/, '').replace(/^[\-\*]\s*/, '').trim();
                        if (cleanLine.length > 5 && !cleanLine.toLowerCase().startsWith('risk')) {
                            risks.push({
                                type: 'General',
                                factor: cleanLine,
                                severity: 'moderate',
                                recommendation: 'Monitor and follow up as needed'
                            });
                        }
                    });
                    
                    if (risks.length > 0) {
                        return risks.slice(0, 3);
                    }
                }
            } catch (error) {
                console.warn('AI risk assessment error:', error);
            }
            
            return [];
        }
        
        async function checkDrugInteractions(medications, patient) {
            const interactions = [];
            
            if (!medications || medications.length < 2) return interactions;
            
            // Check for common interaction patterns
            const medNames = medications.map(med => med.name.toLowerCase());
            
            // Common interaction checks
            const interactionRules = [
                {
                    drugs: ['warfarin', 'aspirin'],
                    severity: 'high',
                    effect: 'Increased bleeding risk',
                    action: 'Monitor INR closely, consider PPI'
                },
                {
                    drugs: ['metformin', 'contrast'],
                    severity: 'high',
                    effect: 'Risk of lactic acidosis',
                    action: 'Stop metformin 48h before contrast'
                },
                {
                    drugs: ['amlodipine', 'simvastatin'],
                    severity: 'moderate',
                    effect: 'Increased statin levels',
                    action: 'Use lower statin dose'
                },
                {
                    drugs: ['fluconazole', 'warfarin'],
                    severity: 'high',
                    effect: 'Enhanced anticoagulation',
                    action: 'Reduce warfarin dose, monitor INR'
                }
            ];
            
            interactionRules.forEach(rule => {
                const hasAllDrugs = rule.drugs.every(drug => 
                    medNames.some(medName => medName.includes(drug))
                );
                
                if (hasAllDrugs) {
                    interactions.push({
                        drugs: rule.drugs,
                        severity: rule.severity,
                        effect: rule.effect,
                        action: rule.action
                    });
                }
            });
            
            // AI-powered interaction check
            if (AI_CONFIG.enabled && medications.length > 1) {
                try {
                    const aiInteractions = await getAIDrugInteractions(medications, patient);
                    interactions.push(...aiInteractions);
                } catch (error) {
                    console.warn('AI drug interaction check failed:', error);
                }
            }
            
            return interactions;
        }
        
        async function getAIDrugInteractions(medications, patient) {
            const medList = medications.map(med => `${med.name} ${med.dosage}`).join(', ');
            
            const prompt = `Check for drug interactions in this medication list for a ${patient.age} year old ${patient.gender}:

Medications: ${medList}
Patient Conditions: ${patient.medicalHistory || 'None'}
Allergies: ${patient.drugAllergies || 'None'}

Return ONLY a valid JSON array with this exact format:
[
  {
    "drugs": ["drug1", "drug2"],
    "severity": "high",
    "effect": "Specific interaction effect",
    "action": "Specific recommendation"
  }
]

IMPORTANT: Return ONLY the JSON array, no explanatory text before or after. Use proper JSON syntax with double quotes.`;

            try {
                const response = await callGemini(prompt);
                if (response) {
                    console.log('Raw drug interaction AI response:', response);
                    
                    const jsonMatch = response.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        console.log('Extracted drug interaction JSON:', jsonMatch[0]);
                        try {
                            const parsedInteractions = JSON.parse(jsonMatch[0]);
                            if (Array.isArray(parsedInteractions) && parsedInteractions.length > 0) {
                                return parsedInteractions;
                            }
                        } catch (parseError) {
                            console.warn('Drug interaction JSON parse failed:', parseError.message);
                            
                            // Try to clean the JSON string
                            let cleanJson = jsonMatch[0];
                            cleanJson = cleanJson.replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
                            cleanJson = cleanJson.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
                            cleanJson = cleanJson.replace(/,\s*}/g, '}');
                            cleanJson = cleanJson.replace(/,\s*]/g, ']');
                            
                            try {
                                const parsedInteractions = JSON.parse(cleanJson);
                                if (Array.isArray(parsedInteractions) && parsedInteractions.length > 0) {
                                    return parsedInteractions;
                                }
                            } catch (cleanParseError) {
                                console.warn('Cleaned drug interaction JSON parse also failed:', cleanParseError.message);
                            }
                        }
                    }
                    
                    // Text parsing fallback
                    console.log('Attempting drug interaction text parsing fallback...');
                    const lines = response.split('\n').filter(line => line.trim().length > 0);
                    const interactions = [];
                    
                    lines.forEach(line => {
                        const cleanLine = line.replace(/^\d+\.?\s*/, '').replace(/^[\-\*]\s*/, '').trim();
                        if (cleanLine.length > 10 && !cleanLine.toLowerCase().startsWith('interaction')) {
                            interactions.push({
                                drugs: ['Unknown', 'Unknown'],
                                severity: 'moderate',
                                effect: cleanLine,
                                action: 'Monitor patient closely'
                            });
                        }
                    });
                    
                    if (interactions.length > 0) {
                        return interactions.slice(0, 3);
                    }
                }
            } catch (error) {
                console.warn('AI drug interaction error:', error);
            }
            
            return [];
        }
        
        async function generateClinicalRecommendations(patient, consultationData) {
            const recommendations = [];
            
            // Age-based recommendations
            const age = parseInt(patient.age) || 0;
            
            if (age >= 21) {
                recommendations.push({
                    category: 'Screening',
                    recommendation: 'Pap smear due (every 3 years)',
                    priority: 'routine'
                });
            }
            
            if (age >= 40) {
                recommendations.push({
                    category: 'Screening',
                    recommendation: 'Annual mammography',
                    priority: 'important'
                });
            }
            
            if (age >= 50) {
                recommendations.push({
                    category: 'Screening',
                    recommendation: 'Colorectal cancer screening',
                    priority: 'important'
                });
            }
            
            // Condition-specific recommendations
            if (consultationData && consultationData.diagnosis) {
                const diagnosis = consultationData.diagnosis.toLowerCase();
                
                if (diagnosis.includes('pcos')) {
                    recommendations.push({
                        category: 'Metabolic',
                        recommendation: 'Annual diabetes screening (OGTT)',
                        priority: 'important'
                    });
                    recommendations.push({
                        category: 'Cardiovascular',
                        recommendation: 'Lipid profile every 2 years',
                        priority: 'routine'
                    });
                }
                
                if (diagnosis.includes('hypertension')) {
                    recommendations.push({
                        category: 'Cardiovascular',
                        recommendation: 'ECG and echocardiogram',
                        priority: 'important'
                    });
                }
            }
            
            return recommendations;
        }
        
        async function identifyRedFlags(patient, consultationData) {
            const redFlags = [];
            
            if (!consultationData) return redFlags;
            
            const complaints = (consultationData.chiefComplaint || '').toLowerCase();
            const diagnosis = (consultationData.diagnosis || '').toLowerCase();
            
            // Gynecological red flags
            if (complaints.includes('postmenopausal bleeding')) {
                redFlags.push({
                    flag: 'Postmenopausal bleeding',
                    concern: 'Rule out endometrial cancer',
                    action: 'Urgent gynecology referral, endometrial biopsy'
                });
            }
            
            if (complaints.includes('severe pelvic pain') && complaints.includes('missed period')) {
                redFlags.push({
                    flag: 'Severe pelvic pain + missed period',
                    concern: 'Ectopic pregnancy',
                    action: 'Urgent -hCG, pelvic ultrasound'
                });
            }
            
            // General red flags
            if (complaints.includes('chest pain') || complaints.includes('breathlessness')) {
                redFlags.push({
                    flag: 'Chest pain/breathlessness',
                    concern: 'Cardiac event',
                    action: 'ECG, cardiac enzymes, consider emergency referral'
                });
            }
            
            return redFlags;
        }
        
        async function suggestPreventiveCare(patient) {
            const suggestions = [];
            const age = parseInt(patient.age) || 0;
            
            // Age-based preventive care
            if (age >= 20) {
                suggestions.push({
                    category: 'Reproductive Health',
                    suggestion: 'Annual gynecological examination',
                    timing: 'Yearly'
                });
            }
            
            if (age >= 30) {
                suggestions.push({
                    category: 'Metabolic',
                    suggestion: 'Diabetes screening (if risk factors)',
                    timing: 'Every 3 years'
                });
            }
            
            if (age >= 40) {
                suggestions.push({
                    category: 'Cardiovascular',
                    suggestion: 'Lipid profile screening',
                    timing: 'Every 5 years'
                });
            }
            
            // Risk factor based
            if (patient.familyHistory) {
                const history = patient.familyHistory.toLowerCase();
                if (history.includes('diabetes')) {
                    suggestions.push({
                        category: 'Genetic Risk',
                        suggestion: 'Early diabetes screening',
                        timing: 'Every 2 years from age 25'
                    });
                }
            }
            
            return suggestions;
        }
        
        function displaySmartInsights(insights) {
            const content = document.getElementById('aiInsightsContent');
            
            const sectionsHtml = `
                ${insights.redFlags.length > 0 ? `
                <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                    <h4 class="font-semibold text-red-800 mb-2 flex items-center">
                        <i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i>
                        Red Flags
                    </h4>
                    ${insights.redFlags.map(flag => `
                        <div class="text-sm mb-2">
                            <div class="font-medium text-red-700">${flag.flag}</div>
                            <div class="text-red-600">${flag.concern}</div>
                            <div class="text-xs text-red-500">${flag.action}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                ${insights.drugInteractions.length > 0 ? `
                <div class="mb-4 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                    <h4 class="font-semibold text-orange-800 mb-2 flex items-center">
                        <i data-lucide="alert-circle" class="w-4 h-4 mr-2"></i>
                        Drug Interactions
                    </h4>
                    ${insights.drugInteractions.map(interaction => `
                        <div class="text-sm mb-2">
                            <div class="font-medium text-orange-700">${interaction.drugs.join(' + ')}</div>
                            <div class="text-orange-600">${interaction.effect}</div>
                            <div class="text-xs text-orange-500">${interaction.action}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                ${insights.riskFactors.length > 0 ? `
                <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h4 class="font-semibold text-yellow-800 mb-2 flex items-center">
                        <i data-lucide="trending-up" class="w-4 h-4 mr-2"></i>
                        Risk Factors
                    </h4>
                    ${insights.riskFactors.map(risk => `
                        <div class="text-sm mb-2">
                            <div class="font-medium text-yellow-700">${risk.factor}</div>
                            <div class="text-yellow-600">Severity: ${risk.severity}</div>
                            <div class="text-xs text-yellow-500">${risk.recommendation}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                ${insights.recommendations.length > 0 ? `
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                        <i data-lucide="lightbulb" class="w-4 h-4 mr-2"></i>
                        Clinical Recommendations
                    </h4>
                    ${insights.recommendations.map(rec => `
                        <div class="text-sm mb-2">
                            <div class="font-medium text-blue-700">${rec.recommendation}</div>
                            <div class="text-blue-600">Category: ${rec.category}</div>
                            <div class="text-xs text-blue-500">Priority: ${rec.priority}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                ${insights.preventiveCare.length > 0 ? `
                <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <h4 class="font-semibold text-green-800 mb-2 flex items-center">
                        <i data-lucide="shield-check" class="w-4 h-4 mr-2"></i>
                        Preventive Care
                    </h4>
                    ${insights.preventiveCare.map(care => `
                        <div class="text-sm mb-2">
                            <div class="font-medium text-green-700">${care.suggestion}</div>
                            <div class="text-green-600">Category: ${care.category}</div>
                            <div class="text-xs text-green-500">Timing: ${care.timing}</div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}
                
                <div class="flex justify-center mt-4">
                    <button id="refreshInsights" class="text-xs bg-purple-100 text-purple-600 px-3 py-1 rounded hover:bg-purple-200">
                        <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i>
                        Refresh Analysis
                    </button>
                </div>
            `;
            
            content.innerHTML = sectionsHtml;
            lucide.createIcons();
            
            // Add refresh functionality
            document.getElementById('refreshInsights').onclick = () => {
                const patient = patients.find(p => p.id === currentPatientId);
                if (patient) {
                    showSmartAIInsights(patient);
                }
            };
        }
        
        // Auto-trigger smart insights when viewing patient details
        function setupSmartInsights() {
            // Add smart insights button to patient detail view
            const smartInsightsBtn = document.createElement('button');
            smartInsightsBtn.id = 'smartInsightsBtn';
            smartInsightsBtn.className = 'text-sm bg-purple-100 text-purple-600 px-3 py-1 rounded hover:bg-purple-200';
            smartInsightsBtn.innerHTML = '<i data-lucide="brain" class="w-4 h-4 inline mr-1"></i>AI Insights';
            
            smartInsightsBtn.onclick = () => {
                const patient = patients.find(p => p.id === currentPatientId);
                if (patient) {
                    showSmartAIInsights(patient);
                }
            };
            
            // Add to patient header buttons
            const patientHeaderButtons = document.querySelector('#patientDetailView .flex.space-x-2');
            if (patientHeaderButtons) {
                patientHeaderButtons.appendChild(smartInsightsBtn);
                lucide.createIcons();
            }
        }
        
        // --- AI ASSISTANT FUNCTIONS ---
        function setupAIAssistants() {
            // Set up initial AI assistant buttons
            const aiComplaintBtn = document.getElementById('aiComplaintBtn');
            const aiDiagnosisBtn = document.getElementById('aiDiagnosisBtn');
            const aiInvestigationBtn = document.getElementById('aiInvestigationBtn');
            const aiAdviceBtn = document.getElementById('aiAdviceBtn');
            
            if (aiComplaintBtn) aiComplaintBtn.onclick = () => suggestComplaints();
            if (aiDiagnosisBtn) aiDiagnosisBtn.onclick = () => suggestDiagnosis();
            if (aiInvestigationBtn) aiInvestigationBtn.onclick = () => suggestInvestigations();
            if (aiAdviceBtn) aiAdviceBtn.onclick = () => generateAdvice();
            
            // Set up medication AI buttons (they may be dynamically created)
            setupMedicationAIButtons();
        }
        
        function setupMedicationAIButtons() {
            // Medication AI buttons are handled by event delegation in attachEventListeners
            // No need for direct event handler assignment
            console.log('Medication AI buttons will be handled by event delegation');
        }
        
        async function generateCompleteMedicationPlan() {
            const diagnosis = document.getElementById('diagnosis').value;
            const complaintText = document.getElementById('chiefComplaint').value;
            const patient = currentPatientId ? patients.find(p => p.id === currentPatientId) : null;
            
            if (!diagnosis && !complaintText) {
                showNotification('Please enter diagnosis or complaints first', 'error');
                return;
            }
            
            let medicationPlan = [];
            
            // AI-powered comprehensive medication plan with enhanced debugging
            console.log(' Starting medication plan generation...');
            console.log('AI_CONFIG.enabled:', AI_CONFIG.enabled);
            console.log('AI_CONFIG.gemini.apiKey length:', AI_CONFIG.gemini.apiKey?.length || 0);
            console.log('AI_CONFIG.gemini.model:', AI_CONFIG.gemini.model);
            
            const hasValidApiKey = AI_CONFIG.gemini.apiKey && AI_CONFIG.gemini.apiKey.length > 10;
            
            if (AI_CONFIG.enabled && hasValidApiKey) {
                try {
                    showNotification('Generating comprehensive medication plan...', 'info');
                    
                    const aiPrompt = `As a medical AI assistant for Dr. Chanda Chowdhury (Gynaecologist & Obstetrician), create a comprehensive medication plan:

PATIENT DETAILS:
Age: ${getCurrentPatientAge()} years
Gender: ${patient ? patient.gender : 'Female'}
Weight: ${patient && patient.weight ? patient.weight + ' kg' : 'Average adult weight assumed'}
Chief Complaints: "${complaintText}"
Diagnosis: "${diagnosis}"

MEDICATION PLAN REQUIREMENTS:
1. Consider patient's age and gender for dosing
2. Include primary treatment medications
3. Add supportive/symptomatic relief medications if needed
4. Consider preventive medications where appropriate
5. Focus on Indian brand names when available
6. Provide complete dosing information

FORMAT REQUIRED - Return as JSON array:
[
  {
    "name": "Medication Name (Brand/Generic)",
    "dosage": "Specific dose with frequency (e.g., 500mg BD)",
    "duration": "Treatment duration (e.g., 7 days)",
    "timing": "When to take (e.g., after meals, empty stomach)",
    "indication": "Why prescribed (e.g., for pain relief)"
  }
]

SPECIALTY CONSIDERATIONS:
- Gynecological/obstetric medication preferences
- Age-appropriate dosing (pediatric/geriatric adjustments)
- Gender-specific considerations
- Drug interactions awareness
- Pregnancy/breastfeeding safety if applicable

Generate 3-6 medications for complete treatment. Return ONLY the JSON array.`;

                    console.log(' Making AI call for medication plan...');
                    const aiResponse = await callGemini(aiPrompt);
                    console.log(' Received AI response:', aiResponse?.substring(0, 200) + '...');
                    
                    if (aiResponse) {
                        try {
                            const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                            if (jsonMatch) {
                                console.log(' Found JSON in response:', jsonMatch[0].substring(0, 200) + '...');
                                medicationPlan = JSON.parse(jsonMatch[0]);
                                console.log(' Parsed medication plan:', medicationPlan.length, 'medications');
                            } else {
                                console.warn(' No JSON array found in AI response');
                                console.log('Full response:', aiResponse);
                            }
                        } catch (e) {
                            console.error(' AI medication plan parsing error:', e);
                            console.log('Response that failed to parse:', aiResponse);
                        }
                    } else {
                        console.warn(' Empty AI response received');
                    }
                } catch (error) {
                    console.error(' AI medication plan error:', error);
                    
                    // Enhanced error reporting
                    if (error.message.includes('API key')) {
                        showNotification('Invalid API key. Please check your Gemini API key in settings.', 'error');
                        return;
                    } else if (error.message.includes('quota') || error.message.includes('429')) {
                        showNotification('API quota exceeded. Please wait and try again later.', 'error');
                        return;
                    } else if (error.message.includes('network')) {
                        showNotification('Network error. Please check your internet connection.', 'error');
                        return;
                    }
                }
            } else {
                console.warn(' AI configuration issues:');
                console.log('- AI enabled:', AI_CONFIG.enabled);
                console.log('- Valid API key:', hasValidApiKey);
                if (!AI_CONFIG.enabled) {
                    showNotification('AI features are disabled. Please enable them in settings.', 'error');
                    return;
                } else if (!hasValidApiKey) {
                    showNotification('No valid Gemini API key found. Please add your API key in settings.', 'error');
                    return;
                }
            }
            
            if (medicationPlan.length === 0) {
                console.warn(' No medications in plan - showing fallback options');
                
                // Enhanced fallback with specific error context
                const errorContext = !AI_CONFIG.enabled ? 'AI disabled' : 
                                   !hasValidApiKey ? 'No API key' : 'AI call failed';
                
                showNotification(`Unable to generate medication plan (${errorContext}). Please check your AI configuration or try again.`, 'error');
                
                // Offer debugging options
                console.log(' Debugging options:');
                console.log('1. Run: checkAIConfiguration() - to check configuration');
                console.log('2. Run: testGeminiAPIConnection() - to test API connection');
                console.log('3. Run: debugGeminiResponse() - to debug API responses');
                
                return;
            }
            
            // Show comprehensive medication plan modal
            showCompleteMedicationPlanModal(medicationPlan);
        }
        
        function showCompleteMedicationPlanModal(medicationPlan) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-96 overflow-y-auto">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i data-lucide="brain" class="w-5 h-5 mr-2 text-green-600"></i>
                        Complete AI Medication Plan
                    </h3>
                    <div class="space-y-4">
                        ${medicationPlan.map((med, index) => `
                            <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer medication-plan-item" 
                                 data-name="${med.name}" data-dosage="${med.dosage}" data-duration="${med.duration}" 
                                 data-timing="${med.timing}" data-indication="${med.indication}">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                    <div>
                                        <div class="font-semibold text-gray-800">${med.name}</div>
                                        <div class="text-sm text-blue-600">${med.indication}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-600">Dosage & Frequency:</div>
                                        <div class="font-medium">${med.dosage}</div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-600">Duration & Timing:</div>
                                        <div class="font-medium">${med.duration}</div>
                                        <div class="text-xs text-gray-500">${med.timing}</div>
                                    </div>
                                </div>
                                <div class="mt-2 flex justify-end">
                                    <button class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200 add-single-med" 
                                            data-index="${index}">Add This Medication</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-between mt-6">
                        <button class="bg-gray-200 px-4 py-2 rounded cancel-btn">Cancel</button>
                        <div class="space-x-2">
                            <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 clear-and-add-all-btn">Clear & Add All</button>
                            <button class="btn-primary px-4 py-2 rounded add-all-to-existing-btn">Add to Existing</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
            
            // Handle individual medication addition
            modal.querySelectorAll('.add-single-med').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.getAttribute('data-index'));
                    const med = medicationPlan[index];
                    addMedicationField({
                        name: med.name,
                        dosage: `${med.dosage} - ${med.timing}`,
                        duration: med.duration
                    });
                    showNotification(`Added ${med.name}`, 'success');
                };
            });
            
            // Handle clear and add all
            modal.querySelector('.clear-and-add-all-btn').onclick = () => {
                // Clear existing medications
                const container = document.getElementById('medicationsContainer');
                const existingMeds = container.querySelectorAll('.medication-item');
                existingMeds.forEach(med => med.remove());
                
                // Add all medications
                medicationPlan.forEach(med => {
                    addMedicationField({
                        name: med.name,
                        dosage: `${med.dosage} - ${med.timing}`,
                        duration: med.duration
                    });
                });
                
                document.body.removeChild(modal);
                showNotification('Complete medication plan added!', 'success');
            };
            
            // Handle add to existing
            modal.querySelector('.add-all-to-existing-btn').onclick = () => {
                medicationPlan.forEach(med => {
                    addMedicationField({
                        name: med.name,
                        dosage: `${med.dosage} - ${med.timing}`,
                        duration: med.duration
                    });
                });
                
                document.body.removeChild(modal);
                showNotification('All medications added to existing list!', 'success');
            };
            
            // Handle cancel
            modal.querySelector('.cancel-btn').onclick = () => {
                document.body.removeChild(modal);
            };
            
            // Close on backdrop click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        }
        
        async function suggestInvestigations() {
            const investigationsInput = document.getElementById('investigations');
            const diagnosis = document.getElementById('diagnosis').value;
            const complaintText = document.getElementById('chiefComplaint').value;
            const patient = currentPatientId ? patients.find(p => p.id === currentPatientId) : null;
            
            if (!diagnosis && !complaintText) {
                showNotification('Please enter diagnosis or complaints first', 'error');
                return;
            }
            
            let suggestions = [];
            
            // AI-powered investigation suggestions
            const hasValidApiKey = AI_CONFIG.gemini.apiKey;
            
            if (AI_CONFIG.enabled && hasValidApiKey) {
                try {
                    showNotification('Generating test recommendations...', 'info');
                    
                    const aiPrompt = `As a medical AI assistant for Dr. Chanda Chowdhury (Gynaecologist & Obstetrician), recommend appropriate investigations and tests:

PATIENT CONTEXT:
Age: ${getCurrentPatientAge()} years
Gender: ${patient ? patient.gender : 'Female'}
Chief Complaints: "${complaintText}"
Diagnosis: "${diagnosis}"

INVESTIGATION CATEGORIES:
1. Blood tests (CBC, hormonal, biochemical)
2. Imaging studies (USG, CT, MRI)
3. Gynecological specific tests
4. Screening tests based on age
5. Follow-up monitoring tests

SPECIALTY FOCUS:
- Gynecological and obstetric investigations
- Women's health screening
- Age-appropriate tests
- Cost-effective workup

Suggest 4-6 relevant investigations. Format as JSON array:
["investigation1", "investigation2", ...]

Return ONLY the JSON array.`;

                    const aiResponse = await callGemini(aiPrompt);
                    
                    if (aiResponse) {
                        try {
                            const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                            if (jsonMatch) {
                                suggestions = JSON.parse(jsonMatch[0]);
                            }
                        } catch (e) {
                            console.warn('AI investigation parsing error:', e);
                        }
                    }
                } catch (error) {
                    console.warn('AI investigation suggestion error:', error);
                }
            }
            
            if (suggestions.length === 0) {
                showNotification('Unable to generate investigation suggestions. Please check your AI configuration.', 'error');
                return;
            }
            
            showSuggestionModal('Investigation Suggestions', suggestions, (selected) => {
                const currentValue = investigationsInput.value;
                investigationsInput.value = currentValue ? currentValue + '\n ' + selected : ' ' + selected;
            });
        }
        
        async function suggestMedications() {
            console.log('suggestMedications called'); // Debug log
            console.log('AI_CONFIG:', AI_CONFIG); // Debug AI config
            
            try {
                const diagnosis = document.getElementById('diagnosis').value;
                const complaintText = document.getElementById('chiefComplaint').value;
                const patient = currentPatientId ? patients.find(p => p.id === currentPatientId) : null;
                
                console.log('Input data:', { diagnosis, complaintText, patient: !!patient }); // Debug input
                
                if (!diagnosis && !complaintText) {
                    showNotification('Please enter diagnosis or complaints first', 'error');
                    return;
                }
                
                // Check AI configuration
                console.log('AI enabled:', AI_CONFIG.enabled);
                console.log('API key exists:', !!AI_CONFIG.gemini.apiKey);
                console.log('API key length:', AI_CONFIG.gemini.apiKey?.length);
                
                // Try AI-powered medication suggestions
                const hasValidApiKey = AI_CONFIG.gemini.apiKey && AI_CONFIG.gemini.apiKey.trim() !== '';
                
                if (!AI_CONFIG.enabled) {
                    showNotification('AI features are disabled. Please enable them in settings.', 'error');
                    return;
                }
                
                if (!hasValidApiKey) {
                    showNotification('Please configure your Gemini API key in settings to use AI features', 'error');
                    return;
                }
                
                let suggestions = [];
                
                try {
                    showNotification('Generating AI medication recommendations...', 'info');
                    
                    const currentPatient = getCurrentPatientData();
                    console.log('Current patient data:', currentPatient); // Debug patient data
                    
                    const aiSuggestions = await MEDICAL_AI.getMedicationSuggestions(
                        currentPatient, 
                        complaintText, 
                        diagnosis
                    );
                    
                    console.log('AI suggestions received:', aiSuggestions); // Debug AI response
                    
                    suggestions = aiSuggestions.map(med => ({
                        name: med.name,
                        dosage: med.dosage,
                        duration: med.duration,
                        manufacturer: med.manufacturer,
                        indication: med.indication,
                        precautions: med.precautions,
                        cost: med.cost
                    }));
                    
                    if (suggestions.length === 0) {
                        showNotification('No medication suggestions received from AI. Please try again.', 'warning');
                        return;
                    }
                    
                } catch (error) {
                    console.error('AI medication suggestion error:', error);
                    showNotification(`AI Error: ${error.message}`, 'error');
                    return;
                }
                
                console.log('Final suggestions:', suggestions); // Debug final data
                
                // Show enhanced medication suggestions modal
                showEnhancedMedicationSuggestionModal(suggestions);
                
            } catch (error) {
                console.error('suggestMedications function error:', error);
                showNotification(`Error in medication suggestions: ${error.message}`, 'error');
            }
        }
        
        function showEnhancedMedicationSuggestionModal(suggestions) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-96 overflow-y-auto">
                    <h3 class="text-lg font-bold mb-4 flex items-center">
                        <i data-lucide="sparkles" class="w-5 h-5 mr-2 text-purple-600"></i>
                        AI Medication Recommendations (Age & Gender Specific)
                    </h3>
                    <div class="space-y-4">
                        ${suggestions.map((med, index) => `
                            <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer medication-suggestion" 
                                 data-name="${med.name}" data-dosage="${med.dosage}" data-duration="${med.duration}">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <div class="font-semibold text-gray-800">${med.name}</div>
                                        <div class="text-sm text-gray-600 mt-1">
                                            <strong>Dosage:</strong> ${med.dosage}
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-600">
                                            <strong>Duration:</strong> ${med.duration}
                                        </div>
                                        <div class="mt-2 flex justify-end">
                                            <button class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200 add-single-medication" 
                                                    data-index="${index}">Add This</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-between mt-6">
                        <button class="bg-gray-200 px-4 py-2 rounded cancel-btn">Cancel</button>
                        <div class="space-x-2">
                            <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 add-all-btn">Add All Medications</button>
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-gray-500 bg-gray-50 p-2 rounded">
                        <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                        Dosages are adjusted based on patient's age (${getCurrentPatientAge()} years) and gender.
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
            
            // Handle individual medication selection
            modal.querySelectorAll('.add-single-medication').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.getAttribute('data-index'));
                    const med = suggestions[index];
                    addMedicationField({
                        name: med.name,
                        dosage: med.dosage,
                        duration: med.duration
                    });
                    showNotification(`Added ${med.name}`, 'success');
                };
            });
            
            // Handle medication card clicks (same as individual add)
            modal.querySelectorAll('.medication-suggestion').forEach(item => {
                item.onclick = (e) => {
                    // Prevent double-click when clicking the button
                    if (e.target.closest('.add-single-medication')) return;
                    
                    const name = item.getAttribute('data-name');
                    const dosage = item.getAttribute('data-dosage');
                    const duration = item.getAttribute('data-duration');
                    
                    addMedicationField({name, dosage, duration});
                    document.body.removeChild(modal);
                    showNotification(`Added ${name}`, 'success');
                };
            });
            
            // Handle add all medications
            modal.querySelector('.add-all-btn').onclick = () => {
                suggestions.forEach(med => {
                    addMedicationField(med);
                });
                document.body.removeChild(modal);
                showNotification('All medications added!', 'success');
            };
            
            // Handle cancel
            modal.querySelector('.cancel-btn').onclick = () => {
                document.body.removeChild(modal);
            };
            
            // Close on backdrop click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        }
        
        async function suggestComplaints() {
            const complaintInput = document.getElementById('chiefComplaint');
            const currentValue = complaintInput.value;
            
            // Get patient context
            const patientContext = getCurrentPatientContext();
            const patient = currentPatientId ? patients.find(p => p.id === currentPatientId) : null;
            
            let suggestions = [];
            
            // Try AI suggestions with gynecology focus
            const hasValidApiKey = AI_CONFIG.gemini.apiKey;
            
            if (AI_CONFIG.enabled && hasValidApiKey) {
                try {
                    showNotification('Generating AI suggestions...', 'info');
                    
                    const aiPrompt = `As a medical AI assistant for Dr. Chanda Chowdhury, a Consultant Gynaecologist & Obstetrician specializing in Infertility, Laparoscopic & Robotic Surgery, suggest 8-10 relevant chief complaints.

Patient Context: ${patientContext}
Current input: "${currentValue}"

Focus primarily on:
1. Gynecological complaints (menstrual disorders, pelvic pain, discharge, infertility)
2. Obstetric complaints (pregnancy-related symptoms)
3. General women's health issues
4. Common medical complaints as secondary options

Return ONLY a JSON array of strings, no other text:
["complaint1", "complaint2", ...]`;

                    let aiResponse = await callGemini(aiPrompt);
                    
                    if (aiResponse) {
                        try {
                            // Clean the response to extract JSON
                            const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                            if (jsonMatch) {
                                suggestions = JSON.parse(jsonMatch[0]);
                            } else {
                                // Fallback parsing
                                suggestions = aiResponse.split('\n')
                                    .map(line => line.replace(/^\d+\.?\s*/, '').replace(/^[\-\*"]\s*/, '').replace(/["]/g, '').trim())
                                    .filter(line => line.length > 5)
                                    .slice(0, 10);
                            }
                        } catch (e) {
                            console.warn('AI response parsing error:', e);
                        }
                    }
                } catch (error) {
                    console.warn('AI complaint suggestion error:', error);
                }
            }
            
            if (suggestions.length === 0) {
                showNotification('Unable to generate complaint suggestions. Please check your AI configuration.', 'error');
                return;
            }
            
            showSuggestionModal('Chief Complaint Suggestions', suggestions, (selected) => {
                complaintInput.value = currentValue ? currentValue + ', ' + selected : selected;
            });
        }
        
        async function suggestDiagnosis() {
            const diagnosisInput = document.getElementById('diagnosis');
            const complaintText = document.getElementById('chiefComplaint').value;
            const patientAge = getCurrentPatientAge();
            const patient = currentPatientId ? patients.find(p => p.id === currentPatientId) : null;
            
            if (!complaintText && !diagnosisInput.value) {
                showNotification('Please enter chief complaint or symptoms first', 'error');
                return;
            }
            
            let suggestions = [];
            
            // Enhanced AI suggestions with gynecology context
            const hasValidApiKey = AI_CONFIG.gemini.apiKey;
            
            if (AI_CONFIG.enabled && hasValidApiKey) {
                try {
                    showNotification('Analyzing symptoms for diagnosis...', 'info');
                    
                    const currentPatient = getCurrentPatientData();
                    const aiSuggestions = await MEDICAL_AI.getDiagnosisSuggestions(
                        currentPatient, 
                        complaintText, 
                        complaintText
                    );
                    
                    if (aiSuggestions && aiSuggestions.length > 0) {
                        suggestions = aiSuggestions.map(diag => diag.diagnosis);
                    } else {
                        throw new Error('No suggestions received from AI');
                    }
                } catch (error) {
                    console.error('AI diagnosis suggestion error:', error);
                    
                    // Show specific error message
                    if (error.message.includes('API key')) {
                        showNotification('AI API key error. Please check your Gemini API key in settings.', 'error');
                        return;
                    } else if (error.message.includes('disabled')) {
                        showNotification('AI features are disabled. Enable them in settings.', 'error');
                        return;
                    } else {
                        showNotification(`AI diagnosis failed: ${error.message}. Please try again or check your internet connection.`, 'error');
                        
                        // Provide fallback suggestions based on common gynecological conditions
                        suggestions = getFallbackDiagnosisSuggestions(complaintText);
                        if (suggestions.length > 0) {
                            setTimeout(() => {
                                showNotification('Showing common gynecological conditions as fallback suggestions.', 'info');
                            }, 2000);
                        }
                    }
                }
            } else {
                if (!AI_CONFIG.enabled) {
                    showNotification('AI features are disabled. Please enable them in settings to use AI diagnosis.', 'error');
                } else {
                    showNotification('Gemini API key not configured. Please add your API key in settings.', 'error');
                }
            }
            
            if (suggestions.length > 0) {
                showSuggestionModal('Diagnosis Suggestions', suggestions, (selected) => {
                    diagnosisInput.value = selected;
                });
            }
        }
        
        function getFallbackDiagnosisSuggestions(complaintText) {
            const complaint = complaintText.toLowerCase();
            const fallbackSuggestions = [];
            
            // Common gynecological conditions based on symptoms
            const conditionsMap = {
                'irregular periods': ['PCOS (Polycystic Ovary Syndrome)', 'Hypothyroidism', 'Dysfunctional Uterine Bleeding', 'Stress-related menstrual disorders'],
                'heavy bleeding': ['Menorrhagia due to Iron Deficiency Anemia', 'Uterine Fibroids', 'Dysfunctional Uterine Bleeding', 'Hormonal Imbalance'],
                'pelvic pain': ['Pelvic Inflammatory Disease (PID)', 'Ovarian Cysts', 'Endometriosis', 'Chronic Pelvic Pain Syndrome'],
                'white discharge': ['Bacterial Vaginosis', 'Vaginal Candidiasis', 'Cervical Infection', 'Physiological Leucorrhea'],
                'missed period': ['Pregnancy', 'PCOS', 'Hypothyroidism', 'Stress-induced Amenorrhea'],
                'abdominal pain': ['Ovarian Cysts', 'PID', 'Appendicitis', 'Urinary Tract Infection'],
                'nausea': ['Early Pregnancy', 'Gastroenteritis', 'PCOS', 'Thyroid Disorders'],
                'fatigue': ['Iron Deficiency Anemia', 'Hypothyroidism', 'Early Pregnancy', 'PCOS'],
                'weight gain': ['PCOS', 'Hypothyroidism', 'Pregnancy', 'Hormonal Imbalance'],
                'acne': ['PCOS', 'Hormonal Acne', 'Thyroid Disorders', 'Insulin Resistance'],
                'hair loss': ['PCOS', 'Hypothyroidism', 'Iron Deficiency Anemia', 'Hormonal Changes'],
                'breast pain': ['Premenstrual Syndrome', 'Hormonal Fluctuations', 'Fibrocystic Disease', 'Early Pregnancy'],
                'urinary problems': ['Urinary Tract Infection', 'Pregnancy', 'Bladder Issues', 'Pelvic Floor Dysfunction'],
                'fever': ['Pelvic Inflammatory Disease', 'UTI', 'Postpartum Infection', 'Ovarian Torsion'],
                'itching': ['Vaginal Candidiasis', 'Bacterial Vaginosis', 'Contact Dermatitis', 'Lichen Sclerosus']
            };
            
            // Find matching conditions based on complaint keywords
            for (const [symptom, conditions] of Object.entries(conditionsMap)) {
                if (complaint.includes(symptom) || complaint.includes(symptom.replace(/s$/, ''))) {
                    fallbackSuggestions.push(...conditions);
                }
            }
            
            // Remove duplicates and limit to 6 suggestions
            const uniqueSuggestions = [...new Set(fallbackSuggestions)];
            
            // If no specific matches, provide general gynecological conditions
            if (uniqueSuggestions.length === 0) {
                return [
                    'PCOS (Polycystic Ovary Syndrome)',
                    'Iron Deficiency Anemia',
                    'Hypothyroidism',
                    'Urinary Tract Infection',
                    'Hormonal Imbalance',
                    'Pelvic Inflammatory Disease'
                ];
            }
            
            return uniqueSuggestions.slice(0, 6);
        }

        // Debug function for Gemini API response format issues
        window.debugGeminiResponse = async function() {
            console.log(' DEBUG: Gemini API Response Format');
            console.log('='.repeat(50));
            
            if (!AI_CONFIG.gemini.apiKey) {
                console.log(' No API key configured');
                return;
            }
            
            try {
                console.log(' Making test API call...');
                
                // Make a raw fetch call to see the exact response format
                const url = `${AI_CONFIG.gemini.baseUrl}/${AI_CONFIG.gemini.model}:generateContent?key=${AI_CONFIG.gemini.apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: 'Hello, please respond with "test successful"'
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 100
                        }
                    })
                });
                
                console.log(' Response Status:', response.status);
                console.log(' Response Headers:', Object.fromEntries(response.headers.entries()));
                
                const rawText = await response.text();
                console.log(' Raw Response Text:', rawText);
                
                try {
                    const data = JSON.parse(rawText);
                    console.log(' Parsed Response Object:', data);
                    console.log(' Response Keys:', Object.keys(data));
                    
                    if (data.candidates) {
                        console.log(' Candidates:', data.candidates.length);
                        if (data.candidates[0]) {
                            console.log(' First Candidate Keys:', Object.keys(data.candidates[0]));
                            if (data.candidates[0].content) {
                                console.log(' Content Keys:', Object.keys(data.candidates[0].content));
                                if (data.candidates[0].content.parts) {
                                    console.log(' Parts:', data.candidates[0].content.parts);
                                }
                            }
                        }
                    }
                } catch (parseError) {
                    console.log(' JSON Parse Error:', parseError.message);
                }
                
            } catch (error) {
                console.log(' Fetch Error:', error.message);
            }
            
            console.log('\n Response format debug completed');
        };

        // Debug function for AI diagnosis issues
        window.debugAIDiagnosis = async function() {
            console.log(' DEBUG: AI Diagnosis System');
            console.log('='.repeat(50));
            
            // Check AI Configuration
            console.log('1. AI Configuration:');
            console.log('   - AI Enabled:', AI_CONFIG.enabled);
            console.log('   - API Key Configured:', !!AI_CONFIG.gemini.apiKey);
            console.log('   - API Key Length:', AI_CONFIG.gemini.apiKey?.length || 0);
            console.log('   - Model:', AI_CONFIG.gemini.model);
            console.log('   - Base URL:', AI_CONFIG.gemini.baseUrl);
            
            // Check form inputs
            const complaintText = document.getElementById('chiefComplaint')?.value || '';
            const diagnosisText = document.getElementById('diagnosis')?.value || '';
            
            console.log('\n2. Form Inputs:');
            console.log('   - Chief Complaint:', complaintText || 'EMPTY');
            console.log('   - Current Diagnosis:', diagnosisText || 'EMPTY');
            
            // Test patient data
            const currentPatient = getCurrentPatientData();
            console.log('\n3. Patient Data:');
            console.log('   - Age:', currentPatient.age);
            console.log('   - Gender:', currentPatient.gender);
            console.log('   - Weight:', currentPatient.weight);
            console.log('   - BP:', currentPatient.bp);
            
            // Test API connectivity
            if (AI_CONFIG.enabled && AI_CONFIG.gemini.apiKey) {
                console.log('\n4. Testing API Connection...');
                try {
                    const testResponse = await callGemini('Test prompt', 'Diagnosis test');
                    console.log('    API Connection: SUCCESS');
                    console.log('   - Response length:', testResponse?.length || 0);
                } catch (error) {
                    console.log('    API Connection: FAILED');
                    console.log('   - Error:', error.message);
                }
                
                // Test diagnosis function specifically
                console.log('\n5. Testing Diagnosis AI Function...');
                try {
                    const testSuggestions = await MEDICAL_AI.getDiagnosisSuggestions(
                        currentPatient,
                        complaintText || 'irregular periods',
                        complaintText || 'irregular periods'
                    );
                    console.log('    Diagnosis Function: SUCCESS');
                    console.log('   - Suggestions count:', testSuggestions?.length || 0);
                    console.log('   - First suggestion:', testSuggestions?.[0]?.diagnosis || 'None');
                } catch (error) {
                    console.log('    Diagnosis Function: FAILED');
                    console.log('   - Error:', error.message);
                }
            } else {
                console.log('\n4. API Connection: SKIPPED (AI not enabled or no API key)');
            }
            
            console.log('\n6. Troubleshooting Steps:');
            if (!AI_CONFIG.enabled) {
                console.log('     Enable AI features in Settings');
            }
            if (!AI_CONFIG.gemini.apiKey) {
                console.log('     Add Gemini API key in Settings');
            }
            if (!complaintText && !diagnosisText) {
                console.log('     Enter chief complaint or symptoms');
            }
            
            console.log('\n Debug completed. Check console for detailed information.');
            showNotification('AI Diagnosis debug completed. Check browser console (F12) for details.', 'info');
        };

        // Debug function for medication plan generation issues
        window.debugMedicationPlan = async function() {
            console.log(' DEBUG: Medication Plan Generation');
            console.log('='.repeat(50));
            
            // Check AI Configuration
            console.log('1. AI Configuration:');
            console.log('   - AI Enabled:', AI_CONFIG.enabled);
            console.log('   - API Key Configured:', !!AI_CONFIG.gemini.apiKey);
            console.log('   - API Key Length:', AI_CONFIG.gemini.apiKey?.length || 0);
            console.log('   - API Key Valid:', AI_CONFIG.gemini.apiKey && AI_CONFIG.gemini.apiKey.length > 10);
            console.log('   - Model:', AI_CONFIG.gemini.model);
            console.log('   - Base URL:', AI_CONFIG.gemini.baseUrl);
            
            // Check form inputs
            const complaintText = document.getElementById('chiefComplaint')?.value || '';
            const diagnosisText = document.getElementById('diagnosis')?.value || '';
            const currentPatient = currentPatientId ? patients.find(p => p.id === currentPatientId) : null;
            
            console.log('\n2. Patient Context:');
            console.log('   - Current Patient ID:', currentPatientId || 'None');
            console.log('   - Patient Found:', !!currentPatient);
            console.log('   - Patient Age:', getCurrentPatientAge());
            console.log('   - Patient Gender:', currentPatient?.gender || 'Unknown');
            console.log('   - Patient Weight:', currentPatient?.weight || 'Unknown');
            
            console.log('\n3. Form Inputs:');
            console.log('   - Chief Complaint:', complaintText || 'Empty');
            console.log('   - Diagnosis:', diagnosisText || 'Empty');
            
            // Test medication plan generation
            if (AI_CONFIG.enabled && AI_CONFIG.gemini.apiKey && AI_CONFIG.gemini.apiKey.length > 10) {
                console.log('\n4. Testing Medication Plan API Call:');
                try {
                    const testPrompt = `As a medical AI assistant for Dr. Chanda Chowdhury (Gynaecologist & Obstetrician), create a comprehensive medication plan:

PATIENT DETAILS:
Age: ${getCurrentPatientAge()} years
Gender: ${currentPatient ? currentPatient.gender : 'Female'}
Weight: ${currentPatient && currentPatient.weight ? currentPatient.weight + ' kg' : 'Average adult weight assumed'}
Chief Complaints: "${complaintText || 'irregular periods'}"
Diagnosis: "${diagnosisText || 'PCOS'}"

FORMAT REQUIRED - Return as JSON array:
[
  {
    "name": "Medication Name (Brand/Generic)",
    "dosage": "Specific dose with frequency (e.g., 500mg BD)",
    "duration": "Treatment duration (e.g., 7 days)",
    "timing": "When to take (e.g., after meals, empty stomach)",
    "indication": "Why prescribed (e.g., for pain relief)"
  }
]

Generate 3-6 medications for complete treatment. Return ONLY the JSON array.`;

                    console.log('    Making test API call...');
                    const testResponse = await callGemini(testPrompt);
                    console.log('    API Response received:', testResponse?.substring(0, 200) + '...');
                    
                    // Test JSON parsing
                    const jsonMatch = testResponse.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        console.log('    JSON found in response');
                        try {
                            const parsedPlan = JSON.parse(jsonMatch[0]);
                            console.log('    JSON parsed successfully');
                            console.log('   - Medications count:', parsedPlan.length);
                            console.log('   - First medication:', parsedPlan[0]?.name || 'None');
                        } catch (parseError) {
                            console.log('    JSON parsing failed:', parseError.message);
                            console.log('   - Raw JSON:', jsonMatch[0]);
                        }
                    } else {
                        console.log('    No JSON array found in response');
                        console.log('   - Full response:', testResponse);
                    }
                    
                } catch (error) {
                    console.log('    API Call Failed:', error.message);
                    console.log('   - Error type:', error.constructor.name);
                    if (error.message.includes('API key')) {
                        console.log('    Solution: Check your Gemini API key in settings');
                    } else if (error.message.includes('quota')) {
                        console.log('    Solution: API quota exceeded, wait or upgrade plan');
                    } else if (error.message.includes('network')) {
                        console.log('    Solution: Check internet connection');
                    }
                }
            } else {
                console.log('\n4. API Test: SKIPPED (AI not enabled or invalid API key)');
            }
            
            console.log('\n5. Troubleshooting Steps:');
            if (!AI_CONFIG.enabled) {
                console.log('     Enable AI features in Settings');
            }
            if (!AI_CONFIG.gemini.apiKey || AI_CONFIG.gemini.apiKey.length <= 10) {
                console.log('     Add valid Gemini API key in Settings (should be ~40 characters)');
            }
            if (!complaintText && !diagnosisText) {
                console.log('     Enter chief complaint or diagnosis to provide context');
            }
            if (!currentPatientId) {
                console.log('     Select a patient for better medication suggestions');
            }
            
            console.log('\n6. Available Debug Commands:');
            console.log('   - checkAIConfiguration() - Check overall AI setup');
            console.log('   - testGeminiAPIConnection() - Test API connectivity');
            console.log('   - debugGeminiResponse() - Debug API response format');
            console.log('   - debugMedicationPlan() - This function');
            
            console.log('\n Medication plan debug completed.');
            showNotification('Medication plan debug completed. Check browser console (F12) for details.', 'info');
        };

        async function generateAdvice() {
            const adviceInput = document.getElementById('advice');
            const diagnosis = document.getElementById('diagnosis').value;
            const complaintText = document.getElementById('chiefComplaint').value;
            const medications = getMedicationsFromForm();
            const patient = currentPatientId ? patients.find(p => p.id === currentPatientId) : null;
            
            let suggestions = [];
            
            // Enhanced AI advice generation with full context
            const hasValidApiKey = AI_CONFIG.gemini.apiKey;
            
            if (AI_CONFIG.enabled && hasValidApiKey) {
                try {
                    showNotification('Generating personalized advice...', 'info');
                    
                    const aiPrompt = `As a medical AI assistant for Dr. Chanda Chowdhury (Gynaecologist & Obstetrician), generate comprehensive patient advice:

PATIENT CONTEXT:
Age: ${getCurrentPatientAge()} years
Gender: ${patient ? patient.gender : 'Female'}
Chief Complaints: "${complaintText}"
Diagnosis: "${diagnosis}"
Prescribed Medications: ${medications.length > 0 ? medications.join(', ') : 'None prescribed'}

ADVICE CATEGORIES TO COVER:
1. Medication compliance and timing
2. Lifestyle modifications specific to the condition
3. Dietary recommendations
4. Activity/exercise guidelines
5. Warning signs to watch for
6. Follow-up schedule
7. Preventive measures

SPECIALTY CONSIDERATIONS:
- Gynecological/reproductive health aspects
- Women's health specific advice
- Age-appropriate recommendations

Generate 6-8 specific, actionable advice points. Return as JSON array only:
["advice1", "advice2", ...]`;

                    let aiResponse = await callGemini(aiPrompt);
                    
                    if (aiResponse) {
                        try {
                            const jsonMatch = aiResponse.match(/\[[\s\S]*\]/);
                            if (jsonMatch) {
                                suggestions = JSON.parse(jsonMatch[0]);
                            } else {
                                suggestions = aiResponse.split('\n')
                                    .map(line => line.replace(/^\d+\.?\s*/, '').replace(/^[\-\*]\s*/, '').trim())
                                    .filter(line => line.length > 10)
                                    .slice(0, 8);
                            }
                        } catch (e) {
                            console.warn('AI advice parsing error:', e);
                        }
                    }
                } catch (error) {
                    console.warn('AI advice generation error:', error);
                }
            }
            
            if (suggestions.length === 0) {
                showNotification('Unable to generate advice suggestions. Please check your AI configuration.', 'error');
                return;
            }
            
            showSuggestionModal('General Advice Suggestions', suggestions, (selected) => {
                const currentValue = adviceInput.value;
                adviceInput.value = currentValue ? currentValue + '\n ' + selected : ' ' + selected;
            });
        }
        
        function getCurrentPatientAge() {
            if (currentPatientId) {
                const patient = patients.find(p => p.id === currentPatientId);
                return patient ? patient.age : 'unknown';
            }
            return 'unknown';
        }
        
        function getCurrentPatientContext() {
            if (currentPatientId) {
                const patient = patients.find(p => p.id === currentPatientId);
                if (patient) {
                    return `${patient.age} year old ${patient.gender}${patient.medicalHistory ? `, with history of: ${patient.medicalHistory}` : ''}`;
                }
            }
            return 'Adult patient';
        }
        
        function getMedicationsFromForm() {
            const medications = [];
            document.querySelectorAll('.medication-item .med-name').forEach(input => {
                if (input.value.trim()) {
                    medications.push(input.value.trim());
                }
            });
            return medications;
        }
        
        // Enhanced AI Integration (Gemini API only)
        
        // Debug function to check Gemini configuration
        function debugGemini() {
            console.log('=== Gemini Configuration Debug ===');
            console.log('AI_CONFIG.enabled:', AI_CONFIG.enabled);
            console.log('AI_CONFIG.provider:', AI_CONFIG.provider);
            console.log('AI_CONFIG.gemini.apiKey length:', AI_CONFIG.gemini.apiKey?.length || 0);
            console.log('AI_CONFIG.gemini.model:', AI_CONFIG.gemini.model);
            console.log('geminiApiKey element exists:', !!document.getElementById('geminiApiKey'));
            console.log('geminiModel element exists:', !!document.getElementById('geminiModel'));
            console.log('aiEnabled element exists:', !!document.getElementById('aiEnabled'));
            console.log('aiProvider element exists:', !!document.getElementById('aiProvider'));
            console.log('===========================');
        }
        
        // Make debug function available globally
        window.debugGemini = debugGemini;


        // Test AI connection (works with Gemini)
        // Test Claude API connection
        async function testGeminiConnection() {
            try {
                const response = await callGemini('Hello, please respond with "API connection successful"');
                console.log(' Gemini API test successful:', response);
                return true;
            } catch (error) {
                console.error(' Gemini API test failed:', error.message);
                if (error.message.includes('429')) {
                    console.log(' Rate limit exceeded. Please wait before trying again.');
                    console.log(' Check your Gemini API usage limits in Google AI Studio.');
                }
                return false;
            }
        }

        async function callGemini(prompt, context = '') {
            if (!AI_CONFIG.gemini.apiKey || AI_CONFIG.gemini.apiKey.trim() === '') {
                console.warn('Gemini API key not configured');
                throw new Error('Gemini API key not configured. Please add your API key in settings.');
            }
            
            if (!validateGeminiModel(AI_CONFIG.gemini.model)) {
                console.warn('Invalid Gemini model:', AI_CONFIG.gemini.model);
                throw new Error(`Invalid Gemini model "${AI_CONFIG.gemini.model}". Please select a valid model in settings.`);
            }
            
            return await callGeminiDirect(prompt, context);
        }
        
        async function callGeminiDirect(prompt, context = '') {
            
            try {
                console.log('Making Gemini API call...');
                const fullPrompt = `As a medical assistant for Dr. Chanda Chowdhury (Gynaecologist & Obstetrician), provide professional medical guidance. ${prompt}. Context: ${context}`;
                
                // Use different API endpoints depending on whether it's a paid API key
                let url, headers;
                
                // Check if it's a paid API key (usually starts with 'AIza')
                const isPaidKey = AI_CONFIG.gemini.apiKey.startsWith('AIza');
                
                if (isPaidKey) {
                    // For paid API keys
                    url = `https://generativelanguage.googleapis.com/v1/models/${AI_CONFIG.gemini.model}:generateContent`;
                    headers = {
                        'Content-Type': 'application/json',
                        'x-goog-api-key': AI_CONFIG.gemini.apiKey
                    };
                } else {
                    // For free API keys
                    url = `${AI_CONFIG.gemini.baseUrl}/${AI_CONFIG.gemini.model}:generateContent?key=${AI_CONFIG.gemini.apiKey}`;
                    headers = {
                        'Content-Type': 'application/json'
                    };
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: fullPrompt
                            }]
                        }],
                        generationConfig: {
                            temperature: AI_CONFIG.gemini.temperature,
                            maxOutputTokens: AI_CONFIG.gemini.maxTokens,
                            topP: 0.8,
                            topK: 40
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { error: { message: errorText } };
                    }
                    
                    console.error('Gemini API error response:', errorData);
                    
                    // Provide specific error messages for common issues
                    if (response.status === 404) {
                        throw new Error(` Gemini API error: 404\nModel "${AI_CONFIG.gemini.model}" not found. Please check your model selection in settings.`);
                    } else if (response.status === 400 && errorData.error?.message?.includes('API key not valid')) {
                        throw new Error(` Gemini API error: Invalid API key format. Please check your API key in settings.`);
                    } else if (response.status === 401 || response.status === 403) {
                        throw new Error(` Gemini API error: ${response.status}\nInvalid API key or insufficient permissions. Please check your API key in settings.`);
                    } else if (response.status === 429) {
                        throw new Error(` Gemini API error: 429\nRate limit exceeded. Please wait before trying again.`);
                    } else if (errorData.error?.message?.includes('safety')) {
                        throw new Error(` Gemini API error: Content filtered due to safety settings. Please modify your request.`);
                    } else {
                        throw new Error(` Gemini API error: ${response.status}\n${errorData.error?.message || 'Unknown error'}`);
                    }
                }
                
                const data = await response.json();
                console.log('Gemini API response received:', {
                    hasData: !!data,
                    hasCandidates: !!(data && data.candidates),
                    candidatesLength: data?.candidates?.length || 0,
                    responseKeys: data ? Object.keys(data) : [],
                    firstCandidateKeys: data?.candidates?.[0] ? Object.keys(data.candidates[0]) : []
                });
                
                // Enhanced response validation and parsing
                if (!data) {
                    throw new Error(' Empty response from Gemini API');
                }
                
                // Handle potential blocking due to safety settings
                if (data.promptFeedback && data.promptFeedback.blockReason) {
                    throw new Error(` Gemini API blocked request: ${data.promptFeedback.blockReason}`);
                }
                
                // Check for error in response
                if (data.error) {
                    throw new Error(` Gemini API error: ${data.error.message || 'Unknown error'}`);
                }
                
                // Handle successful response with enhanced parsing
                if (data.candidates && Array.isArray(data.candidates) && data.candidates.length > 0) {
                    const candidate = data.candidates[0];
                    console.log('Processing candidate:', {
                        hasCandidate: !!candidate,
                        finishReason: candidate?.finishReason,
                        hasContent: !!(candidate && candidate.content),
                        hasParts: !!(candidate && candidate.content && candidate.content.parts),
                        partsLength: candidate?.content?.parts?.length || 0
                    });
                    
                    // Check for specific finish reasons
                    if (candidate.finishReason === "SAFETY") {
                        throw new Error(" Gemini API blocked response due to safety concerns.");
                    }
                    
                    if (candidate.finishReason === "MAX_TOKENS") {
                        console.warn(" Response reached MAX_TOKENS limit - may be incomplete");
                        // We'll continue processing but log a warning
                    }
                    
                    // Enhanced extraction to handle various response formats
                    if (candidate.content) {
                        // Format 1: Check for parts array with text property
                        if (candidate.content.parts && Array.isArray(candidate.content.parts) && candidate.content.parts.length > 0) {
                            // First try to find a part with text property
                            const textPart = candidate.content.parts.find(part => part.text);
                            if (textPart && textPart.text) {
                                console.log(' Successfully extracted text from content.parts[].text');
                                return textPart.text;
                            }
                            
                            // If no text property found, try other properties or stringify the part
                            for (const part of candidate.content.parts) {
                                if (typeof part === 'string') {
                                    console.log(' Found string part directly');
                                    return part;
                                }
                                if (part.rawText) {
                                    console.log(' Found rawText in part');
                                    return part.rawText;
                                }
                            }
                            
                            // If still nothing, stringify the first part that seems to have content
                            for (const part of candidate.content.parts) {
                                if (Object.keys(part).length > 0) {
                                    const partText = JSON.stringify(part);
                                    if (partText && partText.length > 2) { // Not just "{}"
                                        console.log(' Using stringified part object');
                                        return partText;
                                    }
                                }
                            }
                        }
                        
                        // Format 2: content has direct text property
                        if (candidate.content.text) {
                            console.log(' Found text in content object directly');
                            return candidate.content.text;
                        }
                        
                        // Format 3: content has rawText
                        if (candidate.content.rawText) {
                            console.log(' Found rawText in content');
                            return candidate.content.rawText;
                        }
                        
                        // Format 4: content is a string directly
                        if (typeof candidate.content === 'string') {
                            console.log(' Content is string directly');
                            return candidate.content;
                        }
                        
                        // If we have a content object but nothing above worked, stringify it as last resort
                        if (Object.keys(candidate.content).length > 0) {
                            console.log(' Stringifying entire content object as fallback');
                            return JSON.stringify(candidate.content);
                        }
                    }
                    
                    // Format 5: Check direct candidate properties
                    if (candidate.text) {
                        console.log(' Found text directly on candidate');
                        return candidate.text;
                    }
                    
                    if (candidate.rawText) {
                        console.log(' Found rawText on candidate');
                        return candidate.rawText;
                    }
                    
                    // Check if candidate has any text content at all
                    const candidateText = JSON.stringify(candidate);
                    if (candidateText.includes('"text"')) {
                        console.warn(' Text found in response but not in expected location');
                        console.log('Full candidate structure:', candidate);
                    }
                }
                
                // Additional fallback parsing attempts
                if (data.text) {
                    console.log(' Using direct text property');
                    return data.text;
                }
                
                if (data.content && typeof data.content === 'string') {
                    console.log(' Using content property');
                    return data.content;
                }
                
                // If we get here, try one more deep extraction attempt
                try {
                    console.log('Attempting deep extraction of any text content...');
                    // Recursive function to find text in any nested object
                    function findTextInObject(obj, depth = 0) {
                        if (depth > 5) return null; // Prevent infinite recursion
                        
                        if (!obj || typeof obj !== 'object') return null;
                        
                        // Check for common text property names
                        const textProps = ['text', 'rawText', 'content', 'value', 'message', 'response'];
                        for (const prop of textProps) {
                            if (obj[prop] && typeof obj[prop] === 'string' && obj[prop].length > 10) {
                                return obj[prop];
                            }
                        }
                        
                        // Look in arrays
                        if (Array.isArray(obj)) {
                            for (const item of obj) {
                                const found = findTextInObject(item, depth + 1);
                                if (found) return found;
                            }
                            return null;
                        }
                        
                        // Look in nested objects
                        for (const key in obj) {
                            if (typeof obj[key] === 'object' && obj[key] !== null) {
                                const found = findTextInObject(obj[key], depth + 1);
                                if (found) return found;
                            } else if (typeof obj[key] === 'string' && obj[key].length > 50) {
                                // If we find a long string anywhere, it might be our content
                                return obj[key];
                            }
                        }
                        
                        return null;
                    }
                    
                    const extractedText = findTextInObject(data);
                    if (extractedText) {
                        console.log(' Found text through deep extraction');
                        return extractedText;
                    }
                    
                    // If we have candidates array with content objects, return stringified first candidate
                    if (data.candidates && Array.isArray(data.candidates) && data.candidates.length > 0) {
                        const firstCandidate = data.candidates[0];
                        if (firstCandidate) {
                            console.log(' Returning stringified first candidate as fallback');
                            return JSON.stringify(firstCandidate);
                        }
                    }
                } catch (extractError) {
                    console.error('Deep extraction attempt failed:', extractError);
                }
                
                // If we get here, log the full response for debugging
                console.error(' Unexpected response format. Full response:', JSON.stringify(data, null, 2));
                
                // Provide a more helpful error message with sample response structure
                const responseInfo = {
                    hasCandidates: !!(data.candidates),
                    candidatesCount: data.candidates ? data.candidates.length : 0,
                    topLevelKeys: Object.keys(data),
                    candidateKeys: data.candidates && data.candidates[0] ? Object.keys(data.candidates[0]) : [],
                    contentKeys: data.candidates && data.candidates[0] && data.candidates[0].content ? 
                                 Object.keys(data.candidates[0].content) : [],
                    sampleData: JSON.stringify(data).substring(0, 500) + '...'
                };
                
                throw new Error(` Unexpected response format from Gemini API. Response info: ${JSON.stringify(responseInfo)}`);
            } catch (error) {
                console.error('Gemini API error details:', {
                    message: error.message,
                    stack: error.stack,
                    apiKeyConfigured: !!AI_CONFIG.gemini.apiKey,
                    apiKeyLength: AI_CONFIG.gemini.apiKey?.length
                });
                
                // Re-throw the error with more context
                if (error.message.includes('API key') || error.message.includes('401') || error.message.includes('403')) {
                    throw new Error('Invalid or expired API key. Please check your Gemini API key in settings.');
                } else if (error.message.includes('quota') || error.message.includes('credits') || error.message.includes('429')) {
                    throw new Error('API quota exceeded. Please check your Gemini API usage limits.');
                } else if (error.message.includes('network') || error.name === 'TypeError') {
                    throw new Error('Network error. Please check your internet connection and try again.');
                } else {
                    throw error;
                }
            }
        }
        
        // Gemini model validation
        function validateGeminiModel(model) {
            const validModels = [
                'gemini-2.5-pro',
                'gemini-2.5-flash',
                'gemini-2.5-flash-lite',
                'gemini-2.0-flash',
                'gemini-2.0-flash-lite'
            ];
            return validModels.includes(model);
        }

        
        // Local medical knowledge fallback when APIs fail
        
        // Test AI API connection
        async function testAIConnection() {
            const testResultDiv = document.getElementById('apiTestResults');
            const testStatus = document.getElementById('apiTestStatus');
            
            if (!testResultDiv || !testStatus) return;
            
            testStatus.innerHTML = '<span class="text-yellow-500">Testing API connection...</span>';
            testResultDiv.classList.remove('hidden');
            
            try {
                await testGeminiAPIConnection();
            } catch (error) {
                testStatus.innerHTML = `<span class="text-red-500"> API test failed: ${error.message}</span>`;
                console.error('API test error:', error);
            }
        }
        
        // Enhanced Test Gemini API connection with detailed debugging
        async function testGeminiAPIConnection() {
            const testResultDiv = document.getElementById('apiTestResults');
            const testStatus = document.getElementById('apiTestStatus');
            const testOutput = document.getElementById('apiTestOutput');
            
            if (!testResultDiv || !testStatus) return;
            
            testStatus.innerHTML = '<span class="text-yellow-500"> Testing Gemini API connection...</span>';
            testResultDiv.classList.remove('hidden');
            
            // Get the API key from the form input
            const apiKeyInput = document.getElementById('geminiApiKey');
            const modelSelect = document.getElementById('geminiModel');
            const apiKey = apiKeyInput?.value?.trim() || AI_CONFIG.gemini.apiKey;
            const model = modelSelect?.value || AI_CONFIG.gemini.model;
            
            console.log(' Starting Gemini API Test');
            console.log('- API Key Length:', apiKey?.length || 0);
            console.log('- Model:', model);
            console.log('- Base URL:', AI_CONFIG.gemini.baseUrl);
            
            if (!apiKey) {
                testStatus.innerHTML = '<span class="text-red-500"> No API key provided</span>';
                testOutput.textContent = 'Please enter your Gemini API key first.';
                return;
            }
            
            try {
                // Temporarily update config for testing
                const originalKey = AI_CONFIG.gemini.apiKey;
                const originalModel = AI_CONFIG.gemini.model;
                AI_CONFIG.gemini.apiKey = apiKey;
                AI_CONFIG.gemini.model = model;
                
                testOutput.textContent = 'Step 1: Validating API key format...';
                
                // Validate API key format
                if (!apiKey.startsWith('AIza') && apiKey.length < 30) {
                    throw new Error('Invalid API key format. Gemini API keys should start with "AIza" and be longer.');
                }
                
                testOutput.textContent = 'Step 2: Validating model...';
                
                // Validate model
                if (!validateGeminiModel(model)) {
                    throw new Error(`Invalid model "${model}". Please select a valid Gemini model.`);
                }
                
                testOutput.textContent = 'Step 3: Making API call...';
                
                // Make test API call
                const startTime = Date.now();
                const response = await callGeminiDirect('Please respond with exactly: "API test successful"', 'Connection test');
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                console.log(' API Response received:', response);
                console.log(' Response time:', responseTime + 'ms');
                
                // Restore original config
                AI_CONFIG.gemini.apiKey = originalKey;
                AI_CONFIG.gemini.model = originalModel;
                
                if (response && typeof response === 'string' && response.length > 0) {
                    testStatus.innerHTML = '<span class="text-green-500"> Gemini API connection successful!</span>';
                    testOutput.innerHTML = `
                        <div class="space-y-2">
                            <div><strong> Connection Status:</strong> Success</div>
                            <div><strong> Response Time:</strong> ${responseTime}ms</div>
                            <div><strong> API Response:</strong></div>
                            <div class="bg-gray-100 p-2 rounded text-sm">${response}</div>
                            <div class="text-green-600 text-sm">Your Gemini API is working correctly!</div>
                        </div>
                    `;
                } else {
                    testStatus.innerHTML = '<span class="text-orange-500"> API responded but with empty/invalid response</span>';
                    testOutput.innerHTML = `
                        <div class="space-y-2">
                            <div><strong> Status:</strong> Partial Success</div>
                            <div><strong> Response Type:</strong> ${typeof response}</div>
                            <div><strong> Response Length:</strong> ${response?.length || 0}</div>
                            <div class="text-orange-600 text-sm">API connected but response format needs checking.</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(' Gemini API test failed:', error);
                
                // Restore original config
                AI_CONFIG.gemini.apiKey = originalKey;
                AI_CONFIG.gemini.model = originalModel;
                
                testStatus.innerHTML = `<span class="text-red-500"> Gemini API test failed</span>`;
                
                let troubleshooting = '';
                if (error.message.includes('API key')) {
                    troubleshooting = `
                        <div class="mt-2 text-sm">
                            <strong> Troubleshooting:</strong>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li>Get API key from: <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-500 underline">Google AI Studio</a></li>
                                <li>Ensure API key starts with "AIza"</li>
                                <li>Check if API key has proper permissions</li>
                            </ul>
                        </div>
                    `;
                } else if (error.message.includes('model')) {
                    troubleshooting = `
                        <div class="mt-2 text-sm">
                            <strong> Troubleshooting:</strong>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li>Select a valid Gemini model (e.g., gemini-2.5-flash)</li>
                                <li>Check if the model is available in your region</li>
                            </ul>
                        </div>
                    `;
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    troubleshooting = `
                        <div class="mt-2 text-sm">
                            <strong> Troubleshooting:</strong>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li>Check your internet connection</li>
                                <li>Try again in a few moments</li>
                                <li>Check if your firewall blocks the request</li>
                            </ul>
                        </div>
                    `;
                }
                
                testOutput.innerHTML = `
                    <div class="space-y-2">
                        <div><strong> Error:</strong> ${error.message}</div>
                        ${troubleshooting}
                        <div class="text-xs text-gray-500 mt-2">
                            Check browser console (F12) for detailed error information.
                        </div>
                    </div>
                `;
            }
        }


        
        // Comprehensive AI configuration checker
        function checkAIConfiguration() {
            console.log(' === AI Configuration Diagnostic ===');
            console.log('Current Provider:', AI_CONFIG.provider);
            console.log('AI Enabled:', AI_CONFIG.enabled);
            
            // Check Gemini Configuration
            console.log('\n Gemini Configuration:');
            console.log('  - API Key Present:', !!AI_CONFIG.gemini.apiKey);
            console.log('  - API Key Length:', AI_CONFIG.gemini.apiKey?.length || 0);
            console.log('  - API Key Format:', AI_CONFIG.gemini.apiKey?.startsWith('AIza') ? 'Valid Format' : 'Invalid Format');
            console.log('  - Model:', AI_CONFIG.gemini.model);
            console.log('  - Base URL:', AI_CONFIG.gemini.baseUrl);
            console.log('  - Model Valid:', validateGeminiModel(AI_CONFIG.gemini.model));
            
            // Check DOM Elements
            console.log('\n DOM Elements:');
            console.log('  - geminiApiKey input:', !!document.getElementById('geminiApiKey'));
            console.log('  - geminiModel select:', !!document.getElementById('geminiModel'));
            console.log('  - aiEnabled checkbox:', !!document.getElementById('aiEnabled'));
            
            // Check LocalStorage
            console.log('\n LocalStorage Values:');
            console.log('  - gemini_api_key:', localStorage.getItem('gemini_api_key')?.substring(0, 10) + '...' || 'Not Set');
            console.log('  - gemini_model:', localStorage.getItem('gemini_model') || 'Not Set');
            console.log('  - ai_enabled:', localStorage.getItem('ai_enabled') || 'Not Set');
            
            console.log('\n Recommendations:');
            if (!AI_CONFIG.gemini.apiKey) {
                console.log('   Set Gemini API key from https://aistudio.google.com/app/apikey');
            }
            if (!validateGeminiModel(AI_CONFIG.gemini.model)) {
                console.log('   Invalid Gemini model selected. Choose from: gemini-2.5-pro, gemini-2.5-flash, etc.');
            }
            if (!AI_CONFIG.enabled) {
                console.log('   AI features are disabled - enable them in settings');
            }
            console.log('====================================\n');
        }

        // Make function available globally for debugging
        window.checkAIConfiguration = checkAIConfiguration;

        function showSuggestionModal(title, suggestions, onSelect) {
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">${title}</h3>
                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        ${suggestions.map(suggestion => `
                            <button class="w-full text-left p-2 hover:bg-gray-100 rounded suggestion-item" data-suggestion="${suggestion}">
                                ${suggestion}
                            </button>
                        `).join('')}
                    </div>
                    <div class="flex justify-end space-x-2 mt-4">
                        <button class="bg-gray-200 px-4 py-2 rounded cancel-btn">Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle suggestion selection
            modal.querySelectorAll('.suggestion-item').forEach(item => {
                item.onclick = () => {
                    onSelect(item.getAttribute('data-suggestion'));
                    document.body.removeChild(modal);
                };
            });
            
            // Handle cancel
            modal.querySelector('.cancel-btn').onclick = () => {
                document.body.removeChild(modal);
            };
            
            // Close on backdrop click
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        }
        
        function setupAgeCalculation() {
            const dobInput = document.getElementById('patientDOB');
            const ageDisplay = document.getElementById('calculatedAge');
            const ageHidden = document.getElementById('patientAge');
            
            function calculateAge(birthDate) {
                const today = new Date();
                const birth = new Date(birthDate);
                
                if (birth > today) {
                    return 0; // Future date
                }
                
                let age = today.getFullYear() - birth.getFullYear();
                const monthDifference = today.getMonth() - birth.getMonth();
                
                if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                
                return age;
            }
            
            function updateAge() {
                const dob = dobInput.value;
                if (dob) {
                    const age = calculateAge(dob);
                    ageDisplay.textContent = age;
                    ageHidden.value = age;
                } else {
                    ageDisplay.textContent = '-';
                    ageHidden.value = '';
                }
            }
            
            dobInput.addEventListener('change', updateAge);
            dobInput.addEventListener('input', updateAge);
            
            // Calculate age on page load if DOB is already set
            updateAge();
        }
        
        function setupFollowUpHandlers() {
            const followUpType = document.getElementById('followUpType');
            const followUpValue = document.getElementById('followUpValue');
            const followUpHidden = document.getElementById('followUp');
            
            function updateFollowUp() {
                const type = followUpType.value;
                const value = followUpValue.value;
                
                if (type && value) {
                    if (type === 'custom') {
                        followUpHidden.value = value;
                    } else {
                        followUpHidden.value = `After ${value} ${type}`;
                    }
                } else {
                    followUpHidden.value = '';
                }
            }
            
            followUpType.addEventListener('change', updateFollowUp);
            followUpValue.addEventListener('input', updateFollowUp);
        }

        async function savePatient(e) {
            e.preventDefault();
            const patient = {
                // Core Identity
                name: document.getElementById('patientName').value.trim(),
                dob: document.getElementById('patientDOB').value,
                age: document.getElementById('patientAge').value,
                gender: document.getElementById('patientGender').value,
                contact: document.getElementById('patientContact').value.trim(),
                email: document.getElementById('patientEmail').value.trim(),
                address: document.getElementById('patientAddress').value.trim(),
                // Indian Extensions
                abha: document.getElementById('patientABHA')?.value.trim() || '',
                aadhaarLast4: document.getElementById('patientAadhaar')?.value.trim() || '',
                insurance: document.getElementById('patientInsurance')?.value || '',
                bloodGroup: document.getElementById('patientBloodGroup')?.value || '',
                organDonor: document.getElementById('patientOrganDonor')?.value || '',
                languages: document.getElementById('patientLanguages')?.value.trim() || '',
                pin: document.getElementById('patientPIN')?.value.trim() || '',
                city: document.getElementById('patientCity')?.value.trim() || '',
                state: document.getElementById('patientState')?.value || '',
                occupation: document.getElementById('patientOccupation')?.value.trim() || '',
                emergencyContact: document.getElementById('patientEmergencyContact')?.value.trim() || '',
                chronicFlags: Array.from(document.querySelectorAll('.chronic-flag:checked')).map(c=>c.value),
                diet: document.getElementById('patientDiet')?.value || '',
                tobacco: document.getElementById('patientTobacco')?.value || '',
                // Current Vitals
                height: document.getElementById('patientHeight').value,
                weight: document.getElementById('patientWeight').value,
                bloodPressure: document.getElementById('patientBP').value,
                temperature: document.getElementById('patientTemp').value,
                // Medical History
                medicalHistory: document.getElementById('medicalHistory').value,
                surgicalHistory: document.getElementById('surgicalHistory').value,
                medicationHistory: document.getElementById('medicationHistory').value,
                // Allergies
                drugAllergies: document.getElementById('drugAllergies').value,
                foodAllergies: document.getElementById('foodAllergies').value,
                // Personal & Lifestyle
                smokingHistory: document.getElementById('smokingHistory').value,
                alcoholHistory: document.getElementById('alcoholHistory').value,
                exerciseHabits: document.getElementById('exerciseHabits').value,
                occupationalHistory: document.getElementById('occupationalHistory').value,
                // Gynecological History (if female)
                menarche: document.getElementById('menarche').value,
                menstrualCycle: document.getElementById('menstrualCycle').value,
                lastMenstrualPeriod: document.getElementById('lastMenstrualPeriod').value,
                gravida: document.getElementById('gravida').value,
                para: document.getElementById('para').value,
                abortions: document.getElementById('abortions').value,
                living: document.getElementById('living').value,
                contraceptiveHistory: document.getElementById('contraceptiveHistory').value,
                // Family History
                familyHistory: document.getElementById('familyHistory').value,
                // Timestamps
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };
            // Basic validation/masking
            if (patient.aadhaarLast4 && !/^\d{4}$/.test(patient.aadhaarLast4)) {
                showNotification('Aadhaar last 4 must be 4 digits', 'error');
                return;
            }
            if (patient.pin && !/^\d{6}$/.test(patient.pin)) {
                showNotification('PIN must be 6 digits', 'error');
                return;
            }
            if (patient.contact && !/^\d{10}$/.test(patient.contact.replace(/[^0-9]/g,''))) {
                showNotification('Contact must be a 10-digit mobile number', 'error');
                return;
            }
            
            const id = document.getElementById('patientId').value;
            
            try {
                if (id) { // Update existing patient
                    const index = patients.findIndex(p => p.id === id);
                    if (index !== -1) {
                        patient.createdAt = patients[index].createdAt; // Preserve creation date
                        patients[index] = { ...patients[index], ...patient, id: id };
                    }
                } else { // Create new patient
                    patient.id = generateId();
                    patient.patientId = generatePatientId();
                    patients.push(patient);
                    
                    // Record initial vitals if provided
                    if (patient.height || patient.weight || patient.bloodPressure || patient.temperature) {
                        const initialVital = {
                            id: generateId(),
                            date: new Date().toISOString(),
                            height: patient.height,
                            weight: patient.weight,
                            bloodPressure: patient.bloodPressure,
                            temperature: patient.temperature,
                            notes: 'Initial vitals recorded during registration'
                        };
                        saveVital(patient.id, initialVital);
                    }
                }
                
                // Ensure we save to localStorage
                localStorage.setItem(STORAGE_KEYS.PATIENTS, JSON.stringify(patients));
                
                // Show success message first, to ensure user knows it saved even if UI updates fail
                showNotification('Patient saved successfully!', 'success');
                
                // Then update UI (wrapped in try-catch to prevent UI errors from breaking the save)
                try {
                    renderPatientList();
                    showView('patientListView');
                } catch (uiError) {
                    console.error("Error updating UI after patient save:", uiError);
                    // Force view change even if renderPatientList fails
                    showView('patientListView');
                }
                
                // Log confirmation
                console.log('Patient saved. Current patients count:', patients.length);
            } catch (error) {
                console.error("Error saving patient:", error);
                showNotification("Could not save patient details.", 'error');
                
                // Try one more time with a simpler approach if the main save failed
                try {
                    localStorage.setItem(STORAGE_KEYS.PATIENTS, JSON.stringify(patients));
                    console.log("Attempted backup save of patients data");
                } catch (backupError) {
                    console.error("Backup save also failed:", backupError);
                }
            }
        }
        

        
        async function saveSettings(e) {
            e.preventDefault();
            const profile = {
                doctorName: document.getElementById('doctorName').value,
                title: document.getElementById('title').value,
                specializations: document.getElementById('specializations').value,
                qualifications: document.getElementById('qualifications').value,
                mobile: document.getElementById('mobile').value,
                email: document.getElementById('email').value,
                regNumber: document.getElementById('regNumber').value,
                clinicInfo: document.getElementById('clinicInfo').value,
            };
            
            // Save API keys
            const geminiKey = document.getElementById('geminiApiKey').value.trim();
            const geminiModel = document.getElementById('geminiModel').value;
            const aiEnabled = document.getElementById('aiEnabled').checked;
            
            if (geminiKey) {
                localStorage.setItem('gemini_api_key', geminiKey);
                AI_CONFIG.gemini.apiKey = geminiKey;
            }
            if (geminiModel) {
                localStorage.setItem('gemini_model', geminiModel);
                AI_CONFIG.gemini.model = geminiModel;
            }
            AI_CONFIG.enabled = aiEnabled;
            localStorage.setItem('ai_enabled', aiEnabled.toString());
            
            // Save GitHub settings
            const githubToken = document.getElementById('githubToken').value.trim();
            const githubUsername = document.getElementById('githubUsername').value.trim();
            const githubRepo = document.getElementById('githubRepo').value.trim();
            const githubSyncEnabled = document.getElementById('githubSyncEnabled').checked;
            
            if (githubToken) {
                localStorage.setItem('github_token', githubToken);
            } else {
                localStorage.removeItem('github_token');
            }
            if (githubUsername) {
                localStorage.setItem('github_username', githubUsername);
            } else {
                localStorage.removeItem('github_username');
            }
            if (githubRepo) {
                localStorage.setItem('github_repo', githubRepo);
            } else {
                localStorage.removeItem('github_repo');
            }
            localStorage.setItem('github_sync_enabled', githubSyncEnabled.toString());
            
            try {
                doctorProfile = profile;
                saveDoctorProfile();
                updateAIStatus();
                updateGitHubStatus();
                alert("Profile, AI, and GitHub settings saved successfully!");
                showView('patientListView');
            } catch (error) {
                console.error("Error saving settings:", error);
                alert("Could not save profile.");
            }
        }
        
        function updateGitHubStatus() {
            const statusIndicator = document.getElementById('githubStatusIndicator');
            const statusText = document.getElementById('githubStatusText');
            
            const token = localStorage.getItem('github_token');
            const username = localStorage.getItem('github_username');
            const repo = localStorage.getItem('github_repo');
            const enabled = localStorage.getItem('github_sync_enabled') === 'true';
            
            if (!enabled) {
                statusIndicator.className = 'w-2 h-2 rounded-full bg-gray-400';
                statusText.textContent = 'GitHub sync disabled';
                statusText.className = 'text-gray-600';
                return;
            }
            
            const hasConfig = token && username && repo;
            
            if (hasConfig) {
                statusIndicator.className = 'w-2 h-2 rounded-full bg-green-400';
                statusText.textContent = `GitHub sync active (${username}/${repo})`;
                statusText.className = 'text-green-600';
            } else {
                statusIndicator.className = 'w-2 h-2 rounded-full bg-yellow-400';
                statusText.textContent = 'GitHub sync enabled but incomplete configuration';
                statusText.className = 'text-yellow-600';
            }
        }
        
        // GitHub API Functions
        async function testGitHubConnection() {
            const resultsDiv = document.getElementById('githubTestResults');
            const outputDiv = document.getElementById('githubTestOutput');
            const statusDiv = document.getElementById('githubTestStatus');
            
            resultsDiv.classList.remove('hidden');
            outputDiv.innerHTML = '<div class="text-blue-600">Testing GitHub connection...</div>';
            statusDiv.innerHTML = 'Testing...';
            
            const token = localStorage.getItem('github_token');
            const username = localStorage.getItem('github_username');
            const repo = localStorage.getItem('github_repo');
            
            if (!token || !username || !repo) {
                outputDiv.innerHTML = '<div class="text-red-600"> Missing GitHub configuration. Please fill in all fields.</div>';
                statusDiv.innerHTML = 'Failed - Missing config';
                return;
            }
            
            try {
                // Test repository access
                const response = await fetch(`https://api.github.com/repos/${username}/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const repoData = await response.json();
                    outputDiv.innerHTML = `
                        <div class="text-green-600"> Connection successful!</div>
                        <div class="text-sm text-gray-600 mt-2">
                            Repository: ${repoData.full_name}<br>
                            Private: ${repoData.private ? 'Yes' : 'No'}<br>
                            Last updated: ${new Date(repoData.updated_at).toLocaleDateString()}
                        </div>
                    `;
                    statusDiv.innerHTML = 'Success';
                } else if (response.status === 404) {
                    outputDiv.innerHTML = '<div class="text-red-600"> Repository not found. Please check the repository name and ensure it exists.</div>';
                    statusDiv.innerHTML = 'Failed - Repo not found';
                } else if (response.status === 401) {
                    outputDiv.innerHTML = '<div class="text-red-600"> Authentication failed. Please check your GitHub token.</div>';
                    statusDiv.innerHTML = 'Failed - Auth error';
                } else {
                    outputDiv.innerHTML = `<div class="text-red-600"> Error: ${response.status} ${response.statusText}</div>`;
                    statusDiv.innerHTML = 'Failed';
                }
            } catch (error) {
                console.error('GitHub test error:', error);
                outputDiv.innerHTML = `<div class="text-red-600"> Network error: ${error.message}</div>`;
                statusDiv.innerHTML = 'Failed - Network error';
            }
        }
        
        async function syncDataToGitHub() {
            const resultsDiv = document.getElementById('githubTestResults');
            const outputDiv = document.getElementById('githubTestOutput');
            const statusDiv = document.getElementById('githubTestStatus');
            
            resultsDiv.classList.remove('hidden');
            outputDiv.innerHTML = '<div class="text-blue-600">Uploading data to GitHub...</div>';
            statusDiv.innerHTML = 'Uploading...';
            
            try {
                const success = await uploadDataToGitHub();
                if (success) {
                    outputDiv.innerHTML = '<div class="text-green-600"> Data successfully uploaded to GitHub!</div>';
                    statusDiv.innerHTML = 'Upload successful';
                    showNotification('Data synced to GitHub successfully!', 'success');
                } else {
                    outputDiv.innerHTML = '<div class="text-red-600"> Upload failed. Check console for details.</div>';
                    statusDiv.innerHTML = 'Upload failed';
                }
            } catch (error) {
                console.error('GitHub upload error:', error);
                outputDiv.innerHTML = `<div class="text-red-600"> Error: ${error.message}</div>`;
                statusDiv.innerHTML = 'Error';
            }
        }
        
        async function syncDataFromGitHub() {
            const resultsDiv = document.getElementById('githubTestResults');
            const outputDiv = document.getElementById('githubTestOutput');
            const statusDiv = document.getElementById('githubTestStatus');
            
            resultsDiv.classList.remove('hidden');
            outputDiv.innerHTML = '<div class="text-blue-600">Downloading data from GitHub...</div>';
            statusDiv.innerHTML = 'Downloading...';
            
            try {
                const success = await downloadDataFromGitHub();
                if (success) {
                    outputDiv.innerHTML = '<div class="text-green-600"> Data successfully downloaded from GitHub!</div>';
                    statusDiv.innerHTML = 'Download successful';
                    showNotification('Data synced from GitHub successfully!', 'success');
                    // Reload the app data
                    loadPatients();
                    loadDoctorProfile();
                    renderPatientList();
                } else {
                    outputDiv.innerHTML = '<div class="text-red-600"> Download failed. Check console for details.</div>';
                    statusDiv.innerHTML = 'Download failed';
                }
            } catch (error) {
                console.error('GitHub download error:', error);
                outputDiv.innerHTML = `<div class="text-red-600"> Error: ${error.message}</div>`;
                statusDiv.innerHTML = 'Error';
            }
        }
        
        async function uploadDataToGitHub() {
            const token = localStorage.getItem('github_token');
            const username = localStorage.getItem('github_username');
            const repo = localStorage.getItem('github_repo');
            
            if (!token || !username || !repo) {
                throw new Error('GitHub configuration incomplete');
            }
            
            // Prepare data to upload
            const dataToUpload = {
                doctorProfile: doctorProfile,
                patients: patients,
                consultations: consultations,
                lastSync: new Date().toISOString(),
                version: '1.0'
            };
            
            // Encrypt the data for security
            const encryptedData = CryptoJS.AES.encrypt(JSON.stringify(dataToUpload), 'medical-data-key').toString();
            
            const fileData = {
                message: `Medical records sync - ${new Date().toISOString()}`,
                content: btoa(encryptedData), // Base64 encode
                sha: await getFileSHA(username, repo, token, 'medical-data.json')
            };
            
            const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/medical-data.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(fileData)
            });
            
            return response.ok;
        }
        
        async function downloadDataFromGitHub() {
            const token = localStorage.getItem('github_token');
            const username = localStorage.getItem('github_username');
            const repo = localStorage.getItem('github_repo');
            
            if (!token || !username || !repo) {
                throw new Error('GitHub configuration incomplete');
            }
            
            const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/medical-data.json`, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('No data file found in repository');
                }
                throw new Error(`GitHub API error: ${response.status}`);
            }
            
            const fileData = await response.json();
            const encryptedData = atob(fileData.content);
            
            try {
                const decryptedData = CryptoJS.AES.decrypt(encryptedData, 'medical-data-key').toString(CryptoJS.enc.Utf8);
                const parsedData = JSON.parse(decryptedData);
                
                // Update local data
                if (parsedData.doctorProfile) {
                    doctorProfile = parsedData.doctorProfile;
                    saveDoctorProfile();
                }
                if (parsedData.patients) {
                    patients = parsedData.patients;
                    localStorage.setItem(STORAGE_KEYS.PATIENTS, JSON.stringify(patients));
                }
                if (parsedData.consultations) {
                    consultations = parsedData.consultations;
                    // Save consultations by patient
                    const consultationsByPatient = {};
                    consultations.forEach(consultation => {
                        if (!consultationsByPatient[consultation.patientId]) {
                            consultationsByPatient[consultation.patientId] = [];
                        }
                        consultationsByPatient[consultation.patientId].push(consultation);
                    });
                    
                    Object.keys(consultationsByPatient).forEach(patientId => {
                        saveConsultations(patientId, consultationsByPatient[patientId]);
                    });
                }
                
                return true;
            } catch (error) {
                console.error('Data decryption/parsing error:', error);
                throw new Error('Failed to decrypt or parse downloaded data');
            }
        }
        
        async function getFileSHA(username, repo, token, filePath) {
            try {
                const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filePath}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.sha;
                }
            } catch (error) {
                console.log('File does not exist yet, SHA will be omitted');
            }
            return null;
        }
        
        function isGitHubSyncEnabled() {
            const token = localStorage.getItem('github_token');
            const username = localStorage.getItem('github_username');
            const repo = localStorage.getItem('github_repo');
            const enabled = localStorage.getItem('github_sync_enabled') === 'true';
            
            return enabled && token && username && repo;
        }
        
        async function autoSyncToGitHub() {
            if (!isGitHubSyncEnabled()) {
                return;
            }
            
            try {
                console.log('Auto-syncing to GitHub...');
                await uploadDataToGitHub();
                console.log('Auto-sync completed successfully');
            } catch (error) {
                console.error('Auto-sync failed:', error);
                // Don't show error notifications for auto-sync failures to avoid spam
            }
        }
        
        // API Testing Functions (Claude Sonnet only)
        
        async function testDiagnosisAI() {
            const geminiKey = document.getElementById('geminiApiKey').value.trim();
            const resultsDiv = document.getElementById('apiTestResults');
            const outputDiv = document.getElementById('apiTestOutput');
            
            resultsDiv.classList.remove('hidden');
            outputDiv.innerHTML = '<div class="text-blue-600">Testing AI diagnosis functionality...</div>';
            
            if (!geminiKey) {
                outputDiv.innerHTML = '<div class="text-red-600"> No Gemini API key provided</div>';
                return;
            }
            
            try {
                // Temporarily update AI config for testing
                const originalGeminiKey = AI_CONFIG.gemini.apiKey;
                const originalEnabled = AI_CONFIG.enabled;
                
                AI_CONFIG.gemini.apiKey = geminiKey;
                AI_CONFIG.enabled = true;
                
                // Test the diagnosis AI with sample data
                const testPatientData = {
                    age: '25',
                    gender: 'female',
                    weight: '60',
                    bp: 'normal'
                };
                
                const testComplaint = 'irregular periods and pelvic pain';
                
                outputDiv.innerHTML = '<div class="text-blue-600">Making diagnosis AI call...</div>';
                
                const suggestions = await MEDICAL_AI.getDiagnosisSuggestions(
                    testPatientData,
                    testComplaint,
                    testComplaint
                );
                
                // Restore original config
                AI_CONFIG.gemini.apiKey = originalGeminiKey;
                AI_CONFIG.enabled = originalEnabled;
                
                if (suggestions && suggestions.length > 0) {
                    outputDiv.innerHTML = `
                        <div class="text-green-600"> Diagnosis AI working correctly!</div>
                        <div class="text-xs text-gray-600 mt-2">Sample suggestions received:</div>
                        <div class="text-xs text-gray-500 mt-1">
                            ${suggestions.slice(0, 3).map(s => ` ${s.diagnosis}`).join('<br>')}
                        </div>
                    `;
                } else {
                    outputDiv.innerHTML = '<div class="text-red-600"> No diagnosis suggestions received</div>';
                }
                
            } catch (error) {
                console.error('Diagnosis AI test error:', error);
                outputDiv.innerHTML = `
                    <div class="text-red-600"> Diagnosis AI test failed</div>
                    <div class="text-xs text-red-600 mt-1">${error.message}</div>
                `;
                
                // Restore original config in case of error
                AI_CONFIG.gemini.apiKey = document.getElementById('geminiApiKey').value.trim();
                AI_CONFIG.enabled = document.getElementById('aiEnabled').checked;
            }
        }
        
        function showCORSHelp() {
            const helpModal = document.createElement('div');
            helpModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            helpModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">CORS Issues & Solutions</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4 text-sm">
                        <div class="bg-red-50 border border-red-200 p-4 rounded">
                            <h4 class="font-semibold text-red-800 mb-2"> Problem: CORS Restrictions</h4>
                            <p class="text-red-700">
                                When running HTML files locally, browsers block API calls to external services due to Cross-Origin Resource Sharing (CORS) policies.
                            </p>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 p-4 rounded">
                            <h4 class="font-semibold text-green-800 mb-2"> Solution 1: Use a Local Server</h4>
                            <div class="space-y-2">
                                <p class="text-green-700">Run the app using a local web server:</p>
                                <div class="bg-gray-100 p-3 rounded font-mono text-xs">
                                    # Using Python (if installed)<br>
                                    python -m http.server 8000<br><br>
                                    # Using Node.js (if installed)<br>
                                    npx http-server -p 8000<br><br>
                                    # Then open: http://localhost:8000/DOCTOR_CHANDA_0.1.html
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 p-4 rounded">
                            <h4 class="font-semibold text-blue-800 mb-2"> Solution 2: Browser Extensions</h4>
                            <div class="space-y-2">
                                <p class="text-blue-700">Install a CORS extension:</p>
                                <ul class="list-disc list-inside space-y-1 text-blue-700">
                                    <li><strong>Chrome:</strong> "Allow CORS" or "CORS Unblock" extension</li>
                                    <li><strong>Firefox:</strong> "CORS Everywhere" addon</li>
                                    <li><strong>Edge:</strong> "Allow CORS" extension</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 border border-purple-200 p-4 rounded">
                            <h4 class="font-semibold text-purple-800 mb-2"> Solution 3: Deploy Online</h4>
                            <div class="space-y-2">
                                <p class="text-purple-700">Host the app on a web server:</p>
                                <ul class="list-disc list-inside space-y-1 text-purple-700">
                                    <li>GitHub Pages (free)</li>
                                    <li>Netlify (free)</li>
                                    <li>Vercel (free)</li>
                                    <li>Any web hosting service</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded">
                            <h4 class="font-semibold text-yellow-800 mb-2"> Testing Your Setup</h4>
                            <p class="text-yellow-700 mb-2">
                                Use the "Test Gemini" button below to verify your API connection works correctly.
                            </p>
                            <p class="text-yellow-700 text-sm">
                                <strong>Note:</strong> This app now uses only Gemini API for all medical suggestions.
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-6">
                        <button onclick="this.closest('.fixed').remove()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            Got it!
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(helpModal);
            lucide.createIcons();
        }
        
        async function saveConsultation(e) {
            e.preventDefault();
            
            const medications = [];
            document.querySelectorAll('.medication-item').forEach(item => {
                const name = item.querySelector('.med-name').value;
                if (name) { // Only add if name is present
                    medications.push({
                        name: name,
                        dosage: item.querySelector('.med-dosage').value,
                        duration: item.querySelector('.med-duration').value,
                    });
                }
            });

            const consultation = {
                id: generateId(),
                date: new Date().toISOString(),
                chiefComplaint: document.getElementById('chiefComplaint').value,
                diagnosis: document.getElementById('diagnosis').value,
                investigations: document.getElementById('investigations').value,
                medications: medications,
                advice: document.getElementById('advice').value,
                followUp: document.getElementById('followUp').value,
            };

            try {
                // Load existing consultations, add new one, and save
                const consultations = loadConsultations(currentPatientId);
                consultations.push(consultation);
                saveConsultations(currentPatientId, consultations);
                
                showPatientDetail(currentPatientId);

            } catch(error) {
                console.error("Error saving consultation:", error);
                alert("Could not save consultation.");
            }
        }

        async function editConsultation(patientId, consultationId) {
            const consultations = loadConsultations(patientId);
            const consultation = consultations.find(c => c.id === consultationId);
            
            if (!consultation) {
                showNotification('Consultation not found', 'error');
                return;
            }
            
            // Set up the form for editing
            currentPatientId = patientId;
            document.getElementById('consultationPatientId').value = patientId;
            
            // Populate form fields with existing data
            document.getElementById('chiefComplaint').value = consultation.chiefComplaint || '';
            document.getElementById('diagnosis').value = consultation.diagnosis || '';
            document.getElementById('investigations').value = consultation.investigations || '';
            document.getElementById('advice').value = consultation.advice || '';
            
            // Handle follow-up
            if (consultation.followUp) {
                // Try to parse the follow-up format
                const followUpMatch = consultation.followUp.match(/After (\d+) (days|weeks|months)/);
                if (followUpMatch) {
                    document.getElementById('followUpType').value = followUpMatch[2];
                    document.getElementById('followUpValue').value = followUpMatch[1];
                } else {
                    document.getElementById('followUpType').value = 'custom';
                    document.getElementById('followUpValue').value = consultation.followUp;
                }
                document.getElementById('followUp').value = consultation.followUp;
            }
            
            // Clear existing medications container and rebuild
            document.getElementById('medicationsContainer').innerHTML = `
                <div class="flex justify-between items-center">
                    <label class="block text-sm font-medium text-gray-700">Medications (Rx)</label>
                    <div class="flex space-x-2">
                        <button type="button" id="aiMedicationBtn" class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded hover:bg-purple-200 flex items-center space-x-1" title="AI Medication Suggestions">
                            <i data-lucide="sparkles" class="w-3 h-3"></i>
                            <span>AI Suggest</span>
                        </button>
                    </div>
                </div>
            `;
            
            // Event listeners handled by event delegation - no need to re-attach
            console.log('Edit consultation: Medication buttons recreated, event delegation will handle clicks');
            
            // Add existing medications
            if (consultation.medications && consultation.medications.length > 0) {
                consultation.medications.forEach(med => {
                    addMedicationField({
                        name: med.name || '',
                        dosage: med.dosage || '',
                        duration: med.duration || ''
                    });
                });
            } else {
                // Add at least one empty medication field
                addMedicationField({name: '', dosage: '', duration: ''});
            }
            
            // Update form submission to handle editing
            const form = document.getElementById('consultationForm');
            form.onsubmit = async (e) => {
                e.preventDefault();
                await updateConsultation(consultationId);
            };
            
            // Update page title and navigation
            document.querySelector('#consultationFormView h2').textContent = 'Edit Consultation / Prescription';
            document.getElementById('backToPatientDetailName').textContent = 'Back to Patient Details';
            
            // Show the form
            showView('consultationFormView');
            
            // Recreate icons for new buttons
            lucide.createIcons();
        }
        
        async function updateConsultation(consultationId) {
            const medications = [];
            document.querySelectorAll('.medication-item').forEach(item => {
                const name = item.querySelector('.med-name').value;
                if (name) { // Only add if name is present
                    medications.push({
                        name: name,
                        dosage: item.querySelector('.med-dosage').value,
                        duration: item.querySelector('.med-duration').value,
                    });
                }
            });

            const updatedConsultation = {
                id: consultationId, // Keep the same ID
                date: new Date().toISOString(), // Update to current date/time
                chiefComplaint: document.getElementById('chiefComplaint').value,
                diagnosis: document.getElementById('diagnosis').value,
                investigations: document.getElementById('investigations').value,
                medications: medications,
                advice: document.getElementById('advice').value,
                followUp: document.getElementById('followUp').value,
            };

            try {
                // Load existing consultations and update the specific one
                const consultations = loadConsultations(currentPatientId);
                const index = consultations.findIndex(c => c.id === consultationId);
                
                if (index !== -1) {
                    // Preserve original date if user wants to keep it
                    const originalDate = consultations[index].date;
                    const keepOriginalDate = await showCustomConfirm(
                        'Update Consultation Date',
                        'Do you want to keep the original consultation date or update to current date?',
                        'Keep Original',
                        'Update to Current',
                        'calendar'
                    );
                    
                    if (keepOriginalDate) {
                        updatedConsultation.date = originalDate;
                    }
                    
                    consultations[index] = updatedConsultation;
                    saveConsultations(currentPatientId, consultations);
                    
                    showNotification('Consultation updated successfully!', 'success');
                    
                    // Reset form submission handler back to normal
                    document.getElementById('consultationForm').onsubmit = saveConsultation;
                    document.querySelector('#consultationFormView h2').textContent = 'New Consultation / Prescription';
                    
                    // Go back to patient detail view
                    showPatientDetail(currentPatientId);
                } else {
                    throw new Error('Consultation not found');
                }

            } catch(error) {
                console.error("Error updating consultation:", error);
                showNotification('Could not update consultation. Please try again.', 'error');
            }
        }

        function saveVital(patientId, vital) {
            const vitals = loadVitals(patientId);
            vitals.push(vital);
            localStorage.setItem(`vitals_${patientId}`, JSON.stringify(vitals));
        }
        
        function loadVitals(patientId) {
            const saved = localStorage.getItem(`vitals_${patientId}`);
            return saved ? JSON.parse(saved) : [];
        }
        
        function saveTestResult(patientId, testResult) {
            const tests = loadTestResults(patientId);
            tests.push(testResult);
            localStorage.setItem(`tests_${patientId}`, JSON.stringify(tests));
        }
        
        function loadTestResults(patientId) {
            const saved = localStorage.getItem(`tests_${patientId}`);
            return saved ? JSON.parse(saved) : [];
        }
        
        function calculateBMI(height, weight) {
            if (!height || !weight) return null;
            const heightInMeters = height / 100;
            const bmi = weight / (heightInMeters * heightInMeters);
            return bmi.toFixed(1);
        }
        
        function updateBMIDisplay() {
            const height = document.getElementById('patientHeight').value;
            const weight = document.getElementById('patientWeight').value;
            const display = document.getElementById('bmiDisplay');
            
            if (height && weight) {
                const bmi = calculateBMI(height, weight);
                let category = '';
                if (bmi < 18.5) category = 'Underweight';
                else if (bmi < 25) category = 'Normal';
                else if (bmi < 30) category = 'Overweight';
                else category = 'Obese';
                
                display.textContent = `BMI: ${bmi} (${category})`;
            } else {
                display.textContent = '';
            }
        }
        
        function showGynecologicalSection() {
            const gender = document.getElementById('patientGender').value;
            const gynSection = document.getElementById('gynecologicalSection');
            
            if (gender === 'Female') {
                gynSection.style.display = 'block';
            } else {
                gynSection.style.display = 'none';
            }
        }

        async function editPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (patient) {
                // Basic Information
                document.getElementById('patientId').value = patientId;
                document.getElementById('displayPatientId').textContent = patient.patientId || 'N/A';
                document.getElementById('patientName').value = patient.name || '';
                document.getElementById('patientDOB').value = patient.dob || '';
                document.getElementById('patientAge').value = patient.age || '';
                document.getElementById('patientGender').value = patient.gender || '';
                document.getElementById('patientContact').value = patient.contact || '';
                document.getElementById('patientEmail').value = patient.email || '';
                document.getElementById('patientAddress').value = patient.address || '';
                // Extended Indian fields
                const setVal = (id,val)=>{ const el=document.getElementById(id); if(el) el.value = val || ''; };
                setVal('patientABHA', patient.abha);
                setVal('patientAadhaar', patient.aadhaarLast4);
                setVal('patientInsurance', patient.insurance);
                setVal('patientBloodGroup', patient.bloodGroup);
                setVal('patientOrganDonor', patient.organDonor);
                setVal('patientLanguages', patient.languages);
                setVal('patientPIN', patient.pin);
                setVal('patientCity', patient.city);
                setVal('patientState', patient.state);
                setVal('patientOccupation', patient.occupation);
                setVal('patientEmergencyContact', patient.emergencyContact);
                setVal('patientDiet', patient.diet);
                setVal('patientTobacco', patient.tobacco);
                // Chronic flags
                document.querySelectorAll('.chronic-flag').forEach(cb=>{ cb.checked = patient.chronicFlags?.includes(cb.value); });
                
                // Current Vitals
                document.getElementById('patientHeight').value = patient.height || '';
                document.getElementById('patientWeight').value = patient.weight || '';
                document.getElementById('patientBP').value = patient.bloodPressure || '';
                document.getElementById('patientTemp').value = patient.temperature || '';
                
                // Medical History
                document.getElementById('medicalHistory').value = patient.medicalHistory || '';
                document.getElementById('surgicalHistory').value = patient.surgicalHistory || '';
                document.getElementById('medicationHistory').value = patient.medicationHistory || '';
                
                // Allergies
                document.getElementById('drugAllergies').value = patient.drugAllergies || '';
                document.getElementById('foodAllergies').value = patient.foodAllergies || '';
                
                // Personal & Lifestyle
                document.getElementById('smokingHistory').value = patient.smokingHistory || '';
                document.getElementById('alcoholHistory').value = patient.alcoholHistory || '';
                document.getElementById('exerciseHabits').value = patient.exerciseHabits || '';
                document.getElementById('occupationalHistory').value = patient.occupationalHistory || '';
                
                // Gynecological History
                document.getElementById('menarche').value = patient.menarche || '';
                document.getElementById('menstrualCycle').value = patient.menstrualCycle || '';
                document.getElementById('lastMenstrualPeriod').value = patient.lastMenstrualPeriod || '';
                document.getElementById('gravida').value = patient.gravida || '';
                document.getElementById('para').value = patient.para || '';
                document.getElementById('abortions').value = patient.abortions || '';
                document.getElementById('living').value = patient.living || '';
                document.getElementById('contraceptiveHistory').value = patient.contraceptiveHistory || '';
                
                // Family History
                document.getElementById('familyHistory').value = patient.familyHistory || '';
                
                document.getElementById('patientFormTitle').textContent = 'Edit Patient';
                
                // Show/hide gynecological section
                showGynecologicalSection();
                
                // Update BMI display
                updateBMIDisplay();
                
                // Trigger age calculation in case DOB is available
                const event = new Event('change');
                document.getElementById('patientDOB').dispatchEvent(event);
                
                showView('patientFormView');
            }
        }

        // --- MEDICAL CERTIFICATE FUNCTIONS ---
        
        function setupMedicalCertificates() {
            // Create certificate button
            const createCertBtn = document.getElementById('createCertificateBtn');
            if (createCertBtn) {
                createCertBtn.addEventListener('click', showCertificateModal);
            }

            // Auto generate certificate button
            const autoGenBtn = document.getElementById('autoGenerateCertBtn');
            if (autoGenBtn) {
                autoGenBtn.addEventListener('click', showAutoGenerateModal);
            }

            // Certificate modal handlers
            const closeCertModal = document.getElementById('closeCertificateModal');
            const cancelCertForm = document.getElementById('cancelCertificateForm');
            const previewCertBtn = document.getElementById('previewCertificate');
            const certForm = document.getElementById('certificateForm');

            if (closeCertModal) closeCertModal.addEventListener('click', hideCertificateModal);
            if (cancelCertForm) cancelCertForm.addEventListener('click', hideCertificateModal);
            if (previewCertBtn) previewCertBtn.addEventListener('click', previewCertificate);
            if (certForm) certForm.addEventListener('submit', handleCertificateSubmit);

            // Certificate preview modal handlers
            const closeCertPreview = document.getElementById('closeCertificatePreview');
            const editCertBtn = document.getElementById('editCertificate');
            const signAndIssueBtn = document.getElementById('signAndIssueCertificate');
            const printCertBtn = document.getElementById('printCertificate');

            if (closeCertPreview) closeCertPreview.addEventListener('click', hideCertificatePreview);
            if (editCertBtn) editCertBtn.addEventListener('click', editCertificate);
            if (signAndIssueBtn) signAndIssueBtn.addEventListener('click', signAndIssueCertificate);
            if (printCertBtn) printCertBtn.addEventListener('click', printCertificate);

            // Form field handlers
            const indefiniteLeave = document.getElementById('indefiniteLeave');
            const leaveEndDate = document.getElementById('leaveEndDate');
            
            if (indefiniteLeave && leaveEndDate) {
                indefiniteLeave.addEventListener('change', function() {
                    leaveEndDate.disabled = this.checked;
                    if (this.checked) {
                        leaveEndDate.value = '';
                    }
                });
            }

            // Set default date to today
            const certDate = document.getElementById('certificateDate');
            if (certDate) {
                certDate.value = new Date().toISOString().split('T')[0];
            }

            // Auto generate modal handlers
            const closeAutoGenModal = document.getElementById('closeAutoGenerateModal');
            const cancelAutoGen = document.getElementById('cancelAutoGenerate');
            const generateFromConsultation = document.getElementById('generateFromConsultation');

            if (closeAutoGenModal) closeAutoGenModal.addEventListener('click', hideAutoGenerateModal);
            if (cancelAutoGen) cancelAutoGen.addEventListener('click', hideAutoGenerateModal);
            if (generateFromConsultation) generateFromConsultation.addEventListener('click', handleAutoGenerate);

            // Certificate actions modal handlers
            const closeCertActions = document.getElementById('closeCertificateActions');
            const sendEmailBtn = document.getElementById('sendEmailCertificate');
            const shareWhatsAppBtn = document.getElementById('shareWhatsApp');
            const printStandardBtn = document.getElementById('printStandard');
            const downloadCertificatePDFBtn = document.getElementById('downloadCertificatePDF');

            if (closeCertActions) closeCertActions.addEventListener('click', hideCertificateActionsModal);
            if (sendEmailBtn) sendEmailBtn.addEventListener('click', sendCertificateEmail);
            if (shareWhatsAppBtn) shareWhatsAppBtn.addEventListener('click', shareCertificateWhatsApp);
            if (printStandardBtn) printStandardBtn.addEventListener('click', printCertificatePDFForSharing);
            if (downloadCertificatePDFBtn) downloadCertificatePDFBtn.addEventListener('click', downloadCertificatePDF);

            // Close certificate actions modal on backdrop click
            const certActionsModal = document.getElementById('certificateActionsModal');
            if (certActionsModal) {
                certActionsModal.addEventListener('click', (e) => {
                    if (e.target === certActionsModal) {
                        hideCertificateActionsModal();
                    }
                });
            }

            // Preview modal enhanced actions
            const shareEmailPreview = document.getElementById('shareEmailPreview');
            const shareWhatsAppPreview = document.getElementById('shareWhatsAppPreview');

            if (shareEmailPreview) shareEmailPreview.addEventListener('click', () => {
                if (window.tempAutoGeneratedCert) {
                    window.currentCertificateId = 'temp';
                    showCertificateActionsModal('temp');
                }
            });

            if (shareWhatsAppPreview) shareWhatsAppPreview.addEventListener('click', () => {
                if (window.tempAutoGeneratedCert) {
                    window.currentCertificateId = 'temp';
                    showCertificateActionsModal('temp');
                }
            });
        }

        function showCertificateModal() {
            if (!currentPatientId) {
                showNotification('Please select a patient first', 'error');
                return;
            }

            const modal = document.getElementById('certificateModal');
            if (modal) {
                modal.classList.remove('hidden');
                // Clear form
                document.getElementById('certificateForm').reset();
                // Set default date
                document.getElementById('certificateDate').value = new Date().toISOString().split('T')[0];
            }
        }

        function hideCertificateModal() {
            const modal = document.getElementById('certificateModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function hideCertificatePreview() {
            const modal = document.getElementById('certificatePreviewModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function previewCertificate() {
            const formData = getCertificateFormData();
            if (!validateCertificateForm(formData)) return;

            const certificateHtml = generateCertificateTemplate(formData);
            document.getElementById('certificateTemplate').innerHTML = certificateHtml;
            
            hideCertificateModal();
            document.getElementById('certificatePreviewModal').classList.remove('hidden');
        }

        function getCertificateFormData() {
            const patient = patients.find(p => p.id === currentPatientId);
            
            return {
                patientName: patient?.name || '',
                patientAge: patient?.age || '',
                patientGender: patient?.gender || '',
                certificateType: document.getElementById('certificateType').value,
                certificateDate: document.getElementById('certificateDate').value,
                leaveStartDate: document.getElementById('leaveStartDate').value,
                leaveEndDate: document.getElementById('leaveEndDate').value,
                indefiniteLeave: document.getElementById('indefiniteLeave').checked,
                medicalCondition: document.getElementById('medicalCondition').value,
                recommendations: document.getElementById('recommendations').value,
                requiresBedRest: document.getElementById('requiresBedRest').checked,
                requiresFollowUp: document.getElementById('requiresFollowUp').checked
            };
        }

        function validateCertificateForm(data) {
            if (!data.certificateType) {
                showNotification('Please select certificate type', 'error');
                return false;
            }
            if (!data.certificateDate) {
                showNotification('Please select certificate date', 'error');
                return false;
            }
            if (!data.leaveStartDate) {
                showNotification('Please select leave start date', 'error');
                return false;
            }
            if (!data.indefiniteLeave && !data.leaveEndDate) {
                showNotification('Please select leave end date or check indefinite period', 'error');
                return false;
            }
            if (!data.medicalCondition.trim()) {
                showNotification('Please enter medical condition', 'error');
                return false;
            }
            return true;
        }

        function generateCertificateTemplate(data) {
            // Generate medical-standard identifiers
            const certificateUUID = generateMedicalUUID();
            const certificateId = 'MED-CERT-' + Date.now();
            const timestamp = formatMedicalTimestamp();
            const signatureHash = doctorProfile.digitalSignature ? 
                generateDigitalSignatureHash(doctorProfile.digitalSignature, timestamp.iso, doctorProfile.regNumber || 'UNKNOWN') : 
                null;
            
            const formattedDate = new Date(data.certificateDate).toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            const startDate = new Date(data.leaveStartDate).toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            const endDate = data.indefiniteLeave ? 'until further notice' : 
                new Date(data.leaveEndDate).toLocaleDateString('en-IN', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

            const certificateTypes = {
                'sick_leave': 'Medical Sick Leave Certificate',
                'medical_leave': 'Medical Leave Certificate',
                'maternity_leave': 'Maternity Leave Certificate',
                'disability': 'Medical Disability Certificate',
                'fitness': 'Medical Fitness Certificate',
                'covid_isolation': 'COVID-19 Isolation Certificate'
            };

            return `
                <div class="certificate-template" style="font-family: Georgia, 'Times New Roman', serif; background: white; padding: 35px; border-top: 5px solid #2563eb; min-height: 600px;">
                    <header class="certificate-header" style="text-align: center; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px; margin-bottom: 20px; page-break-after: avoid;">
                        <div style="margin-bottom: 12px;">
                            <h2 style="margin: 0; color: #2563eb; font-size: 20px; font-weight: bold;">${doctorProfile.doctorName || 'Dr. [Your Name]'}</h2>
                            <p style="margin: 3px 0; color: #4b5563; font-size: 14px; font-weight: 500;">${doctorProfile.qualifications || 'MBBS, MD'}</p>
                        </div>
                        <div style="color: #6b7280; font-size: 12px; line-height: 1.3; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                                <span><strong>Reg. No:</strong> ${doctorProfile.regNumber || '[Registration Number]'}</span>
                                <span><strong>Specialization:</strong> ${doctorProfile.specializations || 'General Medicine'}</span>
                                ${doctorProfile.mobile ? `<span><strong>Contact:</strong> ${doctorProfile.mobile}</span>` : ''}
                            </div>
                            ${doctorProfile.clinicInfo ? `<p style="margin: 6px 0 0 0; font-size: 11px;"><strong>Clinic:</strong> ${doctorProfile.clinicInfo}</p>` : ''}
                        </div>
                        <div style="margin: 12px 0;">
                            <h3 style="margin: 0; color: #1e40af; font-size: 16px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">${certificateTypes[data.certificateType] || 'Medical Certificate'}</h3>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 10px; color: #6b7280; padding: 6px 0; border-top: 1px solid #e5e7eb;">
                            <div><strong>Certificate No:</strong> ${certificateId}</div>
                            <div><strong>UUID:</strong> ${certificateUUID.substring(0, 8)}...</div>
                        </div>
                    </header>

                    <div class="certificate-content" style="margin-bottom: 80px; page-break-inside: avoid;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 14px;">
                            <div><strong>Patient:</strong> ${data.patientName} (${data.patientAge}/${data.patientGender.charAt(0)})</div>
                            <div><strong>Date:</strong> ${formattedDate}</div>
                        </div>
                        
                        <div style="line-height: 1.6; font-size: 16px;">
                            <p style="margin-bottom: 20px;">This is to certify that <strong>${data.patientName}</strong>, ${data.patientAge} years old ${data.patientGender}, has been under my medical care and treatment.</p>
                            
                            <div style="margin: 20px 0; padding: 15px; background-color: #f8fafc; border-left: 4px solid #2563eb;">
                                <p style="margin: 0;"><strong>Medical Condition:</strong></p>
                                <p style="margin: 10px 0 0 0;">${data.medicalCondition}</p>
                            </div>
                            
                            <p style="margin: 20px 0;">Based on my medical examination and assessment, I hereby recommend that the patient be granted medical leave from <strong>${startDate}</strong> to <strong>${endDate}</strong>.</p>
                            
                            ${data.recommendations ? `
                                <div style="margin: 20px 0; padding: 15px; background-color: #f0f9ff; border-left: 4px solid #0ea5e9;">
                                    <p style="margin: 0;"><strong>Medical Recommendations:</strong></p>
                                    <p style="margin: 10px 0 0 0;">${data.recommendations}</p>
                                </div>
                            ` : ''}
                            
                            ${(data.requiresBedRest || data.requiresFollowUp) ? `
                                <div style="margin: 20px 0;">
                                    <p style="margin: 0 0 10px 0;"><strong>Additional Instructions:</strong></p>
                                    <ul style="margin: 0; padding-left: 20px;">
                                        ${data.requiresBedRest ? '<li>The patient requires complete bed rest during this period.</li>' : ''}
                                        ${data.requiresFollowUp ? '<li>Regular medical follow-up is required.</li>' : ''}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <p style="margin: 30px 0 0 0; font-style: italic; color: #4b5563;">This certificate is issued for official purposes and is valid as per medical recommendation.</p>
                        </div>
                    </div>

                    <!-- Certificate Information Section -->
                    <div style="margin-top: 30px; padding: 15px; background-color: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; page-break-inside: avoid;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 11px; color: #6b7280;">
                            <div>
                                <p style="margin: 0;"><strong>Issue Date:</strong> ${formattedDate}</p>
                                <p style="margin: 3px 0;"><strong>Time:</strong> ${timestamp.time} ${timestamp.timezone}</p>
                            </div>
                            <div>
                                ${signatureHash ? `<p style="margin: 0; font-size: 10px;"><strong>Auth Hash:</strong> ${signatureHash.substring(0, 16)}...</p>` : ''}
                                <p style="margin: 3px 0;"><strong>Certificate ID:</strong> ${certificateId.substring(-8)}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Signature Section - Separate and Clear -->
                    <div class="certificate-footer" style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #2563eb; display: flex; justify-content: flex-end; page-break-inside: avoid;">
                        <div class="certificate-signature" style="text-align: center; width: 300px; border: 2px solid #2563eb; border-radius: 12px; padding: 20px; background: linear-gradient(135deg, #f8fafc, #e2e8f0); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="background: #2563eb; color: white; padding: 6px 12px; border-radius: 15px; font-size: 10px; font-weight: bold; margin-bottom: 12px; display: inline-block;">
                                 AUTHORIZED CERTIFICATE
                            </div>
                            ${doctorProfile.digitalSignature ? `
                                <div style="margin-bottom: 15px;">
                                    <img src="${doctorProfile.digitalSignature}" alt="Digital Signature" style="max-height: 60px; max-width: 200px; display: block; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 4px; padding: 5px; background: white;">
                                </div>
                                <div class="signature-doctor-info" style="border-top: 2px solid #2563eb; padding-top: 10px; margin-top: 10px; font-size: 12px;">
                                    <div style="font-weight: bold; margin-bottom: 4px; color: #1f2937;">${doctorProfile.doctorName || 'Dr. [Your Name]'}</div>
                                    <div style="color: #4b5563; margin-bottom: 3px; font-size: 11px;">${doctorProfile.qualifications || 'MBBS, MD'}</div>
                                    <div style="color: #6b7280; font-size: 10px; margin-bottom: 8px;">Reg. No: ${doctorProfile.regNumber || '[Registration Number]'}</div>
                                    <div class="signature-verification" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 4px 8px; border-radius: 12px; font-size: 9px; font-weight: 600; display: inline-block;">
                                         DIGITALLY VERIFIED & AUTHENTICATED
                                    </div>
                                </div>
                            ` : `
                                <div style="height: 60px; margin-bottom: 15px; border: 2px dashed #cbd5e1; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 11px; background: #f9fafb;">
                                    [Digital Signature Required]
                                </div>
                                <div class="signature-doctor-info" style="border-top: 2px solid #2563eb; padding-top: 10px; margin-top: 10px; font-size: 12px;">
                                    <div style="font-weight: bold; margin-bottom: 4px; color: #1f2937;">${doctorProfile.doctorName || 'Dr. [Your Name]'}</div>
                                    <div style="color: #4b5563; margin-bottom: 3px; font-size: 11px;">${doctorProfile.qualifications || 'MBBS, MD'}</div>
                                    <div style="color: #6b7280; font-size: 10px;">Reg. No: ${doctorProfile.regNumber || '[Registration Number]'}</div>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center; font-size: 10px; color: #9ca3af; border-top: 1px solid #e5e7eb; padding-top: 10px;">
                        This is a digitally generated medical certificate. Generated on ${new Date().toLocaleDateString('en-IN')} at ${new Date().toLocaleTimeString('en-IN')}
                    </div>
                </div>
            `;
        }

        function handleCertificateSubmit(e) {
            e.preventDefault();
            previewCertificate();
        }

        function editCertificate() {
            hideCertificatePreview();
            showCertificateModal();
        }

        function signAndIssueCertificate() {
            // Force refresh of doctor profile from localStorage on mobile
            if (isMobileDevice()) {
                console.log('Mobile device detected, refreshing profile data for certificate signing');
                loadDoctorProfile();
            }
            
            // Double-check signature setup with more robust validation
            const hasSignature = doctorProfile.signatureSetup && 
                                doctorProfile.digitalSignature && 
                                doctorProfile.digitalSignature.length > 0;
            
            console.log('Certificate signature validation:', {
                signatureSetup: doctorProfile.signatureSetup,
                hasDigitalSignature: !!doctorProfile.digitalSignature,
                signatureLength: doctorProfile.digitalSignature ? doctorProfile.digitalSignature.length : 0,
                isMobile: isMobileDevice()
            });
            
            if (!hasSignature) {
                showNotification('Please set up your digital signature first in Settings', 'error');
                return;
            }

            // Show signature PIN modal
            showDigitalSignatureModal();
            
            // Override the signature validation to issue certificate instead of prescription
            window.tempCertificateAction = true;
        }

        function printCertificate() {
            const printContent = document.getElementById('certificateTemplate').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Medical Certificate</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; margin: 20px; line-height: 1.6; }
                        .certificate-template { max-width: 800px; margin: 0 auto; }
                        .certificate-header { text-align: center; border-bottom: 3px solid #2563eb; padding-bottom: 20px; margin-bottom: 30px; }
                        .certificate-title { font-size: 24px; font-weight: bold; color: #1e40af; margin: 20px 0; text-transform: uppercase; letter-spacing: 2px; }
                        .certificate-content { padding: 20px; text-align: justify; }
                        .certificate-template { display: flex; flex-direction: column; height: 100vh; }
                        .certificate-header { flex-shrink: 0; }
                        .certificate-content { flex: 1; overflow: hidden; }
                        .certificate-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: flex-end; flex-shrink: 0; }
                        .certificate-signature { text-align: center; border-top: 1px solid #333; padding-top: 10px; min-width: 200px; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>${printContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function saveCertificate(certificateData) {
            const certificates = loadCertificates(currentPatientId);
            const timestamp = formatMedicalTimestamp();
            const certificateUUID = generateMedicalUUID();
            const certificateId = 'MED-CERT-' + Date.now();
            
            // Generate signature hash for authenticity
            const signatureHash = doctorProfile.digitalSignature ? 
                generateDigitalSignatureHash(doctorProfile.digitalSignature, timestamp.iso, doctorProfile.regNumber || 'UNKNOWN') : 
                null;
            
            const certificate = {
                id: certificateId,
                uuid: certificateUUID,
                patientId: currentPatientId,
                ...certificateData,
                issuedDate: timestamp.iso,
                issuedTimestamp: timestamp,
                issuedBy: doctorProfile.doctorName,
                issuedByRegNo: doctorProfile.regNumber,
                digitalSignatureHash: signatureHash,
                authenticationData: {
                    doctorId: doctorProfile.regNumber || 'UNKNOWN',
                    signatureVerified: !!doctorProfile.digitalSignature,
                    issueLocation: 'Digital Clinic System',
                    version: '1.0',
                    compliance: 'Medical Council Guidelines'
                },
                status: 'issued',
                metadata: {
                    createdAt: timestamp.iso,
                    lastModified: timestamp.iso,
                    digitallyVerified: true,
                    medicalStandard: 'ISO-27799',
                    securityLevel: 'High'
                }
            };
            
            certificates.push(certificate);
            saveCertificates(currentPatientId, certificates);
            
            renderCertificatesList();
            showNotification('Medical certificate issued successfully with digital authentication!', 'success');
            
            // Log certificate issuance for audit trail
            console.log('Medical Certificate Issued:', {
                uuid: certificateUUID,
                id: certificateId,
                patient: currentPatientId,
                doctor: doctorProfile.doctorName,
                timestamp: timestamp.iso,
                authenticated: !!signatureHash
            });
        }

        function loadCertificates(patientId) {
            try {
                const certificates = localStorage.getItem(STORAGE_KEYS.CERTIFICATES + patientId);
                return certificates ? JSON.parse(certificates) : [];
            } catch (error) {
                console.error('Error loading certificates:', error);
                return [];
            }
        }

        function saveCertificates(patientId, certificates) {
            try {
                localStorage.setItem(STORAGE_KEYS.CERTIFICATES + patientId, JSON.stringify(certificates));
            } catch (error) {
                console.error('Error saving certificates:', error);
            }
        }

        function renderCertificatesList() {
            if (!currentPatientId) return;

            const certificates = loadCertificates(currentPatientId);
            const container = document.getElementById('certificatesList');
            const emptyState = document.getElementById('certificatesEmptyState');

            if (!container) return;

            // Update statistics
            updateCertificateStats();

            if (certificates.length === 0) {
                container.innerHTML = '';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }

            if (emptyState) emptyState.style.display = 'none';

            container.innerHTML = certificates.map(cert => `
                <div class="bg-white rounded-lg border p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                                    ${cert.certificateType.replace('_', ' ').toUpperCase()}
                                </span>
                                ${cert.digitalSignatureHash ? 
                                    '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full flex items-center"><i data-lucide="shield-check" class="w-3 h-3 mr-1"></i>Verified</span>' : 
                                    '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">Pending Signature</span>'
                                }
                            </div>
                            <div class="text-xs text-gray-500 mb-2">
                                <span>ID: ${cert.id}</span>
                                ${cert.uuid ? `  UUID: ${cert.uuid.substring(0, 8)}...` : ''}
                            </div>
                            <h4 class="font-medium text-gray-800">${cert.medicalCondition}</h4>
                            <p class="text-sm text-gray-600 mt-1">
                                Leave: ${new Date(cert.leaveStartDate).toLocaleDateString()} - 
                                ${cert.indefiniteLeave ? 'Until further notice' : new Date(cert.leaveEndDate).toLocaleDateString()}
                            </p>
                            <div class="flex items-center justify-between mt-2">
                                <p class="text-xs text-gray-500">
                                    Issued: ${new Date(cert.issuedDate).toLocaleDateString()} 
                                    ${cert.issuedTimestamp ? `at ${cert.issuedTimestamp.time}` : ''}
                                </p>
                                ${cert.digitalSignatureHash ? 
                                    `<span class="text-xs text-green-600 flex items-center">
                                        <i data-lucide="check-circle" class="w-3 h-3 mr-1"></i>
                                        Auth: ${cert.digitalSignatureHash.substring(0, 6)}
                                    </span>` : ''
                                }
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-1">
                            <button onclick="viewCertificate('${cert.id}')" class="text-blue-600 hover:text-blue-800 p-1" title="View Certificate">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                            <button onclick="showCertificateActionsModal('${cert.id}')" class="text-green-600 hover:text-green-800 p-1" title="Share & Print">
                                <i data-lucide="share-2" class="w-4 h-4"></i>
                            </button>
                            <button onclick="printCertificateById('${cert.id}')" class="text-gray-600 hover:text-gray-800 p-1" title="Quick Print">
                                <i data-lucide="printer" class="w-4 h-4"></i>
                            </button>
                            ${cert.digitalSignatureHash ? 
                                `<button onclick="verifyCertificate('${cert.id}')" class="text-purple-600 hover:text-purple-800 p-1" title="Verify Authenticity">
                                    <i data-lucide="shield-check" class="w-4 h-4"></i>
                                </button>` : ''
                            }
                        </div>
                    </div>
                </div>
            `).join('');

            // Re-initialize Lucide icons
            if (window.lucide) {
                window.lucide.createIcons();
            }
        }

        function viewCertificate(certificateId) {
            const certificates = loadCertificates(currentPatientId);
            const certificate = certificates.find(c => c.id === certificateId);
            if (!certificate) {
                showNotification('Certificate not found', 'error');
                return;
            }

            const certificateHtml = generateCertificateTemplate(certificate);
            document.getElementById('certificateTemplate').innerHTML = certificateHtml;
            document.getElementById('certificatePreviewModal').classList.remove('hidden');
        }

        async function printCertificateById(certificateId) {
            try {
                showNotification('Generating certificate for printing...', 'info');
                
                const certificates = loadCertificates(currentPatientId);
                const certificate = certificates.find(c => c.id === certificateId);
                if (!certificate) {
                    showNotification('Certificate not found', 'error');
                    return;
                }

                // Generate certificate HTML
                const certificateHtml = generateCertificateTemplate(certificate);
                
                // Create a temporary container for the certificate with A4 dimensions
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = certificateHtml;
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.style.background = 'white';
                tempContainer.style.width = '794px'; // A4 width at 96 DPI (210mm)
                tempContainer.style.minHeight = '1123px'; // A4 height at 96 DPI (297mm)
                tempContainer.style.padding = '45px'; // 12mm margins at 96 DPI
                document.body.appendChild(tempContainer);
                
                // Wait for content to render
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Capture with html2canvas optimized for A4 certificate
                const canvas = await html2canvas(tempContainer, {
                    scale: 2.5, // Optimized scale for A4 print quality
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: tempContainer.offsetWidth,
                    height: tempContainer.offsetHeight,
                    logging: false,
                    letterRendering: true,
                    fontLoadTimeout: 15000,
                    imageTimeout: 15000,
                    removeContainer: true
                });
                
                // Remove temporary container
                document.body.removeChild(tempContainer);
                
                const imgData = canvas.toDataURL('image/png', 1.0);
                
                // Create optimized A4 PDF for printing and sharing
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    putOnlyUsedFonts: true,
                    floatPrecision: 16
                });
                
                // Standard A4 dimensions
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 12; // Reduced margin for better content utilization
                
                const maxHeight = pageHeight - (margin * 2);
                const maxWidth = pageWidth - (margin * 2);
                
                // Calculate optimal scaling
                const scaleX = maxWidth / canvas.width;
                const scaleY = maxHeight / canvas.height;
                const scale = Math.min(scaleX, scaleY, 1);
                
                let finalWidth = canvas.width * scale;
                let finalHeight = canvas.height * scale;
                
                if (finalHeight > maxHeight) {
                    finalHeight = maxHeight;
                    finalWidth = (canvas.width * finalHeight) / canvas.height;
                }
                
                const xPos = (pageWidth - finalWidth) / 2;
                const yPos = margin;
                
                pdf.addImage(imgData, 'PNG', xPos, yPos, finalWidth, finalHeight, undefined, 'MEDIUM');
                
                // Add PDF metadata
                pdf.setProperties({
                    title: `Medical Certificate - ${certificate.patientName}`,
                    subject: 'Medical Certificate',
                    author: doctorProfile.name || 'Doctor',  
                    creator: 'Medical Records App',
                    producer: 'jsPDF',
                    keywords: 'certificate, medical, healthcare'
                });
                
                // Open PDF in new window for printing
                const pdfBlob = pdf.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                const printWindow = window.open(pdfUrl, '_blank');
                
                // Auto-print after a short delay
                setTimeout(() => {
                    printWindow.print();
                }, 1000);
                
                showNotification('Certificate ready for printing in A4 format!', 'success');
                
            } catch (error) {
                console.error('Certificate print error:', error);
                showNotification('Error preparing certificate for printing. Please try again.', 'error');
            }
        }

        // --- ENHANCED CERTIFICATE FUNCTIONS ---

        function showAutoGenerateModal() {
            if (!currentPatientId) {
                showNotification('Please select a patient first', 'error');
                return;
            }

            const modal = document.getElementById('autoGenerateModal');
            if (modal) {
                modal.classList.remove('hidden');
                loadConsultationsForCertificate();
            }
        }

        function hideAutoGenerateModal() {
            const modal = document.getElementById('autoGenerateModal');
            if (modal) {
                modal.classList.add('hidden');
                document.getElementById('certificateConfig').classList.add('hidden');
            }
        }

        function loadConsultationsForCertificate() {
            const consultations = loadConsultations(currentPatientId);
            const container = document.getElementById('consultationsList');
            
            if (!container) return;

            if (consultations.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i data-lucide="file-x" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                        <p>No consultations found for this patient.</p>
                        <p class="text-sm">Create a consultation first to auto-generate certificates.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = consultations.map((consultation, index) => `
                <div class="consultation-item border rounded-lg p-4 hover:bg-blue-50 cursor-pointer transition-colors" 
                     data-consultation-id="${consultation.id}" onclick="selectConsultationForCert('${consultation.id}')">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                                    ${new Date(consultation.date).toLocaleDateString()}
                                </span>
                                <span class="text-xs text-gray-500">
                                    ${new Date(consultation.date).toLocaleTimeString()}
                                </span>
                            </div>
                            <h4 class="font-medium text-gray-800 mb-1">
                                ${consultation.chiefComplaint || 'General Consultation'}
                            </h4>
                            <p class="text-sm text-gray-600 mb-2">
                                <strong>Diagnosis:</strong> ${consultation.diagnosis || 'Not specified'}
                            </p>
                            ${consultation.medications && consultation.medications.length > 0 ? 
                                `<p class="text-xs text-gray-500">
                                    Medications: ${consultation.medications.length} prescribed
                                </p>` : ''
                            }
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-green-600 font-medium"> Available</span>
                        </div>
                    </div>
                </div>
            `).join('');

            // Re-initialize Lucide icons
            if (window.lucide) {
                window.lucide.createIcons();
            }
        }

        function selectConsultationForCert(consultationId) {
            // Highlight selected consultation
            document.querySelectorAll('.consultation-item').forEach(item => {
                item.classList.remove('bg-blue-100', 'border-blue-500');
                item.classList.add('border-gray-200');
            });

            const selectedItem = document.querySelector(`[data-consultation-id="${consultationId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('bg-blue-100', 'border-blue-500');
                selectedItem.classList.remove('border-gray-200');
            }

            // Store selected consultation ID
            window.selectedConsultationId = consultationId;

            // Show certificate configuration
            document.getElementById('certificateConfig').classList.remove('hidden');
        }

        function handleAutoGenerate() {
            if (!window.selectedConsultationId) {
                showNotification('Please select a consultation first', 'error');
                return;
            }

            const consultations = loadConsultations(currentPatientId);
            const selectedConsultation = consultations.find(c => c.id === window.selectedConsultationId);
            
            if (!selectedConsultation) {
                showNotification('Selected consultation not found', 'error');
                return;
            }

            // Generate certificate data from consultation
            const autoData = generateCertificateFromConsultation(selectedConsultation);
            
            // Show preview
            const certificateHtml = generateCertificateTemplate(autoData);
            document.getElementById('certificateTemplate').innerHTML = certificateHtml;
            
            hideAutoGenerateModal();
            document.getElementById('certificatePreviewModal').classList.remove('hidden');

            // Store the auto-generated data for potential saving
            window.tempAutoGeneratedCert = autoData;
        }

        function generateCertificateFromConsultation(consultation) {
            const patient = patients.find(p => p.id === currentPatientId);
            const certType = document.getElementById('autoCertType').value;
            const leaveDays = parseInt(document.getElementById('autoLeaveDays').value);
            const includeCurrentDiagnosis = document.getElementById('includeCurrentDiagnosis').checked;

            const startDate = new Date();
            const endDate = new Date();
            endDate.setDate(startDate.getDate() + leaveDays);

            // Generate medical condition based on consultation
            let medicalCondition = '';
            if (includeCurrentDiagnosis && consultation.diagnosis) {
                medicalCondition = consultation.diagnosis;
            } else {
                medicalCondition = consultation.chiefComplaint || 'Medical condition requiring rest and treatment';
            }

            // Generate recommendations based on consultation
            let recommendations = '';
            if (consultation.advice) {
                recommendations = consultation.advice;
            }
            if (consultation.medications && consultation.medications.length > 0) {
                recommendations += (recommendations ? '\n' : '') + 'Continue prescribed medications as advised.';
            }
            recommendations += (recommendations ? '\n' : '') + 'Adequate rest and follow-up as needed.';

            return {
                patientName: patient?.name || '',
                patientAge: patient?.age || '',
                patientGender: patient?.gender || '',
                certificateType: certType,
                certificateDate: new Date().toISOString().split('T')[0],
                leaveStartDate: startDate.toISOString().split('T')[0],
                leaveEndDate: endDate.toISOString().split('T')[0],
                indefiniteLeave: false,
                medicalCondition: medicalCondition,
                recommendations: recommendations,
                requiresBedRest: consultation.severity === 'high',
                requiresFollowUp: true,
                autoGenerated: true,
                sourceConsultationId: consultation.id,
                sourceConsultationDate: consultation.date
            };
        }

        function updateCertificateStats() {
            if (!currentPatientId) return;

            const certificates = loadCertificates(currentPatientId);
            const consultations = loadConsultations(currentPatientId);
            
            // Total certificates
            document.getElementById('totalCertificates').textContent = certificates.length;

            // This month certificates
            const thisMonth = new Date();
            thisMonth.setDate(1);
            const monthCerts = certificates.filter(cert => 
                new Date(cert.issuedDate) >= thisMonth
            );
            document.getElementById('monthCertificates').textContent = monthCerts.length;

            // Available consultations
            document.getElementById('availableConsultations').textContent = consultations.length;
        }

        function showCertificateActionsModal(certificateId) {
            window.currentCertificateId = certificateId;
            const patient = patients.find(p => p.id === currentPatientId);
            
            // Pre-fill patient data
            if (patient) {
                document.getElementById('patientEmail').value = patient.email || '';
                document.getElementById('patientWhatsApp').value = patient.mobile || '';
            }

            document.getElementById('certificateActionsModal').classList.remove('hidden');
        }

        function hideCertificateActionsModal() {
            document.getElementById('certificateActionsModal').classList.add('hidden');
        }

        async function sendCertificateEmail() {
            try {
                const email = document.getElementById('patientEmail').value;
                const ccEmail = document.getElementById('ccEmail').value;
                
                if (!email) {
                    showNotification('Please enter patient email address', 'error');
                    return;
                }

                showNotification('Generating certificate PDF for email...', 'info');

                let certificate;
                
                // Check if it's a temporary certificate (preview mode)
                if (window.currentCertificateId === 'temp' && window.tempAutoGeneratedCert) {
                    certificate = window.tempAutoGeneratedCert;
                } else {
                    // Get certificate from storage
                    const certificates = loadCertificates(currentPatientId);
                    certificate = certificates.find(c => c.id === window.currentCertificateId);
                }
                
                if (!certificate) {
                    showNotification('Certificate not found', 'error');
                    return;
                }

                // Generate certificate PDF first (same as download function)
                const certificateHtml = generateCertificateTemplate(certificate);
                
                // Create a temporary container for the certificate
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = certificateHtml;
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.style.background = 'white';
                tempContainer.style.width = '800px';
                tempContainer.style.padding = '40px';
                document.body.appendChild(tempContainer);
                
                // Wait for content to render
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Capture with html2canvas
                const canvas = await html2canvas(tempContainer, {
                    scale: 3,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: tempContainer.offsetWidth,
                    height: tempContainer.offsetHeight,
                    logging: false,
                    letterRendering: true,
                    imageTimeout: 20000
                });
                
                // Remove temporary container
                document.body.removeChild(tempContainer);
                
                const imgData = canvas.toDataURL('image/png', 1.0);
                
                // Create single-page PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15;
                
                const maxHeight = pageHeight - (margin * 2);
                const maxWidth = pageWidth - (margin * 2);
                
                let finalWidth = maxWidth;
                let finalHeight = (canvas.height * finalWidth) / canvas.width;
                
                if (finalHeight > maxHeight) {
                    finalHeight = maxHeight;
                    finalWidth = (canvas.width * finalHeight) / canvas.height;
                }
                
                const xPos = (pageWidth - finalWidth) / 2;
                const yPos = margin;
                
                pdf.addImage(imgData, 'PNG', xPos, yPos, finalWidth, finalHeight);

                // Generate email content
                const patient = patients.find(p => p.id === currentPatientId);
                const subject = `Medical Certificate - ${patient?.name || certificate.patientName || 'Patient'}`;
                
                const certificateTypeFormatted = certificate.certificateType?.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) || 'Medical Certificate';
                const issueDate = certificate.issuedDate ? new Date(certificate.issuedDate).toLocaleDateString() : new Date().toLocaleDateString();
                const startDate = certificate.leaveStartDate ? new Date(certificate.leaveStartDate).toLocaleDateString() : 'N/A';
                const endDate = certificate.indefiniteLeave ? 'Until further notice' : 
                               (certificate.leaveEndDate ? new Date(certificate.leaveEndDate).toLocaleDateString() : 'N/A');

                // Generate filename and save PDF first
                const patientName = patient?.name || certificate.patientName || 'Patient';
                const fileName = `Certificate_${patientName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

                const body = `Dear ${patient?.name || certificate.patientName || 'Patient'},

Please find your medical certificate details below. The certificate PDF has been downloaded for you to attach to this email.

Certificate Details:
- Certificate No: ${certificate.id || 'TEMP-' + Date.now()}
- Type: ${certificateTypeFormatted}
- Issue Date: ${issueDate}
- Leave Period: ${startDate} to ${endDate}
- Medical Condition: ${certificate.medicalCondition || 'As per consultation'}

${certificate.recommendations ? `Medical Recommendations: ${certificate.recommendations}` : ''}

 PDF File: ${fileName}

For any queries, please contact our clinic.

Best regards,
${doctorProfile.doctorName || 'Dr. [Your Name]'}
${doctorProfile.clinicInfo || 'Medical Clinic'}
${doctorProfile.mobile ? 'Phone: ' + doctorProfile.mobile : ''}`;

                // Create mailto link
                const mailtoLink = `mailto:${email}${ccEmail ? `?cc=${ccEmail}` : ''}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                // Open email client
                window.open(mailtoLink);
                
                showNotification('Certificate PDF generated and email client opened!', 'success');
                hideCertificateActionsModal();
                
            } catch (error) {
                console.error('Certificate email error:', error);
                showNotification('Error generating certificate for email. Please try again.', 'error');
            }
        }

        async function shareCertificateWhatsApp() {
            try {
                showNotification('Generating certificate PDF for WhatsApp...', 'info');

                let certificate;
                
                // Check if it's a temporary certificate (preview mode)
                if (window.currentCertificateId === 'temp' && window.tempAutoGeneratedCert) {
                    certificate = window.tempAutoGeneratedCert;
                } else {
                    // Get certificate from storage
                    const certificates = loadCertificates(currentPatientId);
                    certificate = certificates.find(c => c.id === window.currentCertificateId);
                }
                
                if (!certificate) {
                    showNotification('Certificate not found', 'error');
                    return;
                }

                // Generate certificate PDF first (same as download function)
                const certificateHtml = generateCertificateTemplate(certificate);
                
                // Create a temporary container for the certificate
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = certificateHtml;
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.style.background = 'white';
                tempContainer.style.width = '800px';
                tempContainer.style.padding = '40px';
                document.body.appendChild(tempContainer);
                
                // Wait for content to render
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Capture with html2canvas
                const canvas = await html2canvas(tempContainer, {
                    scale: 3,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: tempContainer.offsetWidth,
                    height: tempContainer.offsetHeight,
                    logging: false,
                    letterRendering: true,
                    imageTimeout: 20000
                });
                
                // Remove temporary container
                document.body.removeChild(tempContainer);
                
                const imgData = canvas.toDataURL('image/png', 1.0);
                
                // Create single-page PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15;
                
                const maxHeight = pageHeight - (margin * 2);
                const maxWidth = pageWidth - (margin * 2);
                
                let finalWidth = maxWidth;
                let finalHeight = (canvas.height * finalWidth) / canvas.width;
                
                if (finalHeight > maxHeight) {
                    finalHeight = maxHeight;
                    finalWidth = (canvas.width * finalHeight) / canvas.height;
                }
                
                const xPos = (pageWidth - finalWidth) / 2;
                const yPos = margin;
                
                pdf.addImage(imgData, 'PNG', xPos, yPos, finalWidth, finalHeight);

                const patient = patients.find(p => p.id === currentPatientId);
                
                // Format certificate data
                const certificateTypeFormatted = certificate.certificateType?.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) || 'Medical Certificate';
                const issueDate = certificate.issuedDate ? new Date(certificate.issuedDate).toLocaleDateString() : new Date().toLocaleDateString();
                const startDate = certificate.leaveStartDate ? new Date(certificate.leaveStartDate).toLocaleDateString() : 'N/A';
                const endDate = certificate.indefiniteLeave ? 'Until further notice' : 
                               (certificate.leaveEndDate ? new Date(certificate.leaveEndDate).toLocaleDateString() : 'N/A');
                
                // Generate filename for PDF
                const patientName = patient?.name || certificate.patientName || 'Patient';
                const fileName = `Certificate_${patientName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                // Save PDF first (user can access it later)
                pdf.save(fileName);
                
                // Generate WhatsApp message
                const message = ` *MEDICAL CERTIFICATE*

Dear ${patient?.name || certificate.patientName || 'Patient'},

Your medical certificate has been issued and downloaded as PDF.

 *Certificate No:* ${certificate.id || 'TEMP-' + Date.now()}
 *Issue Date:* ${issueDate}
 *Type:* ${certificateTypeFormatted}
 *Leave Period:* ${startDate} to ${endDate}

 *Medical Condition:* ${certificate.medicalCondition || 'As per consultation'}

${certificate.recommendations ? ` *Recommendations:* ${certificate.recommendations}` : ''}

 *PDF File:* ${fileName}

Issued by: ${doctorProfile.doctorName || 'Dr. [Your Name]'}
${doctorProfile.clinicInfo || 'Medical Clinic'}
${doctorProfile.mobile ? 'Contact: ' + doctorProfile.mobile : ''}

For any queries, please contact our clinic.`;

                // Open WhatsApp directly with the message (let user choose recipient)
                const encodedMessage = encodeURIComponent(message + '\n\n(PDF file has been downloaded to your device - please attach it manually)');
                
                // Try different WhatsApp approaches
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile) {
                    // Mobile: try WhatsApp app first
                    window.open(`whatsapp://send?text=${encodedMessage}`, '_blank');
                } else {
                    // Desktop: use WhatsApp Web
                    window.open(`https://web.whatsapp.com/send?text=${encodedMessage}`, '_blank');
                }
                
                showNotification('Certificate PDF generated and WhatsApp opened!', 'success');
                hideCertificateActionsModal();
                
            } catch (error) {
                console.error('Certificate WhatsApp share error:', error);
                showNotification('Error generating certificate for WhatsApp. Please try again.', 'error');
            }
        }

        function printCertificateAdvanced(format) {
            const certificates = loadCertificates(currentPatientId);
            const certificate = certificates.find(c => c.id === window.currentCertificateId);
            
            if (!certificate) {
                showNotification('Certificate not found', 'error');
                return;
            }

            const certificateHtml = generateCertificateTemplate(certificate);
            const printWindow = window.open('', '_blank');
            
            let additionalStyles = '';
            if (format === 'letterhead') {
                additionalStyles = `
                    .certificate-template::before {
                        content: '';
                        display: block;
                        height: 100px;
                        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 100"><rect width="200" height="100" fill="%234f46e5"/><text x="100" y="50" text-anchor="middle" fill="white" font-size="20">CLINIC LOGO</text></svg>') no-repeat center;
                        background-size: contain;
                        margin-bottom: 20px;
                        page-break-inside: avoid;
                    }
                `;
            }

            printWindow.document.write(`
                <html>
                <head>
                    <title>Medical Certificate</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 1in;
                        }
                        
                        body { 
                            font-family: 'Times New Roman', serif; 
                            margin: 0;
                            padding: 20px; 
                            line-height: 1.6; 
                            color: #333;
                            background: white;
                        }
                        
                        .certificate-template { 
                            display: flex;
                            flex-direction: column;
                            justify-content: space-between;
                            max-width: 800px; 
                            margin: 0 auto; 
                            border: 2px solid #2563eb;
                            padding: 30px;
                            min-height: calc(100vh - 2.5in); /* Adjusted for better screen view */
                            position: relative;
                        }
                        
                        .certificate-header { 
                            text-align: center; 
                            border-bottom: 3px solid #2563eb; 
                            padding-bottom: 20px; 
                            margin-bottom: 30px;
                            page-break-after: avoid;
                        }
                        
                        .certificate-title { 
                            font-size: 24px; 
                            font-weight: bold; 
                            color: #1e40af; 
                            margin: 20px 0; 
                            text-transform: uppercase; 
                            letter-spacing: 2px;
                        }
                        
                        .certificate-content { 
                            padding: 20px 0; 
                            text-align: justify; 
                            font-size: 16px;
                            flex-grow: 1; /* Allows content to expand */
                        }
                        
                        .certificate-content p {
                            margin-bottom: 15px;
                            orphans: 2;
                            widows: 2;
                        }
                        
                        .certificate-footer { 
                            display: flex; 
                            justify-content: space-between; 
                            align-items: flex-end;
                            padding-top: 20px;
                            margin-top: 60px; /* Increased space above footer */
                            border-top: 1px solid #ccc;
                            page-break-inside: avoid;
                            clear: both;
                        }
                        
                        .certificate-signature { 
                            text-align: center; 
                            padding-top: 10px; 
                            min-width: 200px;
                            page-break-inside: avoid;
                        }
                        
                        .certificate-signature img {
                            max-height: 40px;
                            max-width: 120px;
                            margin-bottom: 8px;
                            display: block;
                            margin-left: auto;
                            margin-right: auto;
                        }
                        
                        .certificate-date {
                            text-align: left;
                            page-break-inside: avoid;
                            font-weight: bold;
                        }
                        
                        ${additionalStyles}
                        
                        @media print { 
                            body { 
                                margin: 0; 
                                padding: 0;
                                background: white;
                            }
                            
                            .certificate-template { 
                                border: 2px solid #2563eb;
                                page-break-inside: avoid;
                            }
                            
                            .certificate-header {
                                page-break-after: avoid;
                            }
                            
                            .certificate-content {
                                page-break-inside: avoid;
                            }
                            
                            .certificate-footer {
                                page-break-inside: avoid;
                                margin-top: 40px !important;
                                border-top: 1px solid #ccc !important;
                                padding-top: 20px !important;
                            }
                        }
                    </style>
                </head>
                <body>${certificateHtml}</body>
                </html>
            `);
            printWindow.document.close();
            
            // Wait for content to load before printing
            setTimeout(() => {
                printWindow.print();
            }, 800);
            
            hideCertificateActionsModal();
        }

        // Expose all certificate-related functions to global scope for onclick handlers
        window.hideAutoGenerateModal = hideAutoGenerateModal;
        window.hideCertificateActionsModal = hideCertificateActionsModal;

        // Final safety check - ensure loading spinner is always hidden
        setTimeout(() => {
            const loadingSpinner = document.getElementById('loading');
            if (loadingSpinner && loadingSpinner.style.display !== 'none') {
                console.log(' Final safety: Forcing loading spinner to hide');
                loadingSpinner.style.display = 'none';
            }
        }, 2000);
        window.sendCertificateEmail = sendCertificateEmail;
        window.shareCertificateWhatsApp = shareCertificateWhatsApp;
        window.printCertificateAdvanced = printCertificateAdvanced;
        window.verifyCertificate = verifyCertificate;

        // --- NEW PRESCRIPTION FUNCTIONS (Similar to Certificate) ---
        
        function viewPrescriptionModal(patient, consultation) {
            try {
                const prescriptionContent = document.getElementById('prescriptionContent');
                if (!prescriptionContent) {
                    showNotification('Prescription content not found', 'error');
                    return;
                }
                
                // Create a new window/tab to display the prescription
                const prescriptionWindow = window.open('', '_blank', 'width=800,height=1000,scrollbars=yes,resizable=yes');
                
                const prescriptionHTML = '<!DOCTYPE html>' +
                    '<html>' +
                    '<head>' +
                        '<title>Prescription - ' + patient.name + '</title>' +
                        '<meta charset="UTF-8">' +
                        '<meta name="viewport" content="width=device-width, initial-scale=1.0">' +
                        '<script src="https://cdn.tailwindcss.com"><\/script>' +
                        '<style>' +
                            'body { font-family: Georgia, "Times New Roman", serif; }' +
                            '.prescription-container { max-width: 800px; margin: 20px auto; background: white; padding: 40px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }' +
                            '@media print { ' +
                                'body { margin: 0; }' +
                                '.prescription-container { box-shadow: none; margin: 0; padding: 20px; }' +
                            '}' +
                        '</style>' +
                    '</head>' +
                    '<body class="bg-gray-100">' +
                        '<div class="prescription-container">' +
                            prescriptionContent.innerHTML +
                        '</div>' +
                        '<div class="text-center mt-6 no-print">' +
                            '<button onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded-lg mr-3 hover:bg-blue-700">' +
                                ' Print' +
                            '</button>' +
                            '<button onclick="window.close()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">' +
                                ' Close' +
                            '</button>' +
                        '</div>' +
                    '</body>' +
                    '</html>';
                
                prescriptionWindow.document.write(prescriptionHTML);
                prescriptionWindow.document.close();
                
                showNotification('Prescription opened in new window', 'success');
            } catch (error) {
                console.error('Error viewing prescription:', error);
                showNotification('Error opening prescription view', 'error');
            }
        }

        function verifyPrescriptionAuthenticity(patient, consultation) {
            try {
                // Get prescription details
                const prescriptionContent = document.getElementById('prescriptionContent');
                if (!prescriptionContent) {
                    showNotification('Prescription not found', 'error');
                    return;
                }
                
                // Extract prescription ID and hash from the displayed content
                const prescriptionIdElement = prescriptionContent.querySelector('[style*="Prescription ID"]');
                const authHashElement = prescriptionContent.querySelector('[style*="Auth Hash"]');
                
                let verificationData = {
                    prescriptionId: consultation.prescriptionId || 'RX-' + Date.now(),
                    patientName: patient.name,
                    doctorName: doctorProfile.doctorName || 'Dr. [Your Name]',
                    issueDate: consultation.consultationDate || new Date().toISOString().split('T')[0],
                    digitalSignature: doctorProfile.digitalSignature ? 'Present' : 'Not Present',
                    authHash: authHashElement ? 'Valid' : 'Not Available'
                };
                
                // Create verification modal
                const verificationModal = document.createElement('div');
                verificationModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                verificationModal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-green-600"> Prescription Verification</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="font-medium">Prescription ID:</span>
                                <span class="text-gray-600">${verificationData.prescriptionId}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Patient:</span>
                                <span class="text-gray-600">${verificationData.patientName}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Doctor:</span>
                                <span class="text-gray-600">${verificationData.doctorName}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Issue Date:</span>
                                <span class="text-gray-600">${new Date(verificationData.issueDate).toLocaleDateString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Digital Signature:</span>
                                <span class="${verificationData.digitalSignature === "Present" ? "text-green-600" : "text-orange-600"}">${verificationData.digitalSignature}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-medium">Authentication:</span>
                                <span class="${verificationData.authHash === "Valid" ? "text-green-600" : "text-orange-600"}">${verificationData.authHash}</span>
                            </div>
                        </div>
                        <div class="mt-6 p-4 rounded-lg ${verificationData.digitalSignature === "Present" ? "bg-green-50 border border-green-200" : "bg-orange-50 border border-orange-200"}">
                            <div class="flex items-center space-x-2">
                                ${verificationData.digitalSignature === "Present" ? 
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><path d="M9 12l2 2 4-4"/><path d="M21 12c0 1.66-1.34 3-3 3H6a3 3 0 01-3-3V8a3 3 0 013-3h12a3 3 0 013 3v4z"/></svg>' :
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-600"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
                                }
                                <div>
                                    <p class="font-medium ${verificationData.digitalSignature === "Present" ? "text-green-800" : "text-orange-800"}">
                                        ${verificationData.digitalSignature === "Present" ? "Prescription Verified" : "Verification Incomplete"}
                                    </p>
                                    <p class="text-xs ${verificationData.digitalSignature === "Present" ? "text-green-600" : "text-orange-600"}">
                                        ${verificationData.digitalSignature === "Present" ? 
                                            "This prescription has been digitally signed and authenticated" : 
                                            "This prescription requires digital signature for full verification"
                                        }
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <button onclick="this.closest('.fixed').remove()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(verificationModal);
                showNotification('Prescription verification completed', 'success');
                
            } catch (error) {
                console.error('Error verifying prescription:', error);
                showNotification('Error verifying prescription authenticity', 'error');
            }
        }

        // --- CERTIFICATE PDF FUNCTIONS (Single Page Like Prescription) ---
        
        async function printCertificatePDFForSharing() {
            try {
                showNotification('Generating certificate PDF for printing...', 'info');
                
                let certificate;
                
                // Check if it's a temporary certificate (preview mode)
                if (window.currentCertificateId === 'temp' && window.tempAutoGeneratedCert) {
                    certificate = window.tempAutoGeneratedCert;
                } else {
                    // Get certificate from storage
                    const certificates = loadCertificates(currentPatientId);
                    certificate = certificates.find(c => c.id === window.currentCertificateId);
                }
                
                if (!certificate) {
                    showNotification('Certificate not found', 'error');
                    return;
                }
                
                // Generate certificate HTML
                const certificateHtml = generateCertificateTemplate(certificate);
                
                // Create a temporary container for the certificate
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = certificateHtml;
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.style.background = 'white';
                tempContainer.style.width = '800px';
                tempContainer.style.padding = '40px';
                document.body.appendChild(tempContainer);
                
                // Wait for content to render
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Capture with html2canvas
                const canvas = await html2canvas(tempContainer, {
                    scale: 3,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: tempContainer.offsetWidth,
                    height: tempContainer.offsetHeight,
                    logging: false,
                    letterRendering: true,
                    imageTimeout: 20000
                });
                
                // Remove temporary container
                document.body.removeChild(tempContainer);
                
                const imgData = canvas.toDataURL('image/png', 1.0);
                
                // Create single-page PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 15;
                
                const maxHeight = pageHeight - (margin * 2);
                const maxWidth = pageWidth - (margin * 2);
                
                let finalWidth = maxWidth;
                let finalHeight = (canvas.height * finalWidth) / canvas.width;
                
                if (finalHeight > maxHeight) {
                    finalHeight = maxHeight;
                    finalWidth = (canvas.width * finalHeight) / canvas.height;
                }
                
                const xPos = (pageWidth - finalWidth) / 2;
                const yPos = margin;
                
                pdf.addImage(imgData, 'PNG', xPos, yPos, finalWidth, finalHeight);
                
                // Open PDF in new window for printing
                const pdfBlob = pdf.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                const printWindow = window.open(pdfUrl, '_blank');
                
                // Auto-print after a short delay
                setTimeout(() => {
                    printWindow.print();
                }, 1000);
                
                showNotification('Certificate PDF ready for printing!', 'success');
                hideCertificateActionsModal();
                
            } catch (error) {
                console.error('Certificate print error:', error);
                showNotification('Error generating certificate PDF for printing. Please try again.', 'error');
            }
        }
        
        async function downloadCertificatePDF() {
            try {
                showNotification('Generating certificate PDF...', 'info');
                
                let certificate;
                
                // Check if it's a temporary certificate (preview mode)
                if (window.currentCertificateId === 'temp' && window.tempAutoGeneratedCert) {
                    certificate = window.tempAutoGeneratedCert;
                } else {
                    // Get certificate from storage
                    const certificates = loadCertificates(currentPatientId);
                    certificate = certificates.find(c => c.id === window.currentCertificateId);
                }
                
                if (!certificate) {
                    showNotification('Certificate not found', 'error');
                    return;
                }
                
                // Generate certificate HTML
                const certificateHtml = generateCertificateTemplate(certificate);
                
                // Create a temporary container for the certificate
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = certificateHtml;
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.style.background = 'white';
                tempContainer.style.width = '800px';
                tempContainer.style.padding = '40px';
                document.body.appendChild(tempContainer);
                
                // Wait for content to render
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Capture with html2canvas using same settings as prescription
                const canvas = await html2canvas(tempContainer, {
                    scale: 3, // High quality for crisp text
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: tempContainer.offsetWidth,
                    height: tempContainer.offsetHeight,
                    logging: false,
                    letterRendering: true,
                    imageTimeout: 20000,
                    onclone: (clonedDoc) => {
                        // Apply exact same styling to cloned document
                        const clonedContainer = clonedDoc.querySelector('div');
                        if (clonedContainer) {
                            clonedContainer.style.boxShadow = 'none';
                            clonedContainer.style.margin = '0';
                            clonedContainer.style.transform = 'none';
                        }
                        
                        // Ensure all text is sharp
                        const allElements = clonedDoc.querySelectorAll('*');
                        allElements.forEach(el => {
                            el.style.webkitFontSmoothing = 'antialiased';
                            el.style.mozOsxFontSmoothing = 'grayscale';
                        });
                    }
                });
                
                // Remove temporary container
                document.body.removeChild(tempContainer);
                
                const imgData = canvas.toDataURL('image/png', 1.0);
                
                // Create PDF with exact single-page layout (same as prescription)
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pageWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const margin = 15;
                
                const maxHeight = pageHeight - (margin * 2);
                const maxWidth = pageWidth - (margin * 2);
                
                let finalWidth = maxWidth;
                let finalHeight = (canvas.height * finalWidth) / canvas.width;
                
                // Scale down if needed to fit on single page
                if (finalHeight > maxHeight) {
                    finalHeight = maxHeight;
                    finalWidth = (canvas.width * finalHeight) / canvas.height;
                }
                
                // Center the content
                const xPos = (pageWidth - finalWidth) / 2;
                const yPos = margin;
                
                pdf.addImage(imgData, 'PNG', xPos, yPos, finalWidth, finalHeight);
                
                // Generate filename
                const patient = patients.find(p => p.id === currentPatientId);
                const patientName = patient?.name || certificate.patientName || 'Patient';
                const fileName = `Certificate_${patientName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                // Download PDF
                pdf.save(fileName);
                
                showNotification('Certificate PDF downloaded successfully!', 'success');
                hideCertificateActionsModal();
                
            } catch (error) {
                console.error('Certificate PDF download error:', error);
                showNotification('Error generating certificate PDF. Please try again.', 'error');
            }
        }

        // Make new functions globally available
        window.viewPrescriptionModal = viewPrescriptionModal;
        window.verifyPrescriptionAuthenticity = verifyPrescriptionAuthenticity;
        window.downloadCertificatePDF = downloadCertificatePDF;
        window.printCertificatePDFForSharing = printCertificatePDFForSharing;

    </script>

    <!-- Simplified Mobile Footer -->
    <footer class="bg-gray-800 text-white mt-8 py-4 text-center text-sm no-print">
        <p> 2025 MediRecords Pro</p>
        <div class="mt-1 flex items-center justify-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            <span class="text-xs text-gray-400">Secure & HIPAA Compliant</span>
        </div>
    </footer>
</body>
</html>
